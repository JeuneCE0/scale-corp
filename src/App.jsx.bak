import { useState, useEffect, useCallback, useMemo, useRef, Fragment } from "react";
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, PieChart, Pie, Cell, Area, AreaChart, Legend } from "recharts";
const C={bg:"#06060b",card:"#0e0e16",card2:"#131320",brd:"#1a1a2c",brdL:"#24243a",acc:"#c8a44e",accD:"rgba(200,164,78,.1)",g:"#34d399",gD:"rgba(52,211,153,.1)",r:"#f87171",rD:"rgba(248,113,113,.1)",o:"#fb923c",oD:"rgba(251,146,60,.1)",b:"#60a5fa",bD:"rgba(96,165,250,.1)",t:"#e4e4e7",td:"#71717a",tm:"#3f3f50",v:"#a78bfa",vD:"rgba(167,139,250,.1)"};
const MN=["Jan","FÃ©v","Mar","Avr","Mai","Jun","Jul","AoÃ»","Sep","Oct","Nov","DÃ©c"];
const curM=()=>{const d=new Date();return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;};
const ml=k=>{if(!k)return"";const[y,m]=k.split("-");return`${MN[parseInt(m)-1]} ${y}`;};
const fmt=n=>new Intl.NumberFormat("fr-FR").format(Math.round(n||0));
const fK=n=>n>=1e3?`${(n/1e3).toFixed(1).replace(".0","")}K`:String(n);
const pct=(a,b)=>b?Math.round(a/b*100):0;
const clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));
const prevM=m=>{const[y,mo]=m.split("-").map(Number);const d=new Date(y,mo-2,1);return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;};
const nextM=m=>{const[y,mo]=m.split("-").map(Number);const d=new Date(y,mo,1);return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;};
const pf=v=>parseFloat(v)||0;const gr=(reps,id,m)=>reps[`${id}_${m}`]||null;
const FONT="'DM Sans',system-ui,sans-serif";
const BF={ca:"",charges:"",chargesOps:"",salaire:"",formation:"",clients:"",churn:"",pub:"",leads:"",leadsContact:"",leadsClos:"",notes:"",mrr:"",pipeline:"",tresoSoc:""};
const deadline=m=>{const[y,mo]=m.split("-").map(Number);return new Date(y,mo,5).toLocaleDateString("fr-FR",{day:"numeric",month:"long"});};
const qOf=m=>Math.ceil(parseInt(m.split("-")[1])/3);
const qMonths=m=>{const[y]=m.split("-").map(Number);const s=(qOf(m)-1)*3;return[0,1,2].map(i=>`${y}-${String(s+i+1).padStart(2,"0")}`);};
const qLabel=m=>`T${qOf(m)} ${m.split("-")[0]}`;
const ago=d=>{const s=Math.floor((Date.now()-new Date(d).getTime())/1e3);if(s<60)return"Ã  l'instant";if(s<3600)return`il y a ${Math.floor(s/60)}min`;if(s<86400)return`il y a ${Math.floor(s/3600)}h`;return`il y a ${Math.floor(s/86400)}j`;};
const uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,6);
const curW=()=>{const d=new Date();const jan1=new Date(d.getFullYear(),0,1);return`${d.getFullYear()}-W${String(Math.ceil(((d-jan1)/864e5+jan1.getDay()+1)/7)).padStart(2,"0")}`;};
const MOODS=["ðŸ˜«","ðŸ˜Ÿ","ðŸ˜","ðŸ™‚","ðŸ”¥"];
const sinceLbl=d=>{if(!d)return"";const s=new Date(d),n=new Date();const m=(n.getFullYear()-s.getFullYear())*12+n.getMonth()-s.getMonth();if(m<1)return"Ce mois";if(m===1)return"1 mois";if(m<12)return`${m} mois`;const y=Math.floor(m/12),rm=m%12;return rm>0?`${y}a ${rm}m`:`${y} an${y>1?"s":""}`;};
const sinceMonths=d=>{if(!d)return 0;const s=new Date(d),n=new Date();return(n.getFullYear()-s.getFullYear())*12+n.getMonth()-s.getMonth();};
const CSS=`*{box-sizing:border-box;margin:0;padding:0}body{margin:0;overflow-x:hidden}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}.fade-up{animation:fadeUp 0.5s ease forwards;opacity:0}
@keyframes barGrow{from{transform:scaleY(0)}to{transform:scaleY(1)}}
@keyframes fu{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes fi{from{opacity:0}to{opacity:1}}@keyframes si{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
@keyframes bg{from{width:0}to{width:var(--w,100%)}}
@keyframes mi{from{opacity:0;transform:scale(.95) translateY(12px)}to{opacity:1;transform:scale(1) translateY(0)}}
@keyframes sp{to{transform:rotate(360deg)}}@keyframes sh{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
@keyframes gl{0%,100%{border-color:rgba(200,164,78,.1)}50%{border-color:rgba(200,164,78,.35)}}
@keyframes fl{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}
@keyframes typing{0%{opacity:.2}20%{opacity:1}100%{opacity:.2}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
@keyframes celebIn{0%{opacity:0;transform:scale(.3) translateY(50px)}40%{transform:scale(1.1) translateY(-10px)}100%{opacity:1;transform:scale(1) translateY(0)}}
@keyframes confetti{0%{transform:translateY(0) rotate(0);opacity:1}100%{transform:translateY(120vh) rotate(720deg);opacity:0}}
@keyframes celebGlow{0%,100%{box-shadow:0 0 20px rgba(200,164,78,.15)}50%{box-shadow:0 0 40px rgba(200,164,78,.4),0 0 80px rgba(200,164,78,.15)}}
@keyframes mglow{0%,100%{box-shadow:0 0 3px rgba(200,164,78,.2)}50%{box-shadow:0 0 10px rgba(200,164,78,.4)}}
.fu{animation:fu .35s ease both}.fi{animation:fi .25s ease both}.si{animation:si .3s ease both}
.d1{animation-delay:.03s}.d2{animation-delay:.06s}.d3{animation-delay:.09s}.d4{animation-delay:.12s}.d5{animation-delay:.15s}.d6{animation-delay:.18s}.d7{animation-delay:.21s}.d8{animation-delay:.24s}
.hv{transition:all .18s ease}.hv:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,0,0,.25)}
.ba{transition:all .12s ease}.ba:hover{transform:translateY(-1px)}.ba:active{transform:scale(.97)}
.mi{animation:mi .25s cubic-bezier(.16,1,.3,1)}.gl{animation:gl 2.5s ease infinite}.fl{animation:fl 3s ease-in-out infinite}
.pg{animation:bg .5s cubic-bezier(.4,0,.2,1) both}
.dots span{animation:typing 1.4s infinite both}.dots span:nth-child(2){animation-delay:.2s}.dots span:nth-child(3){animation-delay:.4s}
::-webkit-scrollbar{width:3px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:${C.brd};border-radius:3px}
input[type=range]{-webkit-appearance:none;background:${C.brd};height:3px;border-radius:4px;outline:none}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:${C.acc};cursor:pointer;box-shadow:0 2px 6px rgba(200,164,78,.3)}
select{cursor:pointer}select:focus{border-color:${C.acc}44}
button:focus-visible{outline:2px solid ${C.acc}44;outline-offset:2px}`;
const DS=[
 {id:"leadx",nom:"LEADX",porteur:"Dayyaan",act:"Media Buying",pT:"benefices",pP:30,stat:"active",color:"#c8a44e",pin:"1001",rec:true,obj:10000,objQ:28000,ghlKey:"",ghlLocationId:"BjQ4DxmWrLl3nCNcjmhE",revToken:"",revEnv:"sandbox",revolutCompany:"leadx",incub:"2025-06-01",slackId:""},
 {id:"copy",nom:"Copywriting",porteur:"Sol",act:"Copywriting",pT:"benefices",pP:20,stat:"active",color:"#60a5fa",pin:"1002",rec:false,obj:15000,objQ:42000,ghlKey:"",ghlLocationId:"2lB0paK192CFU1cLz5eT",revToken:"",revEnv:"sandbox",revolutCompany:"bcs",incub:"2025-03-15",slackId:""},
 {id:"bbp",nom:"BourbonBonsPlans",porteur:"SimÃ©on",act:"VidÃ©o",pT:"benefices",pP:20,stat:"active",color:"#34d399",pin:"1003",rec:true,obj:8000,objQ:22000,ghlKey:"",revToken:"",revEnv:"sandbox",incub:"2025-08-01",slackId:""},
 {id:"studio",nom:"Studio Branding",porteur:"Pablo",act:"Design",pT:"benefices",pP:20,stat:"active",color:"#fb923c",pin:"1004",rec:false,obj:5000,objQ:14000,ghlKey:"",revToken:"",revEnv:"sandbox",incub:"2025-09-01",slackId:""},
 {id:"eco",nom:"L'Ã‰cosystÃ¨me",porteur:"Scale Corp",act:"Consulting",pT:"ca",pP:100,stat:"active",color:"#a78bfa",pin:"admin",rec:false,obj:7000,objQ:20000,ghlKey:"",ghlLocationId:"NsV7HI2MbE6qHtRp410y",revToken:"",revEnv:"sandbox",revolutCompany:"eco",incub:"2024-01-01",slackId:""},
 {id:"padel",nom:"Padel AcadÃ©mie",porteur:"Louis",act:"Formation",pT:"benefices",pP:20,stat:"lancement",color:"#14b8a6",pin:"1005",rec:false,obj:3000,objQ:0,ghlKey:"",revToken:"",revEnv:"sandbox",incub:"2026-01-15",slackId:""},
 {id:"iphone",nom:"Formation iPhone",porteur:"Ã€ dÃ©finir",act:"Contenu",pT:"benefices",pP:20,stat:"lancement",color:"#8b5cf6",pin:"1006",rec:false,obj:0,objQ:0,ghlKey:"",revToken:"",revEnv:"sandbox",incub:"2026-02-01",slackId:""},
 {id:"import",nom:"Import Auto",porteur:"Ã€ dÃ©finir",act:"Import",pT:"benefices",pP:20,stat:"lancement",color:"#ec4899",pin:"1007",rec:false,obj:0,objQ:0,ghlKey:"",revToken:"",revEnv:"sandbox",incub:"",slackId:""},
 {id:"tennis",nom:"Formation Tennis",porteur:"Ã€ dÃ©finir",act:"Tennis",pT:"benefices",pP:20,stat:"signature",color:"#06b6d4",pin:"1008",rec:false,obj:0,objQ:0,ghlKey:"",revToken:"",revEnv:"sandbox",incub:"",slackId:""},
 {id:"virale",nom:"VidÃ©o Virale",porteur:"Ã€ dÃ©finir",act:"VidÃ©o",pT:"benefices",pP:20,stat:"signature",color:"#f43f5e",pin:"1009",rec:false,obj:0,objQ:0,ghlKey:"",revToken:"",revEnv:"sandbox",incub:"",slackId:""},
 {id:"mindset",nom:"Coaching Mindset",porteur:"Ã€ dÃ©finir",act:"Mindset",pT:"benefices",pP:20,stat:"signature",color:"#eab308",pin:"1010",rec:false,obj:0,objQ:0,ghlKey:"",revToken:"",revEnv:"sandbox",incub:"",slackId:""},
];
const DH={logiciels:1200,equipe:300,service:500,cabinet:280,remun:3000,reservePct:30,crm:150,treso:2000,revolutToken:"",revolutEnv:"sandbox",slack:{enabled:false,mode:"bob",webhookUrl:"",botToken:"",channel:"",bobWebhook:"",notifyPulse:true,notifyReport:true,notifyValidation:true,notifyReminders:true},brand:{name:"SCALE CORP",sub:"Plateforme de pilotage",logoUrl:"",logoLetter:"S",accentColor:"#c8a44e"}};
const DEAL_STAGES=["IdÃ©e","Contact","NÃ©gociation","Due Diligence","Signature"];
function mkPrefill(){ return {}; }

function autoGenerateReport(socId, month, socBank, ghlData, subs){
 const sb=socBank?.[socId], gd=ghlData?.[socId];
 const monthly=sb?.monthly?.[month];
 const txns=(sb?.transactions||[]).filter(t=>{const d=t.created_at||t.date||"";return d.startsWith(month);});
 const sumTxns=(keywords)=>Math.abs(txns.filter(t=>{const desc=((t.description||"")+(t.reference||"")).toLowerCase();return keywords.some(k=>desc.includes(k))&&(t.legs?.[0]?.amount||0)<0;}).reduce((a,t)=>a+Math.abs(t.legs?.[0]?.amount||0),0));
 const ca=monthly?.income||0;
 const dividendesHolding=Math.round(Math.abs(txns.filter(t=>{const hasCpty=!!t.legs?.[0]?.counterparty;const single=(t.legs||[]).length===1;const legDesc=((t.legs?.[0]?.description||"")).toLowerCase();return((/dividend/i.test(t.reference||"")&&hasCpty&&single)||(/scale\s*corp/i.test(legDesc)&&hasCpty&&single))&&(t.legs?.[0]?.amount||0)<0;}).reduce((a,t)=>a+Math.abs(t.legs?.[0]?.amount||0),0)));
 const charges=Math.max(0,(monthly?.expense||0)-dividendesHolding);
 const chargesOps=Math.round(sumTxns(["abonnement","subscription","saas","hosting","heroku","vercel","aws","stripe fee"]));
 const salaire=Math.round(sumTxns(["salaire","salary","freelance","prestation"]));
 const pub=Math.round(sumTxns(["facebook","google ads","meta ads","tiktok","pub ","advertising","adwords"]));
 const formation=Math.round(sumTxns(["formation","training","skool","udemy","coursera"]));
 const clients=gd?.stats?.wonDeals||gd?.ghlClients?.filter(c=>c.status==="active")?.length||0;
 const leads=gd?.stats?.totalLeads||0;
 const pipeline=gd?.stats?.pipelineValue||0;
 const tresoSoc=sb?.balance||0;
 const activeClients=gd?.ghlClients?.filter(c=>c.status==="active")||[];
 const mrr=activeClients.reduce((a,c)=>{const b=c.billing;if(!b)return a;if(b.freq==="monthly")return a+pf(b.amount);if(b.freq==="annual")return a+pf(b.amount)/12;return a;},0);
 return{ca:String(Math.round(ca)),charges:String(Math.round(charges)),chargesOps:String(chargesOps),salaire:String(salaire),formation:String(formation),clients:String(clients),churn:"",pub:String(pub),leads:String(leads),leadsContact:"",leadsClos:String(gd?.stats?.wonDeals||0),notes:"Auto-gÃ©nÃ©rÃ© depuis Revolut + GHL",mrr:String(Math.round(mrr)),pipeline:String(Math.round(pipeline)),tresoSoc:String(Math.round(tresoSoc)),dividendesHolding:String(dividendesHolding),ok:false,at:new Date().toISOString(),comment:"",_auto:true};
}
const DEMO_JOURNAL={};
const DEMO_ACTIONS=[];
const DEMO_PULSES={};
const DEMO_DEALS=[];
const curQ=()=>{const d=new Date();return`${d.getFullYear()}-Q${Math.ceil((d.getMonth()+1)/3)}`;};
const DEMO_OKRS=[];
const DEMO_SYNERGIES=[];
const SYN_TYPES={referral:{label:"Referral",icon:"ðŸ”—",color:C.b},collab:{label:"Collaboration",icon:"ðŸ¤",color:C.v},resource:{label:"Ressource partagÃ©e",icon:"ðŸ“¦",color:C.o}};
const SYN_STATUS={active:{label:"En cours",color:C.b},won:{label:"GagnÃ©",color:C.g},lost:{label:"Perdu",color:C.r}};
const SUB_CATS={crm:{l:"CRM/Marketing",icon:"ðŸ’»",c:C.v},design:{l:"Design",icon:"ðŸŽ¨",c:C.o},comms:{l:"Communication",icon:"ðŸ’¬",c:C.b},iadev:{l:"IA/Dev",icon:"ðŸ¤–",c:C.g},productivite:{l:"ProductivitÃ©",icon:"ðŸ“Š",c:C.acc},formation:{l:"Formation/CommunautÃ©",icon:"ðŸŽ“",c:"#f59e0b"},paiement:{l:"Paiement",icon:"ðŸ’³",c:C.r},abonnement:{l:"Abonnement",icon:"ðŸ”„",c:"#8b5cf6"},prestataire:{l:"Prestataire",icon:"ðŸ‘¤",c:"#ec4899"},autre:{l:"Autre",icon:"ðŸ“¦",c:C.td}};
const AUTO_CAT_MAP=[
 [/gohighlevel|highlevel|hubspot|mailchimp|convertkit|activecampaign|brevo|sendinblue/i,"crm"],
 [/figma|canva|adobe|photoshop|illustrator|creative cloud/i,"design"],
 [/slack|zoom|google workspace|microsoft 365|microsoft|teams|twilio/i,"comms"],
 [/openai|anthropic|chatgpt|claude|github|vercel|aws|amazon web|heroku|netlify|railway|render/i,"iadev"],
 [/notion|zapier|make\.com|integromat|airtable|clickup|asana|monday/i,"productivite"],
 [/skool|teachable|kajabi|podia|thinkific|circle/i,"formation"],
 [/stripe|revolut|paypal|wise|mollie|gocardless/i,"paiement"],
 [/l.cosyst.me|lecosysteme/i,"abonnement"],
 [/lucien/i,"prestataire"],
];
function autoCategorize(name){for(const[rx,cat]of AUTO_CAT_MAP)if(rx.test(name))return cat;return"autre";}
function autoDetectSubscriptions(bankData,socId){
 if(!bankData?.transactions)return[];
 const excluded=EXCLUDED_ACCOUNTS[socId]||[];
 const txns=bankData.transactions.filter(t=>{const leg=t.legs?.[0];if(!leg)return false;if(excluded.includes(leg.account_id))return false;return leg.amount<0;});
 const byDesc={};
 txns.forEach(t=>{const desc=(t.reference||t.description||t.legs?.[0]?.description||"").trim();const amt=Math.abs(t.legs[0].amount);if(!desc||amt<1)return;const key=desc.toLowerCase().replace(/[^a-z0-9]/g,"");if(!byDesc[key])byDesc[key]={desc,amounts:[],dates:[],key};byDesc[key].amounts.push(Math.round(amt));byDesc[key].dates.push(new Date(t.created_at));});
 const subs=[];
 const KNOWN=[/gohighlevel|highlevel/i,/zapier/i,/slack/i,/notion/i,/stripe/i,/revolut/i,/adobe|creative cloud/i,/figma/i,/skool/i,/convertkit/i,/canva/i,/chatgpt|openai/i,/anthropic|claude/i,/google workspace|google storage/i,/microsoft/i,/aws|amazon web/i,/vercel/i,/github/i,/zoom/i,/hubspot/i,/mailchimp/i,/brevo/i,/heroku/i,/airtable/i,/make\.com/i,/clickup/i];
 Object.values(byDesc).forEach(g=>{
  const isKnown=KNOWN.some(rx=>rx.test(g.desc));
  const amtCounts={};g.amounts.forEach(a=>{amtCounts[a]=(amtCounts[a]||0)+1;});
  const topAmt=Object.entries(amtCounts).sort((a,b)=>b[1]-a[1])[0];
  const recurring=topAmt&&topAmt[1]>=2;
  if(!isKnown&&!recurring)return;
  const amount=parseInt(topAmt[0]);
  const months=g.dates.length;
  const spanMs=g.dates.length>1?Math.max(...g.dates)-Math.min(...g.dates):0;
  const spanMonths=spanMs/(1000*60*60*24*30);
  const freq=amount>500&&spanMonths>6?"annual":"monthly";
  subs.push({id:"auto_"+g.key,socId:socId==="all"?"holding":socId,name:g.desc,amount,freq,cat:autoCategorize(g.desc),start:g.dates.sort((a,b)=>a-b)[0].toISOString().slice(0,10),notes:`Auto-dÃ©tectÃ© (${months}x trouvÃ©)`,auto:true});
 });
 return subs;
}
const DEMO_SUBS=[];
const DEMO_TEAM=[];
function subMonthly(sub){return sub.freq==="annual"?Math.round(sub.amount/12):sub.amount;}
const BILL_TYPES={
 fixed:{l:"Forfait fixe",icon:"ðŸ’°",c:C.acc,desc:"Montant fixe mensuel avec ou sans engagement"},
 percent:{l:"% du CA/bÃ©nÃ©fice",icon:"ðŸ“Š",c:C.v,desc:"Pourcentage sur le CA ou bÃ©nÃ©fice gÃ©nÃ©rÃ©"},
 oneoff:{l:"Prestation unique",icon:"ðŸŽ¯",c:C.b,desc:"Paiement unique (formation, accompagnement)"},
};
const CLIENT_STATUS={active:{l:"Actif",c:C.g,icon:"âœ“"},paused:{l:"En pause",c:C.o,icon:"â¸"},churned:{l:"Perdu",c:C.r,icon:"âœ—"},completed:{l:"TerminÃ©",c:C.td,icon:"âœ“"},prospect:{l:"Prospect",c:C.b,icon:"â—Œ"}};
const DEMO_CLIENTS=[];
function clientMonthlyRevenue(cl){
 const b=cl.billing;if(!b)return 0;
 if(b.type==="fixed"&&cl.status==="active")return b.amount;
 if(b.type==="percent"&&cl.status==="active"){
  const base=b.basis==="benefice"?Math.max(0,(cl.clientCA||0)-(cl.clientCharges||0)):(cl.clientCA||0);
  return Math.round(base*(b.percent||0)/100);
 }
 return 0;
}
function clientTotalValue(cl){
 const b=cl.billing;if(!b)return 0;
 if(b.type==="oneoff")return b.amount;
 if(b.type==="fixed"){
  const months=b.commitment||1;
  return b.amount*months;
 }
 return clientMonthlyRevenue(cl)*12;
}
function commitmentEnd(cl){
 const b=cl.billing;if(!b||b.type!=="fixed"||!b.commitment||!b.startDate)return null;
 const d=new Date(b.startDate);d.setMonth(d.getMonth()+b.commitment);return d;
}
function commitmentRemaining(cl){
 const end=commitmentEnd(cl);if(!end)return null;
 const now=new Date();const m=Math.max(0,Math.round((end-now)/(30*864e5)));return m;
}
const INV_STATUS={
 draft:{l:"Brouillon",c:C.td,icon:"ðŸ“",bg:C.card2},
 sent:{l:"EnvoyÃ©e",c:C.b,icon:"ðŸ“¤",bg:C.bD},
 paid:{l:"PayÃ©e",c:C.g,icon:"âœ…",bg:C.gD},
 overdue:{l:"En retard",c:C.r,icon:"âš ï¸",bg:C.rD},
 cancelled:{l:"AnnulÃ©e",c:C.td,icon:"âœ—",bg:C.card2},
};
function generateInvoices(client,socName){
 const b=client.billing;if(!b)return[];
 const invs=[];const now=new Date();
 const baseNum=`${socName.replace(/\s/g,"").slice(0,4).toUpperCase()}-${now.getFullYear()}`;
 if(b.type==="fixed"&&b.commitment>0){
  const start=b.startDate?new Date(b.startDate):now;
  for(let i=0;i<b.commitment;i++){
   const due=new Date(start);due.setMonth(due.getMonth()+i);
   const monthLabel=due.toLocaleDateString("fr-FR",{month:"long",year:"numeric"});
   invs.push({
    id:uid(),clientId:client.id,socId:client.socId,
    number:`${baseNum}-${String(i+1).padStart(3,"0")}`,
    amount:b.amount,
    dueDate:due.toISOString().slice(0,10),
    status:due<now?"paid":"draft",
    description:`${b.freq==="monthly"?"Forfait mensuel":"Forfait annuel"} â€” ${monthLabel}`,
    ghlInvoiceId:"",createdAt:now.toISOString(),sentAt:"",paidAt:due<now?due.toISOString():"",
    installment:i+1,totalInstallments:b.commitment,
   });
  }
 } else if(b.type==="fixed"&&!b.commitment){
  const due=b.startDate?new Date(b.startDate):now;
  invs.push({
   id:uid(),clientId:client.id,socId:client.socId,
   number:`${baseNum}-001`,amount:b.amount,
   dueDate:due.toISOString().slice(0,10),status:"draft",
   description:`Forfait mensuel â€” ${due.toLocaleDateString("fr-FR",{month:"long",year:"numeric"})}`,
   ghlInvoiceId:"",createdAt:now.toISOString(),sentAt:"",paidAt:"",
   installment:1,totalInstallments:1,
  });
 } else if(b.type==="oneoff"){
  const nParts=b.installments||1;
  const partAmount=Math.round(b.amount/nParts);
  const start=b.paidDate?new Date(b.paidDate):now;
  for(let i=0;i<nParts;i++){
   const due=new Date(start);due.setMonth(due.getMonth()+i);
   invs.push({
    id:uid(),clientId:client.id,socId:client.socId,
    number:`${baseNum}-${String(i+1).padStart(3,"0")}`,
    amount:i===nParts-1?b.amount-partAmount*(nParts-1):partAmount,
    dueDate:due.toISOString().slice(0,10),
    status:i===0&&b.paidDate?"paid":"draft",
    description:nParts>1?`${b.product||"Prestation"} â€” Ã‰chÃ©ance ${i+1}/${nParts}`:`${b.product||"Prestation"}`,
    ghlInvoiceId:"",createdAt:now.toISOString(),sentAt:"",paidAt:i===0&&b.paidDate?b.paidDate:"",
    installment:i+1,totalInstallments:nParts,
   });
  }
 } else if(b.type==="percent"){
  const rev=clientMonthlyRevenue(client);
  if(rev>0){
   invs.push({
    id:uid(),clientId:client.id,socId:client.socId,
    number:`${baseNum}-001`,amount:rev,
    dueDate:now.toISOString().slice(0,10),status:"draft",
    description:`${b.percent}% ${b.basis==="benefice"?"du bÃ©nÃ©fice":"du CA"} â€” ${now.toLocaleDateString("fr-FR",{month:"long",year:"numeric"})}`,
    ghlInvoiceId:"",createdAt:now.toISOString(),sentAt:"",paidAt:"",
    installment:1,totalInstallments:1,
   });
  }
 }
 return invs;
}
function refreshInvoiceStatuses(invoices){
 const today=new Date().toISOString().slice(0,10);
 return invoices.map(inv=>{
  if(inv.status==="sent"&&inv.dueDate<today)return{...inv,status:"overdue"};
  return inv;
 });
}
async function ghlCreateInvoice(apiKey,invoice,client){
 if(!apiKey)return null;
 try{
  const body={
   name:invoice.description,
   contactId:client.ghlId||"",
   dueDate:invoice.dueDate,
   items:[{name:invoice.description,amount:invoice.amount,qty:1}],
   status:"draft",
   currency:"EUR",
   businessDetails:{name:client.socId},
   invoiceNumber:invoice.number,
  };
  const r=await fetch(`${GHL_BASE}/invoices/`,{
   method:"POST",
   headers:{"Authorization":`Bearer ${apiKey}`,"Content-Type":"application/json"},
   body:JSON.stringify(body)
  });
  if(!r.ok)throw new Error(`GHL ${r.status}`);
  const data=await r.json();
  return data.id||data.invoiceId||null;
 }catch(e){console.warn("GHL create invoice failed:",e.message);return null;}
}
async function ghlSendInvoice(apiKey,ghlInvoiceId){
 if(!apiKey||!ghlInvoiceId)return false;
 try{
  const r=await fetch(`${GHL_BASE}/invoices/${ghlInvoiceId}/send`,{
   method:"POST",
   headers:{"Authorization":`Bearer ${apiKey}`,"Content-Type":"application/json"},
  });
  return r.ok;
 }catch(e){console.warn("GHL send invoice failed:",e.message);return false;}
}
function mkDemoInvoices(){ return []; }
function teamMonthly(tm,socCA){return tm.payType==="fixed"?tm.amount:Math.round((socCA||0)*tm.amount/100);}
function normalizeStr(s){return(s||"").toLowerCase().replace(/[^a-z0-9]/g,"");}
function fuzzyMatch(a,b){
 const na=normalizeStr(a),nb=normalizeStr(b);
 if(!na||!nb)return 0;
 if(na===nb)return 1;
 if(na.includes(nb)||nb.includes(na))return .9;
 const ta=a.toLowerCase().split(/\s+/).filter(Boolean),tb=b.toLowerCase().split(/\s+/).filter(Boolean);
 const common=ta.filter(t=>tb.some(u=>u.includes(t)||t.includes(u)));
 return common.length/Math.max(ta.length,tb.length);
}
function matchSubsToRevolut(subs,socBankData,socId){
 if(!socBankData?.transactions)return subs.map(s=>({...s,revMatch:null}));
 const excluded=EXCLUDED_ACCOUNTS[socId]||[];
 const txns=socBankData.transactions.filter(t=>{const leg=t.legs?.[0];if(!leg)return false;if(excluded.includes(leg.account_id))return false;return leg.amount<0;});
 return subs.map(sub=>{
  if(sub.socId!==socId&&sub.socId!=="holding")return{...sub,revMatch:null};
  const subName=sub.name;const subAmt=sub.amount;
  const matches=txns.filter(tx=>{
   const desc=tx.legs?.[0]?.description||tx.reference||tx.merchant?.name||"";
   const txAmt=Math.abs(tx.legs[0].amount);
   const nameSim=fuzzyMatch(subName,desc);
   const amtDiff=subAmt>0?Math.abs(txAmt-subAmt)/subAmt:1;
   return nameSim>=.5&&amtDiff<.3;
  }).sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
  if(matches.length===0)return{...sub,revMatch:null};
  const last=matches[0];
  const lastDate=new Date(last.created_at);
  const nextDate=new Date(lastDate);
  if(sub.freq==="annual")nextDate.setFullYear(nextDate.getFullYear()+1);
  else nextDate.setMonth(nextDate.getMonth()+1);
  return{...sub,revMatch:{
   txId:last.id,
   txDesc:last.legs?.[0]?.description||last.reference||"",
   txAmount:Math.abs(last.legs[0].amount),
   lastPayment:lastDate.toISOString(),
   nextPayment:nextDate.toISOString(),
   matchCount:matches.length,
   allTxIds:matches.map(m=>m.id),}};
 });
}
function deduplicatedCharges(totalChargesFromReport,matchedSubs){
 const matchedTotal=matchedSubs.filter(s=>s.revMatch).reduce((a,s)=>a+subMonthly(s),0);
 return{raw:totalChargesFromReport,matchedSubsTotal:matchedTotal,deduped:totalChargesFromReport,note:matchedTotal>0?`${fmt(matchedTotal)}â‚¬ d'abos dÃ©jÃ  comptÃ©s dans Revolut`:""};
}
const KB_CATS={playbook:{label:"ðŸ“˜ Playbooks",color:C.b},template:{label:"ðŸ“„ Templates",color:C.g},contact:{label:"ðŸ‘¤ Contacts",color:C.o},tool:{label:"ðŸ”§ Outils",color:C.v},tip:{label:"ðŸ’¡ Tips",color:C.acc}};
const DEMO_KB=[
 {id:"kb1",title:"Playbook Cold Outreach B2B",cat:"playbook",author:"leadx",content:"1. Identifier ICP via LinkedIn Sales Nav\n2. Scraper avec Phantombuster\n3. SÃ©quence 3 emails (J0, J3, J7)\n4. Follow-up LinkedIn J10\n5. Call si ouverture > 40%",tags:["prospection","b2b","email"],date:"2026-01-05",likes:3},
 {id:"kb2",title:"Template Proposition Commerciale",cat:"template",author:"copy",content:"Structure gagnante :\nâ€¢ Contexte client (montrer qu'on a compris)\nâ€¢ ProblÃ¨me identifiÃ©\nâ€¢ Solution proposÃ©e (3 options)\nâ€¢ Pricing avec ancrage\nâ€¢ Garantie + urgence\nâ€¢ CTA clair",tags:["vente","pricing","template"],date:"2026-01-12",likes:5},
 {id:"kb3",title:"Contact Imprimeur fiable",cat:"contact",author:"bbp",content:"Jean-Marc Dubois â€” Imprim'Express\njm@imprimexpress.re â€” 0692 XX XX XX\nTarifs compÃ©titifs, dÃ©lais 48h, livraison gratuite > 200â‚¬",tags:["print","fournisseur"],date:"2026-01-20",likes:2},
 {id:"kb4",title:"Stack Outils recommandÃ©e",cat:"tool",author:"eco",content:"â€¢ CRM: GoHighLevel (dÃ©jÃ  intÃ©grÃ©)\nâ€¢ Compta: Pennylane\nâ€¢ Design: Figma + Canva Pro\nâ€¢ VidÃ©o: CapCut Pro + DaVinci\nâ€¢ Emailing: Brevo\nâ€¢ Analytics: Plausible\nâ€¢ Paiement: Stripe + Revolut Business",tags:["outils","stack","setup"],date:"2025-12-15",likes:7},
 {id:"kb5",title:"MÃ©thode pricing \"Value-Based\"",cat:"tip",author:"copy",content:"Ne jamais pricer au temps passÃ©. Toujours pricer Ã  la valeur crÃ©Ã©e.\n\nFormule : Prix = 10% de la valeur annuelle que tu gÃ©nÃ¨res pour le client.\n\nExemple : tu gÃ¨res 50Kâ‚¬/an de pub â†’ facture 5Kâ‚¬/mois minimum.",tags:["pricing","mindset"],date:"2026-02-01",likes:4},
 {id:"kb6",title:"Script Appel DÃ©couverte",cat:"playbook",author:"leadx",content:"Intro (2min) : Contexte, pourquoi cet appel\nDouleur (5min) : Quel est le plus gros frein Ã  ta croissance ?\nImpact (3min) : Combien Ã§a te coÃ»te de ne rien faire ?\nSolution (5min) : Voici comment on rÃ©sout Ã§a\nClose (2min) : On dÃ©marre quand ?",tags:["vente","appel","closing"],date:"2026-02-08",likes:6},
];
const GHL_STAGES_COLORS=["#60a5fa","#c8a44e","#fb923c","#34d399","#a78bfa","#f43f5e","#14b8a6","#eab308"];
const GHL_BASE="/api/ghl";
function mkGHLDemo(){ return {}; }
async function fetchGHL(action,locationId,params={}){
 try{
  const r=await fetch(GHL_BASE,{
   method:"POST",
   headers:{"Content-Type":"application/json"},
   body:JSON.stringify({action,locationId,...params})
  });
  if(!r.ok)throw new Error(`GHL proxy ${r.status}`);return await r.json();
 }catch(e){console.warn("GHL fetch failed:",e.message);return null;}
}
async function syncGHLForSoc(soc){
 if(!soc.ghlLocationId)return null;
 const loc=soc.ghlLocationId;
 const pipData=await fetchGHL("pipelines",loc);
 if(!pipData||!pipData.pipelines)return null;
 const pip=pipData.pipelines[0];if(!pip)return null;
 const oppData=await fetchGHL("opportunities",loc,{pipeline_id:pip.id});
 const opps=(oppData?.opportunities||[]).map(o=>({
  id:o.id,name:o.contact?.name||o.name||"Sans nom",stage:o.pipelineStageId,
  value:o.monetaryValue||0,email:o.contact?.email||"",phone:o.contact?.phone||"",
  createdAt:o.createdAt,updatedAt:o.updatedAt,status:o.status||"open",source:o.source||"Inconnu"
 }));
 const stages=pip.stages?.map(s2=>s2.name)||[];
 const stageMap={};pip.stages?.forEach(s2=>{stageMap[s2.id]=s2.name;});
 const mappedOpps=opps.map(o=>({...o,stage:stageMap[o.stage]||o.stage}));
 const won=mappedOpps.filter(o=>o.status==="won");const open2=mappedOpps.filter(o=>o.status==="open");
 // Fetch contacts list
 const ctData=await fetchGHL("contacts_list",loc);
 const rawContacts=(ctData?.contacts||[]);
 // Build a map of contactIdâ†’opp status from opportunities
 const contactOppStatus={};
 (oppData?.opportunities||[]).forEach(o=>{
  const cid=o.contact?.id;if(!cid)return;
  if(o.status==="won")contactOppStatus[cid]="active";
  else if(o.status==="lost"&&!contactOppStatus[cid])contactOppStatus[cid]="churned";
  else if(!contactOppStatus[cid])contactOppStatus[cid]="prospect";
 });
 const ghlClients=rawContacts.map(c=>({
  id:`ghl_${c.id}`,socId:soc.id,name:c.contactName||[c.firstName,c.lastName].filter(Boolean).join(" ")||"Sans nom",
  contact:c.contactName||[c.firstName,c.lastName].filter(Boolean).join(" ")||"",
  email:c.email||"",phone:c.phone||"",
  billing:{type:"fixed",amount:0,freq:"monthly",commitment:0,startDate:c.dateAdded?.slice(0,10)||""},
  status:contactOppStatus[c.id]||"prospect",
  notes:(c.tags||[]).join(", "),ghlId:c.id,stripeId:"",at:c.dateAdded||new Date().toISOString()
 }));
 return{
  pipelines:[{id:pip.id,name:pip.name,stages}],opportunities:mappedOpps,ghlClients,
  stats:{totalLeads:mappedOpps.length,openDeals:open2.length,wonDeals:won.length,
   lostDeals:mappedOpps.filter(o=>o.status==="lost").length,pipelineValue:open2.reduce((a,o)=>a+o.value,0),
   wonValue:won.reduce((a,o)=>a+o.value,0),conversionRate:mappedOpps.length>0?Math.round(won.length/mappedOpps.length*100):0,
   avgDealSize:mappedOpps.length>0?Math.round(mappedOpps.reduce((a,o)=>a+o.value,0)/mappedOpps.length):0,
   sourceBreakdown:[]},lastSync:new Date().toISOString(),isDemo:false
 };
}
const SLACK_MODES={
 webhook:{l:"Webhook",desc:"Incoming Webhook URL â€” simple, pas besoin d'app",icon:"ðŸ”—"},
 bot:{l:"Bot Token",desc:"Bot OAuth Token (xoxb-â€¦) â€” plus de contrÃ´le, peut tagger",icon:"ðŸ¤–"},
 bob:{l:"Bob (Agent IA)",desc:"Via votre app Bob existante â€” webhook custom",icon:"ðŸ§ "},
};
async function slackWebhookSend(webhookUrl,message){
 if(!webhookUrl)return{ok:false,error:"no_webhook"};
 try{
  const r=await fetch(webhookUrl,{
   method:"POST",
   headers:{"Content-Type":"application/json"},
   body:JSON.stringify(message),
  });
  return{ok:r.ok,status:r.status};
 }catch(e){console.warn("Slack webhook failed:",e.message);return{ok:false,error:e.message};}
}
async function slackBotSend(botToken,channel,message){
 if(!botToken||!channel)return{ok:false,error:"no_bot_config"};
 try{
  const r=await fetch("https://slack.com/api/chat.postMessage",{
   method:"POST",
   headers:{"Authorization":`Bearer ${botToken}`,"Content-Type":"application/json"},
   body:JSON.stringify({channel,...message}),
  });
  const data=await r.json();
  return{ok:data.ok,error:data.error||null,ts:data.ts};
 }catch(e){console.warn("Slack bot failed:",e.message);return{ok:false,error:e.message};}
}
async function slackSend(slackConfig,message){
 if(!slackConfig)return{ok:false,error:"no_config"};
 const mode=slackConfig.mode||"webhook";
 if(mode==="bot"){
  return slackBotSend(slackConfig.botToken,slackConfig.channel,message);
 }
 const url=mode==="bob"?slackConfig.bobWebhook:slackConfig.webhookUrl;
 return slackWebhookSend(url,message);
}
function slackMention(soc){
 if(soc.slackId)return`<@${soc.slackId}>`;
 return`*${soc.porteur}*`;
}
function buildPulseSlackMsg(soc,pulse){
 const moodEmojis=["ðŸ˜«","ðŸ˜Ÿ","ðŸ˜","ðŸ™‚","ðŸ”¥"];
 const confColors=["#e74c3c","#f39c12","#95a5a6","#3498db","#2ecc71"];
 return{
  text:`âš¡ Pulse hebdo â€” ${soc.nom}`,
  blocks:[
   {type:"header",text:{type:"plain_text",text:`âš¡ Pulse hebdo â€” ${soc.nom}`,emoji:true}},
   {type:"section",text:{type:"mrkdwn",text:`${slackMention(soc)} a envoyÃ© son pulse`}},
   {type:"section",fields:[
    {type:"mrkdwn",text:`*Mood:* ${moodEmojis[pulse.mood]} (${pulse.mood+1}/5)`},
    {type:"mrkdwn",text:`*Confiance:* ${pulse.conf}/5`},
   ]},
   {type:"section",text:{type:"mrkdwn",text:`*ðŸ† Victoire:* ${pulse.win}`}},
   ...(pulse.blocker?[{type:"section",text:{type:"mrkdwn",text:`*ðŸš§ Blocage:* ${pulse.blocker}`}}]:[]),
   {type:"context",elements:[{type:"mrkdwn",text:`ðŸ“… ${new Date().toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long"})} Â· ${soc.act}`}]},
  ],
 };
}
function buildReportSlackMsg(soc,report,mo){
 const ca=pf(report.ca),ch=pf(report.charges),marge=ca-ch;
 const margePct=ca>0?Math.round(marge/ca*100):0;
 return{
  text:`ðŸ“Š Rapport ${ml(mo)} â€” ${soc.nom}`,
  blocks:[
   {type:"header",text:{type:"plain_text",text:`ðŸ“Š Rapport mensuel â€” ${soc.nom}`,emoji:true}},
   {type:"section",text:{type:"mrkdwn",text:`${slackMention(soc)} a soumis son rapport pour *${ml(mo)}*`}},
   {type:"section",fields:[
    {type:"mrkdwn",text:`*ðŸ’° CA:* ${fmt(ca)}â‚¬`},
    {type:"mrkdwn",text:`*ðŸ“‰ Charges:* ${fmt(ch)}â‚¬${pf(report.dividendesHolding)>0?` (+ ðŸ›ï¸ ${fmt(report.dividendesHolding)}â‚¬ dividendes)`:""}`},
    {type:"mrkdwn",text:`*ðŸ“Š Marge:* ${fmt(marge)}â‚¬ (${margePct}%)`},
    ...(pf(report.pipeline)>0?[{type:"mrkdwn",text:`*ðŸ”® Pipeline:* ${fmt(report.pipeline)}â‚¬`}]:[]),
    ...(pf(report.tresoSoc)>0?[{type:"mrkdwn",text:`*ðŸ¦ TrÃ©so:* ${fmt(report.tresoSoc)}â‚¬`}]:[]),
    ...(pf(report.mrr)>0?[{type:"mrkdwn",text:`*ðŸ”„ MRR:* ${fmt(report.mrr)}â‚¬`}]:[]),
   ]},
   ...(pf(report.leads)>0?[{type:"section",text:{type:"mrkdwn",text:`*Funnel:* ${report.leads} leads â†’ ${report.leadsContact} contactÃ©s â†’ ${report.leadsClos} closÃ©s`}}]:[]),
   ...(report.notes?[{type:"section",text:{type:"mrkdwn",text:`*ðŸ“ Notes:* ${report.notes}`}}]:[]),
   {type:"context",elements:[{type:"mrkdwn",text:`RemontÃ©e thÃ©orique: *${fmt((soc.pT==="ca"?ca:Math.max(0,marge))*soc.pP/100)}â‚¬* (${soc.pP}% ${soc.pT==="ca"?"du CA":"des bÃ©nÃ©fices"})${pf(report.dividendesHolding)>0?` Â· DÃ©jÃ  virÃ©: ${fmt(pf(report.dividendesHolding))}â‚¬ Â· Reste: ${fmt(Math.max(0,(soc.pT==="ca"?ca:Math.max(0,marge))*soc.pP/100-pf(report.dividendesHolding)))}â‚¬`:""}`}]},
  ],
 };
}
function buildReminderSlackMsg(soc,type,deadlineStr){
 const isReport=type==="report";
 return{
  text:`${isReport?"ðŸ“‹":"âš¡"} Rappel ${isReport?"rapport":"pulse"} â€” ${soc.nom}`,
  blocks:[
   {type:"section",text:{type:"mrkdwn",text:
    isReport
    ?`Hey ${slackMention(soc)} ðŸ‘‹ Ton rapport mensuel pour *${ml(curM())}* est attendu avant le *${deadlineStr}*. N'oublie pas de le soumettre sur la plateforme !`
    :`Hey ${slackMention(soc)} ðŸ‘‹ Ton pulse hebdo n'est pas encore envoyÃ©. Un petit check de 30 secondes pour dire comment Ã§a va cette semaine ?`}},
   {type:"context",elements:[{type:"mrkdwn",text:`ðŸ¤– Bob â€” Rappel automatique Scale Corp`}]},
  ],
 };
}
function buildValidationSlackMsg(soc,comment,mo){
 return{
  text:`âœ… Rapport validÃ© â€” ${soc.nom}`,
  blocks:[
   {type:"section",text:{type:"mrkdwn",text:`${slackMention(soc)} âœ… Ton rapport *${ml(mo)}* a Ã©tÃ© validÃ© par Scale Corp !${comment?`\nðŸ’¬ _"${comment}"_`:""}`}},
  ],
 };
}
async function checkAndSendReminders(socs2,reps2,pulses2,slackConfig){
 if(!slackConfig||!slackConfig.enabled)return[];
 const results=[];const now=new Date();const cM2=curM();const w=curW();
 const dayOfMonth=now.getDate();const dayOfWeek=now.getDay();
 for(const s of socs2.filter(x=>["active","lancement"].includes(x.stat)&&x.id!=="eco")){
  if(dayOfMonth<=3){
   const rep=gr(reps2,s.id,cM2);
   if(!rep||!rep.at){
    const r=await slackSend(slackConfig,buildReminderSlackMsg(s,"report",deadline(cM2)));
    results.push({soc:s.nom,type:"report_reminder",ok:r.ok});
   }
  }
  if(dayOfWeek===5){
   const p=pulses2[`${s.id}_${w}`];
   if(!p){
    const r=await slackSend(slackConfig,buildReminderSlackMsg(s,"pulse",""));
    results.push({soc:s.nom,type:"pulse_reminder",ok:r.ok});
   }
  }
 }
 return results;
}
const REV_ENVS={sandbox:"https://sandbox-b2b.revolut.com/api/1.0",production:"https://b2b.revolut.com/api/1.0"};
const CURR_SYMBOLS={EUR:"â‚¬",USD:"$",GBP:"Â£",CHF:"CHF",SEK:"kr",NOK:"kr",DKK:"kr",PLN:"zÅ‚",CZK:"KÄ",HUF:"Ft",RON:"lei",BGN:"Ð»Ð²",HRK:"kn",AED:"AED",CAD:"CA$",AUD:"A$",JPY:"Â¥"};
function mkRevolutDemo(){ return null; }
async function fetchRevolut(company,endpoint){
 try{
  const action=endpoint.includes("/transactions")?"transactions":"accounts";
  const r=await fetch("/api/revolut",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action,company})});
  if(!r.ok)throw new Error(`Revolut proxy ${r.status}`);return await r.json();
 }catch(e){console.warn("Revolut fetch failed:",e.message);return null;}
}
async function syncRevolut(company){
 if(!company)return null;
 const accounts=await fetchRevolut(company,"/accounts");
 if(!accounts)return null;
 const txns=await fetchRevolut(company,"/transactions?count=25");
 const accs=(Array.isArray(accounts)?accounts:[]).map(a=>({
  id:a.id,name:a.name||"Compte",balance:a.balance,currency:a.currency,state:a.state,updated_at:a.updated_at
 }));
 const totalEUR=accs.reduce((s,a)=>s+(a.currency==="EUR"?a.balance:a.balance*0.92),0);
 return{accounts:accs,transactions:Array.isArray(txns)?txns:[],totalEUR,lastSync:new Date().toISOString(),isDemo:false};
}
function mkSocRevDemo(){ return null; }
// Accounts to exclude from treasury per company (personal pockets, dividend transit, etc.)
const EXCLUDED_ACCOUNTS={
 leadx:["5c008ba9-b9a7-4141-97dc-6a53ef3d6646","5fce1497-811e-4266-9889-2da74aa27733"], // Dayyaan + SCALE CORP
 copy:["a1edf694-6f10-4b88-bfc1-7f2447f0fd8d","a86df684-33a0-413b-b56b-1e4fc2b13886"], // Sol + Anthony & Rudy (soc.id="copy" for BCS)
 eco:["a418f8cb-7001-40e8-acd3-e52f092294d4","39786a9f-7dd8-46e3-aba8-d8acca9e4bd7","fa4578d8-5d7f-4b9c-b2eb-afa01061d28e","88fb482e-26b3-494e-9234-5cded1b76799","d45a5ba7-cefa-4e21-85f9-cdafa6c60648","12440858-679f-4781-8db1-eb0ebbb986b3","f893a7c1-64b4-4247-9625-9f640d768b96","9f8f33c4-112f-44ad-81ea-a8acbca1efb7"], // Anthony, Dettes, Loyer, A-Loyer, Courses, Rudy, A-Courses, A-Loisirs
};
async function syncSocRevolut(soc){
 if(!soc.revolutCompany)return null;
 const accounts=await fetchRevolut(soc.revolutCompany,"/accounts");
 if(!accounts)return null;
 const now=new Date();const cm=curM();const pm=prevM(cm);
 const from1=new Date(now.getFullYear(),now.getMonth()-1,1).toISOString();
 const txnsRaw=await fetchRevolut(soc.revolutCompany,`/transactions?from=${from1}&count=500`);
 const txns=(Array.isArray(txnsRaw)?txnsRaw:[]).map(t=>{
  const dt=new Date(t.created_at);
  return{...t,month:`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}`};
 });
 const excluded=EXCLUDED_ACCOUNTS[soc.id]||[];
 const accs=(Array.isArray(accounts)?accounts:[]).map(a=>({id:a.id,name:a.name||"Compte",balance:a.balance,currency:a.currency,state:a.state,excluded:excluded.includes(a.id)}));
 const balance=accs.filter(a=>!a.excluded).reduce((s,a)=>s+(a.currency==="EUR"?a.balance:a.balance*0.92),0);
 const monthly={};
 txns.forEach(tx=>{const m=tx.month;const leg=tx.legs?.[0];if(!leg)return;if(excluded.includes(leg.account_id))return;const amt=leg.amount;if(!monthly[m])monthly[m]={income:0,expense:0};if(amt>0)monthly[m].income+=amt;else monthly[m].expense+=Math.abs(amt);});
 Object.keys(monthly).forEach(m=>{monthly[m].income=Math.round(monthly[m].income);monthly[m].expense=Math.round(monthly[m].expense);});
 return{accounts:accs,transactions:txns.sort((a,b)=>new Date(b.created_at)-new Date(a.created_at)),balance:Math.round(balance),monthly,lastSync:new Date().toISOString(),isDemo:false};
}
function revFinancials(socBankData,month){
 if(!socBankData||!socBankData.monthly)return null;
 const m=socBankData.monthly[month];
 if(!m)return null;
 return{ca:m.income,charges:m.expense,tresoSoc:socBankData.balance,net:m.income-m.expense};
}
async function sGet(k){try{const r=await window.storage.get(k);return r?JSON.parse(r.value):null;}catch{return null;}}
async function sSet(k,v){try{await window.storage.set(k,JSON.stringify(v));}catch{}}
function calcH(socs,reps,hold,month){
 let rem=0,cn=0;socs.forEach(s=>{if(s.id==="eco")return;if(["active","lancement"].includes(s.stat))cn++;const r=gr(reps,s.id,month);if(!r)return;const ca=pf(r.ca),ch=pf(r.charges);rem+=(s.pT==="ca"?ca:Math.max(0,ca-ch))*s.pP/100;});
 const crm=cn*hold.crm,eR=gr(reps,"eco",month),eCa=eR?pf(eR.ca):0,tCh=hold.logiciels+hold.equipe+hold.service+hold.cabinet,eNet=eCa-tCh;
 const tIn=Math.max(0,eNet)+rem+crm,after=tIn-hold.remun,res=Math.max(0,after*hold.reservePct/100),dispo=Math.max(0,after-res);
 return{rem,crm,eNet,eCa,tCh,tIn,res,dispo,pf:hold.remun/2+dispo/2};
}
function simH(socs,simCA,hold){
 let rem=0,cn=0;socs.forEach(s=>{if(s.id==="eco")return;if(["active","lancement"].includes(s.stat))cn++;const ca=simCA[s.id]||0;const ch=ca*0.25;rem+=(s.pT==="ca"?ca:Math.max(0,ca-ch))*s.pP/100;});
 const crm=cn*hold.crm,eCa=simCA.eco||0,tCh=hold.logiciels+hold.equipe+hold.service+hold.cabinet,eNet=eCa-tCh;
 const tIn=Math.max(0,eNet)+rem+crm,after=tIn-hold.remun,res=Math.max(0,after*hold.reservePct/100),dispo=Math.max(0,after-res);
 return{rem,crm,eNet,eCa,tCh,tIn,res,dispo,pf:hold.remun/2+dispo/2};
}
function healthScore(s,reps){
 const c=curM(),p=prevM(c),r=gr(reps,s.id,c),rp=gr(reps,s.id,p);
 if(!r)return{grade:"â€”",color:C.tm,score:0,obj:0,growth:0,margin:0,retention:0};
 let pts=0;const ca=pf(r.ca),ch=pf(r.charges),marge=ca-ch;
 let objS=15,growS=12,margS=0,retS=0;
 if(s.obj>0){const op=pct(ca,s.obj);objS=op>=100?30:op>=80?20:op>=60?10:0;}pts+=objS;
 if(rp){const pca=pf(rp.ca);if(pca>0){const t=pct(ca-pca,pca);growS=t>=10?25:t>=0?15:t>=-10?8:0;}}pts+=growS;
 if(ca>0){const mp=pct(marge,ca);margS=mp>=30?25:mp>=15?18:mp>=0?10:0;}pts+=margS;
 const churnV=parseInt(r.churn||"0");retS=churnV===0?20:churnV===1?12:churnV<=2?5:0;pts+=retS;
 const grade=pts>=80?"A":pts>=60?"B":pts>=40?"C":"D";
 return{grade,color:{A:C.g,B:C.b,C:C.o,D:C.r}[grade],score:pts,obj:objS,growth:growS,margin:margS,retention:retS};
}
function qCA(reps,sid,month){return qMonths(month).reduce((a,m)=>a+pf(gr(reps,sid,m)?.ca),0);}
function getAlerts(socs,reps,hold){
 const a=[],c=curM(),p=prevM(c);
 socs.filter(s=>s.stat==="active").forEach(s=>{const r=gr(reps,s.id,c),rp=gr(reps,s.id,p);
  if(!r){a.push({t:"danger",m:`${s.nom} â€” rapport manquant`});return;}
  if(!r.ok)a.push({t:"info",m:`${s.nom} â€” en attente de validation`});
  const ca=pf(r.ca);if(s.obj>0&&ca<s.obj*.7)a.push({t:"danger",m:`${s.nom} â€” CA < 70% objectif`});
  if(rp){const cp=pf(rp.ca);if(cp>0&&ca<cp*.8)a.push({t:"danger",m:`${s.nom} â€” CA baisse ${pct(cp-ca,cp)}%`});}
  if(s.rec&&parseInt(r.churn||"0")>=2)a.push({t:"warn",m:`${s.nom} â€” ${r.churn} clients perdus`});
  const ts=pf(r.tresoSoc);if(ts>0&&ts<2000)a.push({t:"warn",m:`${s.nom} â€” trÃ©so basse`});});
 return a.sort((x,y)=>({danger:0,warn:1,info:2}[x.t]-{danger:0,warn:1,info:2}[y.t]));
}
function buildFeed(socs,reps,actions,pulses){
 const items=[],c=curM(),p=prevM(c);
 [c,p].forEach(m=>{socs.forEach(s=>{const r=gr(reps,s.id,m);if(!r||!r.at)return;items.push({color:s.color,date:r.at,m:r.ok?`âœ“ ${s.nom} validÃ© (${ml(m)})`:`${s.porteur} a soumis ${s.nom}`});});});
 actions.filter(a=>a.at).forEach(a=>{const s=socs.find(x=>x.id===a.socId);items.push({color:s?.color||C.td,date:a.at,m:a.done?`âœ“ Action: ${a.text}`:`â†’ Action: ${a.text}`});});
 Object.entries(pulses).forEach(([k,p2])=>{const sid=k.split("_")[0];const s=socs.find(x=>x.id===sid);if(s)items.push({color:s.color,date:p2.at,m:`${MOODS[p2.mood]} Pulse ${s.porteur}: "${p2.win}"`});});
 return items.sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,20);
}
function project(reps,sid,allM){const data=allM.map(m=>pf(gr(reps,sid,m)?.ca)).filter(v=>v>0);if(data.length<2)return null;const l3=data.slice(-3);const avg=l3.reduce((a,v)=>a+v,0)/l3.length;const t=data.length>=2?(data[data.length-1]-data[data.length-2])/Math.max(1,data[data.length-2]):0;return[1,2,3].map(i=>Math.max(0,Math.round(avg*(1+t*i*.5))));}
function runway(reps,sid,allM){const data=allM.map(m=>{const r=gr(reps,sid,m);return r?{ch:pf(r.charges),ts:pf(r.tresoSoc)}:null;}).filter(Boolean);if(data.length<1)return null;const last=data[data.length-1];if(!last.ts||last.ts<=0)return null;const avgCh=data.reduce((a,d)=>a+d.ch,0)/data.length;if(avgCh<=0)return{months:99,treso:last.ts};return{months:Math.round(last.ts/avgCh),treso:last.ts};}
function calcLeaderboard(socs,reps,actions,pulses,allM){
 return socs.filter(s=>s.stat==="active"&&s.id!=="eco").map(s=>{
  let score=0;const hs=healthScore(s,reps);score+=hs.score;
  const reportsCount=allM.filter(m=>gr(reps,s.id,m)).length;score+=reportsCount*5;
  const doneActs=actions.filter(a=>a.socId===s.id&&a.done).length;score+=doneActs*10;
  const pulseCount=Object.keys(pulses).filter(k=>k.startsWith(s.id+"_")).length;score+=pulseCount*8;
  const streak=pulseCount;
  return{soc:s,score,hs,reportsCount,doneActs,pulseCount,streak};
 }).sort((a,b)=>b.score-a.score);
}
function buildAIContext(socs,reps,hold,actions,pulses,allM,revData,socBank,okrs,synergies,clients2){
 const cM2=curM();const hc=calcH(socs,reps,hold,cM2);
 const brandName=hold?.brand?.name||"Scale Corp";
 let ctx=`Tu es le co-pilote IA de ${brandName}, un incubateur/holding qui gÃ¨re ${socs.length} sociÃ©tÃ©s. RÃ©ponds en franÃ§ais, sois concis et actionnable.\n\nDonnÃ©es actuelles (${ml(cM2)}):\n`;
 ctx+=`Holding: Flux entrant=${fmt(hc.tIn)}â‚¬, Disponible=${fmt(hc.dispo)}â‚¬, Par fondateur=${fmt(hc.pf)}â‚¬, TrÃ©so dÃ©clarÃ©e=${fmt(hold.treso)}â‚¬\n`;
 if(revData&&revData.accounts){ctx+=`Banque Revolut Holding: Solde total=${fmt(revData.totalEUR)}â‚¬\n`;revData.accounts.forEach(a=>{ctx+=`  ${a.name}: ${fmt(a.balance)} ${a.currency}\n`;});}
 ctx+="\n";
 socs.filter(s=>s.stat==="active").forEach(s=>{
  const r=gr(reps,s.id,cM2),rp=gr(reps,s.id,prevM(cM2));
  const hs=healthScore(s,reps);const rw=runway(reps,s.id,allM);
  ctx+=`${s.nom} (${s.porteur}, ${s.act}${s.incub?`, incubÃ© depuis ${sinceLbl(s.incub)}`:""}) â€” Grade ${hs.grade} (${hs.score}/100)\n`;
  if(r)ctx+=`  CA: ${fmt(r.ca)}â‚¬, Charges: ${fmt(r.charges)}â‚¬, Marge: ${fmt(pf(r.ca)-pf(r.charges))}â‚¬ (${pct(pf(r.ca)-pf(r.charges),pf(r.ca))}%)\n  Pipeline: ${fmt(r.pipeline)}â‚¬, TrÃ©so: ${fmt(r.tresoSoc)}â‚¬${s.rec?`, MRR: ${fmt(r.mrr)}â‚¬, Churn: ${r.churn||0}`:""}\n`;
  if(r&&(pf(r.salaire)>0||pf(r.chargesOps)>0))ctx+=`  DÃ©tail: RÃ©mun fondateur=${fmt(r.salaire)}â‚¬, Charges ops=${fmt(r.chargesOps)}â‚¬, Formation=${fmt(r.formation)}â‚¬, Pub=${fmt(r.pub)}â‚¬\n`;
  if(r&&pf(r.leads)>0)ctx+=`  Leads: ${r.leads} gÃ©nÃ©rÃ©s â†’ ${r.leadsContact} contactÃ©s â†’ ${r.leadsClos} closÃ©s (closing ${pct(pf(r.leadsClos),pf(r.leads))}%)\n`;
  const sb=socBank?.[s.id];
  if(sb){const bf=revFinancials(sb,cM2);ctx+=`  Banque Revolut: Solde=${fmt(sb.balance)}â‚¬`;if(bf)ctx+=`, EncaissÃ© ce mois=${fmt(bf.ca)}â‚¬, DÃ©caissÃ©=${fmt(bf.charges)}â‚¬`;ctx+="\n";}
  if(rp)ctx+=`  Mois prÃ©cÃ©dent: CA ${fmt(rp.ca)}â‚¬ (${pf(r?.ca)>=pf(rp.ca)?"â†‘":"â†“"})\n`;
  if(rw)ctx+=`  Runway: ~${rw.months} mois\n`;
  const pw=Object.entries(pulses).filter(([k])=>k.startsWith(s.id+"_")).pop();
  if(pw)ctx+=`  Dernier pulse: ${MOODS[pw[1].mood]} â€” Win: "${pw[1].win}"${pw[1].blocker?` Blocage: "${pw[1].blocker}"`:""}\n`;
  const ms=calcMilestones(s,reps,actions,pulses,allM);const msU=ms.filter(m2=>m2.unlocked);
  if(msU.length>0){const top3=msU.sort((a2,b2)=>b2.tier-a2.tier).slice(0,3);ctx+=`  Milestones: ${msU.length}/${ms.length} â€” ${top3.map(m2=>m2.label).join(", ")}\n`;}
  const sCl=(clients2||[]).filter(c=>c.socId===s.id);
  if(sCl.length>0){const actCl=sCl.filter(c=>c.status==="active");const mrr=actCl.reduce((a2,c)=>a2+clientMonthlyRevenue(c),0);ctx+=`  Clients: ${actCl.length} actifs/${sCl.length} total, MRR clients=${fmt(mrr)}â‚¬\n`;
   const byT={fixed:sCl.filter(c=>c.billing?.type==="fixed"),percent:sCl.filter(c=>c.billing?.type==="percent"),oneoff:sCl.filter(c=>c.billing?.type==="oneoff")};
   if(byT.fixed.length>0)ctx+=`    Forfaits: ${byT.fixed.length} (${byT.fixed.filter(c=>c.status==="active").map(c=>`${c.name}:${fmt(c.billing.amount)}â‚¬/m`).join(", ")})\n`;
   if(byT.percent.length>0)ctx+=`    % deals: ${byT.percent.length} (${byT.percent.filter(c=>c.status==="active").map(c=>`${c.name}:${c.billing.percent}% ${c.billing.basis}`).join(", ")})\n`;
   if(byT.oneoff.length>0)ctx+=`    One-off: ${byT.oneoff.length} Â· Total ${fmt(byT.oneoff.reduce((a2,c)=>a2+(c.billing?.amount||0),0))}â‚¬\n`;
  }
  ctx+="\n";
 });
 const openActs=actions.filter(a=>!a.done);
 if(openActs.length>0){ctx+=`Actions ouvertes:\n`;openActs.forEach(a=>{const s=socs.find(x=>x.id===a.socId);ctx+=`  - ${s?.nom||""}: ${a.text} (deadline: ${ml(a.deadline)}${a.deadline<cM2?" âš  EN RETARD":""})\n`;});}
 if(synergies&&synergies.length>0){ctx+=`\nSynergies inter-sociÃ©tÃ©s (${synergies.length}):\n`;const wonVal=synergies.filter(s=>s.status==="won").reduce((a,s)=>a+pf(s.value),0);ctx+=`  Valeur gagnÃ©e: ${fmt(wonVal)}â‚¬, En cours: ${synergies.filter(s=>s.status==="active").length}\n`;synergies.slice(-5).forEach(sy=>{const sf=socs.find(s=>s.id===sy.from);const st=socs.find(s=>s.id===sy.to);ctx+=`  ${sf?.nom||"?"} â†’ ${st?.nom||"?"}: ${sy.desc} (${sy.status}${pf(sy.value)>0?`, ${fmt(sy.value)}â‚¬`:""})\n`;});}
 const sAlerts=calcSmartAlerts(socs,reps,actions,pulses,allM,{});
 if(sAlerts.length>0){ctx+=`\nâš  Alertes (${sAlerts.length}):\n`;sAlerts.slice(0,8).forEach(a=>{ctx+=`  ${a.icon} ${a.title}: ${a.desc}\n`;});}
 return ctx;
}
/* MILESTONES ENGINE */
const MILESTONE_DEFS=[
 {id:"ca1k",cat:"ca",icon:"ðŸ’°",label:"Premier 1 000â‚¬",desc:"1 000â‚¬ de CA cumulÃ©",tier:1,check:(d)=>d.totalCA>=1000},
 {id:"ca5k",cat:"ca",icon:"ðŸ’°",label:"Cap 5K",desc:"5 000â‚¬ de CA cumulÃ©",tier:2,check:(d)=>d.totalCA>=5000},
 {id:"ca10k",cat:"ca",icon:"ðŸ’°",label:"Cap 10K",desc:"10 000â‚¬ de CA cumulÃ©",tier:3,check:(d)=>d.totalCA>=10000},
 {id:"ca25k",cat:"ca",icon:"ðŸ”¥",label:"Cap 25K",desc:"25 000â‚¬ de CA cumulÃ©",tier:4,check:(d)=>d.totalCA>=25000},
 {id:"ca50k",cat:"ca",icon:"ðŸ”¥",label:"Cap 50K",desc:"50 000â‚¬ de CA cumulÃ©",tier:5,check:(d)=>d.totalCA>=50000},
 {id:"ca100k",cat:"ca",icon:"ðŸ‘‘",label:"Club 100K",desc:"100 000â‚¬ de CA cumulÃ©",tier:6,check:(d)=>d.totalCA>=100000},
 {id:"anc1m",cat:"time",icon:"ðŸŒ±",label:"Premier mois",desc:"1 mois dans l'incubateur",tier:1,check:(d)=>d.incubMonths>=1},
 {id:"anc3m",cat:"time",icon:"ðŸŒ¿",label:"Trimestre",desc:"3 mois d'association",tier:2,check:(d)=>d.incubMonths>=3},
 {id:"anc6m",cat:"time",icon:"ðŸŒ³",label:"Semestre",desc:"6 mois cÃ´te Ã  cÃ´te",tier:3,check:(d)=>d.incubMonths>=6},
 {id:"anc12m",cat:"time",icon:"ðŸ›ï¸",label:"1 an",desc:"Un an d'incubation !",tier:4,check:(d)=>d.incubMonths>=12},
 {id:"anc24m",cat:"time",icon:"â­",label:"VÃ©tÃ©ran",desc:"2 ans d'incubation",tier:5,check:(d)=>d.incubMonths>=24},
 {id:"grow2",cat:"growth",icon:"ðŸ“ˆ",label:"DÃ©collage",desc:"2 mois consÃ©cutifs de croissance",tier:1,check:(d)=>d.growthStreak>=2},
 {id:"grow3",cat:"growth",icon:"ðŸ“ˆ",label:"Tendance",desc:"3 mois consÃ©cutifs de croissance",tier:2,check:(d)=>d.growthStreak>=3},
 {id:"grow5",cat:"growth",icon:"ðŸš€",label:"FusÃ©e",desc:"5 mois consÃ©cutifs de croissance",tier:3,check:(d)=>d.growthStreak>=5},
 {id:"grow10",cat:"growth",icon:"ðŸŒŸ",label:"InarrÃªtable",desc:"10 mois de croissance d'affilÃ©e",tier:5,check:(d)=>d.growthStreak>=10},
 {id:"prof1",cat:"profit",icon:"ðŸ’Ž",label:"Dans le vert",desc:"Premier mois rentable",tier:1,check:(d)=>d.profitableMonths>=1},
 {id:"prof3",cat:"profit",icon:"ðŸ’Ž",label:"StabilitÃ©",desc:"3 mois rentables au total",tier:2,check:(d)=>d.profitableMonths>=3},
 {id:"prof50",cat:"profit",icon:"ðŸ’Ž",label:"Machine Ã  marge",desc:"Un mois Ã  50%+ de marge",tier:3,check:(d)=>d.bestMarginPct>=50},
 {id:"profstr3",cat:"profit",icon:"ðŸ†",label:"SÃ©rie verte",desc:"3 mois rentables d'affilÃ©e",tier:4,check:(d)=>d.profitStreak>=3},
 {id:"rep3",cat:"engage",icon:"ðŸ“Š",label:"RÃ©gulier",desc:"3 rapports soumis",tier:1,check:(d)=>d.reportsCount>=3},
 {id:"rep6",cat:"engage",icon:"ðŸ“Š",label:"Fiable",desc:"6 rapports soumis",tier:2,check:(d)=>d.reportsCount>=6},
 {id:"rep12",cat:"engage",icon:"ðŸ“Š",label:"Exemplaire",desc:"12 rapports soumis â€” 1 an complet",tier:3,check:(d)=>d.reportsCount>=12},
 {id:"pul4",cat:"engage",icon:"âš¡",label:"ConnectÃ©",desc:"4 pulses envoyÃ©s",tier:1,check:(d)=>d.pulseCount>=4},
 {id:"pul12",cat:"engage",icon:"âš¡",label:"Pulse master",desc:"12 pulses envoyÃ©s â€” 3 mois non-stop",tier:3,check:(d)=>d.pulseCount>=12},
 {id:"act5",cat:"engage",icon:"âœ…",label:"ExÃ©cutant",desc:"5 actions complÃ©tÃ©es",tier:2,check:(d)=>d.doneActions>=5},
 {id:"act15",cat:"engage",icon:"âœ…",label:"Machine",desc:"15 actions complÃ©tÃ©es",tier:4,check:(d)=>d.doneActions>=15},
 {id:"gradeA",cat:"grade",icon:"â­",label:"Grade A",desc:"Atteindre le grade A",tier:3,check:(d)=>d.bestGrade==="A"},
 {id:"gradeA3",cat:"grade",icon:"ðŸŒŸ",label:"A constant",desc:"3 mois en grade A consÃ©cutifs",tier:5,check:(d)=>d.gradeAStreak>=3},
 {id:"pip10k",cat:"pipeline",icon:"ðŸŽ¯",label:"Pipeline 10K",desc:"Atteindre 10Kâ‚¬ de pipeline",tier:2,check:(d)=>d.bestPipeline>=10000},
 {id:"pip25k",cat:"pipeline",icon:"ðŸŽ¯",label:"Pipeline 25K",desc:"Pipeline Ã  25Kâ‚¬",tier:3,check:(d)=>d.bestPipeline>=25000},
 {id:"pip50k",cat:"pipeline",icon:"ðŸŽ¯",label:"Pipeline 50K",desc:"Pipeline Ã  50Kâ‚¬ â€” gros joueur",tier:4,check:(d)=>d.bestPipeline>=50000},
 {id:"tres5k",cat:"tresor",icon:"ðŸ¦",label:"Coussin 5K",desc:"5 000â‚¬ de trÃ©sorerie",tier:2,check:(d)=>d.bestTreso>=5000},
 {id:"tres10k",cat:"tresor",icon:"ðŸ¦",label:"Coussin 10K",desc:"10 000â‚¬ en rÃ©serve",tier:3,check:(d)=>d.bestTreso>=10000},
 {id:"tres25k",cat:"tresor",icon:"ðŸ¦",label:"Coffre-fort",desc:"25 000â‚¬ de trÃ©sorerie",tier:4,check:(d)=>d.bestTreso>=25000},
 {id:"best5k",cat:"record",icon:"ðŸ…",label:"Best month 5K",desc:"Un mois Ã  5 000â‚¬+ de CA",tier:2,check:(d)=>d.bestCA>=5000},
 {id:"best10k",cat:"record",icon:"ðŸ…",label:"Best month 10K",desc:"Un mois Ã  10 000â‚¬+ de CA",tier:3,check:(d)=>d.bestCA>=10000},
 {id:"best25k",cat:"record",icon:"ðŸ¥‡",label:"Best month 25K",desc:"Un mois Ã  25 000â‚¬+ de CA",tier:5,check:(d)=>d.bestCA>=25000},
 {id:"double",cat:"record",icon:"âš¡",label:"DoublÃ©",desc:"Doubler le CA d'un mois sur l'autre",tier:3,check:(d)=>d.hasDoubled},
];
const MILESTONE_CATS={ca:"ðŸ† Chiffre d'affaires",time:"ðŸ“… AnciennetÃ©",growth:"ðŸ“ˆ Croissance",profit:"ðŸ’Ž RentabilitÃ©",engage:"ðŸ“Š Engagement",grade:"â­ Excellence",pipeline:"ðŸŽ¯ Pipeline",tresor:"ðŸ¦ TrÃ©sorerie",record:"ðŸ… Records"};
const TIER_COLORS={1:C.td,2:C.b,3:C.g,4:C.acc,5:"#c084fc",6:"#fbbf24"};
const TIER_BG={1:C.card2,2:C.bD,3:C.gD,4:C.accD,5:"rgba(192,132,252,.1)",6:"rgba(251,191,36,.12)"};
function calcMilestoneData(soc,reps,actions,pulses,allM){
 const months=allM.map(m=>{const r=gr(reps,soc.id,m);if(!r)return null;return{m,ca:pf(r.ca),ch:pf(r.charges),mrr:pf(r.mrr),pipeline:pf(r.pipeline),treso:pf(r.tresoSoc)};}).filter(Boolean);
 const totalCA=months.reduce((a,d)=>a+d.ca,0);
 const bestCA=months.reduce((a,d)=>Math.max(a,d.ca),0);
 const bestPipeline=months.reduce((a,d)=>Math.max(a,d.pipeline),0);
 const bestTreso=months.reduce((a,d)=>Math.max(a,d.treso),0);
 const incubMonths=sinceMonths(soc.incub);
 let growthStreak=0,maxGrowth=0;
 for(let i=1;i<months.length;i++){if(months[i].ca>months[i-1].ca){growthStreak++;maxGrowth=Math.max(maxGrowth,growthStreak);}else growthStreak=0;}
 maxGrowth=Math.max(maxGrowth,growthStreak);
 const profMonths=months.filter(d=>d.ca-d.ch>0);
 const profitableMonths=profMonths.length;
 const bestMarginPct=months.reduce((a,d)=>d.ca>0?Math.max(a,Math.round((d.ca-d.ch)/d.ca*100)):a,0);
 let profitStreak=0,maxProfStreak=0;
 for(const d of months){if(d.ca-d.ch>0){profitStreak++;maxProfStreak=Math.max(maxProfStreak,profitStreak);}else profitStreak=0;}
 const reportsCount=months.length;
 const pulseCount=Object.keys(pulses).filter(k=>k.startsWith(soc.id+"_")).length;
 const doneActions=actions.filter(a=>a.socId===soc.id&&a.done).length;
 const hs=healthScore(soc,reps);
 const bestGrade=hs.grade;
 let gradeAStreak=0;
 for(let i=allM.length-1;i>=0;i--){const tmpReps={...reps};const r=gr(reps,soc.id,allM[i]);if(!r)break;const g=healthScore(soc,reps).grade;if(g==="A")gradeAStreak++;else break;}
 let hasDoubled=false;
 for(let i=1;i<months.length;i++){if(months[i-1].ca>0&&months[i].ca>=months[i-1].ca*2){hasDoubled=true;break;}}
 return{totalCA,bestCA,bestPipeline,bestTreso,incubMonths,growthStreak:maxGrowth,profitableMonths,bestMarginPct,profitStreak:maxProfStreak,reportsCount,pulseCount,doneActions,bestGrade,gradeAStreak,hasDoubled};
}
function calcMilestones(soc,reps,actions,pulses,allM){
 const data=calcMilestoneData(soc,reps,actions,pulses,allM);
 return MILESTONE_DEFS.map(m=>({...m,unlocked:m.check(data)}));
}
/* UI COMPONENTS */
function Badge({s}){const m={active:[C.gD,C.g,"Active"],lancement:[C.oD,C.o,"Lancement"],signature:[C.bD,C.b,"Signature"],inactive:[C.rD,C.r,"Inactive"]};const[bg2,c2,l]=m[s]||m.inactive;return <span style={{background:bg2,color:c2,padding:"2px 8px",borderRadius:20,fontSize:9,fontWeight:700,letterSpacing:.5}}>{l}</span>;}
function IncubBadge({incub}){if(!incub)return null;const lbl=sinceLbl(incub);return <span style={{background:C.vD,color:C.v,padding:"2px 7px",borderRadius:20,fontSize:9,fontWeight:600}}>ðŸ“… {lbl}</span>;}
function GradeBadge({grade,color,size="sm"}){const s=size==="lg"?{w:32,h:32,fs:16,r:9,bw:2}:{w:22,h:22,fs:11,r:6,bw:1.5};return <span style={{display:"inline-flex",alignItems:"center",justifyContent:"center",width:s.w,height:s.h,borderRadius:s.r,background:color+"15",color,fontWeight:900,fontSize:s.fs,border:`${s.bw}px solid ${color}33`,flexShrink:0}}>{grade}</span>;}
function KPI({label,value,sub,accent,small,delay=0,icon}){
 return <div className={`fu d${delay}`} style={{background:C.card,border:`1px solid ${C.brd}`,borderRadius:12,padding:small?"10px 12px":"14px 16px",flex:"1 1 130px",minWidth:small?90:120,transition:"border-color .2s"}} onMouseEnter={e=>e.currentTarget.style.borderColor=accent||C.brdL} onMouseLeave={e=>e.currentTarget.style.borderColor=C.brd}>
  <div style={{display:"flex",alignItems:"center",gap:4,marginBottom:3}}>{icon&&<span style={{fontSize:10}}>{icon}</span>}<span style={{color:C.td,fontSize:9,fontWeight:700,letterSpacing:.8,textTransform:"uppercase"}}>{label}</span></div>
  <div style={{fontSize:small?14:20,fontWeight:800,color:accent||C.t,lineHeight:1.1}}>{value}</div>
  {sub&&<div style={{color:C.td,fontSize:9,marginTop:2}}>{sub}</div>}
 </div>;
}
function PBar({value,max,color,h=5}){const w=clamp(pct(value,max),0,100);return <div style={{background:C.brd,borderRadius:h,height:h,overflow:"hidden"}}><div className="pg" style={{background:color||C.acc,height:"100%",width:`${w}%`,"--w":`${w}%`,borderRadius:h}}/></div>;}
function Btn({children,onClick,v="primary",small,style:sx,disabled,full}){
 const t={primary:{background:C.acc,color:"#0a0a0f"},secondary:{background:C.card2,color:C.t,border:`1px solid ${C.brd}`},ghost:{background:"transparent",color:C.td},danger:{background:C.rD,color:C.r},success:{background:C.gD,color:C.g},ai:{background:`linear-gradient(135deg,${C.v},${C.acc})`,color:"#0a0a0f"}};
 return <button className="ba" disabled={disabled} onClick={onClick} style={{border:"none",borderRadius:8,fontWeight:600,cursor:disabled?"not-allowed":"pointer",fontFamily:FONT,opacity:disabled?0.35:1,padding:small?"5px 10px":"9px 18px",fontSize:small?10:12,width:full?"100%":"auto",letterSpacing:.3,...t[v],...sx}}>{children}</button>;
}
function Inp({label,value,onChange,type="text",placeholder,suffix,textarea,small,note,onKeyDown}){
 return <div style={{marginBottom:small?6:10}}>
  {label&&<label style={{display:"block",color:C.td,fontSize:10,fontWeight:600,marginBottom:3,letterSpacing:.3}}>{label}</label>}
  <div style={{display:"flex",alignItems:"center",background:C.bg,border:`1px solid ${C.brd}`,borderRadius:8,overflow:"hidden",transition:"border-color .15s"}} onFocus={e=>e.currentTarget.style.borderColor=C.acc+"55"} onBlur={e=>e.currentTarget.style.borderColor=C.brd}>
   {textarea?<textarea value={value||""} onChange={e=>onChange(e.target.value)} placeholder={placeholder} rows={2} style={{flex:1,background:"transparent",border:"none",color:C.t,padding:"7px 10px",fontSize:12,fontFamily:FONT,outline:"none",resize:"vertical"}}/>
    :<input type={type} value={value==null?"":value} onChange={e=>onChange(e.target.value)} onKeyDown={onKeyDown} placeholder={placeholder} style={{flex:1,background:"transparent",border:"none",color:C.t,padding:small?"6px 10px":"8px 10px",fontSize:12,fontFamily:FONT,outline:"none",width:"100%"}}/>}
   {suffix&&<span style={{padding:"0 8px 0 2px",color:C.td,fontSize:11,flexShrink:0}}>{suffix}</span>}
  </div>{note&&<div style={{color:C.tm,fontSize:9,marginTop:2}}>{note}</div>}</div>;
}
function Sel({label,value,onChange,options}){return <div style={{marginBottom:10}}>{label&&<label style={{display:"block",color:C.td,fontSize:10,fontWeight:600,marginBottom:3,letterSpacing:.3}}>{label}</label>}<select value={value} onChange={e=>onChange(e.target.value)} style={{width:"100%",background:C.bg,border:`1px solid ${C.brd}`,borderRadius:8,color:C.t,padding:"8px 10px",fontSize:12,fontFamily:FONT,outline:"none"}}>{options.map(o=><option key={o.v} value={o.v}>{o.l}</option>)}</select></div>;}
function Sect({children,title,sub,right}){return <div className="fu" style={{marginTop:16}}><div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-end",marginBottom:8,flexWrap:"wrap",gap:4}}><div>{title&&<h2 style={{color:C.t,fontSize:13,fontWeight:800,margin:0,letterSpacing:.2}}>{title}</h2>}{sub&&<p style={{color:C.td,fontSize:10,margin:"1px 0 0"}}>{sub}</p>}</div>{right}</div>{children}</div>;}
function Card({children,style:sx,onClick,accent,delay=0}){return <div className={`fu d${Math.min(delay,8)}`} onClick={onClick} style={{background:C.card,border:`1px solid ${C.brd}`,borderRadius:11,padding:14,cursor:onClick?"pointer":"default",transition:"border-color .15s, box-shadow .15s",...(accent?{borderLeft:`3px solid ${accent}`}:{}),...sx}} onMouseEnter={onClick?e=>{e.currentTarget.style.borderColor=C.brdL;e.currentTarget.style.boxShadow="0 2px 12px rgba(0,0,0,.2)";}:undefined} onMouseLeave={onClick?e=>{e.currentTarget.style.borderColor=accent||C.brd;e.currentTarget.style.boxShadow="none";}:undefined}>{children}</div>;}
function Modal({open,onClose,title,children,wide}){if(!open)return null;return <div className="fi" onClick={onClose} style={{position:"fixed",inset:0,background:"rgba(0,0,0,.75)",zIndex:1000,display:"flex",alignItems:"flex-start",justifyContent:"center",padding:"28px 14px",overflowY:"auto",backdropFilter:"blur(6px)"}}><div className="mi" onClick={e=>e.stopPropagation()} style={{background:C.card,border:`1px solid ${C.brd}`,borderRadius:14,padding:20,width:wide?700:440,maxWidth:"100%",boxShadow:"0 16px 50px rgba(0,0,0,.5)"}}><div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}><h3 style={{margin:0,fontSize:15,fontWeight:800,color:C.t}}>{title}</h3><Btn v="ghost" small onClick={onClose}>âœ•</Btn></div>{children}</div></div>;}
function CTip({active,payload,label}){if(!active||!payload)return null;return <div style={{background:C.card2,border:`1px solid ${C.brd}`,borderRadius:8,padding:"6px 10px",boxShadow:"0 4px 16px rgba(0,0,0,.4)"}}><div style={{color:C.t,fontWeight:700,fontSize:9,marginBottom:2}}>{label}</div>{payload.map((p,i)=><div key={i} style={{display:"flex",alignItems:"center",gap:4,marginBottom:1}}><span style={{width:4,height:4,borderRadius:2,background:p.color}}/><span style={{color:C.td,fontSize:9}}>{p.name}:</span><span style={{color:C.t,fontSize:9,fontWeight:600}}>{fmt(p.value)}â‚¬</span></div>)}</div>;}
function Toggle({on,onToggle,label}){return <div onClick={onToggle} style={{display:"inline-flex",alignItems:"center",gap:7,cursor:"pointer",padding:"5px 10px",borderRadius:8,background:on?C.accD:C.card2,border:`1px solid ${on?C.acc+"66":C.brd}`,transition:"all .15s"}}><div style={{width:26,height:14,borderRadius:7,background:on?C.acc:C.brd,position:"relative",transition:"background .2s"}}><div style={{width:10,height:10,borderRadius:5,background:on?"#0a0a0f":C.td,position:"absolute",top:2,left:on?14:2,transition:"left .2s"}}/></div><span style={{fontSize:10,fontWeight:600,color:on?C.acc:C.td}}>{label}</span></div>;}
function ActionItem({a,socs,onToggle,onDelete}){const s=socs.find(x=>x.id===a.socId);const late=!a.done&&a.deadline<curM();return <div className="fu" style={{display:"flex",alignItems:"center",gap:8,padding:"8px 10px",background:C.card,borderRadius:8,border:`1px solid ${late?C.r+"44":C.brd}`,marginBottom:3}}><div onClick={()=>onToggle(a.id)} style={{width:18,height:18,borderRadius:5,border:`2px solid ${a.done?C.g:C.brd}`,background:a.done?C.gD:"transparent",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>{a.done&&<span style={{color:C.g,fontSize:11}}>âœ“</span>}</div><div style={{flex:1,minWidth:0}}><div style={{fontSize:12,fontWeight:600,color:a.done?C.td:C.t,textDecoration:a.done?"line-through":"none"}}>{a.text}</div><div style={{fontSize:10,color:late?C.r:C.td}}>{s&&<><span style={{width:5,height:5,borderRadius:3,background:s.color,display:"inline-block",marginRight:4}}/>{s.nom} Â· </>}{ml(a.deadline)}{late&&" âš  En retard"}</div></div>{onDelete&&<Btn v="ghost" small onClick={()=>onDelete(a.id)} style={{fontSize:9,padding:"2px 6px"}}>âœ•</Btn>}</div>;}
/* AI CO-PILOT */
function AICoPilot({socs,reps,hold,actions,pulses,allM,revData,socBank,okrs,synergies,clients}){
 const[msgs,setMsgs]=useState([{role:"assistant",content:"Salut ! Je suis ton co-pilote IA. Je connais toutes les donnÃ©es de ton portfolio. Pose-moi n'importe quelle question â€” analyse, recommandation, rÃ©cap pour une rÃ©union, comparaison entre sociÃ©tÃ©sâ€¦"}]);
 const[input,setInput]=useState("");const[loading,setLoading]=useState(false);const ref=useRef(null);
 const PRESETS=["Quelle sociÃ©tÃ© prioriser ce mois ?","GÃ©nÃ¨re un rÃ©cap pour la rÃ©union","Quels sont les risques actuels ?","Compare LEADX et Copywriting","Propose un plan d'action pour ce trimestre"];
 const send=async(text)=>{
  if(!text.trim()||loading)return;const q=text.trim();setInput("");
  setMsgs(prev=>[...prev,{role:"user",content:q}]);setLoading(true);
  try{
   const ctx=buildAIContext(socs,reps,hold,actions,pulses,allM,revData,socBank,okrs,synergies,clients);
   const resp=await fetch("https://api.anthropic.com/v1/messages",{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:1000,system:ctx,messages:[...msgs.filter(m=>m.role!=="system"),{role:"user",content:q}]})
   });
   const data=await resp.json();const reply=data.content?.map(b=>b.text||"").join("\n")||"DÃ©solÃ©, je n'ai pas pu rÃ©pondre.";
   setMsgs(prev=>[...prev,{role:"assistant",content:reply}]);
  }catch(e){setMsgs(prev=>[...prev,{role:"assistant",content:"âŒ Erreur de connexion. RÃ©essaie."}]);}
  setLoading(false);
 };
 useEffect(()=>{ref.current?.scrollTo({top:ref.current.scrollHeight,behavior:"smooth"});},[msgs]);
 return <div style={{display:"flex",flexDirection:"column",height:"calc(100vh - 120px)"}}>
  <div style={{display:"flex",flexWrap:"wrap",gap:4,marginBottom:8}}>{PRESETS.map((p,i)=><button key={i} onClick={()=>send(p)} style={{padding:"5px 10px",borderRadius:20,fontSize:10,fontWeight:600,border:`1px solid ${C.brd}`,background:C.card,color:C.td,cursor:"pointer",fontFamily:FONT,transition:"all .2s"}} onMouseEnter={e=>{e.target.style.borderColor=C.acc;e.target.style.color=C.acc;}} onMouseLeave={e=>{e.target.style.borderColor=C.brd;e.target.style.color=C.td;}}>{p}</button>)}</div>
  <div ref={ref} style={{flex:1,overflowY:"auto",padding:"4px 0"}}>
   {msgs.map((m,i)=><div key={i} className="fu" style={{display:"flex",justifyContent:m.role==="user"?"flex-end":"flex-start",marginBottom:8}}>
    <div style={{maxWidth:"85%",padding:"10px 14px",borderRadius:12,background:m.role==="user"?C.acc+"22":C.card,border:`1px solid ${m.role==="user"?C.acc+"44":C.brd}`,fontSize:12,lineHeight:1.7,color:C.t,whiteSpace:"pre-wrap"}}>
    {m.role==="assistant"&&<div style={{display:"flex",alignItems:"center",gap:4,marginBottom:4}}><span style={{fontSize:14}}>ðŸ¤–</span><span style={{fontWeight:700,fontSize:10,color:C.v}}>CO-PILOTE</span></div>}
    {m.content}
    </div>
   </div>)}
   {loading&&<div className="fu" style={{padding:"10px 14px",background:C.card,borderRadius:12,border:`1px solid ${C.brd}`,display:"inline-block"}}><span className="dots" style={{fontSize:18}}><span>Â·</span><span>Â·</span><span>Â·</span></span></div>}
  </div>
  <div style={{display:"flex",gap:8,padding:"10px 0 0",borderTop:`1px solid ${C.brd}`}}>
   <input value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>{if(e.key==="Enter")send(input);}} placeholder="Demande Ã  ton co-piloteâ€¦" style={{flex:1,background:C.bg,border:`1px solid ${C.brd}`,borderRadius:10,color:C.t,padding:"10px 14px",fontSize:13,fontFamily:FONT,outline:"none"}}/>
   <Btn v="ai" onClick={()=>send(input)} disabled={!input.trim()||loading}>âœ¦ Envoyer</Btn>
  </div>
 </div>;
}
/* PULSE SYSTEM */
function PulseForm({soc,pulses,savePulse,hold}){
 const w=curW();const existing=pulses[`${soc.id}_${w}`];
 const[mood,setMood]=useState(existing?.mood??-1);const[win,setWin]=useState(existing?.win||"");
 const[blocker,setBlocker]=useState(existing?.blocker||"");const[conf,setConf]=useState(existing?.conf??3);const[sent,setSent]=useState(!!existing);const[slackSent,setSlackSent]=useState(false);
 const submit=()=>{
  const pulse={mood,win,blocker,conf,at:new Date().toISOString()};
  savePulse(`${soc.id}_${w}`,pulse);setSent(true);setTimeout(()=>setSent(false),2e3);
  if(hold?.slack?.enabled&&hold.slack.notifyPulse){
   slackSend(hold.slack,buildPulseSlackMsg(soc,pulse)).then(r=>{if(r.ok)setSlackSent(true);});
  }
 };
 return <Card style={{padding:14}} accent={soc.color}>
  <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:10}}>
   <span style={{fontWeight:700,fontSize:13}}>âš¡ Pulse hebdo {existing&&<span style={{color:C.g,fontSize:10,fontWeight:600}}>âœ“ DÃ©jÃ  envoyÃ©</span>}</span>
   {hold?.slack?.enabled&&<span style={{fontSize:7,color:C.g,background:C.gD,padding:"1px 5px",borderRadius:4}}>{SLACK_MODES[hold.slack.mode]?.icon||"ðŸ’¬"} Slack</span>}
  </div>
  <div style={{marginBottom:10}}><div style={{color:C.td,fontSize:11,fontWeight:600,marginBottom:4}}>Comment tu te sens ?</div><div style={{display:"flex",gap:6}}>{MOODS.map((e,i)=><button key={i} onClick={()=>setMood(i)} style={{fontSize:22,padding:"4px 8px",borderRadius:8,border:`2px solid ${mood===i?C.acc:C.brd}`,background:mood===i?C.accD:"transparent",cursor:"pointer",transition:"all .15s"}}>{e}</button>)}</div></div>
  <Inp label="ðŸ† Ta victoire de la semaine" value={win} onChange={setWin} placeholder="Ex: 2 nouveaux clients signÃ©s" small/>
  <Inp label="ðŸš§ Un blocage ?" value={blocker} onChange={setBlocker} placeholder="Ex: attente rÃ©ponse fournisseur (optionnel)" small/>
  <div style={{marginBottom:10}}><div style={{color:C.td,fontSize:11,fontWeight:600,marginBottom:4}}>Confiance pour la suite (1-5)</div><div style={{display:"flex",alignItems:"center",gap:8}}><input type="range" min={1} max={5} value={conf} onChange={e=>setConf(parseInt(e.target.value))} style={{flex:1}}/><span style={{fontWeight:800,fontSize:16,color:[C.r,C.o,C.td,C.b,C.g][conf-1]}}>{conf}/5</span></div></div>
  <Btn onClick={submit} full v={sent?"success":"primary"} disabled={mood<0||!win.trim()}>{sent?"âœ“ EnvoyÃ© !":"Envoyer le pulse"}</Btn>
  {slackSent&&<div style={{textAlign:"center",fontSize:9,color:C.g,marginTop:4}}>ðŸ’¬ Notification Slack envoyÃ©e</div>}
 </Card>;
}
function PulseOverview({socs,pulses}){
 const w=curW();const actS=socs.filter(s=>s.stat==="active"&&s.id!=="eco");
 return <>{actS.map(s=>{const p=pulses[`${s.id}_${w}`];
  return <div key={s.id} className="fu" style={{display:"flex",alignItems:"center",gap:8,padding:"6px 10px",background:C.card,borderRadius:8,border:`1px solid ${C.brd}`,marginBottom:3}}>
   <span style={{width:5,height:5,borderRadius:3,background:s.color}}/><span style={{flex:1,fontSize:12,fontWeight:600}}>{s.porteur}</span>
   {p?<><span style={{fontSize:16}}>{MOODS[p.mood]}</span><span style={{fontSize:10,color:C.td,maxWidth:120,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{p.win}</span>{p.blocker&&<span style={{fontSize:9,color:C.r,background:C.rD,padding:"2px 6px",borderRadius:10}}>blocage</span>}<span style={{fontWeight:700,fontSize:11,color:[C.r,C.o,C.td,C.b,C.g][p.conf-1]}}>{p.conf}/5</span></>
    :<span style={{fontSize:10,color:C.tm}}>â€” pas encore envoyÃ©</span>}
  </div>;})}</>;
}
/* MEETING MODE */
function MeetingMode({socs,reps,hold,actions,pulses,allM,onExit}){
 const cM2=curM();const actS=socs.filter(s=>s.stat==="active");const hc=calcH(socs,reps,hold,cM2);
 const[step,setStep]=useState(0);const[timer,setTimer]=useState(0);const[running,setRunning]=useState(false);const[notes,setNotes]=useState("");
 const steps=[{title:"Vue d'ensemble",icon:"ðŸ“Š"},{title:"Alertes & Actions",icon:"âš "},...actS.map(s=>({title:s.nom,icon:"ðŸ¢",soc:s})),{title:"DÃ©cisions & Prochaines Ã©tapes",icon:"âœ…"}];
 useEffect(()=>{let id;if(running)id=setInterval(()=>setTimer(t=>t+1),1e3);return()=>clearInterval(id);},[running]);
 const fmtT=s=>`${Math.floor(s/60)}:${String(s%60).padStart(2,"0")}`;
 return <div style={{background:C.bg,minHeight:"100vh",fontFamily:FONT,color:C.t}}>
  <style>{CSS}</style>
  <div style={{background:`linear-gradient(135deg,${C.card},${C.card2})`,borderBottom:`1px solid ${C.brd}`,padding:"14px 20px"}}>
   <div style={{display:"flex",alignItems:"center",justifyContent:"space-between"}}>
    <div><div style={{color:C.acc,fontSize:10,fontWeight:700,letterSpacing:2}}>MODE RÃ‰UNION</div><h1 style={{margin:0,fontSize:18,fontWeight:900}}>{hold?.brand?.name||"Scale Corp"} â€” {ml(cM2)}</h1></div>
    <div style={{display:"flex",alignItems:"center",gap:10}}>
    <div style={{textAlign:"center"}}><div style={{fontSize:28,fontWeight:900,fontVariantNumeric:"tabular-nums",color:running?C.g:C.t}}>{fmtT(timer)}</div><div style={{display:"flex",gap:4,marginTop:4}}><Btn small v={running?"danger":"success"} onClick={()=>setRunning(!running)}>{running?"â¸":"â–¶"}</Btn><Btn small v="ghost" onClick={()=>setTimer(0)}>â†»</Btn></div></div>
    <Btn v="ghost" onClick={onExit}>âœ• Quitter</Btn>
    </div>
   </div>
   <div style={{display:"flex",gap:2,marginTop:12,overflowX:"auto"}}>{steps.map((s,i)=><button key={i} onClick={()=>setStep(i)} style={{padding:"8px 14px",borderRadius:8,fontSize:11,fontWeight:step===i?700:500,border:"none",background:step===i?C.acc+"22":"transparent",color:step===i?C.acc:C.td,cursor:"pointer",fontFamily:FONT,whiteSpace:"nowrap"}}>{s.icon} {s.title}</button>)}</div>
  </div>
  <div style={{padding:"20px 30px",maxWidth:900,margin:"0 auto"}}>
   {step===0&&<div className="si">
    <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(160px,1fr))",gap:14}}>
    <KPI label="CA Groupe" value={`${fmt(actS.reduce((a,s)=>a+pf(gr(reps,s.id,cM2)?.ca),0))}â‚¬`} accent={C.acc}/><KPI label="Marge" value={`${fmt(actS.reduce((a,s)=>a+pf(gr(reps,s.id,cM2)?.ca)-pf(gr(reps,s.id,cM2)?.charges),0))}â‚¬`} accent={C.g}/><KPI label="/ Fondateur" value={`${fmt(hc.pf)}â‚¬`} accent={C.o}/><KPI label="Pipeline" value={`${fmt(socs.reduce((a,s)=>a+pf(gr(reps,s.id,cM2)?.pipeline),0))}â‚¬`} accent={C.b}/>
    </div>
    <div style={{display:"flex",flexWrap:"wrap",gap:8,marginTop:16}}>{actS.map(s=>{const hs=healthScore(s,reps);const r=gr(reps,s.id,cM2);return <Card key={s.id} accent={s.color} style={{flex:"1 1 200px",padding:14}}><div style={{display:"flex",alignItems:"center",gap:6,marginBottom:6}}><GradeBadge grade={hs.grade} color={hs.color}/><span style={{fontWeight:700,fontSize:14}}>{s.nom}</span></div><div style={{fontSize:22,fontWeight:900}}>{r?`${fmt(r.ca)}â‚¬`:"â€”"}</div><div style={{color:C.td,fontSize:11,marginTop:2}}>{s.porteur}</div></Card>;})}</div>
   </div>}
   {step===1&&<div className="si">
    <Sect title="Alertes">{getAlerts(socs,reps,hold).map((a,i)=><div key={i} style={{padding:"6px 10px",background:{danger:C.rD,warn:C.oD,info:C.bD}[a.t],borderRadius:8,marginBottom:3,color:{danger:C.r,warn:C.o,info:C.b}[a.t],fontSize:12,fontWeight:600}}>âš  {a.m}</div>)}</Sect>
    <Sect title="Actions en retard">{actions.filter(a=>!a.done&&a.deadline<cM2).map(a=><ActionItem key={a.id} a={a} socs={socs} onToggle={()=>{}} onDelete={()=>{}}/>)}</Sect>
    <Sect title="Actions en cours">{actions.filter(a=>!a.done&&a.deadline>=cM2).slice(0,8).map(a=><ActionItem key={a.id} a={a} socs={socs} onToggle={()=>{}} onDelete={()=>{}}/>)}</Sect>
   </div>}
   {step>=2&&step<steps.length-1&&steps[step].soc&&(()=>{
    const s=steps[step].soc,r=gr(reps,s.id,cM2),rp=gr(reps,s.id,prevM(cM2));const hs=healthScore(s,reps);const rw=runway(reps,s.id,allM);const proj=project(reps,s.id,allM);
    const pw=Object.entries(pulses).filter(([k])=>k.startsWith(s.id+"_")).pop();
    const sActs=actions.filter(a=>a.socId===s.id&&!a.done);
    return <div className="si">
    <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:16}}>
    <div style={{width:40,height:40,borderRadius:10,background:`${s.color}22`,border:`2px solid ${s.color}44`,display:"flex",alignItems:"center",justifyContent:"center",fontWeight:900,fontSize:18,color:s.color}}>{s.nom[0]}</div>
    <div style={{flex:1}}><div style={{fontWeight:900,fontSize:18}}>{s.nom}</div><div style={{color:C.td,fontSize:11,display:"flex",gap:6,alignItems:"center"}}><span>{s.porteur} â€” {s.act}</span>{s.incub&&<span style={{color:C.v,fontSize:9,background:C.vD,padding:"1px 6px",borderRadius:8}}>ðŸ“… {sinceLbl(s.incub)}</span>}</div></div>
    <GradeBadge grade={hs.grade} color={hs.color} size="lg"/>
    </div>
    <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(120px,1fr))",gap:10}}>
    <KPI label="CA" value={r?`${fmt(r.ca)}â‚¬`:"â€”"} accent={C.acc} small/><KPI label="Marge" value={r?`${fmt(pf(r.ca)-pf(r.charges))}â‚¬`:"â€”"} accent={C.g} small/>
    {s.rec&&<KPI label="MRR" value={r?`${fmt(r.mrr)}â‚¬`:"â€”"} accent={C.b} small/>}
    <KPI label="Pipeline" value={r?`${fmt(r.pipeline)}â‚¬`:"â€”"} accent={C.acc} small/>
    {rw&&<KPI label="Runway" value={`${rw.months} mois`} accent={rw.months<3?C.r:rw.months<6?C.o:C.g} small/>}
    </div>
    {pw&&<Card style={{marginTop:12,padding:12}} accent={s.color}><div style={{display:"flex",alignItems:"center",gap:8}}><span style={{fontSize:22}}>{MOODS[pw[1].mood]}</span><div><div style={{fontSize:12,fontWeight:600}}>Pulse: {pw[1].win}</div>{pw[1].blocker&&<div style={{fontSize:11,color:C.r}}>Blocage: {pw[1].blocker}</div>}</div></div></Card>}
    {(()=>{const ms=calcMilestones(s,reps,actions,pulses,allM);const un=ms.filter(m=>m.unlocked);const next=ms.filter(m=>!m.unlocked).sort((a2,b2)=>a2.tier-b2.tier)[0];
    return un.length>0?<Card style={{marginTop:10,padding:12}}>
    <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:6}}>
    <span style={{color:C.td,fontSize:10,fontWeight:700,letterSpacing:.8}}>ðŸ† MILESTONES</span>
    <span style={{fontSize:9,color:C.acc,fontWeight:700}}>{un.length}/{ms.length}</span>
    </div>
    <div style={{display:"flex",gap:4,flexWrap:"wrap",marginBottom:next?6:0}}>
    {un.sort((a2,b2)=>b2.tier-a2.tier).slice(0,8).map(m2=><span key={m2.id} title={`${m2.label}: ${m2.desc}`} style={{fontSize:13,padding:"2px 4px",background:TIER_BG[m2.tier],borderRadius:6,border:`1px solid ${TIER_COLORS[m2.tier]}22`}}>{m2.icon}</span>)}
    {un.length>8&&<span style={{fontSize:9,color:C.td,alignSelf:"center"}}>+{un.length-8}</span>}
    </div>
    {next&&<div style={{display:"flex",alignItems:"center",gap:4,padding:"4px 6px",background:C.bg,borderRadius:6,opacity:.6}}>
    <span style={{fontSize:10,filter:"grayscale(1)"}}>{next.icon}</span>
    <span style={{fontSize:9,color:C.td}}>Prochain : <strong style={{color:C.t}}>{next.label}</strong> â€” {next.desc}</span>
    </div>}
    </Card>:null;
    })()}
    {proj&&<Card style={{marginTop:10,padding:12}}><div style={{color:C.td,fontSize:10,fontWeight:700,marginBottom:4}}>PROJECTION T+3</div><div style={{display:"flex",gap:12}}>{proj.map((v,i)=><span key={i} style={{fontSize:12}}>{ml(nextM(i===0?cM2:nextM(i===1?cM2:nextM(cM2))))}: <strong style={{color:C.acc}}>{fmt(v)}â‚¬</strong></span>)}</div></Card>}
    {sActs.length>0&&<Sect title="Actions ouvertes">{sActs.map(a=><ActionItem key={a.id} a={a} socs={socs} onToggle={()=>{}} onDelete={()=>{}}/>)}</Sect>}
    </div>;
   })()}
   {step===steps.length-1&&<div className="si"><Sect title="Notes de rÃ©union"><Inp value={notes} onChange={setNotes} textarea placeholder="DÃ©cisions prises, prochaines Ã©tapesâ€¦"/></Sect></div>}
   <div style={{display:"flex",justifyContent:"space-between",marginTop:20}}>
    <Btn v="secondary" onClick={()=>setStep(Math.max(0,step-1))} disabled={step===0}>â† PrÃ©cÃ©dent</Btn>
    <span style={{color:C.td,fontSize:11}}>{step+1}/{steps.length}</span>
    <Btn onClick={()=>setStep(Math.min(steps.length-1,step+1))} disabled={step===steps.length-1}>Suivant â†’</Btn>
   </div>
  </div>
 </div>;
}
/* DEAL FLOW */
function DealFlow({deals,saveDeals}){
 const[edit,setEdit]=useState(null);
 const move=(id,dir)=>{saveDeals(deals.map(d=>d.id===id?{...d,stage:clamp(d.stage+dir,0,DEAL_STAGES.length-1)}:d));};
 const del=(id)=>{saveDeals(deals.filter(d=>d.id!==id));};
 const saveDeal=()=>{if(!edit)return;const idx=deals.findIndex(d=>d.id===edit.id);saveDeals(idx>=0?deals.map(d=>d.id===edit.id?edit:d):[...deals,edit]);setEdit(null);};
 return <>
  <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12,marginTop:6}}><span style={{color:C.td,fontSize:12}}>{deals.length} opportunitÃ©s</span><Btn small onClick={()=>setEdit({id:uid(),nom:"",contact:"",stage:0,value:0,notes:"",at:new Date().toISOString()})}>+ Deal</Btn></div>
  <div style={{display:"flex",gap:8,overflowX:"auto",paddingBottom:10}}>{DEAL_STAGES.map((stage,si)=><div key={si} style={{minWidth:170,flex:"1 1 170px"}}>
   <div style={{color:C.td,fontSize:10,fontWeight:700,letterSpacing:1,marginBottom:6,textAlign:"center"}}>{stage}</div>
   {deals.filter(d=>d.stage===si).map(d=><Card key={d.id} style={{marginBottom:5,padding:"10px 12px",cursor:"pointer"}} onClick={()=>setEdit({...d})}>
    <div style={{fontWeight:700,fontSize:12,marginBottom:2}}>{d.nom}</div>
    <div style={{fontSize:10,color:C.td}}>{d.contact}</div>
    {d.value>0&&<div style={{fontSize:11,fontWeight:700,color:C.acc,marginTop:2}}>{fmt(d.value)}â‚¬/mois</div>}
    <div style={{display:"flex",gap:3,marginTop:6}}>{si>0&&<Btn v="ghost" small onClick={e=>{e.stopPropagation();move(d.id,-1);}}>â†</Btn>}{si<DEAL_STAGES.length-1&&<Btn v="ghost" small onClick={e=>{e.stopPropagation();move(d.id,1);}}>â†’</Btn>}</div>
   </Card>)}
  </div>)}</div>
  <Modal open={!!edit} onClose={()=>setEdit(null)} title={edit?.nom||"Nouveau deal"}>
   {edit&&<><Inp label="Nom sociÃ©tÃ©" value={edit.nom} onChange={v=>setEdit({...edit,nom:v})}/><Inp label="Contact" value={edit.contact} onChange={v=>setEdit({...edit,contact:v})}/><Inp label="Valeur estimÃ©e" value={edit.value} onChange={v=>setEdit({...edit,value:pf(v)})} type="number" suffix="â‚¬/mois"/><Sel label="Ã‰tape" value={edit.stage} onChange={v=>setEdit({...edit,stage:parseInt(v)})} options={DEAL_STAGES.map((s,i)=>({v:i,l:s}))}/><Inp label="Notes" value={edit.notes} onChange={v=>setEdit({...edit,notes:v})} textarea/>
   <div style={{display:"flex",gap:8,marginTop:12}}><Btn onClick={saveDeal}>Sauver</Btn><Btn v="secondary" onClick={()=>setEdit(null)}>Annuler</Btn>{deals.find(d=>d.id===edit.id)&&<Btn v="danger" onClick={()=>{del(edit.id);setEdit(null);}} style={{marginLeft:"auto"}}>Supprimer</Btn>}</div></>}
  </Modal>
 </>;
}
/* BANKING - REVOLUT */
const TX_CATEGORIES=[
 {id:"all",label:"Toutes",icon:""},
 {id:"revenus",label:"ðŸ’° Revenus",icon:"ðŸ’°"},
 {id:"loyer",label:"ðŸ  Loyer",icon:"ðŸ "},
 {id:"pub",label:"ðŸ“¢ PublicitÃ©",icon:"ðŸ“¢"},
 {id:"abonnements",label:"ðŸ’» Abonnements",icon:"ðŸ’»"},
 {id:"equipe",label:"ðŸ‘¥ Ã‰quipe",icon:"ðŸ‘¥"},
 {id:"transfert",label:"ðŸ¦ Transfert interne",icon:"ðŸ¦"},
 {id:"autres",label:"ðŸ“¦ Autres dÃ©penses",icon:"ðŸ“¦"},
 {id:"dividendes",label:"ðŸ›ï¸ Dividendes Holding",icon:"ðŸ›ï¸"},
];
function categorizeTransaction(tx){
 const leg=tx.legs?.[0];if(!leg)return{id:"autres",label:"ðŸ“¦ Autres dÃ©penses",icon:"ðŸ“¦"};
 const amt=leg.amount;const ref=((leg.description||"")+" "+(tx.reference||"")).toLowerCase();
 const legDesc=((tx.legs?.[0]?.description||"")+"").toLowerCase();
 const hasCounterparty=!!tx.legs?.[0]?.counterparty;const isSingleLeg=(tx.legs||[]).length===1;
 const isRealDividend=(/dividend/i.test(tx.reference||"")&&hasCounterparty&&isSingleLeg)||(/scale\s*corp/i.test(legDesc)&&hasCounterparty&&isSingleLeg);
 if(isRealDividend)return TX_CATEGORIES[8];
 if(amt>0)return TX_CATEGORIES[1];
 if(/loyer|rent/.test(ref))return TX_CATEGORIES[2];
 if(/facebook|google ads|meta ads|meta|tiktok|pub/.test(ref))return TX_CATEGORIES[3];
 if(/lecosysteme|l.{0,2}ecosyst[eÃ¨]me/i.test(ref))return TX_CATEGORIES[4];
 if(/stripe|notion|slack|ghl|zapier|skool|adobe|figma|revolut|gohighlevel|highlevel|canva|chatgpt|openai|anthropic|vercel|github|zoom|brevo|make\.com|clickup|airtable/.test(ref))return TX_CATEGORIES[4];
 if(/lucien|salaire|salary|freelance|prestataire|prestation/.test(ref))return TX_CATEGORIES[5];
 if(tx.type==="transfer")return TX_CATEGORIES[6];
 return TX_CATEGORIES[7];
}
function BankingPanel({revData,onSync,compact}){
 if(!revData||!revData.accounts){
  return <Card style={{textAlign:"center",padding:compact?16:30}}>
   <div style={{fontSize:compact?24:36,marginBottom:6}}>ðŸ¦</div>
   <div style={{fontWeight:700,fontSize:compact?12:14,marginBottom:4}}>Revolut Business</div>
   <div style={{color:C.td,fontSize:11,marginBottom:10}}>Connecte ton compte dans ParamÃ¨tres Holding</div>
   <Btn small onClick={onSync}>Charger donnÃ©es demo</Btn>
  </Card>;
 }
 const{accounts,transactions,totalEUR,lastSync,isDemo}=revData;
 const inflow=transactions.filter(t=>t.legs?.[0]?.amount>0).reduce((s,t)=>s+t.legs[0].amount,0);
 const outflow=Math.abs(transactions.filter(t=>t.legs?.[0]?.amount<0).reduce((s,t)=>s+t.legs[0].amount,0));
 const cs=v=>CURR_SYMBOLS[v]||v;
 if(compact)return <Card style={{padding:12}} accent={C.g}>
  <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8}}>
   <div style={{display:"flex",alignItems:"center",gap:5}}><span style={{fontSize:14}}>ðŸ¦</span><span style={{fontWeight:700,fontSize:11,color:C.td}}>REVOLUT</span>{isDemo&&<span style={{fontSize:8,color:C.o,background:C.oD,padding:"1px 5px",borderRadius:6}}>DEMO</span>}</div>
   <span style={{fontSize:9,color:C.tm}}>{ago(lastSync)}</span>
  </div>
  <div style={{fontWeight:900,fontSize:20,color:C.g}}>{fmt(totalEUR)}â‚¬</div>
  <div style={{display:"flex",gap:8,marginTop:6}}>{accounts.slice(0,3).map(a=><div key={a.id} style={{fontSize:10,color:C.td}}>{a.name}: <strong style={{color:C.t}}>{fmt(a.balance)}{cs(a.currency)}</strong></div>)}</div>
 </Card>;
 return <>
  {isDemo&&<div className="fu" style={{background:C.oD,border:`1px solid ${C.o}22`,borderRadius:10,padding:"8px 14px",marginBottom:10,display:"flex",alignItems:"center",justifyContent:"space-between"}}><span style={{color:C.o,fontSize:11,fontWeight:600}}>âš  DonnÃ©es demo â€” Ajoute ton token Revolut dans ParamÃ¨tres Holding</span><Btn small v="secondary" onClick={onSync}>â†» Sync</Btn></div>}
  <div className="fu" style={{background:`linear-gradient(135deg,${C.card},${C.card2})`,border:`1px solid ${C.brd}`,borderRadius:14,padding:20,marginBottom:14,textAlign:"center"}}>
   <div style={{color:C.td,fontSize:10,fontWeight:700,letterSpacing:1,marginBottom:4}}>SOLDE TOTAL</div>
   <div style={{fontWeight:900,fontSize:34,color:C.g,lineHeight:1}}>{fmt(totalEUR)}â‚¬</div>
   <div style={{color:C.td,fontSize:11,marginTop:4}}>DerniÃ¨re sync: {ago(lastSync)}</div>
   {!isDemo&&<Btn small v="secondary" onClick={onSync} style={{marginTop:8}}>â†» Actualiser</Btn>}
  </div>
  <Sect title="Comptes" sub={`${accounts.length} comptes`}>
   {accounts.map((a,i)=><div key={a.id} className={`fu d${Math.min(i+1,8)}`} style={{display:"flex",alignItems:"center",gap:10,padding:"12px 14px",background:C.card,borderRadius:10,border:`1px solid ${C.brd}`,marginBottom:4}}>
    <div style={{width:36,height:36,borderRadius:9,background:a.state==="active"?C.gD:C.rD,display:"flex",alignItems:"center",justifyContent:"center",fontSize:16}}>ðŸ¦</div>
    <div style={{flex:1}}><div style={{fontWeight:700,fontSize:13}}>{a.name}</div><div style={{color:C.td,fontSize:10}}>{a.currency} Â· {a.state==="active"?"Actif":"Inactif"}</div></div>
    <div style={{textAlign:"right"}}><div style={{fontWeight:900,fontSize:18,color:a.balance>=0?C.g:C.r}}>{fmt(a.balance)} {cs(a.currency)}</div></div>
   </div>)}
  </Sect>
  <div style={{display:"flex",gap:10,marginTop:4}}>
   <KPI label="EntrÃ©es (30j)" value={`+${fmt(inflow)}â‚¬`} accent={C.g} delay={1}/>
   <KPI label="Sorties (30j)" value={`-${fmt(outflow)}â‚¬`} accent={C.r} delay={2}/>
   <KPI label="Net" value={`${fmt(inflow-outflow)}â‚¬`} accent={inflow-outflow>=0?C.g:C.r} delay={3}/>
  </div>
  <BankingTransactions transactions={transactions} cs={cs}/>
 </>;
}
function BankingTransactions({transactions,cs}){
 const[catFilter,setCatFilter]=useState("all");
 const[typeFilter,setTypeFilter]=useState("all");
 const[periodFilter,setPeriodFilter]=useState("all");
 const[sortBy,setSortBy]=useState("recent");
 const[search,setSearch]=useState("");
 const filtered=useMemo(()=>{
  const now=new Date();let txs=[...transactions];
  // period
  if(periodFilter==="month"){const s=new Date(now.getFullYear(),now.getMonth(),1);txs=txs.filter(t=>new Date(t.created_at)>=s);}
  else if(periodFilter==="lastmonth"){const s=new Date(now.getFullYear(),now.getMonth()-1,1);const e=new Date(now.getFullYear(),now.getMonth(),1);txs=txs.filter(t=>{const d=new Date(t.created_at);return d>=s&&d<e;});}
  else if(periodFilter==="3months"){const s=new Date(now.getFullYear(),now.getMonth()-2,1);txs=txs.filter(t=>new Date(t.created_at)>=s);}
  // type
  if(typeFilter==="in")txs=txs.filter(t=>t.legs?.[0]?.amount>0);
  else if(typeFilter==="out")txs=txs.filter(t=>t.legs?.[0]?.amount<0);
  // category
  if(catFilter!=="all")txs=txs.filter(t=>categorizeTransaction(t).id===catFilter);
  // search
  if(search.trim()){const q=search.toLowerCase();txs=txs.filter(t=>{const ref=((t.legs?.[0]?.description||"")+" "+(t.reference||"")+" "+(t.merchant?.name||"")).toLowerCase();return ref.includes(q);});}
  // sort
  if(sortBy==="oldest")txs.sort((a,b)=>new Date(a.created_at)-new Date(b.created_at));
  else if(sortBy==="recent")txs.sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
  else if(sortBy==="amountUp")txs.sort((a,b)=>(a.legs?.[0]?.amount||0)-(b.legs?.[0]?.amount||0));
  else if(sortBy==="amountDown")txs.sort((a,b)=>(b.legs?.[0]?.amount||0)-(a.legs?.[0]?.amount||0));
  return txs;
 },[transactions,catFilter,typeFilter,periodFilter,sortBy,search]);
 const totals=useMemo(()=>{
  let inp=0,out=0,div=0;filtered.forEach(t=>{const a=t.legs?.[0]?.amount||0;if(a>0)inp+=a;else{out+=Math.abs(a);if(categorizeTransaction(t).id==="dividendes")div+=Math.abs(a);}});
  return{inp:Math.round(inp),out:Math.round(out),net:Math.round(inp-out),count:filtered.length,div:Math.round(div)};
 },[filtered]);
 const selS={background:C.bg,border:`1px solid ${C.brd}`,borderRadius:6,color:C.t,padding:"4px 6px",fontSize:10,fontFamily:FONT,outline:"none"};
 return <>
  <div style={{display:"flex",flexWrap:"wrap",gap:4,alignItems:"center",marginTop:10,marginBottom:6}}>
   <select value={catFilter} onChange={e=>setCatFilter(e.target.value)} style={selS}>{TX_CATEGORIES.map(c=><option key={c.id} value={c.id}>{c.label}</option>)}</select>
   <select value={typeFilter} onChange={e=>setTypeFilter(e.target.value)} style={selS}><option value="all">Toutes</option><option value="in">EntrÃ©es</option><option value="out">Sorties</option></select>
   <select value={periodFilter} onChange={e=>setPeriodFilter(e.target.value)} style={selS}><option value="all">Tout</option><option value="month">Ce mois</option><option value="lastmonth">Mois dernier</option><option value="3months">3 derniers mois</option></select>
   <select value={sortBy} onChange={e=>setSortBy(e.target.value)} style={selS}><option value="recent">Plus rÃ©cent</option><option value="oldest">Plus ancien</option><option value="amountDown">Montant â†“</option><option value="amountUp">Montant â†‘</option></select>
   <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="ðŸ” Rechercherâ€¦" style={{...selS,flex:"1 1 100px",minWidth:80}}/>
  </div>
  <div style={{display:"flex",gap:6,marginBottom:8}}>
   <div style={{flex:1,background:C.card,border:`1px solid ${C.brd}`,borderRadius:8,padding:"6px 8px"}}><div style={{fontSize:8,color:C.td,fontWeight:700}}>ENTRÃ‰ES</div><div style={{fontWeight:800,fontSize:12,color:C.g}}>+{fmt(totals.inp)}â‚¬</div></div>
   <div style={{flex:1,background:C.card,border:`1px solid ${C.brd}`,borderRadius:8,padding:"6px 8px"}}><div style={{fontSize:8,color:C.td,fontWeight:700}}>SORTIES</div><div style={{fontWeight:800,fontSize:12,color:C.r}}>-{fmt(totals.out)}â‚¬</div></div>
   <div style={{flex:1,background:C.card,border:`1px solid ${C.brd}`,borderRadius:8,padding:"6px 8px"}}><div style={{fontSize:8,color:C.td,fontWeight:700}}>NET</div><div style={{fontWeight:800,fontSize:12,color:totals.net>=0?C.g:C.r}}>{fmt(totals.net)}â‚¬</div></div>
   <div style={{flex:1,background:C.card,border:`1px solid ${C.brd}`,borderRadius:8,padding:"6px 8px"}}><div style={{fontSize:8,color:C.td,fontWeight:700}}>TX</div><div style={{fontWeight:800,fontSize:12,color:C.t}}>{totals.count}</div></div>
  </div>
  {totals.div>0&&<div style={{background:"#7c3aed11",border:"1px solid #7c3aed33",borderRadius:8,padding:"6px 10px",marginBottom:8,display:"flex",alignItems:"center",gap:6,fontSize:11}}><span style={{fontSize:13}}>ðŸ›ï¸</span><span style={{color:"#7c3aed",fontWeight:700}}>Total dividendes holding : {fmt(totals.div)}â‚¬</span><span style={{color:C.td,fontSize:10}}>(non comptÃ©s dans les charges opÃ©rationnelles)</span></div>}
  <Sect title="Transactions" sub={`${totals.count} rÃ©sultats`}>
   {filtered.map((tx,i)=>{
    const leg=tx.legs?.[0];if(!leg)return null;
    const isIn=leg.amount>0;const desc=leg.description||tx.reference||tx.merchant?.name||"Transaction";
    const cat=categorizeTransaction(tx);const isDiv=cat.id==="dividendes";
    const catColors={"revenus":C.g,"loyer":"#f59e0b","pub":"#ec4899","abonnements":C.b,"equipe":C.o,"transfert":"#6366f1","dividendes":"#7c3aed","autres":C.td};
    return <div key={tx.id} className={`fu d${Math.min(i+1,8)}`} style={{display:"flex",alignItems:"center",gap:8,padding:"8px 10px",background:isDiv?"#7c3aed11":C.card,borderRadius:8,border:`1px solid ${isDiv?"#7c3aed33":C.brd}`,marginBottom:2}}>
    <div style={{width:26,height:26,borderRadius:7,background:isIn?C.gD:isDiv?"#7c3aed22":C.rD,display:"flex",alignItems:"center",justifyContent:"center",fontSize:11,fontWeight:900,color:isIn?C.g:isDiv?"#7c3aed":C.r,flexShrink:0}}>{cat.icon||"â†‘"}</div>
    <div style={{flex:1,minWidth:0}}><div style={{display:"flex",alignItems:"center",gap:4}}><span style={{fontWeight:600,fontSize:12,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{desc}</span><span style={{fontSize:9,padding:"1px 6px",borderRadius:8,background:(catColors[cat.id]||C.td)+"22",color:catColors[cat.id]||C.td,fontWeight:600,whiteSpace:"nowrap",flexShrink:0}}>{cat.label}</span></div><div style={{fontSize:10,color:C.td}}>{new Date(tx.created_at).toLocaleDateString("fr-FR")} Â· {tx.type==="card_payment"?"Carte":"Virement"}</div></div>
    <span style={{fontWeight:800,fontSize:13,color:isIn?C.g:isDiv?"#7c3aed":C.r,whiteSpace:"nowrap"}}>{isIn?"+":""}{fmt(leg.amount)} {cs(leg.currency)}</span>
    </div>;
   })}
   {filtered.length===0&&<div style={{textAlign:"center",padding:20,color:C.td,fontSize:11}}>Aucune transaction trouvÃ©e</div>}
  </Sect>
 </>;
}
/* GHL CRM TAB */
function TabCRM({socs,ghlData,onSync}){
 const[selSoc,setSelSoc]=useState("all");
 const actS=socs.filter(s=>s.stat==="active"&&s.id!=="eco");
 const hasData=Object.keys(ghlData).length>0;
 const aggStats=useMemo(()=>{
  const ids=selSoc==="all"?actS.map(s=>s.id):[selSoc];
  let tLeads=0,tOpen=0,tWon=0,tLost=0,pVal=0,wVal=0;
  ids.forEach(id=>{const d=ghlData[id];if(!d)return;const st=d.stats;tLeads+=st.totalLeads;tOpen+=st.openDeals;tWon+=st.wonDeals;tLost+=st.lostDeals;pVal+=st.pipelineValue;wVal+=st.wonValue;});
  return{tLeads,tOpen,tWon,tLost,pVal,wVal,conv:tLeads>0?Math.round(tWon/tLeads*100):0};
 },[ghlData,selSoc,actS]);
 const opps=useMemo(()=>{
  const ids=selSoc==="all"?actS.map(s=>s.id):[selSoc];
  const all=[];ids.forEach(id=>{const d=ghlData[id];if(!d)return;d.opportunities.forEach(o=>{all.push({...o,socId:id});});});
  return all.sort((a,b)=>new Date(b.updatedAt)-new Date(a.updatedAt));
 },[ghlData,selSoc,actS]);
 const stages=useMemo(()=>{
  const ids=selSoc==="all"?actS.map(s=>s.id):[selSoc];
  const st=new Set();ids.forEach(id=>{const d=ghlData[id];if(!d)return;d.opportunities.forEach(o=>st.add(o.stage));});
  return[...st];
 },[ghlData,selSoc,actS]);
 const sources=useMemo(()=>{
  const ids=selSoc==="all"?actS.map(s=>s.id):[selSoc];
  const m={};ids.forEach(id=>{const d=ghlData[id];if(!d)return;d.opportunities.forEach(o=>{m[o.source]=(m[o.source]||0)+1;});});
  return Object.entries(m).map(([s,c])=>({source:s,count:c})).sort((a,b)=>b.count-a.count);
 },[ghlData,selSoc,actS]);
 const isDemo=Object.values(ghlData).some(d=>d.isDemo);
 if(!hasData)return <div className="fu" style={{textAlign:"center",padding:50}}>
  <div style={{fontSize:40,marginBottom:10}}>ðŸ“¡</div>
  <div style={{fontWeight:700,fontSize:16,marginBottom:6}}>Connecte tes comptes GHL</div>
  <div style={{color:C.td,fontSize:12,marginBottom:16,maxWidth:350,margin:"0 auto 16px"}}>Ajoute ta clÃ© API GoHighLevel dans les paramÃ¨tres de chaque sociÃ©tÃ© (onglet SociÃ©tÃ©s â†’ modifier)</div>
  <Btn onClick={onSync}>Charger les donnÃ©es demo</Btn>
 </div>;
 return <>
  {isDemo&&<div className="fu" style={{background:C.oD,border:`1px solid ${C.o}22`,borderRadius:10,padding:"8px 14px",marginBottom:10,display:"flex",alignItems:"center",justifyContent:"space-between"}}><span style={{color:C.o,fontSize:11,fontWeight:600}}>âš  DonnÃ©es demo â€” Ajoute tes clÃ©s API GHL pour les vraies donnÃ©es</span><Btn small v="secondary" onClick={onSync}>â†» Sync</Btn></div>}
  <div style={{display:"flex",gap:6,alignItems:"center",marginTop:6,marginBottom:14,flexWrap:"wrap"}}>
   <select value={selSoc} onChange={e=>setSelSoc(e.target.value)} style={{background:C.bg,border:`1px solid ${C.brd}`,borderRadius:8,color:C.t,padding:"8px 12px",fontSize:12,fontFamily:FONT,outline:"none"}}><option value="all">Toutes les sociÃ©tÃ©s</option>{actS.map(s=><option key={s.id} value={s.id}>{s.nom}</option>)}</select>
   {!isDemo&&<Btn small v="secondary" onClick={onSync}>â†» Sync GHL</Btn>}
   {ghlData[actS[0]?.id]&&<span style={{color:C.tm,fontSize:10}}>DerniÃ¨re sync: {ago(ghlData[actS[0].id].lastSync)}</span>}
  </div>
  <div style={{display:"flex",flexWrap:"wrap",gap:10}}>
   <KPI label="Leads total" value={String(aggStats.tLeads)} accent={C.b} delay={1}/><KPI label="Pipeline ouvert" value={`${fmt(aggStats.pVal)}â‚¬`} accent={C.acc} delay={2}/><KPI label="Deals gagnÃ©s" value={`${fmt(aggStats.wVal)}â‚¬`} accent={C.g} delay={3}/><KPI label="Conversion" value={`${aggStats.conv}%`} accent={aggStats.conv>=30?C.g:aggStats.conv>=15?C.o:C.r} delay={4}/>
  </div>
  <Sect title="Funnel" sub="RÃ©partition par Ã©tape">
   {stages.map((st,i)=>{const stOpps=opps.filter(o=>o.stage===st);const val=stOpps.reduce((a,o)=>a+o.value,0);const w=aggStats.tLeads>0?Math.round(stOpps.length/aggStats.tLeads*100):0;
    return <div key={st} className={`fu d${Math.min(i+1,8)}`} style={{marginBottom:4}}>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:3}}>
    <div style={{display:"flex",alignItems:"center",gap:6}}><span style={{width:8,height:8,borderRadius:2,background:GHL_STAGES_COLORS[i%GHL_STAGES_COLORS.length]}}/><span style={{fontWeight:600,fontSize:12}}>{st}</span></div>
    <div style={{display:"flex",gap:10,alignItems:"center"}}><span style={{color:C.td,fontSize:11}}>{stOpps.length} deals</span><span style={{fontWeight:700,fontSize:12,color:C.acc}}>{fmt(val)}â‚¬</span></div>
    </div>
    <PBar value={w} max={100} color={GHL_STAGES_COLORS[i%GHL_STAGES_COLORS.length]} h={5}/>
    </div>;
   })}
  </Sect>
  {selSoc==="all"&&<Sect title="Pipeline par sociÃ©tÃ©">
   {actS.map((s,i)=>{const d=ghlData[s.id];if(!d)return null;return <div key={s.id} className={`fu d${Math.min(i+1,8)}`} style={{display:"flex",alignItems:"center",gap:8,padding:"8px 12px",background:C.card,borderRadius:8,border:`1px solid ${C.brd}`,marginBottom:3}}>
    <span style={{width:6,height:6,borderRadius:3,background:s.color}}/><span style={{flex:1,fontWeight:700,fontSize:12}}>{s.nom}</span>
    <span style={{fontSize:10,color:C.td}}>{d.stats.totalLeads} leads</span>
    <span style={{fontSize:10,color:C.b}}>{d.stats.openDeals} ouverts</span>
    <span style={{fontSize:10,color:C.g}}>{d.stats.wonDeals} gagnÃ©s</span>
    <span style={{fontWeight:700,fontSize:12,color:C.acc}}>{fmt(d.stats.pipelineValue)}â‚¬</span>
   </div>;})}
  </Sect>}
  {sources.length>0&&<Sect title="Sources de leads">
   <div className="fu d1" style={{height:160,background:C.card,borderRadius:12,border:`1px solid ${C.brd}`,padding:"14px 6px 6px 0"}}><ResponsiveContainer><BarChart data={sources} layout="vertical"><CartesianGrid strokeDasharray="3 3" stroke={C.brd}/><XAxis type="number" tick={{fill:C.td,fontSize:9}} axisLine={false} tickLine={false}/><YAxis type="category" dataKey="source" tick={{fill:C.td,fontSize:9}} axisLine={false} tickLine={false} width={90}/><Tooltip contentStyle={{background:C.card2,border:`1px solid ${C.brd}`,borderRadius:10,fontSize:11}}/><Bar dataKey="count" fill={C.b} radius={[0,3,3,0]} name="Leads"/></BarChart></ResponsiveContainer></div>
  </Sect>}
  <Sect title="OpportunitÃ©s rÃ©centes" sub={`${opps.length} au total`}>
   {opps.slice(0,12).map((o,i)=>{const s=socs.find(x=>x.id===o.socId);
    return <div key={o.id} className={`fu d${Math.min(i+1,8)}`} style={{display:"flex",alignItems:"center",gap:8,padding:"8px 10px",background:C.card,borderRadius:8,border:`1px solid ${C.brd}`,marginBottom:3}}>
    {s&&<span style={{width:5,height:5,borderRadius:3,background:s.color,flexShrink:0}}/>}
    <div style={{flex:1,minWidth:0}}><div style={{fontWeight:600,fontSize:12,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{o.name}</div><div style={{fontSize:10,color:C.td}}>{o.stage} Â· {o.source}</div></div>
    <span style={{fontWeight:700,fontSize:12,color:o.status==="won"?C.g:C.acc}}>{fmt(o.value)}â‚¬</span>
    <span style={{fontSize:9,padding:"2px 6px",borderRadius:10,background:o.status==="won"?C.gD:o.status==="lost"?C.rD:C.bD,color:o.status==="won"?C.g:o.status==="lost"?C.r:C.b,fontWeight:600}}>{o.status==="won"?"GagnÃ©":o.status==="lost"?"Perdu":"Ouvert"}</span>
    </div>;
   })}
  </Sect>
 </>;
}
/* PORTEUR VIEW (Rapport/Stats/Actions/Journal/Pulse) */
/* MILESTONES UI */
function MilestonesWall({milestones,soc}){
 const[showAll,setShowAll]=useState(false);
 const unlocked=milestones.filter(m=>m.unlocked);
 const locked=milestones.filter(m=>!m.unlocked);
 const nextUp=locked.sort((a,b)=>a.tier-b.tier).slice(0,3);
 const cats=[...new Set(milestones.map(m=>m.cat))];
 const progress=Math.round(unlocked.length/milestones.length*100);
 return <>
  <Card accent={C.acc} style={{padding:16,marginTop:6,marginBottom:14}}>
   <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8}}>
    <div>
    <div style={{color:C.td,fontSize:9,fontWeight:700,letterSpacing:.8}}>MILESTONES DÃ‰BLOQUÃ‰S</div>
    <div style={{display:"flex",alignItems:"baseline",gap:6,marginTop:2}}>
    <span style={{fontWeight:900,fontSize:28,color:C.acc,lineHeight:1}}>{unlocked.length}</span>
    <span style={{color:C.td,fontSize:12}}>/ {milestones.length}</span>
    </div>
    </div>
    <div style={{width:56,height:56,borderRadius:28,background:C.bg,border:`3px solid ${C.acc}44`,display:"flex",alignItems:"center",justifyContent:"center",position:"relative"}}>
    <span style={{fontWeight:900,fontSize:16,color:C.acc}}>{progress}%</span>
    <svg style={{position:"absolute",inset:-3}} width={62} height={62}><circle cx={31} cy={31} r={27} fill="none" stroke={C.brd} strokeWidth={3}/><circle cx={31} cy={31} r={27} fill="none" stroke={C.acc} strokeWidth={3} strokeDasharray={`${progress*1.7} 170`} strokeLinecap="round" transform="rotate(-90 31 31)" style={{transition:"stroke-dasharray .6s ease"}}/></svg>
    </div>
   </div>
   <PBar value={unlocked.length} max={milestones.length} color={C.acc} h={4}/>
  </Card>
  {unlocked.length>0&&<Sect title="TrophÃ©es" sub={`${unlocked.length} dÃ©bloquÃ©s`}>
   <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(90px,1fr))",gap:6}}>
    {unlocked.sort((a,b)=>b.tier-a.tier).slice(0,showAll?999:12).map((m,i)=>
    <div key={m.id} className={`fu d${Math.min(i+1,8)}`} style={{background:TIER_BG[m.tier],border:`1px solid ${TIER_COLORS[m.tier]}22`,borderRadius:10,padding:"10px 8px",textAlign:"center",position:"relative",overflow:"hidden"}}>
    {m.tier>=4&&<div style={{position:"absolute",inset:0,background:`radial-gradient(ellipse at 50% 0%,${TIER_COLORS[m.tier]}08,transparent 70%)`,pointerEvents:"none"}}/>}
    <div style={{fontSize:20,marginBottom:3,filter:m.tier>=5?"drop-shadow(0 0 4px rgba(251,191,36,.4))":"none"}}>{m.icon}</div>
    <div style={{fontWeight:700,fontSize:9,color:TIER_COLORS[m.tier],lineHeight:1.2}}>{m.label}</div>
    <div style={{fontSize:7,color:C.td,marginTop:2,lineHeight:1.2}}>{m.desc}</div>
    </div>
    )}
   </div>
   {unlocked.length>12&&!showAll&&<div style={{textAlign:"center",marginTop:8}}><Btn small v="ghost" onClick={()=>setShowAll(true)}>Voir tout ({unlocked.length})</Btn></div>}
  </Sect>}
  {nextUp.length>0&&<Sect title="Prochains paliers">
   {nextUp.map((m,i)=>
    <div key={m.id} className={`fu d${Math.min(i+1,4)}`} style={{display:"flex",alignItems:"center",gap:8,padding:"8px 10px",background:C.card,borderRadius:8,border:`1px dashed ${C.brd}`,marginBottom:3,opacity:.7}}>
    <span style={{fontSize:16,filter:"grayscale(1) opacity(.5)"}}>{m.icon}</span>
    <div style={{flex:1}}>
    <div style={{fontWeight:600,fontSize:11,color:C.td}}>{m.label}</div>
    <div style={{fontSize:9,color:C.tm}}>{m.desc}</div>
    </div>
    <span style={{fontSize:8,color:C.td,background:C.card2,padding:"2px 6px",borderRadius:8}}>ðŸ”’</span>
    </div>
   )}
  </Sect>}
  <Sect title="Par catÃ©gorie">
   {cats.map(cat=>{
    const catMs=milestones.filter(m=>m.cat===cat);
    const catUnlocked=catMs.filter(m=>m.unlocked).length;
    return <div key={cat} className="fu" style={{marginBottom:8}}>
    <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:4}}>
    <span style={{fontSize:11,fontWeight:700}}>{MILESTONE_CATS[cat]||cat}</span>
    <span style={{fontSize:9,color:C.td}}>{catUnlocked}/{catMs.length}</span>
    </div>
    <div style={{display:"flex",gap:3}}>
    {catMs.sort((a,b)=>a.tier-b.tier).map(m=><div key={m.id} style={{flex:1,height:4,borderRadius:2,background:m.unlocked?TIER_COLORS[m.tier]:C.brd,transition:"background .3s"}} title={`${m.label}: ${m.desc}${m.unlocked?" âœ“":" ðŸ”’"}`}/>)}
    </div>
    </div>;
   })}
  </Sect>
 </>;
}
function MilestonesCompact({milestones,max=5}){
 const unlocked=milestones.filter(m=>m.unlocked);
 if(unlocked.length===0)return null;
 const top=unlocked.sort((a,b)=>b.tier-a.tier).slice(0,max);
 return <div style={{display:"flex",gap:2,alignItems:"center"}}>
  {top.map(m=><span key={m.id} title={m.label} style={{fontSize:10,filter:m.tier>=4?"none":"opacity(.7)"}}>{m.icon}</span>)}
  {unlocked.length>max&&<span style={{fontSize:8,color:C.td}}>+{unlocked.length-max}</span>}
 </div>;
}
function MilestoneCount({milestones}){
 const n=milestones.filter(m=>m.unlocked).length;
 if(n===0)return null;
 return <span style={{fontSize:8,color:C.acc,background:C.accD,padding:"1px 5px",borderRadius:8,fontWeight:700}}>ðŸ† {n}</span>;
}
/* PER-SOCIÃ‰TÃ‰ BANKING WIDGET */
function SocBankWidget({bankData,onSync,soc}){
 if(!bankData)return <Card style={{textAlign:"center",padding:20}}>
  <div style={{fontSize:28,marginBottom:6}}>ðŸ¦</div>
  <div style={{fontWeight:700,fontSize:13,marginBottom:4}}>Revolut Business</div>
  <div style={{color:C.td,fontSize:11,marginBottom:10}}>Connecte ton compte Revolut</div>
  <Btn small onClick={onSync}>Charger donnÃ©es demo</Btn>
 </Card>;
 const{accounts:allAccounts,transactions:allTransactions,balance,monthly,lastSync,isDemo}=bankData;
 const excl=EXCLUDED_ACCOUNTS[soc?.id]||[];
 const accounts=allAccounts.filter(a=>!excl.includes(a.id));
 const transactions=allTransactions.filter(t=>{const leg=t.legs?.[0];return!leg||!excl.includes(leg.account_id);});
 const cm=curM(),pm=prevM(cm);
 const cmData=monthly?.[cm],pmData=monthly?.[pm];
 const inflow=transactions.filter(t=>t.legs?.[0]?.amount>0).reduce((s,t)=>s+t.legs[0].amount,0);
 const outflow=Math.abs(transactions.filter(t=>t.legs?.[0]?.amount<0).reduce((s,t)=>s+t.legs[0].amount,0));
 return <>
  {isDemo&&<div className="fu" style={{background:C.oD,border:`1px solid ${C.o}22`,borderRadius:10,padding:"6px 12px",marginBottom:8,display:"flex",alignItems:"center",justifyContent:"space-between"}}><span style={{color:C.o,fontSize:10,fontWeight:600}}>âš  Demo â€” Ajoute le token Revolut via l'admin</span><Btn small v="ghost" onClick={onSync} style={{fontSize:9}}>â†»</Btn></div>}
  <Card style={{padding:16,textAlign:"center",marginBottom:10}} accent={C.g}>
   <div style={{color:C.td,fontSize:10,fontWeight:700,letterSpacing:1}}>SOLDE REVOLUT</div>
   <div style={{fontWeight:900,fontSize:28,color:C.g,lineHeight:1.2}}>{fmt(balance)}â‚¬</div>
   <div style={{color:C.tm,fontSize:10,marginTop:2}}>Sync: {ago(lastSync)}</div>
  </Card>
  <div style={{display:"flex",gap:8,marginBottom:10}}>
   <KPI label={`EncaissÃ© ${ml(cm).split(" ")[0]}`} value={cmData?`${fmt(cmData.income)}â‚¬`:"â€”"} accent={C.g} small delay={1}/>
   <KPI label={`DÃ©caissÃ© ${ml(cm).split(" ")[0]}`} value={cmData?`${fmt(cmData.expense)}â‚¬`:"â€”"} accent={C.r} small delay={2}/>
   <KPI label="Net" value={cmData?`${fmt(cmData.income-cmData.expense)}â‚¬`:"â€”"} accent={cmData&&cmData.income-cmData.expense>=0?C.g:C.r} small delay={3}/>
  </div>
  {pmData&&cmData&&<Card style={{padding:10,marginBottom:10}}>
   <div style={{color:C.td,fontSize:10,fontWeight:700,marginBottom:6}}>VS MOIS PRÃ‰CÃ‰DENT</div>
   <div style={{display:"flex",gap:14}}>
    <div style={{fontSize:11}}><span style={{color:C.td}}>EncaissÃ©:</span> <strong style={{color:cmData.income>=pmData.income?C.g:C.r}}>{cmData.income>=pmData.income?"â†‘":"â†“"} {fmt(Math.abs(cmData.income-pmData.income))}â‚¬</strong></div>
    <div style={{fontSize:11}}><span style={{color:C.td}}>DÃ©caissÃ©:</span> <strong style={{color:cmData.expense<=pmData.expense?C.g:C.r}}>{cmData.expense<=pmData.expense?"â†“":"â†‘"} {fmt(Math.abs(cmData.expense-pmData.expense))}â‚¬</strong></div>
   </div>
  </Card>}
  {accounts.length>0&&<Sect title="Comptes">{accounts.map((a,i)=><div key={a.id} className={`fu d${Math.min(i+1,4)}`} style={{display:"flex",alignItems:"center",gap:6,padding:"6px 10px",background:C.card,borderRadius:8,border:`1px solid ${C.brd}`,marginBottom:2}}><span style={{fontSize:12}}>ðŸ¦</span><span style={{flex:1,fontWeight:600,fontSize:12}}>{a.name}</span><span style={{fontWeight:800,fontSize:13,color:C.g}}>{fmt(a.balance)} {CURR_SYMBOLS[a.currency]||a.currency}</span></div>)}</Sect>}
  <Sect title={`Transactions du mois`} sub={`${(()=>{const excl=EXCLUDED_ACCOUNTS[soc?.id]||[];const now2=new Date();const mStart=new Date(now2.getFullYear(),now2.getMonth(),1);return transactions.filter(tx=>{const leg=tx.legs?.[0];if(!leg)return false;if(excl.includes(leg.account_id))return false;return new Date(tx.created_at)>=mStart;}).length;})()} transactions`}>
   {(()=>{const excl=EXCLUDED_ACCOUNTS[soc?.id]||[];const now2=new Date();const mStart=new Date(now2.getFullYear(),now2.getMonth(),1);const monthTx=transactions.filter(tx=>{const leg=tx.legs?.[0];if(!leg)return false;if(excl.includes(leg.account_id))return false;return new Date(tx.created_at)>=mStart;});return monthTx.length===0?<div style={{color:C.td,fontSize:11,padding:12,textAlign:"center"}}>Aucune transaction ce mois</div>:monthTx.map((tx,i)=>{const leg=tx.legs?.[0];if(!leg)return null;const isIn=leg.amount>0;const cat=categorizeTransaction(tx);const isDiv=cat.id==="dividendes";const catColors={"revenus":C.g,"loyer":"#f59e0b","pub":"#ec4899","abonnements":C.b,"equipe":C.o,"transfert":"#6366f1","dividendes":"#7c3aed","autres":C.td};
    return <div key={tx.id} className={`fu d${Math.min(i+1,8)}`} style={{display:"flex",alignItems:"center",gap:6,padding:"6px 8px",background:isDiv?"#7c3aed11":C.card,borderRadius:7,border:`1px solid ${isDiv?"#7c3aed33":C.brd}`,marginBottom:2}}>
    <span style={{width:20,height:20,borderRadius:5,background:isIn?C.gD:isDiv?"#7c3aed22":C.rD,display:"flex",alignItems:"center",justifyContent:"center",fontSize:9,fontWeight:900,color:isIn?C.g:isDiv?"#7c3aed":C.r,flexShrink:0}}>{cat.icon||"â†‘"}</span>
    <div style={{flex:1,minWidth:0}}><div style={{display:"flex",alignItems:"center",gap:4}}><span style={{fontWeight:600,fontSize:11,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{leg.description||tx.reference||"â€”"}</span><span style={{fontSize:9,padding:"1px 5px",borderRadius:8,background:(catColors[cat.id]||C.td)+"22",color:catColors[cat.id]||C.td,fontWeight:600,whiteSpace:"nowrap",flexShrink:0}}>{cat.label}</span></div><div style={{fontSize:9,color:C.td}}>{new Date(tx.created_at).toLocaleDateString("fr-FR")}</div></div>
    <span style={{fontWeight:700,fontSize:11,color:isIn?C.g:isDiv?"#7c3aed":C.r}}>{isIn?"+":""}{fmt(leg.amount)}â‚¬</span>
    </div>;});})()}
  </Sect>
 </>;
}
/* SYNERGIES MAP */
function SynergiesPanel({socs,synergies,saveSynergies}){
 const[editing,setEditing]=useState(null);
 const actS=socs.filter(s=>s.stat==="active"&&s.id!=="eco");
 const totalValue=synergies.filter(s=>s.status==="won").reduce((a,s)=>a+pf(s.value),0);
 const activeCount=synergies.filter(s=>s.status==="active").length;
 const matrix=useMemo(()=>{
  const m={};actS.forEach(s=>{m[s.id]={out:{},in:{}};});
  synergies.forEach(sy=>{
   if(m[sy.from])m[sy.from].out[sy.to]=(m[sy.from].out[sy.to]||0)+1;
   if(m[sy.to])m[sy.to].in[sy.from]=(m[sy.to].in[sy.from]||0)+1;
  });return m;
 },[actS,synergies]);
 const addSyn=()=>setEditing({id:uid(),from:actS[0]?.id||"",to:actS[1]?.id||"",type:"referral",desc:"",value:0,date:new Date().toISOString().slice(0,10),status:"active"});
 const saveSyn=()=>{if(!editing)return;const idx=synergies.findIndex(s=>s.id===editing.id);saveSynergies(idx>=0?synergies.map(s=>s.id===editing.id?editing:s):[...synergies,editing]);setEditing(null);};
 return <>
  <div style={{display:"flex",alignItems:"center",gap:8,marginTop:6,marginBottom:12,flexWrap:"wrap"}}>
   <KPI label="Valeur totale" value={`${fmt(totalValue)}â‚¬`} accent={C.g} small delay={1}/>
   <KPI label="En cours" value={activeCount} accent={C.b} small delay={2}/>
   <KPI label="Total" value={synergies.length} accent={C.acc} small delay={3}/>
   <Btn small onClick={addSyn}>+ Synergie</Btn>
  </div>
  <Card style={{padding:14,marginBottom:12}}>
   <div style={{color:C.td,fontSize:9,fontWeight:700,letterSpacing:.8,marginBottom:8}}>CARTE DES SYNERGIES</div>
   <div style={{display:"grid",gridTemplateColumns:`40px repeat(${actS.length},1fr)`,gap:1,fontSize:8}}>
    <div/>
    {actS.map(s=><div key={s.id} style={{textAlign:"center",fontWeight:700,color:s.color,padding:3,overflow:"hidden",textOverflow:"ellipsis"}}>{s.nom.slice(0,6)}</div>)}
    {actS.map(row=><Fragment key={row.id}>
    <div style={{fontWeight:700,color:row.color,padding:3,display:"flex",alignItems:"center"}}>{row.nom.slice(0,5)}</div>
    {actS.map(col=>{
    const count=(matrix[row.id]?.out[col.id]||0);
    const isself=row.id===col.id;
    return <div key={col.id} style={{textAlign:"center",padding:4,background:isself?C.tm:count>0?`${C.acc}${Math.min(99,count*25).toString(16).padStart(2,"0")}`:C.bg,borderRadius:3,color:count>0?C.acc:C.tm,fontWeight:count>0?700:400,cursor:count>0?"pointer":"default",border:`1px solid ${C.brd}`}} title={!isself?`${row.nom} â†’ ${col.nom}: ${count} synergies`:""}>{isself?"Â·":count||""}</div>;
    })}
    </Fragment>)}
   </div>
  </Card>
  <Sect title="Historique">
   {synergies.sort((a,b)=>new Date(b.date)-new Date(a.date)).map((sy,i)=>{
    const sf=socs.find(s=>s.id===sy.from);const st=socs.find(s=>s.id===sy.to);const tp=SYN_TYPES[sy.type]||SYN_TYPES.referral;const ss=SYN_STATUS[sy.status]||SYN_STATUS.active;
    return <div key={sy.id} className={`fu d${Math.min(i+1,8)}`} style={{display:"flex",alignItems:"center",gap:8,padding:"8px 10px",background:C.card,borderRadius:8,border:`1px solid ${C.brd}`,marginBottom:3,cursor:"pointer"}} onClick={()=>setEditing({...sy})}>
    <span style={{fontSize:12}}>{tp.icon}</span>
    <div style={{flex:1,minWidth:0}}>
    <div style={{fontSize:11,fontWeight:600}}><span style={{color:sf?.color}}>{sf?.nom}</span> â†’ <span style={{color:st?.color}}>{st?.nom}</span></div>
    <div style={{fontSize:9,color:C.td,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{sy.desc}</div>
    </div>
    {pf(sy.value)>0&&<span style={{fontSize:10,fontWeight:700,color:C.g}}>{fmt(sy.value)}â‚¬</span>}
    <span style={{fontSize:8,color:ss.color,background:ss.color+"18",padding:"1px 5px",borderRadius:6,fontWeight:600}}>{ss.label}</span>
    </div>;
   })}
  </Sect>
  <Modal open={!!editing} onClose={()=>setEditing(null)} title="Synergie">{editing&&<>
   <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"0 10px"}}>
    <Sel label="De" value={editing.from} onChange={v=>setEditing({...editing,from:v})} options={actS.map(s=>({v:s.id,l:s.nom}))}/>
    <Sel label="Vers" value={editing.to} onChange={v=>setEditing({...editing,to:v})} options={actS.map(s=>({v:s.id,l:s.nom}))}/>
    <Sel label="Type" value={editing.type} onChange={v=>setEditing({...editing,type:v})} options={Object.entries(SYN_TYPES).map(([k,v])=>({v:k,l:`${v.icon} ${v.label}`}))}/>
    <Sel label="Statut" value={editing.status} onChange={v=>setEditing({...editing,status:v})} options={Object.entries(SYN_STATUS).map(([k,v])=>({v:k,l:v.label}))}/>
    <Inp label="Valeur" type="number" value={editing.value} onChange={v=>setEditing({...editing,value:pf(v)})} suffix="â‚¬"/>
    <Inp label="Date" type="date" value={editing.date} onChange={v=>setEditing({...editing,date:v})}/>
   </div>
   <Inp label="Description" value={editing.desc} onChange={v=>setEditing({...editing,desc:v})} textarea placeholder="DÃ©tails de la synergieâ€¦"/>
   <div style={{display:"flex",gap:8,marginTop:12}}>
    <Btn onClick={saveSyn}>Sauver</Btn><Btn v="secondary" onClick={()=>setEditing(null)}>Annuler</Btn>
    {synergies.find(s=>s.id===editing.id)&&<Btn v="danger" onClick={()=>{saveSynergies(synergies.filter(s=>s.id!==editing.id));setEditing(null);}} style={{marginLeft:"auto"}}>Supprimer</Btn>}
   </div>
  </>}</Modal>
 </>;
}
/* KNOWLEDGE BASE */
function KnowledgeBase({socs,kb,saveKb,isPorteur,socId}){
 const[cat,setCat]=useState("all");const[search,setSearch]=useState("");const[editing,setEditing]=useState(null);const[expanded,setExpanded]=useState(null);
 const filtered=kb.filter(k=>(cat==="all"||k.cat===cat)&&(search===""||k.title.toLowerCase().includes(search.toLowerCase())||k.tags?.some(t=>t.includes(search.toLowerCase()))||k.content.toLowerCase().includes(search.toLowerCase())));
 const addEntry=()=>setEditing({id:uid(),title:"",cat:"tip",author:socId||"eco",content:"",tags:[],date:new Date().toISOString().slice(0,10),likes:0});
 const saveEntry=()=>{if(!editing||!editing.title.trim())return;const idx=kb.findIndex(k=>k.id===editing.id);saveKb(idx>=0?kb.map(k=>k.id===editing.id?editing:k):[...kb,editing]);setEditing(null);};
 const likeEntry=(id)=>saveKb(kb.map(k=>k.id===id?{...k,likes:(k.likes||0)+1}:k));
 return <>
  <div style={{display:"flex",alignItems:"center",gap:6,marginTop:6,marginBottom:12,flexWrap:"wrap"}}>
   <div style={{flex:"1 1 140px",position:"relative"}}>
    <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Rechercherâ€¦" style={{width:"100%",background:C.bg,border:`1px solid ${C.brd}`,borderRadius:8,color:C.t,padding:"7px 10px 7px 28px",fontSize:11,fontFamily:FONT,outline:"none"}}/>
    <span style={{position:"absolute",left:9,top:"50%",transform:"translateY(-50%)",fontSize:11,color:C.td}}>ðŸ”</span>
   </div>
   <select value={cat} onChange={e=>setCat(e.target.value)} style={{background:C.bg,border:`1px solid ${C.brd}`,borderRadius:8,color:C.t,padding:"6px 10px",fontSize:11,fontFamily:FONT,outline:"none"}}><option value="all">Toutes catÃ©gories</option>{Object.entries(KB_CATS).map(([k,v])=><option key={k} value={k}>{v.label}</option>)}</select>
   <Btn small onClick={addEntry}>+ Contribution</Btn>
  </div>
  <div style={{display:"flex",gap:4,marginBottom:12,flexWrap:"wrap"}}>
   {Object.entries(KB_CATS).map(([k,v])=>{const cnt=kb.filter(e=>e.cat===k).length;
    return <div key={k} onClick={()=>setCat(cat===k?"all":k)} style={{padding:"4px 10px",background:cat===k?v.color+"18":C.card2,border:`1px solid ${cat===k?v.color+"44":C.brd}`,borderRadius:8,fontSize:10,fontWeight:600,color:cat===k?v.color:C.td,cursor:"pointer",transition:"all .15s"}}>
    {v.label} <span style={{fontWeight:800}}>{cnt}</span>
    </div>;
   })}
  </div>
  {filtered.length===0&&<div className="fu" style={{textAlign:"center",padding:40,color:C.td}}>Aucun rÃ©sultat</div>}
  {filtered.sort((a,b)=>(b.likes||0)-(a.likes||0)).map((entry,i)=>{
   const s=socs.find(x=>x.id===entry.author);const catInfo=KB_CATS[entry.cat]||KB_CATS.tip;const isOpen=expanded===entry.id;
   return <Card key={entry.id} accent={catInfo.color} style={{marginBottom:6,padding:12,cursor:"pointer"}} delay={Math.min(i+1,8)} onClick={()=>setExpanded(isOpen?null:entry.id)}>
    <div style={{display:"flex",alignItems:"flex-start",gap:8}}>
    <span style={{fontSize:16,marginTop:2}}>{catInfo.label.split(" ")[0]}</span>
    <div style={{flex:1,minWidth:0}}>
    <div style={{fontWeight:700,fontSize:12,color:C.t,marginBottom:2}}>{entry.title}</div>
    <div style={{display:"flex",gap:6,alignItems:"center",fontSize:9,color:C.td}}>
    {s&&<span style={{color:s.color,fontWeight:600}}>{s.nom}</span>}
    <span>{new Date(entry.date).toLocaleDateString("fr-FR")}</span>
    {entry.tags?.map(t=><span key={t} style={{background:C.card2,padding:"0 4px",borderRadius:3}}>#{t}</span>)}
    </div>
    {isOpen&&<div style={{marginTop:8,padding:"10px 12px",background:C.bg,borderRadius:8,fontSize:11,color:C.t,lineHeight:1.6,whiteSpace:"pre-wrap",border:`1px solid ${C.brd}`}}>{entry.content}</div>}
    </div>
    <div style={{display:"flex",flexDirection:"column",alignItems:"center",gap:2}}>
    <button onClick={e=>{e.stopPropagation();likeEntry(entry.id);}} style={{background:"none",border:"none",cursor:"pointer",fontSize:12,padding:2}}>ðŸ‘</button>
    <span style={{fontSize:10,fontWeight:700,color:C.acc}}>{entry.likes||0}</span>
    </div>
    </div>
    {isOpen&&<div style={{display:"flex",gap:4,marginTop:8}}>
    <Btn small v="ghost" onClick={e=>{e.stopPropagation();setEditing({...entry});}}>âœï¸ Modifier</Btn>
    <Btn small v="ghost" onClick={e=>{e.stopPropagation();saveKb(kb.filter(k=>k.id!==entry.id));}}>ðŸ—‘</Btn>
    </div>}
   </Card>;
  })}
  <Modal open={!!editing} onClose={()=>setEditing(null)} title="Knowledge Base">{editing&&<>
   <Inp label="Titre" value={editing.title} onChange={v=>setEditing({...editing,title:v})} placeholder="Ex: Playbook Cold Outreach"/>
   <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"0 10px"}}>
    <Sel label="CatÃ©gorie" value={editing.cat} onChange={v=>setEditing({...editing,cat:v})} options={Object.entries(KB_CATS).map(([k,v])=>({v:k,l:v.label}))}/>
    <Sel label="Auteur" value={editing.author} onChange={v=>setEditing({...editing,author:v})} options={socs.map(s=>({v:s.id,l:s.nom}))}/>
   </div>
   <Inp label="Contenu" value={editing.content} onChange={v=>setEditing({...editing,content:v})} textarea placeholder="Le contenu partagÃ©â€¦"/>
   <Inp label="Tags (sÃ©parÃ©s par virgule)" value={(editing.tags||[]).join(", ")} onChange={v=>setEditing({...editing,tags:v.split(",").map(t=>t.trim().toLowerCase()).filter(Boolean)})} placeholder="vente, prospection, template"/>
   <div style={{display:"flex",gap:8,marginTop:12}}><Btn onClick={saveEntry}>Publier</Btn><Btn v="secondary" onClick={()=>setEditing(null)}>Annuler</Btn></div>
  </>}</Modal>
 </>;
}
/* 1. MATRICE DE RISQUE PORTFOLIO */
function RiskMatrix({socs,reps,allM}){
 const cM2=curM();const pm=prevM(cM2);const[hover,setHover]=useState(null);
 const data=socs.filter(s=>s.stat==="active"&&s.id!=="eco").map(s=>{
  const r=gr(reps,s.id,cM2),rp=gr(reps,s.id,pm);
  const ca=pf(r?.ca),caPrev=pf(rp?.ca),ch=pf(r?.charges);
  const growth=caPrev>0?Math.round((ca-caPrev)/caPrev*100):-100;
  const margin=ca>0?Math.round((ca-ch)/ca*100):0;
  return{nom:s.nom,color:s.color,growth:clamp(growth,-50,150),margin:clamp(margin,-30,80),ca:Math.max(ca,500),porteur:s.porteur,id:s.id};
 }).filter(d=>d.ca>0);
 const W=320,H=240,P={t:20,r:20,b:30,l:40};
 const xMin=-50,xMax=150,yMin=-30,yMax=80;
 const sx=v=>P.l+(v-xMin)/(xMax-xMin)*(W-P.l-P.r);
 const sy=v=>H-P.b-(v-yMin)/(yMax-yMin)*(H-P.t-P.b);
 return <Sect title="Matrice de risque" sub="Croissance Ã— RentabilitÃ© â€” taille = CA">
  <Card style={{padding:14}}>
   <svg viewBox={`0 0 ${W} ${H}`} style={{width:"100%",height:"auto",maxHeight:280}}>
    <line x1={P.l} y1={P.t} x2={P.l} y2={H-P.b} stroke={C.brd} strokeWidth={1}/>
    <line x1={P.l} y1={H-P.b} x2={W-P.r} y2={H-P.b} stroke={C.brd} strokeWidth={1}/>
    <line x1={sx(0)} y1={P.t} x2={sx(0)} y2={H-P.b} stroke={C.brd} strokeDasharray="3 3" strokeWidth={.5}/>
    <line x1={P.l} y1={sy(0)} x2={W-P.r} y2={sy(0)} stroke={C.brd} strokeDasharray="3 3" strokeWidth={.5}/>
    {[-50,0,50,100,150].map(v=><text key={"x"+v} x={sx(v)} y={H-P.b+12} textAnchor="middle" fill={C.td} fontSize={7}>{v}%</text>)}
    {[-30,0,30,60].map(v=><text key={"y"+v} x={P.l-4} y={sy(v)+3} textAnchor="end" fill={C.td} fontSize={7}>{v}%</text>)}
    <text x={W/2} y={H-2} textAnchor="middle" fill={C.td} fontSize={8}>Croissance %</text>
    <text x={8} y={H/2} textAnchor="middle" fill={C.td} fontSize={8} transform={`rotate(-90,8,${H/2})`}>Marge %</text>
    <rect x={sx(0)} y={P.t} width={W-P.r-sx(0)} height={sy(0)-P.t} fill={C.g} opacity={.03}/>
    <rect x={P.l} y={P.t} width={sx(0)-P.l} height={sy(0)-P.t} fill={C.acc} opacity={.03}/>
    <rect x={sx(0)} y={sy(0)} width={W-P.r-sx(0)} height={H-P.b-sy(0)} fill={C.o} opacity={.03}/>
    <rect x={P.l} y={sy(0)} width={sx(0)-P.l} height={H-P.b-sy(0)} fill={C.r} opacity={.03}/>
    {data.map(d=>{const r2=clamp(d.ca/600,6,20);return <g key={d.id} onMouseEnter={()=>setHover(d)} onMouseLeave={()=>setHover(null)} style={{cursor:"pointer"}}>
    <circle cx={sx(d.growth)} cy={sy(d.margin)} r={r2} fill={d.color+"66"} stroke={d.color} strokeWidth={1.5}/>
    <text x={sx(d.growth)} y={sy(d.margin)-r2-3} textAnchor="middle" fill={C.t} fontSize={7} fontWeight={700}>{d.nom}</text>
    </g>;})}
   </svg>
   {hover&&<div style={{background:C.card2,border:`1px solid ${C.brd}`,borderRadius:8,padding:"6px 10px",marginTop:6}}>
    <span style={{fontWeight:700,fontSize:11,color:hover.color}}>{hover.nom}</span> <span style={{fontSize:9,color:C.td}}>({hover.porteur})</span>
    <div style={{display:"flex",gap:12,marginTop:3,fontSize:10}}>
    <span>CA: <strong>{fmt(hover.ca)}â‚¬</strong></span>
    <span>Croissance: <strong style={{color:hover.growth>=0?C.g:C.r}}>{hover.growth>0?"+":""}{hover.growth}%</strong></span>
    <span>Marge: <strong style={{color:hover.margin>=0?C.g:C.r}}>{hover.margin}%</strong></span>
    </div>
   </div>}
   <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6,marginTop:10}}>
    {[["â­ Stars","Croissance+ & Marge+",C.g],["ðŸ’° Cash cows","Marge+ mais stagne",C.acc],["ðŸš€ Ã€ surveiller","CroÃ®t mais pas rentable",C.o],["âš  Critique","DÃ©clin & pertes",C.r]].map(([l,d,c],i)=>
    <div key={i} style={{display:"flex",alignItems:"center",gap:5,padding:"4px 8px",background:c+"08",borderRadius:6,border:`1px solid ${c}18`}}>
    <span style={{fontSize:10}}>{l.split(" ")[0]}</span>
    <div><div style={{fontSize:9,fontWeight:600,color:c}}>{l.split(" ").slice(1).join(" ")}</div><div style={{fontSize:7,color:C.td}}>{d}</div></div>
    </div>
    )}
   </div>
  </Card>
 </Sect>;
}
/* 2. ALERTES INTELLIGENTES */
function calcSmartAlerts(socs,reps,actions,pulses,allM,socBank){
 const cM2=curM();const pm=prevM(cM2);const alerts=[];
 socs.filter(s=>s.stat==="active"&&s.id!=="eco").forEach(s=>{
  const r=gr(reps,s.id,cM2),rp=gr(reps,s.id,pm),rpp=gr(reps,s.id,prevM(pm));
  const ca=pf(r?.ca),caPrev=pf(rp?.ca),caPP=pf(rpp?.ca);
  const ch=pf(r?.charges);const rw=runway(reps,s.id,allM);
  if(caPrev>0&&ca>0&&(ca-caPrev)/caPrev<-.3)alerts.push({soc:s,type:"danger",icon:"ðŸ“‰",title:`${s.nom}: CA en chute`,desc:`${fmt(ca)}â‚¬ vs ${fmt(caPrev)}â‚¬ (-${Math.abs(Math.round((ca-caPrev)/caPrev*100))}%)`,priority:1});
  if(caPrev>0&&caPP>0&&ca<caPrev&&caPrev<caPP)alerts.push({soc:s,type:"warning",icon:"âš ï¸",title:`${s.nom}: tendance baissiÃ¨re`,desc:"2 mois consÃ©cutifs de baisse du CA",priority:2});
  if(rw&&rw.months<3&&rw.months>0)alerts.push({soc:s,type:"danger",icon:"ðŸ”¥",title:`${s.nom}: runway critique`,desc:`${rw.months} mois restants (${fmt(rw.treso)}â‚¬)`,priority:1});
  if(ca>0&&ch>ca)alerts.push({soc:s,type:"danger",icon:"ðŸ’¸",title:`${s.nom}: marge nÃ©gative`,desc:`Charges (${fmt(ch)}â‚¬) > CA (${fmt(ca)}â‚¬)`,priority:1});
  if(!r)alerts.push({soc:s,type:"warning",icon:"ðŸ“‹",title:`${s.nom}: rapport manquant`,desc:`Aucun rapport soumis pour ${ml(cM2)}`,priority:3});
  if(ca>0&&s.obj>0&&ca>=s.obj*1.2)alerts.push({soc:s,type:"success",icon:"ðŸŽ¯",title:`${s.nom}: objectif Ã©crasÃ© !`,desc:`${fmt(ca)}â‚¬ vs obj ${fmt(s.obj)}â‚¬ (+${Math.round((ca/s.obj-1)*100)}%)`,priority:4});
  if(caPrev>0&&ca>=caPrev*2)alerts.push({soc:s,type:"success",icon:"ðŸš€",title:`${s.nom}: CA doublÃ© !`,desc:`${fmt(ca)}â‚¬ vs ${fmt(caPrev)}â‚¬ le mois dernier`,priority:4});
  const lastPulse=Object.entries(pulses).filter(([k])=>k.startsWith(s.id+"_")).pop();
  if(!lastPulse||!lastPulse[1]?.at||(Date.now()-new Date(lastPulse[1].at).getTime())>14*864e5)alerts.push({soc:s,type:"info",icon:"ðŸ“¡",title:`${s.nom}: silence radio`,desc:"Pas de pulse depuis 2+ semaines",priority:3});
  const sb=socBank?.[s.id];
  if(sb&&sb.balance<1000)alerts.push({soc:s,type:"danger",icon:"ðŸ¦",title:`${s.nom}: solde bancaire bas`,desc:`Seulement ${fmt(sb.balance)}â‚¬ en banque`,priority:1});
 });
 return alerts.sort((a,b)=>a.priority-b.priority);
}
function SmartAlertsPanel({alerts}){
 if(alerts.length===0)return <Card style={{padding:20,textAlign:"center"}}><span style={{fontSize:28}}>âœ…</span><div style={{color:C.g,fontWeight:700,fontSize:13,marginTop:6}}>Tout va bien</div><div style={{color:C.td,fontSize:10}}>Aucune alerte dÃ©tectÃ©e</div></Card>;
 const typeStyles={danger:{bg:C.rD,brd:C.r},warning:{bg:C.oD,brd:C.o},success:{bg:C.gD,brd:C.g},info:{bg:C.bD,brd:C.b}};
 return <div>{alerts.map((a,i)=>{const st=typeStyles[a.type]||typeStyles.info;
  return <div key={i} className={`fu d${Math.min(i+1,8)}`} style={{display:"flex",alignItems:"center",gap:8,padding:"8px 12px",background:st.bg,border:`1px solid ${st.brd}18`,borderRadius:8,marginBottom:4}}>
   <span style={{fontSize:16}}>{a.icon}</span>
   <div style={{flex:1}}>
    <div style={{fontWeight:700,fontSize:11,color:st.brd}}>{a.title}</div>
    <div style={{fontSize:9,color:C.td}}>{a.desc}</div>
   </div>
   <span style={{width:6,height:6,borderRadius:3,background:a.soc.color,flexShrink:0}}/>
  </div>;
 })}</div>;
}
/* 3. COHORT ANALYSIS */
function CohortAnalysis({socs,reps,allM}){
 const cohorts=useMemo(()=>{
  const groups={};
  socs.filter(s=>s.incub&&s.stat!=="signature").forEach(s=>{
   const d=new Date(s.incub);const q=`${d.getFullYear()}-Q${Math.ceil((d.getMonth()+1)/3)}`;
   if(!groups[q])groups[q]={label:q,socs:[]};
   groups[q].socs.push(s);
  });
  return Object.values(groups).sort((a,b)=>a.label.localeCompare(b.label));
 },[socs]);
 const cohortData=useMemo(()=>{
  return cohorts.map(c=>{
   const metrics=c.socs.map(s=>{
    const reports=allM.map(m=>{const r=gr(reps,s.id,m);return r?{m,ca:pf(r.ca),ch:pf(r.charges)}:null;}).filter(Boolean);
    const totalCA=reports.reduce((a,r2)=>a+r2.ca,0);
    const avgCA=reports.length>0?Math.round(totalCA/reports.length):0;
    const months=sinceMonths(s.incub);
    const lastCA=reports.length>0?reports[reports.length-1].ca:0;
    return{nom:s.nom,color:s.color,totalCA,avgCA,months,lastCA,reportsCount:reports.length};
   });
   const avgTotalCA=metrics.length?Math.round(metrics.reduce((a,m)=>a+m.totalCA,0)/metrics.length):0;
   const avgMonthlyCA=metrics.length?Math.round(metrics.reduce((a,m)=>a+m.avgCA,0)/metrics.length):0;
   const avgReports=metrics.length?Math.round(metrics.reduce((a,m)=>a+m.reportsCount,0)/metrics.length):0;
   return{...c,metrics,avgTotalCA,avgMonthlyCA,avgReports};
  });
 },[cohorts,reps,allM]);
 return <Sect title="Analyse par cohorte" sub="Performance par promotion d'incubation">
  {cohortData.length===0&&<div className="fu" style={{textAlign:"center",padding:40,color:C.td}}>Ajoutez des dates d'incubation pour voir les cohortes</div>}
  {cohortData.length>0&&<Card style={{padding:14,marginBottom:12}}>
   <div style={{height:200}}><ResponsiveContainer><BarChart data={cohortData.map(c=>({name:c.label,CA_moy:c.avgMonthlyCA,SociÃ©tÃ©s:c.socs.length}))}>
    <CartesianGrid strokeDasharray="3 3" stroke={C.brd}/>
    <XAxis dataKey="name" tick={{fill:C.td,fontSize:9}} axisLine={false} tickLine={false}/>
    <YAxis tick={{fill:C.td,fontSize:9}} axisLine={false} tickLine={false} tickFormatter={v=>`${fK(v)}â‚¬`}/>
    <Tooltip content={<CTip/>}/>
    <Bar dataKey="CA_moy" fill={C.acc} radius={[4,4,0,0]} name="CA moyen/mois"/>
   </BarChart></ResponsiveContainer></div>
  </Card>}
  {cohortData.map((c,ci)=>
   <Card key={c.label} accent={C.v} style={{marginBottom:8,padding:14}} delay={Math.min(ci+1,6)}>
    <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8}}>
    <div><span style={{fontWeight:800,fontSize:14,color:C.v}}>{c.label}</span><span style={{color:C.td,fontSize:10,marginLeft:6}}>{c.socs.length} sociÃ©tÃ©{c.socs.length>1?"s":""}</span></div>
    <div style={{display:"flex",gap:8}}>
    <div style={{textAlign:"center"}}><div style={{fontSize:8,color:C.td}}>CA moy</div><div style={{fontWeight:800,fontSize:12,color:C.acc}}>{fmt(c.avgMonthlyCA)}â‚¬</div></div>
    <div style={{textAlign:"center"}}><div style={{fontSize:8,color:C.td}}>Rapports</div><div style={{fontWeight:800,fontSize:12,color:C.b}}>{c.avgReports}</div></div>
    </div>
    </div>
    <div style={{display:"flex",gap:4,flexWrap:"wrap"}}>
    {c.metrics.map(m=>
    <div key={m.nom} style={{display:"flex",alignItems:"center",gap:4,padding:"3px 8px",background:C.bg,borderRadius:6,border:`1px solid ${m.color}22`}}>
    <span style={{width:4,height:4,borderRadius:2,background:m.color}}/>
    <span style={{fontSize:9,fontWeight:600}}>{m.nom}</span>
    <span style={{fontSize:8,color:C.td}}>CA:{fmt(m.avgCA)}â‚¬</span>
    <span style={{fontSize:7,color:C.td}}>{m.months}m</span>
    </div>
    )}
    </div>
   </Card>
  )}
 </Sect>;
}
/* 4. CHALLENGES INTER-SOCIÃ‰TÃ‰S */
const CHALLENGE_TEMPLATES=[
 {id:"c_double",title:"ðŸ”¥ DoublÃ©",desc:"Doubler son CA vs mois dernier",metric:"ca_growth",target:100,unit:"%",icon:"ðŸ”¥"},
 {id:"c_margin",title:"ðŸ’Ž Marge d'or",desc:"Atteindre 60%+ de marge",metric:"margin",target:60,unit:"%",icon:"ðŸ’Ž"},
 {id:"c_pipeline",title:"ðŸŽ¯ Pipeline monstre",desc:"Pipeline > 2Ã— CA",metric:"pipeline_ratio",target:200,unit:"%",icon:"ðŸŽ¯"},
 {id:"c_streak",title:"ðŸ“ˆ SÃ©rie verte",desc:"3 mois consÃ©cutifs de hausse",metric:"growth_streak",target:3,unit:"mois",icon:"ðŸ“ˆ"},
 {id:"c_reports",title:"ðŸ“Š Exemplaire",desc:"Rapport soumis avant le 5 du mois",metric:"early_report",target:1,unit:"",icon:"ðŸ“Š"},
 {id:"c_pulse",title:"âš¡ Ultra-connectÃ©",desc:"Pulse envoyÃ© chaque semaine ce mois",metric:"pulse_count",target:4,unit:"",icon:"âš¡"},
];
/* ABONNEMENTS & Ã‰QUIPE PANEL */
function SubsTeamPanel({socs,subs,saveSubs,team,saveTeam,socId,reps,isCompact,socBankData,revData}){
 const[editSub,setEditSub]=useState(null);const[editTm,setEditTm]=useState(null);const[showRecon,setShowRecon]=useState(false);
 const[catFilter,setCatFilter]=useState("all");const[autoSubs,setAutoSubs]=useState([]);
 const cM2=curM();
 const bankData0=socId==="all"?null:(socId==="holding"?revData:socBankData);
 const detectSubs=useCallback(()=>{const detected=autoDetectSubscriptions(bankData0,socId);setAutoSubs(detected);},[bankData0,socId]);
 useEffect(()=>{detectSubs();},[detectSubs]);
 const manualSubs=socId==="all"?subs:subs.filter(s=>s.socId===socId);
 const manualNames=new Set(manualSubs.map(s=>s.name.toLowerCase().replace(/[^a-z0-9]/g,"")));
 const mergedAutoSubs=autoSubs.filter(a=>!manualNames.has(a.name.toLowerCase().replace(/[^a-z0-9]/g,"")));
 const mySubs=catFilter==="all"?[...manualSubs,...mergedAutoSubs]:[...manualSubs,...mergedAutoSubs].filter(s=>s.cat===catFilter);
 const myTeam=socId==="all"?team:team.filter(t=>t.socId===socId);
 const bankData=bankData0;
 const matchedSubs=useMemo(()=>matchSubsToRevolut(mySubs,bankData,socId),[mySubs,bankData,socId]);
 const matchedCount=matchedSubs.filter(s=>s.revMatch).length;
 const unmatchedCount=matchedSubs.filter(s=>!s.revMatch).length;
 const totalSubsMonthly=mySubs.reduce((a,s)=>a+subMonthly(s),0);
 const totalTeamMonthly=myTeam.reduce((a,t)=>{
  const ca=t.socId!=="holding"?pf(gr(reps,t.socId,cM2)?.ca):0;
  return a+teamMonthly(t,ca);
 },0);
 const totalChargesRecurrentes=totalSubsMonthly+totalTeamMonthly;
 const matchedSubsMonthly=matchedSubs.filter(s=>s.revMatch).reduce((a,s)=>a+subMonthly(s),0);
 const addSub=()=>{const ns={id:uid(),socId:socId==="all"?"holding":socId,name:"",amount:0,freq:"monthly",cat:"logiciel",start:new Date().toISOString().slice(0,10),notes:""};setEditSub(ns);};
 const addTm=()=>{const nt={id:uid(),socId:socId==="all"?"holding":socId,name:"",role:"",payType:"fixed",amount:0,notes:""};setEditTm(nt);};
 const saveSub=(s)=>{const idx=subs.findIndex(x=>x.id===s.id);if(idx>=0){const ns=[...subs];ns[idx]=s;saveSubs(ns);}else saveSubs([...subs,s]);setEditSub(null);};
 const deleteSub=(id)=>saveSubs(subs.filter(s=>s.id!==id));
 const saveTm2=(t)=>{const idx=team.findIndex(x=>x.id===t.id);if(idx>=0){const nt=[...team];nt[idx]=t;saveTeam(nt);}else saveTeam([...team,t]);setEditTm(null);};
 const deleteTm=(id)=>saveTeam(team.filter(t=>t.id!==id));
 return <div>
  {!isCompact&&<Card accent={C.r} style={{padding:14,marginBottom:12}}>
   <div style={{display:"flex",alignItems:"center",justifyContent:"space-between"}}>
    <div>
    <div style={{color:C.td,fontSize:9,fontWeight:700,letterSpacing:.8}}>CHARGES RÃ‰CURRENTES / MOIS</div>
    <div style={{fontWeight:900,fontSize:24,color:C.r,marginTop:2}}>{fmt(totalChargesRecurrentes)}â‚¬</div>
    </div>
    <div style={{display:"flex",gap:10}}>
    <div style={{textAlign:"center"}}><div style={{fontWeight:700,fontSize:14,color:C.b}}>{fmt(totalSubsMonthly)}â‚¬</div><div style={{fontSize:8,color:C.td}}>Abonnements</div></div>
    <div style={{textAlign:"center"}}><div style={{fontWeight:700,fontSize:14,color:C.o}}>{fmt(totalTeamMonthly)}â‚¬</div><div style={{fontSize:8,color:C.td}}>Ã‰quipe</div></div>
    </div>
   </div>
   {totalChargesRecurrentes>0&&<div style={{display:"flex",gap:2,marginTop:8,height:6,borderRadius:3,overflow:"hidden"}}>
    <div style={{width:`${pct(totalSubsMonthly,totalChargesRecurrentes)}%`,background:C.b,borderRadius:3,transition:"width .3s"}}/>
    <div style={{width:`${pct(totalTeamMonthly,totalChargesRecurrentes)}%`,background:C.o,borderRadius:3,transition:"width .3s"}}/>
   </div>}
   {bankData&&mySubs.length>0&&<div style={{marginTop:8,padding:"6px 8px",background:C.bg,borderRadius:6,display:"flex",alignItems:"center",justifyContent:"space-between"}}>
    <div style={{display:"flex",alignItems:"center",gap:6}}>
    <span style={{fontSize:10}}>ðŸ¦</span>
    <span style={{fontSize:9,color:C.td}}>Rapprochement Revolut :</span>
    <span style={{fontSize:9,fontWeight:700,color:C.g}}>{matchedCount} matchÃ©s</span>
    {unmatchedCount>0&&<span style={{fontSize:9,fontWeight:700,color:C.o}}>{unmatchedCount} non trouvÃ©s</span>}
    </div>
    <button onClick={()=>setShowRecon(!showRecon)} style={{background:"none",border:"none",color:C.acc,fontSize:9,cursor:"pointer",fontFamily:FONT,fontWeight:600}}>{showRecon?"Masquer":"Voir dÃ©tail"}</button>
   </div>}
   {matchedSubsMonthly>0&&<div style={{marginTop:4,padding:"4px 8px",background:C.gD,borderRadius:6,display:"flex",alignItems:"center",gap:4}}>
    <span style={{fontSize:10}}>âœ…</span>
    <span style={{fontSize:9,color:C.g,fontWeight:600}}>{fmt(matchedSubsMonthly)}â‚¬/mois dÃ©jÃ  dans Revolut â€” pas de doublon dans l'analyse</span>
   </div>}
  </Card>}
  {showRecon&&bankData&&<Card accent={C.b} style={{padding:14,marginBottom:12}}>
   <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:10}}>
    <span style={{fontSize:14}}>ðŸ”</span>
    <div style={{fontWeight:800,fontSize:12,color:C.b}}>Rapprochement bancaire</div>
   </div>
   {matchedSubs.map((s,i)=><div key={s.id} className={`fu d${Math.min(i+1,8)}`} style={{display:"flex",alignItems:"center",gap:6,padding:"5px 8px",background:C.bg,borderRadius:6,marginBottom:2}}>
    <span style={{fontSize:10}}>{s.revMatch?"âœ…":"âŒ"}</span>
    <span style={{flex:1,fontSize:10,fontWeight:600}}>{s.name}</span>
    <span style={{fontSize:9,color:C.td}}>{fmt(s.amount)}â‚¬/{s.freq==="annual"?"an":"m"}</span>
    {s.revMatch&&<>
    <span style={{fontSize:8,color:C.g,background:C.gD,padding:"1px 5px",borderRadius:4}}>= {fmt(s.revMatch.txAmount)}â‚¬ Revolut</span>
    <span style={{fontSize:8,color:C.td}}>Dernier: {new Date(s.revMatch.lastPayment).toLocaleDateString("fr-FR",{day:"numeric",month:"short"})}</span>
    <span style={{fontSize:8,color:C.b,fontWeight:600}}>Prochain: {new Date(s.revMatch.nextPayment).toLocaleDateString("fr-FR",{day:"numeric",month:"short"})}</span>
    </>}
    {!s.revMatch&&<span style={{fontSize:8,color:C.o,background:C.oD,padding:"1px 5px",borderRadius:4}}>Aucune transaction trouvÃ©e</span>}
   </div>)}
   <div style={{marginTop:6,fontSize:9,color:C.td,lineHeight:1.4}}>Le matching compare le nom de l'abonnement avec les transactions Revolut (similaritÃ© â‰¥50%, montant Â±30%). Les abos matchÃ©s ne sont pas comptÃ©s en double dans l'analyse des charges.</div>
  </Card>}
  <Sect title="ðŸ’» Abonnements" right={<div style={{display:"flex",gap:4,alignItems:"center"}}><Btn small onClick={detectSubs}>ðŸ”„ DÃ©tecter</Btn><Btn small onClick={addSub}>+ Abo</Btn></div>} sub={`${mySubs.length} Â· ${fmt(totalSubsMonthly)}â‚¬/mois Â· ${fmt(totalSubsMonthly*12)}â‚¬/an`}>
   <div style={{display:"flex",gap:3,flexWrap:"wrap",marginBottom:8}}>
    <button onClick={()=>setCatFilter("all")} style={{background:catFilter==="all"?C.acc+"22":"transparent",border:`1px solid ${catFilter==="all"?C.acc:C.brd}`,borderRadius:6,padding:"2px 8px",fontSize:9,color:catFilter==="all"?C.acc:C.td,cursor:"pointer",fontFamily:FONT,fontWeight:600}}>Tous</button>
    {Object.entries(SUB_CATS).map(([k,v])=><button key={k} onClick={()=>setCatFilter(k)} style={{background:catFilter===k?v.c+"22":"transparent",border:`1px solid ${catFilter===k?v.c:C.brd}`,borderRadius:6,padding:"2px 8px",fontSize:9,color:catFilter===k?v.c:C.td,cursor:"pointer",fontFamily:FONT,fontWeight:600}}>{v.icon} {v.l}</button>)}
   </div>
   {mergedAutoSubs.length>0&&<div style={{padding:"6px 8px",background:C.bD,borderRadius:6,marginBottom:8,display:"flex",alignItems:"center",gap:6}}>
    <span style={{fontSize:10}}>ðŸ¤–</span><span style={{fontSize:9,color:C.b,fontWeight:600}}>{mergedAutoSubs.length} abonnement{mergedAutoSubs.length>1?"s":""} auto-dÃ©tectÃ©{mergedAutoSubs.length>1?"s":""} depuis Revolut</span>
   </div>}
   {mySubs.length===0&&<div style={{color:C.td,fontSize:11,padding:12,textAlign:"center"}}>Aucun abonnement</div>}
   {Object.entries(SUB_CATS).map(([cat,info])=>{
    const catSubs=mySubs.filter(s=>s.cat===cat);
    if(catSubs.length===0)return null;
    const catTotal=catSubs.reduce((a,s)=>a+subMonthly(s),0);
    return <div key={cat} style={{marginBottom:8}}>
    <div style={{display:"flex",alignItems:"center",gap:4,marginBottom:4}}>
    <span style={{fontSize:10}}>{info.icon}</span>
    <span style={{fontSize:10,fontWeight:700,color:C.td}}>{info.l}</span>
    <span style={{fontSize:9,color:info.c,fontWeight:700,marginLeft:"auto"}}>{fmt(catTotal)}â‚¬/m</span>
    </div>
    {catSubs.map((s,i)=>{
    const soc=socs.find(x=>x.id===s.socId);
    const ms=matchedSubs.find(m=>m.id===s.id);
    const rm=ms?.revMatch;
    return <div key={s.id} className={`fu d${Math.min(i+1,5)}`} style={{display:"flex",alignItems:"center",gap:6,padding:"6px 10px",background:C.card,borderRadius:8,border:`1px solid ${rm?C.g+"33":C.brd}`,marginBottom:2,cursor:"pointer"}} onClick={()=>setEditSub({...s})}>
    <div style={{flex:1,minWidth:0}}>
    <div style={{display:"flex",alignItems:"center",gap:4}}>
    <span style={{fontWeight:600,fontSize:11}}>{s.name}</span>
    {socId==="all"&&soc&&<span style={{fontSize:8,color:soc.color,background:soc.color+"18",padding:"1px 5px",borderRadius:8}}>{soc.nom}</span>}
    {socId==="all"&&s.socId==="holding"&&<span style={{fontSize:8,color:C.v,background:C.vD,padding:"1px 5px",borderRadius:8}}>Holding</span>}
    {rm&&<span style={{fontSize:7,color:C.g,background:C.gD,padding:"1px 4px",borderRadius:4,fontWeight:700}} title={`MatchÃ© avec "${rm.txDesc}" sur Revolut`}>ðŸ¦ âœ“</span>}
    {s.auto&&<span style={{fontSize:7,color:C.b,background:C.bD,padding:"1px 4px",borderRadius:4,fontWeight:700}}>ðŸ¤– auto</span>}
    </div>
    {s.notes&&<div style={{color:C.td,fontSize:9,marginTop:1}}>{s.notes}</div>}
    {rm&&<div style={{display:"flex",gap:8,marginTop:2}}>
    <span style={{fontSize:8,color:C.td}}>Dernier paiement : <strong style={{color:C.t}}>{new Date(rm.lastPayment).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"})}</strong></span>
    <span style={{fontSize:8,color:C.b,fontWeight:600}}>Prochain : {new Date(rm.nextPayment).toLocaleDateString("fr-FR",{day:"numeric",month:"short"})}</span>
    </div>}
    </div>
    <div style={{textAlign:"right"}}>
    <div style={{fontWeight:700,fontSize:12,color:C.t}}>{fmt(s.amount)}â‚¬<span style={{fontSize:8,color:C.td,fontWeight:400}}>/{s.freq==="annual"?"an":"m"}</span></div>
    <div style={{fontSize:8,color:C.td}}>{s.freq==="annual"?`${fmt(Math.round(s.amount/12))}â‚¬/m`:`${fmt(s.amount*12)}â‚¬/an`}</div>
    {rm&&rm.txAmount!==s.amount&&<div style={{fontSize:7,color:C.o}}>Revolut: {fmt(rm.txAmount)}â‚¬</div>}
    </div>
    </div>;
    })}
    </div>;
   })}
  </Sect>
  <Sect title="ðŸ‘¥ Ã‰quipe & Prestataires" right={<Btn small onClick={addTm}>+ Membre</Btn>} sub={`${myTeam.length} Â· ${fmt(totalTeamMonthly)}â‚¬/mois`}>
   {myTeam.length===0&&<div style={{color:C.td,fontSize:11,padding:12,textAlign:"center"}}>Aucun membre</div>}
   {myTeam.map((t,i)=>{
    const soc=socs.find(x=>x.id===t.socId);
    const ca=t.socId!=="holding"?pf(gr(reps,t.socId,cM2)?.ca):0;
    const cost=teamMonthly(t,ca);
    return <Card key={t.id} style={{marginBottom:3,padding:"10px 12px",cursor:"pointer"}} delay={Math.min(i+1,6)} onClick={()=>setEditTm({...t})}>
    <div style={{display:"flex",alignItems:"center",gap:8}}>
    <div style={{width:32,height:32,borderRadius:8,background:t.payType==="fixed"?C.bD:C.oD,border:`1.5px solid ${t.payType==="fixed"?C.b:C.o}33`,display:"flex",alignItems:"center",justifyContent:"center",fontWeight:800,fontSize:13,color:t.payType==="fixed"?C.b:C.o}}>{t.name?t.name[0]:"?"}</div>
    <div style={{flex:1,minWidth:0}}>
    <div style={{display:"flex",alignItems:"center",gap:4}}>
    <span style={{fontWeight:700,fontSize:12}}>{t.name||"Sans nom"}</span>
    <span style={{fontSize:9,color:C.td,background:C.card2,padding:"1px 5px",borderRadius:8}}>{t.role}</span>
    </div>
    <div style={{display:"flex",gap:6,marginTop:2}}>
    {socId==="all"&&soc&&<span style={{fontSize:8,color:soc.color}}>ðŸ“ {soc.nom}</span>}
    {socId==="all"&&t.socId==="holding"&&<span style={{fontSize:8,color:C.v}}>ðŸ“ Holding</span>}
    {t.notes&&<span style={{fontSize:8,color:C.td}}>{t.notes}</span>}
    </div>
    </div>
    <div style={{textAlign:"right"}}>
    <div style={{fontWeight:800,fontSize:14,color:t.payType==="fixed"?C.b:C.o}}>{t.payType==="fixed"?`${fmt(t.amount)}â‚¬`:`${t.amount}%`}</div>
    <div style={{fontSize:8,color:C.td}}>{t.payType==="fixed"?"fixe / mois":"du contrat"}</div>
    {t.payType==="percent"&&ca>0&&<div style={{fontSize:8,color:C.o,fontWeight:600}}>â‰ˆ {fmt(cost)}â‚¬</div>}
    </div>
    </div>
    </Card>;
   })}
  </Sect>
  <Modal open={!!editSub} onClose={()=>setEditSub(null)} title={editSub?.name?"Modifier abonnement":"Nouvel abonnement"}>
   {editSub&&<>
    <Inp label="Nom" value={editSub.name} onChange={v=>setEditSub({...editSub,name:v})} placeholder="Ex: Notion, Adobe, GoHighLevelâ€¦"/>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"0 10px"}}>
    <Inp label="Montant" value={editSub.amount} onChange={v=>setEditSub({...editSub,amount:pf(v)})} type="number" suffix="â‚¬"/>
    <Sel label="FrÃ©quence" value={editSub.freq} onChange={v=>setEditSub({...editSub,freq:v})} options={[{v:"monthly",l:"Mensuel"},{v:"annual",l:"Annuel"}]}/>
    </div>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"0 10px"}}>
    <Sel label="CatÃ©gorie" value={editSub.cat} onChange={v=>setEditSub({...editSub,cat:v})} options={Object.entries(SUB_CATS).map(([k,v2])=>({v:k,l:`${v2.icon} ${v2.l}`}))}/>
    {socId==="all"&&<Sel label="Affectation" value={editSub.socId} onChange={v=>setEditSub({...editSub,socId:v})} options={[{v:"holding",l:"ðŸ¢ Holding"},...socs.filter(s=>s.stat==="active"||s.stat==="lancement").map(s=>({v:s.id,l:s.nom}))]}/>}
    </div>
    <Inp label="Date de dÃ©but" value={editSub.start} onChange={v=>setEditSub({...editSub,start:v})} type="date"/>
    <Inp label="Notes" value={editSub.notes} onChange={v=>setEditSub({...editSub,notes:v})} placeholder="DÃ©tailsâ€¦"/>
    {editSub.freq==="annual"&&editSub.amount>0&&<div style={{padding:"6px 8px",background:C.bD,borderRadius:6,fontSize:10,color:C.b,fontWeight:600}}>= {fmt(Math.round(editSub.amount/12))}â‚¬/mois</div>}
    {(()=>{
    if(!bankData||!editSub.name||!editSub.amount)return null;
    const preview=matchSubsToRevolut([editSub],bankData,socId);
    const rm=preview[0]?.revMatch;
    if(!rm)return <div style={{padding:"8px 10px",background:C.oD,borderRadius:8,marginTop:6}}>
    <div style={{display:"flex",alignItems:"center",gap:4}}>
    <span style={{fontSize:10}}>ðŸ”</span>
    <span style={{fontSize:10,color:C.o,fontWeight:600}}>Aucune transaction Revolut correspondante trouvÃ©e</span>
    </div>
    <div style={{fontSize:8,color:C.td,marginTop:2}}>Le systÃ¨me recherche les transactions avec un nom similaire et un montant proche (Â±30%)</div>
    </div>;
    return <div style={{padding:"10px 12px",background:C.gD,borderRadius:8,marginTop:6}}>
    <div style={{display:"flex",alignItems:"center",gap:4,marginBottom:6}}>
    <span style={{fontSize:10}}>ðŸ¦</span>
    <span style={{fontSize:10,color:C.g,fontWeight:700}}>Transaction Revolut trouvÃ©e !</span>
    </div>
    <div style={{display:"flex",flexDirection:"column",gap:3}}>
    <div style={{display:"flex",alignItems:"center",justifyContent:"space-between"}}>
    <span style={{fontSize:10,color:C.t}}>"{rm.txDesc}"</span>
    <span style={{fontSize:10,fontWeight:700,color:C.g}}>{fmt(rm.txAmount)}â‚¬</span>
    </div>
    <div style={{display:"flex",gap:12}}>
    <span style={{fontSize:9,color:C.td}}>Dernier paiement : <strong style={{color:C.t}}>{new Date(rm.lastPayment).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"})}</strong></span>
    <span style={{fontSize:9,color:C.b,fontWeight:600}}>Prochain : {new Date(rm.nextPayment).toLocaleDateString("fr-FR",{day:"numeric",month:"long"})}</span>
    </div>
    <div style={{fontSize:8,color:C.td}}>{rm.matchCount} paiement{rm.matchCount>1?"s":""} trouvÃ©{rm.matchCount>1?"s":""} sur Revolut</div>
    {rm.txAmount!==editSub.amount&&<div style={{fontSize:9,color:C.o,fontWeight:600,marginTop:2}}>âš  Le montant Revolut ({fmt(rm.txAmount)}â‚¬) diffÃ¨re du montant dÃ©clarÃ© ({fmt(editSub.amount)}â‚¬) â€” <button style={{background:"none",border:"none",color:C.acc,fontSize:9,cursor:"pointer",fontFamily:FONT,fontWeight:700,textDecoration:"underline"}} onClick={()=>setEditSub({...editSub,amount:Math.round(rm.txAmount)})}>Utiliser le montant Revolut</button></div>}
    </div>
    </div>;
    })()}
    <div style={{display:"flex",gap:8,marginTop:12}}>
    <Btn onClick={()=>saveSub(editSub)}>Sauver</Btn>
    {subs.some(s=>s.id===editSub.id)&&<Btn v="secondary" onClick={()=>{deleteSub(editSub.id);setEditSub(null);}}>ðŸ—‘ Supprimer</Btn>}
    <Btn v="secondary" onClick={()=>setEditSub(null)}>Annuler</Btn>
    </div>
   </>}
  </Modal>
  <Modal open={!!editTm} onClose={()=>setEditTm(null)} title={editTm?.name?"Modifier membre":"Nouveau membre"}>
   {editTm&&<>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"0 10px"}}>
    <Inp label="Nom" value={editTm.name} onChange={v=>setEditTm({...editTm,name:v})} placeholder="Ex: Arnaud, Sarahâ€¦"/>
    <Inp label="RÃ´le" value={editTm.role} onChange={v=>setEditTm({...editTm,role:v})} placeholder="Ex: CSM, Closer, Monteurâ€¦"/>
    </div>
    <div style={{padding:"10px 12px",background:C.card2,borderRadius:10,border:`1px solid ${C.brd}`,marginBottom:8}}>
    <div style={{color:C.td,fontSize:9,fontWeight:700,letterSpacing:.8,marginBottom:8}}>TYPE DE RÃ‰MUNÃ‰RATION</div>
    <div style={{display:"flex",gap:6,marginBottom:8}}>
    {[{v:"fixed",l:"ðŸ’° Fixe / mois",c:C.b},{v:"percent",l:"ðŸ“Š % du contrat",c:C.o}].map(opt=>
    <button key={opt.v} onClick={()=>setEditTm({...editTm,payType:opt.v})} style={{flex:1,padding:"8px 10px",borderRadius:8,border:`1.5px solid ${editTm.payType===opt.v?opt.c:C.brd}`,background:editTm.payType===opt.v?opt.c+"15":C.card,color:editTm.payType===opt.v?opt.c:C.td,fontWeight:editTm.payType===opt.v?700:500,fontSize:11,cursor:"pointer",fontFamily:FONT,transition:"all .15s"}}>{opt.l}</button>
    )}
    </div>
    <Inp label={editTm.payType==="fixed"?"Montant fixe":"Pourcentage"} value={editTm.amount} onChange={v=>setEditTm({...editTm,amount:pf(v)})} type="number" suffix={editTm.payType==="fixed"?"â‚¬/mois":"%"}/>
    {editTm.payType==="percent"&&<div style={{padding:"6px 8px",background:C.oD,borderRadius:6,fontSize:10,color:C.o,marginTop:4}}>Ce membre touche {editTm.amount}% du CA des contrats qu'il gÃ¨re</div>}
    </div>
    {socId==="all"&&<Sel label="Affectation" value={editTm.socId} onChange={v=>setEditTm({...editTm,socId:v})} options={[{v:"holding",l:"ðŸ¢ Holding"},...socs.filter(s=>s.stat==="active"||s.stat==="lancement").map(s=>({v:s.id,l:s.nom}))]}/>}
    <Inp label="Notes" value={editTm.notes} onChange={v=>setEditTm({...editTm,notes:v})} placeholder="DÃ©tails, scope, horairesâ€¦"/>
    <div style={{display:"flex",gap:8,marginTop:12}}>
    <Btn onClick={()=>saveTm2(editTm)}>Sauver</Btn>
    {team.some(t=>t.id===editTm.id)&&<Btn v="secondary" onClick={()=>{deleteTm(editTm.id);setEditTm(null);}}>ðŸ—‘ Supprimer</Btn>}
    <Btn v="secondary" onClick={()=>setEditTm(null)}>Annuler</Btn>
    </div>
   </>}
  </Modal>
 </div>;
}
function SubsTeamBadge({subs,team,socId,reps}){
 const cM2=curM();
 const mySubs=socId?subs.filter(s=>s.socId===socId):subs;
 const myTeam=socId?team.filter(t=>t.socId===socId):team;
 const totalS=mySubs.reduce((a,s)=>a+subMonthly(s),0);
 const totalT=myTeam.reduce((a,t)=>{const ca=t.socId!=="holding"?pf(gr(reps,t.socId,cM2)?.ca):0;return a+teamMonthly(t,ca);},0);
 const total=totalS+totalT;
 if(total===0)return null;
 return <span style={{fontSize:8,color:C.r,background:C.rD,padding:"1px 5px",borderRadius:8,fontWeight:600}}>ðŸ”„ {fmt(total)}â‚¬/m</span>;
}
function ChallengesPanel({socs,reps,allM,pulses,challenges,saveChallenges}){
 const cM2=curM();const pm=prevM(cM2);const actS=socs.filter(s=>s.stat==="active"&&s.id!=="eco");
 const[editing,setEditing]=useState(false);
 const scored=useMemo(()=>{
  return(challenges||[]).filter(c=>c.month===cM2||c.month===pm).map(ch=>{
   const tmpl=CHALLENGE_TEMPLATES.find(t=>t.id===ch.templateId)||{};
   const scores=actS.map(s=>{
    const r=gr(reps,s.id,ch.month),rp=gr(reps,s.id,prevM(ch.month));
    const ca=pf(r?.ca),caPrev=pf(rp?.ca),ch2=pf(r?.charges);
    let val=0;
    if(tmpl.metric==="ca_growth")val=caPrev>0?Math.round((ca-caPrev)/caPrev*100):0;
    else if(tmpl.metric==="margin")val=ca>0?Math.round((ca-ch2)/ca*100):0;
    else if(tmpl.metric==="pipeline_ratio")val=ca>0?Math.round(pf(r?.pipeline)/ca*100):0;
    else if(tmpl.metric==="pulse_count")val=Object.keys(pulses).filter(k=>k.startsWith(s.id+"_")&&k.includes(ch.month.replace("-",""))).length;
    else if(tmpl.metric==="growth_streak"){let str=0;const mi=allM.indexOf(ch.month);if(mi>0)for(let i=mi;i>0;i--){const rc=pf(gr(reps,s.id,allM[i])?.ca),rcc=pf(gr(reps,s.id,allM[i-1])?.ca);if(rc>rcc)str++;else break;}val=str;}
    return{soc:s,value:val,achieved:val>=(tmpl.target||0)};
   }).sort((a,b)=>b.value-a.value);
   return{...ch,...tmpl,scores,winner:scores[0]};
  });
 },[challenges,reps,pulses,actS,allM,cM2,pm]);
 const launchChallenge=(tmplId)=>{
  const nc={id:uid(),templateId:tmplId,month:cM2,createdAt:new Date().toISOString()};
  saveChallenges([...(challenges||[]),nc]);
 };
 return <>
  {scored.filter(c=>c.month===cM2).length>0&&<Sect title={`Challenges â€” ${ml(cM2)}`}>
   {scored.filter(c=>c.month===cM2).map((ch,i)=>
    <Card key={ch.id} accent={C.acc} style={{marginBottom:8,padding:14}} delay={Math.min(i+1,6)}>
    <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:10}}>
    <span style={{fontSize:24}}>{ch.icon}</span>
    <div style={{flex:1}}>
    <div style={{fontWeight:800,fontSize:14}}>{ch.title}</div>
    <div style={{color:C.td,fontSize:10}}>{ch.desc} â€” cible: {ch.target}{ch.unit}</div>
    </div>
    </div>
    {ch.scores.map((sc,si)=>
    <div key={sc.soc.id} className={`fu d${Math.min(si+1,8)}`} style={{display:"flex",alignItems:"center",gap:6,padding:"5px 8px",background:si===0?C.accD:C.card,borderRadius:6,border:`1px solid ${si===0?C.acc+"44":C.brd}`,marginBottom:2}}>
    <span style={{fontWeight:800,fontSize:12,color:si===0?C.acc:si===1?"#C0C0C0":si===2?"#CD7F32":C.td,width:16}}>{si+1}</span>
    <span style={{width:5,height:5,borderRadius:3,background:sc.soc.color}}/>
    <span style={{flex:1,fontWeight:600,fontSize:11}}>{sc.soc.nom}</span>
    <span style={{fontWeight:800,fontSize:12,color:sc.achieved?C.g:C.td}}>{sc.value}{ch.unit}</span>
    {sc.achieved&&<span style={{fontSize:8,color:C.g,background:C.gD,padding:"1px 5px",borderRadius:6,fontWeight:600}}>âœ“</span>}
    </div>
    )}
    </Card>
   )}
  </Sect>}
  {scored.filter(c=>c.month!==cM2).length>0&&<Sect title="Historique">
   {scored.filter(c=>c.month!==cM2).map((ch,i)=>
    <div key={ch.id} className={`fu d${Math.min(i+1,6)}`} style={{display:"flex",alignItems:"center",gap:8,padding:"8px 10px",background:C.card,borderRadius:8,border:`1px solid ${C.brd}`,marginBottom:3}}>
    <span style={{fontSize:14}}>{ch.icon}</span>
    <div style={{flex:1}}><span style={{fontWeight:600,fontSize:11}}>{ch.title}</span><span style={{color:C.td,fontSize:9,marginLeft:6}}>{ml(ch.month)}</span></div>
    {ch.winner&&<><span style={{width:4,height:4,borderRadius:2,background:ch.winner.soc.color}}/><span style={{fontWeight:700,fontSize:10,color:C.acc}}>ðŸ† {ch.winner.soc.nom}</span></>}
    </div>
   )}
  </Sect>}
  <Sect title="Lancer un challenge" sub="Choisir un dÃ©fi pour ce mois">
   <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(150px,1fr))",gap:6}}>
    {CHALLENGE_TEMPLATES.map(tmpl=>{
    const active=(challenges||[]).some(c=>c.templateId===tmpl.id&&c.month===cM2);
    return <div key={tmpl.id} className="fu ba" onClick={active?undefined:()=>launchChallenge(tmpl.id)} style={{padding:12,background:active?C.gD:C.card,border:`1px solid ${active?C.g+"44":C.brd}`,borderRadius:10,cursor:active?"default":"pointer",textAlign:"center",opacity:active?0.6:1}}>
    <div style={{fontSize:20,marginBottom:4}}>{tmpl.icon}</div>
    <div style={{fontWeight:700,fontSize:10,color:active?C.g:C.t}}>{tmpl.title.replace(/^. /,"")}</div>
    <div style={{fontSize:8,color:C.td,marginTop:2}}>{tmpl.desc}</div>
    {active&&<div style={{fontSize:7,color:C.g,marginTop:3,fontWeight:700}}>ACTIF</div>}
    </div>;
    })}
   </div>
  </Sect>
 </>;
}
/* 5. AI WEEKLY COACH */
function AIWeeklyCoach({soc,reps,allM,actions,pulses,milestones}){
 const cM2=curM();const pm=prevM(cM2);
 const r=gr(reps,soc.id,cM2),rp=gr(reps,soc.id,pm);
 const ca=pf(r?.ca),caPrev=pf(rp?.ca),ch=pf(r?.charges);
 const hs=healthScore(soc,reps);
 const nextMs=milestones.filter(m=>!m.unlocked).sort((a,b)=>a.tier-b.tier)[0];
 const openActs=actions.filter(a=>a.socId===soc.id&&!a.done);
 const insights=useMemo(()=>{
  const ins=[];
  if(ca>0&&caPrev>0){
   const growth=Math.round((ca-caPrev)/caPrev*100);
   if(growth>20)ins.push({type:"success",icon:"ðŸ“ˆ",text:`CA en hausse de ${growth}% â€” excellent momentum ! Continue de pousser.`});
   else if(growth<-10)ins.push({type:"danger",icon:"ðŸ“‰",text:`CA en baisse de ${Math.abs(growth)}%. Identifie les 2 causes principales et agis cette semaine.`});
   else ins.push({type:"info",icon:"ðŸ“Š",text:`CA stable (${growth>0?"+":""}${growth}%). Cherche un levier de croissance Ã  activer.`});
  }
  if(ca>0){const mPct=Math.round((ca-ch)/ca*100);
   if(mPct<20)ins.push({type:"warning",icon:"ðŸ’¸",text:`Marge Ã  ${mPct}% â€” trop basse. Objectif : passer Ã  40%+ en optimisant les charges.`});
   else if(mPct>60)ins.push({type:"success",icon:"ðŸ’Ž",text:`Marge excellente Ã  ${mPct}%. RÃ©investis dans l'acquisition.`});
  }
  if(openActs.length>3)ins.push({type:"warning",icon:"ðŸ“‹",text:`${openActs.length} actions ouvertes. Ferme-en 2 cette semaine avant d'en crÃ©er de nouvelles.`});
  if(nextMs)ins.push({type:"info",icon:"ðŸ†",text:`Prochain milestone : "${nextMs.label}" â€” ${nextMs.desc}. Tu y es presque !`});
  if(hs.grade==="D"||hs.grade==="F")ins.push({type:"danger",icon:"âš ï¸",text:`Grade ${hs.grade} â€” focus sur ${hs.obj<hs.growth?"les objectifs":"la croissance"} en prioritÃ©.`});
  if(ins.filter(i=>i.type==="success").length>=2)ins.push({type:"success",icon:"ðŸ”¥",text:"Tu es en feu ! Garde ce rythme et documente ce qui marche dans la Knowledge Base."});
  return ins;
 },[ca,caPrev,ch,openActs,nextMs,hs]);
 const typeStyles={danger:{bg:C.rD,color:C.r},warning:{bg:C.oD,color:C.o},success:{bg:C.gD,color:C.g},info:{bg:C.bD,color:C.b}};
 return <Card accent={C.v} style={{padding:14,marginTop:8}}>
  <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:10}}>
   <span style={{fontSize:16}}>ðŸ§ </span>
   <div><div style={{fontWeight:800,fontSize:12,color:C.v}}>Coach IA</div><div style={{fontSize:8,color:C.td}}>Brief hebdomadaire personnalisÃ©</div></div>
  </div>
  {insights.length===0&&<div style={{color:C.td,fontSize:11,textAlign:"center",padding:10}}>Soumets un rapport pour activer le coaching</div>}
  {insights.map((ins,i)=>{const st=typeStyles[ins.type]||typeStyles.info;
   return <div key={i} className={`fu d${Math.min(i+1,6)}`} style={{display:"flex",alignItems:"flex-start",gap:6,padding:"6px 8px",background:st.bg,borderRadius:6,marginBottom:4}}>
    <span style={{fontSize:12,flexShrink:0,marginTop:1}}>{ins.icon}</span>
    <div style={{fontSize:10,color:C.t,lineHeight:1.4}}>{ins.text}</div>
   </div>;
  })}
 </Card>;
}
/* CLIENTS PANEL (per-sociÃ©tÃ© CRM) */
function ClientsPanel({soc,clients,saveClients,ghlData,socBankData,invoices,saveInvoices}){
 const[editCl,setEditCl]=useState(null);const[filter,setFilter]=useState("all");const[stageFilter,setStageFilter]=useState("all");const[invView,setInvView]=useState(null);
 const[sending,setSending]=useState(null);
 const myClients=clients.filter(c=>c.socId===soc.id);
 const myInvoices=(invoices||[]).filter(inv=>inv.socId===soc.id);
 const active=myClients.filter(c=>c.status==="active");
 const byType=t=>myClients.filter(c=>c.billing?.type===t);
 const mrrFixed=byType("fixed").filter(c=>c.status==="active").reduce((a,c)=>a+c.billing.amount,0);
 const mrrPercent=byType("percent").filter(c=>c.status==="active").reduce((a,c)=>a+clientMonthlyRevenue(c),0);
 const oneoffThisMonth=byType("oneoff").filter(c=>{const d=c.billing?.paidDate;if(!d)return false;return d.startsWith(curM());}).reduce((a,c)=>a+c.billing.amount,0);
 const oneoffTotal=byType("oneoff").reduce((a,c)=>a+c.billing.amount,0);
 const totalMRR=mrrFixed+mrrPercent;
 const totalPortfolio=myClients.reduce((a,c)=>a+clientTotalValue(c),0);
 const avgDealValue=myClients.length?Math.round(totalPortfolio/myClients.length):0;
 const churnCount=myClients.filter(c=>c.status==="churned").length;
 const churnRate=myClients.length>0?Math.round(churnCount/myClients.length*100):0;
 const invDraft=myInvoices.filter(i=>i.status==="draft");
 const invSent=myInvoices.filter(i=>i.status==="sent");
 const invPaid=myInvoices.filter(i=>i.status==="paid");
 const invOverdue=myInvoices.filter(i=>i.status==="overdue");
 const totalFacture=myInvoices.reduce((a,i)=>a+i.amount,0);
 const totalEncaisse=invPaid.reduce((a,i)=>a+i.amount,0);
 const totalAttente=invSent.concat(invDraft).reduce((a,i)=>a+i.amount,0);
 const endingSoon=myClients.filter(c=>{const r=commitmentRemaining(c);return r!==null&&r<=2&&r>0&&c.status==="active";});
 const allOpps=Object.values(ghlData).flatMap(d=>(d.opportunities||[]));
 const uniqueStages=[...new Set(allOpps.map(o=>o.stage).filter(Boolean))];
 const ghlIdsInStage=stageFilter==="all"?null:new Set(allOpps.filter(o=>o.stage===stageFilter).map(o=>o.id));
 const afterType=filter==="all"?myClients:myClients.filter(c=>filter==="type_fixed"?c.billing?.type==="fixed":filter==="type_percent"?c.billing?.type==="percent":filter==="type_oneoff"?c.billing?.type==="oneoff":c.status===filter);
 const filtered=stageFilter==="all"?afterType:afterType.filter(c=>{if(!c.ghlId)return false;const opps2=allOpps.filter(o=>o.stage===stageFilter);return opps2.some(o=>o.name===c.name||o.email===c.email||o.id===c.ghlId);});
 const addClient=(type)=>{
  const base={id:uid(),socId:soc.id,name:"",contact:"",email:"",phone:"",status:"active",notes:"",ghlId:"",stripeId:"",at:new Date().toISOString()};
  if(type==="fixed")base.billing={type:"fixed",amount:0,freq:"monthly",commitment:0,startDate:new Date().toISOString().slice(0,10)};
  else if(type==="percent")base.billing={type:"percent",percent:0,basis:"ca",startDate:new Date().toISOString().slice(0,10)};
  else base.billing={type:"oneoff",amount:0,product:"",deliveredDate:"",paidDate:"",installments:1};
  setEditCl(base);
 };
 const saveCl=(cl)=>{
  const isNew=!clients.some(c=>c.id===cl.id);
  const idx=clients.findIndex(x=>x.id===cl.id);
  if(idx>=0){const nc=[...clients];nc[idx]=cl;saveClients(nc);}else saveClients([...clients,cl]);
  const b=cl.billing;
  const needsInvoices=(b?.type==="fixed"&&b.commitment>0)||(b?.type==="oneoff"&&b.amount>0);
  if(needsInvoices){
   const existingForClient=(invoices||[]).filter(i=>i.clientId===cl.id);
   if(isNew||existingForClient.length===0){
    const newInvs=generateInvoices(cl,soc.nom);
    const apiKey=soc.ghlKey;
    if(apiKey){
    newInvs.forEach(async(inv)=>{
    const ghlId=await ghlCreateInvoice(apiKey,inv,cl);
    if(ghlId)inv.ghlInvoiceId=ghlId;
    });
    }
    const allInvs=[...(invoices||[]).filter(i=>i.clientId!==cl.id),...newInvs];
    saveInvoices(allInvs);
   }
  }
  setEditCl(null);
 };
 const deleteCl=(id)=>{
  saveClients(clients.filter(c=>c.id!==id));
  saveInvoices((invoices||[]).filter(i=>i.clientId!==id));
  setEditCl(null);
 };
 const regenInvoices=(cl)=>{
  const newInvs=generateInvoices(cl,soc.nom);
  const allInvs=[...(invoices||[]).filter(i=>i.clientId!==cl.id),...newInvs];
  saveInvoices(allInvs);
 };
 const sendInvoice=async(inv)=>{
  setSending(inv.id);
  const apiKey=soc.ghlKey;
  let ghlOk=false;
  if(apiKey&&inv.ghlInvoiceId){ghlOk=await ghlSendInvoice(apiKey,inv.ghlInvoiceId);}
  const updated=(invoices||[]).map(i=>i.id===inv.id?{...i,status:"sent",sentAt:new Date().toISOString()}:i);
  saveInvoices(updated);
  setSending(null);
 };
 const markPaid=(inv)=>{
  const updated=(invoices||[]).map(i=>i.id===inv.id?{...i,status:"paid",paidAt:new Date().toISOString()}:i);
  saveInvoices(updated);
 };
 const cancelInvoice=(inv)=>{
  const updated=(invoices||[]).map(i=>i.id===inv.id?{...i,status:"cancelled"}:i);
  saveInvoices(updated);
 };
 const clientInvoices=(clId)=>(invoices||[]).filter(i=>i.clientId===clId).sort((a,b)=>a.dueDate.localeCompare(b.dueDate));
 return <div>
  <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(100px,1fr))",gap:6,marginBottom:12}}>
   <Card accent={C.acc} style={{padding:"10px 12px",textAlign:"center"}} delay={1}>
    <div style={{color:C.td,fontSize:8,fontWeight:700,letterSpacing:.5}}>MRR TOTAL</div>
    <div style={{fontWeight:900,fontSize:20,color:C.acc}}>{fmt(totalMRR)}â‚¬</div>
    <div style={{fontSize:8,color:C.td}}>Forfaits: {fmt(mrrFixed)}â‚¬ Â· %: {fmt(mrrPercent)}â‚¬</div>
   </Card>
   <Card style={{padding:"10px 12px",textAlign:"center"}} delay={2}>
    <div style={{color:C.td,fontSize:8,fontWeight:700,letterSpacing:.5}}>CLIENTS ACTIFS</div>
    <div style={{fontWeight:900,fontSize:20,color:C.g}}>{active.length}</div>
    <div style={{fontSize:8,color:C.td}}>{myClients.length} total Â· Churn {churnRate}%</div>
   </Card>
   <Card style={{padding:"10px 12px",textAlign:"center"}} delay={3}>
    <div style={{color:C.td,fontSize:8,fontWeight:700,letterSpacing:.5}}>ONE-OFF CE MOIS</div>
    <div style={{fontWeight:900,fontSize:20,color:C.b}}>{fmt(oneoffThisMonth)}â‚¬</div>
    <div style={{fontSize:8,color:C.td}}>Total vendu: {fmt(oneoffTotal)}â‚¬</div>
   </Card>
   <Card style={{padding:"10px 12px",textAlign:"center"}} delay={4}>
    <div style={{color:C.td,fontSize:8,fontWeight:700,letterSpacing:.5}}>VALEUR MOY.</div>
    <div style={{fontWeight:900,fontSize:20,color:C.t}}>{fmt(avgDealValue)}â‚¬</div>
    <div style={{fontSize:8,color:C.td}}>par client</div>
   </Card>
  </div>
  {totalMRR>0&&<Card style={{padding:14,marginBottom:12}}>
   <div style={{color:C.td,fontSize:9,fontWeight:700,letterSpacing:.8,marginBottom:8}}>RÃ‰PARTITION DES REVENUS</div>
   <div style={{display:"flex",gap:2,height:8,borderRadius:4,overflow:"hidden",marginBottom:8}}>
    {mrrFixed>0&&<div style={{width:`${pct(mrrFixed,totalMRR+oneoffThisMonth)}%`,background:C.acc,borderRadius:3,transition:"width .3s"}}/>}
    {mrrPercent>0&&<div style={{width:`${pct(mrrPercent,totalMRR+oneoffThisMonth)}%`,background:C.v,borderRadius:3,transition:"width .3s"}}/>}
    {oneoffThisMonth>0&&<div style={{width:`${pct(oneoffThisMonth,totalMRR+oneoffThisMonth)}%`,background:C.b,borderRadius:3,transition:"width .3s"}}/>}
   </div>
   <div style={{display:"flex",gap:12}}>
    {[{l:"Forfaits fixes",v:mrrFixed,c:C.acc,n:byType("fixed").filter(c=>c.status==="active").length},
    {l:"% CA/bÃ©nÃ©fice",v:mrrPercent,c:C.v,n:byType("percent").filter(c=>c.status==="active").length},
    {l:"One-off (mois)",v:oneoffThisMonth,c:C.b,n:byType("oneoff").filter(c=>{const d=c.billing?.paidDate;return d&&d.startsWith(curM());}).length}
    ].map((s,i)=><div key={i} style={{display:"flex",alignItems:"center",gap:4}}>
    <span style={{width:8,height:8,borderRadius:2,background:s.c}}/>
    <span style={{fontSize:9,color:C.td}}>{s.l}: <strong style={{color:s.c}}>{fmt(s.v)}â‚¬</strong> ({s.n})</span>
    </div>)}
   </div>
  </Card>}
  {endingSoon.length>0&&<Card accent={C.o} style={{padding:12,marginBottom:12}}>
   <div style={{display:"flex",alignItems:"center",gap:4,marginBottom:6}}>
    <span style={{fontSize:12}}>âš ï¸</span>
    <span style={{fontWeight:700,fontSize:11,color:C.o}}>Engagements qui se terminent bientÃ´t</span>
   </div>
   {endingSoon.map(cl=>{const r=commitmentRemaining(cl);const end=commitmentEnd(cl);
    return <div key={cl.id} style={{display:"flex",alignItems:"center",gap:6,padding:"3px 0",fontSize:10}}>
    <span style={{fontWeight:600,color:C.t}}>{cl.name}</span>
    <span style={{color:C.o,fontWeight:700}}>{r} mois restant{r>1?"s":""}</span>
    <span style={{color:C.td,fontSize:8}}>fin {end?.toLocaleDateString("fr-FR",{month:"short",year:"numeric"})}</span>
    <span style={{color:C.td,fontSize:9,marginLeft:"auto"}}>{fmt(cl.billing.amount)}â‚¬/m</span>
    </div>;
   })}
  </Card>}
  {myInvoices.length>0&&<Card accent={C.b} style={{padding:14,marginBottom:12}}>
   <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:10}}>
    <div style={{display:"flex",alignItems:"center",gap:6}}>
    <span style={{fontSize:14}}>ðŸ§¾</span>
    <span style={{fontWeight:800,fontSize:12}}>Facturation</span>
    {!soc.ghlLocationId&&!soc.ghlKey&&<span style={{fontSize:7,color:C.o,background:C.oD,padding:"1px 5px",borderRadius:4}}>Mode local</span>}
    {(soc.ghlLocationId||soc.ghlKey)&&<span style={{fontSize:7,color:C.g,background:C.gD,padding:"1px 5px",borderRadius:4}}>GHL connectÃ©</span>}
    </div>
    <button onClick={()=>setInvView(invView?"":"all")} style={{background:"none",border:"none",color:C.acc,fontSize:9,cursor:"pointer",fontFamily:FONT,fontWeight:600}}>{invView?"Masquer":"Voir toutes"}</button>
   </div>
   <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:6,marginBottom:10}}>
    <div style={{textAlign:"center",padding:"6px 4px",background:C.bg,borderRadius:6}}>
    <div style={{fontWeight:900,fontSize:16,color:C.g}}>{fmt(totalEncaisse)}â‚¬</div>
    <div style={{fontSize:7,color:C.td,fontWeight:600}}>ENCAISSÃ‰</div>
    </div>
    <div style={{textAlign:"center",padding:"6px 4px",background:C.bg,borderRadius:6}}>
    <div style={{fontWeight:900,fontSize:16,color:C.b}}>{fmt(totalAttente)}â‚¬</div>
    <div style={{fontSize:7,color:C.td,fontWeight:600}}>EN ATTENTE</div>
    </div>
    <div style={{textAlign:"center",padding:"6px 4px",background:C.bg,borderRadius:6}}>
    <div style={{fontWeight:900,fontSize:16,color:C.td}}>{invDraft.length}</div>
    <div style={{fontSize:7,color:C.td,fontWeight:600}}>BROUILLONS</div>
    </div>
    <div style={{textAlign:"center",padding:"6px 4px",background:invOverdue.length>0?C.rD:C.bg,borderRadius:6}}>
    <div style={{fontWeight:900,fontSize:16,color:invOverdue.length>0?C.r:C.td}}>{invOverdue.length}</div>
    <div style={{fontSize:7,color:invOverdue.length>0?C.r:C.td,fontWeight:600}}>EN RETARD</div>
    </div>
   </div>
   {totalFacture>0&&<div style={{display:"flex",gap:1,height:6,borderRadius:3,overflow:"hidden",marginBottom:6}}>
    {invPaid.length>0&&<div style={{width:`${pct(invPaid.reduce((a,i)=>a+i.amount,0),totalFacture)}%`,background:C.g,borderRadius:2,transition:"width .3s"}}/>}
    {invSent.length>0&&<div style={{width:`${pct(invSent.reduce((a,i)=>a+i.amount,0),totalFacture)}%`,background:C.b,borderRadius:2,transition:"width .3s"}}/>}
    {invDraft.length>0&&<div style={{width:`${pct(invDraft.reduce((a,i)=>a+i.amount,0),totalFacture)}%`,background:C.brd,borderRadius:2,transition:"width .3s"}}/>}
    {invOverdue.length>0&&<div style={{width:`${pct(invOverdue.reduce((a,i)=>a+i.amount,0),totalFacture)}%`,background:C.r,borderRadius:2,transition:"width .3s"}}/>}
   </div>}
   {invDraft.length>0&&<div style={{marginTop:6}}>
    <div style={{fontSize:9,color:C.td,fontWeight:700,marginBottom:4}}>ðŸ“¤ PrÃªtes Ã  envoyer ({invDraft.length})</div>
    {invDraft.slice(0,5).map((inv,i)=>{
    const cl=myClients.find(c=>c.id===inv.clientId);
    return <div key={inv.id} className={`fu d${Math.min(i+1,5)}`} style={{display:"flex",alignItems:"center",gap:6,padding:"5px 8px",background:C.bg,borderRadius:6,marginBottom:2}}>
    <span style={{fontSize:9}}>ðŸ“</span>
    <div style={{flex:1,minWidth:0}}>
    <div style={{display:"flex",alignItems:"center",gap:4}}>
    <span style={{fontWeight:600,fontSize:10}}>{cl?.name||"Client"}</span>
    <span style={{fontSize:8,color:C.td}}>{inv.description.length>35?inv.description.slice(0,35)+"â€¦":inv.description}</span>
    </div>
    <div style={{fontSize:8,color:C.td}}>Ã‰chÃ©ance: {new Date(inv.dueDate).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"})}</div>
    </div>
    <span style={{fontWeight:700,fontSize:11,color:C.t,whiteSpace:"nowrap"}}>{fmt(inv.amount)}â‚¬</span>
    <button onClick={(e)=>{e.stopPropagation();sendInvoice(inv);}} disabled={sending===inv.id} style={{padding:"3px 8px",borderRadius:5,border:`1px solid ${C.b}`,background:C.bD,color:C.b,fontSize:9,fontWeight:700,cursor:"pointer",fontFamily:FONT,opacity:sending===inv.id?.5:1,transition:"all .15s"}}>
    {sending===inv.id?"Envoiâ€¦":"Envoyer"}
    </button>
    </div>;
    })}
    {invDraft.length>5&&<div style={{fontSize:8,color:C.td,textAlign:"center",marginTop:2}}>+ {invDraft.length-5} autres brouillons</div>}
   </div>}
   {invOverdue.length>0&&<div style={{marginTop:6}}>
    <div style={{fontSize:9,color:C.r,fontWeight:700,marginBottom:4}}>âš ï¸ En retard ({invOverdue.length})</div>
    {invOverdue.map((inv,i)=>{
    const cl=myClients.find(c=>c.id===inv.clientId);
    const days=Math.round((new Date()-new Date(inv.dueDate))/(864e5));
    return <div key={inv.id} style={{display:"flex",alignItems:"center",gap:6,padding:"5px 8px",background:C.rD,borderRadius:6,marginBottom:2}}>
    <span style={{fontSize:9}}>âš ï¸</span>
    <div style={{flex:1,minWidth:0}}>
    <span style={{fontWeight:600,fontSize:10,color:C.r}}>{cl?.name||"Client"}</span>
    <span style={{fontSize:8,color:C.r,marginLeft:4}}>{days}j de retard</span>
    </div>
    <span style={{fontWeight:700,fontSize:11,color:C.r}}>{fmt(inv.amount)}â‚¬</span>
    <button onClick={()=>markPaid(inv)} style={{padding:"3px 8px",borderRadius:5,border:`1px solid ${C.g}`,background:C.gD,color:C.g,fontSize:9,fontWeight:700,cursor:"pointer",fontFamily:FONT}}>Marquer payÃ©e</button>
    </div>;
    })}
   </div>}
  </Card>}
  {invView&&<Card style={{padding:14,marginBottom:12}}>
   <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:10}}>
    <span style={{fontWeight:800,fontSize:12}}>ðŸ§¾ Toutes les factures ({myInvoices.length})</span>
    <div style={{display:"flex",gap:4}}>
    {["all",...myClients.map(c=>c.id)].map(v=>{
    const lbl=v==="all"?"Tous":myClients.find(c=>c.id===v)?.name?.slice(0,12)||"?";
    return <button key={v} onClick={()=>setInvView(v)} style={{padding:"2px 8px",borderRadius:4,fontSize:8,fontWeight:invView===v?700:500,border:`1px solid ${invView===v?C.acc:C.brd}`,background:invView===v?C.accD:"transparent",color:invView===v?C.acc:C.td,cursor:"pointer",fontFamily:FONT}}>{lbl}</button>;
    })}
    </div>
   </div>
   {(invView==="all"?myInvoices:myInvoices.filter(i=>i.clientId===invView)).sort((a,b)=>a.dueDate.localeCompare(b.dueDate)).map((inv,i)=>{
    const cl=myClients.find(c=>c.id===inv.clientId);const st=INV_STATUS[inv.status]||INV_STATUS.draft;
    return <div key={inv.id} className={`fu d${Math.min(i+1,10)}`} style={{display:"flex",alignItems:"center",gap:6,padding:"6px 10px",background:st.bg,borderRadius:6,border:`1px solid ${st.c}15`,marginBottom:2}}>
    <span style={{fontSize:10}}>{st.icon}</span>
    <div style={{width:28,textAlign:"center"}}><span style={{fontSize:7,color:st.c,fontWeight:700,background:st.c+"18",padding:"1px 4px",borderRadius:3}}>{st.l}</span></div>
    <div style={{flex:1,minWidth:0}}>
    <div style={{display:"flex",alignItems:"center",gap:4}}>
    <span style={{fontWeight:600,fontSize:10}}>{cl?.name||"?"}</span>
    <span style={{fontSize:7,color:C.td,fontFamily:"monospace"}}>{inv.number}</span>
    {inv.totalInstallments>1&&<span style={{fontSize:7,color:C.b,background:C.bD,padding:"0px 4px",borderRadius:3}}>{inv.installment}/{inv.totalInstallments}</span>}
    </div>
    <div style={{fontSize:8,color:C.td,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{inv.description}</div>
    </div>
    <div style={{textAlign:"right",flexShrink:0}}>
    <div style={{fontWeight:700,fontSize:11,color:C.t}}>{fmt(inv.amount)}â‚¬</div>
    <div style={{fontSize:7,color:C.td}}>{new Date(inv.dueDate).toLocaleDateString("fr-FR",{day:"numeric",month:"short"})}</div>
    </div>
    <div style={{display:"flex",gap:2,flexShrink:0}}>
    {inv.status==="draft"&&<button onClick={()=>sendInvoice(inv)} disabled={sending===inv.id} style={{padding:"2px 6px",borderRadius:4,border:`1px solid ${C.b}`,background:C.bD,color:C.b,fontSize:8,fontWeight:700,cursor:"pointer",fontFamily:FONT,opacity:sending===inv.id?.5:1}}>{sending===inv.id?"â€¦":"ðŸ“¤ Envoyer"}</button>}
    {(inv.status==="sent"||inv.status==="overdue")&&<button onClick={()=>markPaid(inv)} style={{padding:"2px 6px",borderRadius:4,border:`1px solid ${C.g}`,background:C.gD,color:C.g,fontSize:8,fontWeight:700,cursor:"pointer",fontFamily:FONT}}>âœ… PayÃ©e</button>}
    {inv.status!=="paid"&&inv.status!=="cancelled"&&<button onClick={()=>cancelInvoice(inv)} style={{padding:"2px 6px",borderRadius:4,border:`1px solid ${C.brd}`,background:"transparent",color:C.td,fontSize:8,cursor:"pointer",fontFamily:FONT}}>âœ—</button>}
    </div>
    </div>;
   })}
  </Card>}
  <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:10,flexWrap:"wrap"}}>
   {[{v:"all",l:`Tous (${myClients.length})`},{v:"type_fixed",l:`ðŸ’° Fixes (${byType("fixed").length})`},{v:"type_percent",l:`ðŸ“Š % (${byType("percent").length})`},{v:"type_oneoff",l:`ðŸŽ¯ One-off (${byType("oneoff").length})`}].map(f2=>
    <button key={f2.v} onClick={()=>setFilter(f2.v)} style={{padding:"4px 10px",borderRadius:6,fontSize:9,fontWeight:filter===f2.v?700:500,border:`1px solid ${filter===f2.v?C.acc:C.brd}`,background:filter===f2.v?C.accD:"transparent",color:filter===f2.v?C.acc:C.td,cursor:"pointer",fontFamily:FONT}}>{f2.l}</button>
   )}
   {uniqueStages.length>0&&<select value={stageFilter} onChange={e=>setStageFilter(e.target.value)} style={{padding:"4px 10px",borderRadius:6,fontSize:9,border:`1px solid ${stageFilter!=="all"?C.acc:C.brd}`,background:stageFilter!=="all"?C.accD:"transparent",color:stageFilter!=="all"?C.acc:C.td,cursor:"pointer",fontFamily:FONT,outline:"none"}}><option value="all">ðŸ”€ Stage Pipeline: Tous</option>{uniqueStages.map(s=><option key={s} value={s}>{s}</option>)}</select>}
   <div style={{marginLeft:"auto",display:"flex",gap:4}}>
    <Btn small onClick={()=>addClient("fixed")}>+ Forfait</Btn>
    <Btn small v="secondary" onClick={()=>addClient("percent")}>+ %</Btn>
    <Btn small v="secondary" onClick={()=>addClient("oneoff")}>+ One-off</Btn>
   </div>
  </div>
  {filtered.length===0&&<div style={{textAlign:"center",padding:30,color:C.td}}><div style={{fontSize:24,marginBottom:6}}>ðŸ‘¥</div>Aucun client pour le moment</div>}
  {filtered.map((cl,i)=>{
   const b=cl.billing||{};const bt=BILL_TYPES[b.type]||BILL_TYPES.fixed;const cs=CLIENT_STATUS[cl.status]||CLIENT_STATUS.active;
   const monthly=clientMonthlyRevenue(cl);const cr=commitmentRemaining(cl);
   const clInvs=clientInvoices(cl.id);const clDraft=clInvs.filter(x=>x.status==="draft").length;const clPaid=clInvs.filter(x=>x.status==="paid").length;const clOverdue=clInvs.filter(x=>x.status==="overdue").length;
   return <Card key={cl.id} accent={bt.c} style={{marginBottom:4,padding:"12px 14px",cursor:"pointer"}} delay={Math.min(i+1,8)} onClick={()=>setEditCl({...cl})}>
    <div style={{display:"flex",alignItems:"center",gap:8}}>
    <div style={{width:36,height:36,borderRadius:9,background:bt.c+"18",border:`1.5px solid ${bt.c}33`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:14,flexShrink:0}}>{bt.icon}</div>
    <div style={{flex:1,minWidth:0}}>
    <div style={{display:"flex",alignItems:"center",gap:4,flexWrap:"wrap"}}>
    <span style={{fontWeight:700,fontSize:12}}>{cl.name||"Sans nom"}</span>
    <span style={{fontSize:7,color:cs.c,background:cs.c+"18",padding:"1px 5px",borderRadius:8,fontWeight:700}}>{cs.icon} {cs.l}</span>
    <span style={{fontSize:7,color:bt.c,background:bt.c+"18",padding:"1px 5px",borderRadius:8}}>{bt.l}</span>
    {clInvs.length>0&&<span style={{fontSize:7,color:C.td,background:C.card2,padding:"1px 5px",borderRadius:8}}>ðŸ“„{clInvs.length}</span>}
    {clDraft>0&&<span style={{fontSize:7,color:C.acc,background:C.accD,padding:"1px 4px",borderRadius:4,fontWeight:700}}>{clDraft} Ã  envoyer</span>}
    {clOverdue>0&&<span style={{fontSize:7,color:C.r,background:C.rD,padding:"1px 4px",borderRadius:4,fontWeight:700}}>âš  {clOverdue} en retard</span>}
    {clInvs.length>0&&<span style={{fontSize:7,color:C.b,background:C.bD,padding:"1px 5px",borderRadius:8}}>ðŸ§¾ {clPaid}/{clInvs.length}</span>}
    {clOverdue>0&&<span style={{fontSize:7,color:C.r,background:C.rD,padding:"1px 5px",borderRadius:8,fontWeight:700}}>âš  {clOverdue} retard</span>}
    {clDraft>0&&<span style={{fontSize:7,color:C.td,background:C.card2,padding:"1px 5px",borderRadius:8}}>{clDraft} brouillon{clDraft>1?"s":""}</span>}
    </div>
    {cl.contact&&<div style={{color:C.td,fontSize:9,marginTop:1}}>{cl.contact}{cl.email?` Â· ${cl.email}`:""}</div>}
    {cl.notes&&<div style={{color:C.td,fontSize:9,marginTop:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{cl.notes}</div>}
    <div style={{display:"flex",gap:8,marginTop:3,flexWrap:"wrap"}}>
    {b.type==="fixed"&&<>
    <span style={{fontSize:9,color:C.acc,fontWeight:700}}>{fmt(b.amount)}â‚¬/{b.freq==="annual"?"an":"mois"}</span>
    {b.commitment>0&&<span style={{fontSize:8,color:C.td}}>Engagement {b.commitment} mois{cr!==null?` Â· ${cr} restant${cr>1?"s":""}`:""}</span>}
    {!b.commitment&&<span style={{fontSize:8,color:C.o}}>Sans engagement</span>}
    </>}
    {b.type==="percent"&&<>
    <span style={{fontSize:9,color:C.v,fontWeight:700}}>{b.percent}% {b.basis==="benefice"?"du bÃ©nÃ©fice":"du CA"}</span>
    {cl.clientCA>0&&<span style={{fontSize:8,color:C.td}}>CA client: {fmt(cl.clientCA)}â‚¬ â†’ <strong style={{color:C.v}}>{fmt(monthly)}â‚¬/mois</strong></span>}
    </>}
    {b.type==="oneoff"&&<>
    <span style={{fontSize:9,color:C.b,fontWeight:700}}>{fmt(b.amount)}â‚¬</span>
    {b.product&&<span style={{fontSize:8,color:C.td}}>{b.product}</span>}
    {b.paidDate&&<span style={{fontSize:8,color:C.g}}>PayÃ© le {new Date(b.paidDate).toLocaleDateString("fr-FR",{day:"numeric",month:"short"})}</span>}
    </>}
    </div>
    </div>
    <div style={{textAlign:"right",flexShrink:0}}>
    {b.type!=="oneoff"&&<>
    <div style={{fontWeight:900,fontSize:16,color:bt.c}}>{fmt(monthly)}â‚¬</div>
    <div style={{fontSize:8,color:C.td}}>/ mois</div>
    </>}
    {b.type==="oneoff"&&<>
    <div style={{fontWeight:900,fontSize:16,color:bt.c}}>{fmt(b.amount)}â‚¬</div>
    <div style={{fontSize:8,color:C.td}}>one-off</div>
    </>}
    </div>
    </div>
   </Card>;
  })}
  {myInvoices.length>0&&<>
   <div style={{marginTop:16,marginBottom:4,display:"flex",alignItems:"center",justifyContent:"space-between"}}>
    <div style={{display:"flex",alignItems:"center",gap:6}}>
    <span style={{fontSize:14}}>ðŸ“„</span>
    <span style={{fontWeight:800,fontSize:13}}>Facturation</span>
    <span style={{fontSize:9,color:C.td}}>{myInvoices.length} factures</span>
    </div>
    <button onClick={()=>setInvView(invView?"":"all")} style={{background:"none",border:"none",color:C.acc,fontSize:10,fontWeight:600,cursor:"pointer",fontFamily:FONT}}>{invView?"Masquer les factures":"Voir toutes les factures"}</button>
   </div>
   <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:6,marginBottom:10}}>
    <div style={{padding:"8px 10px",background:C.gD,borderRadius:8,textAlign:"center"}}>
    <div style={{fontWeight:900,fontSize:16,color:C.g}}>{fmt(totalEncaisse)}â‚¬</div>
    <div style={{fontSize:8,color:C.g,fontWeight:600}}>EncaissÃ© ({invPaid.length})</div>
    </div>
    <div style={{padding:"8px 10px",background:C.oD,borderRadius:8,textAlign:"center"}}>
    <div style={{fontWeight:900,fontSize:16,color:C.o}}>{fmt(invSent.reduce((a,i)=>a+i.amount,0))}â‚¬</div>
    <div style={{fontSize:8,color:C.o,fontWeight:600}}>EnvoyÃ© ({invSent.length})</div>
    </div>
    <div style={{padding:"8px 10px",background:C.card2,borderRadius:8,textAlign:"center"}}>
    <div style={{fontWeight:900,fontSize:16,color:C.td}}>{fmt(invDraft.reduce((a,i)=>a+i.amount,0))}â‚¬</div>
    <div style={{fontSize:8,color:C.td,fontWeight:600}}>Brouillon ({invDraft.length})</div>
    </div>
    {invOverdue.length>0&&<div style={{padding:"8px 10px",background:C.rD,borderRadius:8,textAlign:"center"}}>
    <div style={{fontWeight:900,fontSize:16,color:C.r}}>{fmt(invOverdue.reduce((a,i)=>a+i.amount,0))}â‚¬</div>
    <div style={{fontSize:8,color:C.r,fontWeight:600}}>En retard ({invOverdue.length})</div>
    </div>}
    {invOverdue.length===0&&<div style={{padding:"8px 10px",background:C.gD,borderRadius:8,textAlign:"center"}}>
    <div style={{fontWeight:900,fontSize:16,color:C.g}}>{fmt(totalFacture)}â‚¬</div>
    <div style={{fontSize:8,color:C.g,fontWeight:600}}>Total facturÃ©</div>
    </div>}
   </div>
   {totalFacture>0&&<div style={{marginBottom:12}}>
    <div style={{display:"flex",gap:2,height:6,borderRadius:3,overflow:"hidden"}}>
    <div style={{width:`${pct(totalEncaisse,totalFacture)}%`,background:C.g,borderRadius:3,transition:"width .3s"}}/>
    <div style={{width:`${pct(invSent.reduce((a,i)=>a+i.amount,0),totalFacture)}%`,background:C.o,borderRadius:3,transition:"width .3s"}}/>
    <div style={{width:`${pct(invDraft.reduce((a,i)=>a+i.amount,0),totalFacture)}%`,background:C.brd,borderRadius:3,transition:"width .3s"}}/>
    </div>
    <div style={{display:"flex",justifyContent:"space-between",marginTop:2}}>
    <span style={{fontSize:8,color:C.g}}>{pct(totalEncaisse,totalFacture)}% encaissÃ©</span>
    <span style={{fontSize:8,color:C.td}}>{fmt(totalFacture-totalEncaisse)}â‚¬ restant</span>
    </div>
   </div>}
   {invView&&<>
    {myClients.map(cl=>{
    const clInvs=clientInvoices(cl.id);
    if(clInvs.length===0)return null;
    const clPaid=clInvs.filter(i=>i.status==="paid").reduce((a,i)=>a+i.amount,0);
    const clTotal=clInvs.reduce((a,i)=>a+i.amount,0);
    return <div key={cl.id} style={{marginBottom:10}}>
    <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:4,padding:"4px 0"}}>
    <span style={{fontWeight:700,fontSize:11,color:C.t}}>{cl.name}</span>
    <span style={{fontSize:8,color:C.td}}>â€”</span>
    <span style={{fontSize:9,color:C.g,fontWeight:600}}>{fmt(clPaid)}â‚¬ / {fmt(clTotal)}â‚¬</span>
    <div style={{flex:1,height:3,background:C.brd,borderRadius:2,overflow:"hidden",marginLeft:4}}>
    <div style={{height:"100%",width:`${pct(clPaid,clTotal)}%`,background:C.g,borderRadius:2}}/>
    </div>
    </div>
    {clInvs.map((inv,j)=>{
    const ist=INV_STATUS[inv.status]||INV_STATUS.draft;
    const isLate=inv.status==="overdue";
    return <div key={inv.id} className={`fu d${Math.min(j+1,6)}`} style={{display:"flex",alignItems:"center",gap:6,padding:"6px 10px",background:ist.bg||C.card,borderRadius:8,border:`1px solid ${isLate?C.r+"44":C.brd}`,marginBottom:2}}>
    <span style={{fontSize:10,flexShrink:0}}>{ist.icon}</span>
    <div style={{flex:1,minWidth:0}}>
    <div style={{display:"flex",alignItems:"center",gap:4}}>
    <span style={{fontWeight:600,fontSize:10,color:C.t}}>{inv.description}</span>
    {inv.totalInstallments>1&&<span style={{fontSize:7,color:C.b,background:C.bD,padding:"1px 4px",borderRadius:4}}>{inv.installment}/{inv.totalInstallments}</span>}
    </div>
    <div style={{display:"flex",gap:8,marginTop:1}}>
    <span style={{fontSize:8,color:C.td}}>NÂ° {inv.number}</span>
    <span style={{fontSize:8,color:isLate?C.r:C.td}}>Ã‰ch. {new Date(inv.dueDate).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"})}</span>
    {inv.sentAt&&<span style={{fontSize:8,color:C.o}}>EnvoyÃ© {new Date(inv.sentAt).toLocaleDateString("fr-FR",{day:"numeric",month:"short"})}</span>}
    {inv.paidAt&&<span style={{fontSize:8,color:C.g}}>PayÃ© {new Date(inv.paidAt).toLocaleDateString("fr-FR",{day:"numeric",month:"short"})}</span>}
    {inv.ghlInvoiceId&&<span style={{fontSize:7,color:C.acc,background:C.accD,padding:"1px 4px",borderRadius:3}}>GHL âœ“</span>}
    </div>
    </div>
    <div style={{fontWeight:800,fontSize:13,color:ist.c,whiteSpace:"nowrap"}}>{fmt(inv.amount)}â‚¬</div>
    <div style={{display:"flex",gap:2,flexShrink:0}}>
    {inv.status==="draft"&&<button onClick={(e)=>{e.stopPropagation();sendInvoice(inv);}} disabled={sending===inv.id} style={{padding:"3px 8px",borderRadius:5,border:`1px solid ${C.acc}`,background:C.accD,color:C.acc,fontSize:8,fontWeight:700,cursor:"pointer",fontFamily:FONT,opacity:sending===inv.id?.5:1}} title="Envoyer au client">{sending===inv.id?"â³":"ðŸ“© Envoyer"}</button>}
    {inv.status==="sent"&&<button onClick={(e)=>{e.stopPropagation();markPaid(inv);}} style={{padding:"3px 8px",borderRadius:5,border:`1px solid ${C.g}`,background:C.gD,color:C.g,fontSize:8,fontWeight:700,cursor:"pointer",fontFamily:FONT}} title="Marquer comme payÃ©">âœ… PayÃ©</button>}
    {inv.status==="overdue"&&<>
    <button onClick={(e)=>{e.stopPropagation();sendInvoice(inv);}} style={{padding:"3px 8px",borderRadius:5,border:`1px solid ${C.o}`,background:C.oD,color:C.o,fontSize:8,fontWeight:700,cursor:"pointer",fontFamily:FONT}} title="Relancer">ðŸ“© Relancer</button>
    <button onClick={(e)=>{e.stopPropagation();markPaid(inv);}} style={{padding:"3px 6px",borderRadius:5,border:`1px solid ${C.g}`,background:C.gD,color:C.g,fontSize:8,fontWeight:700,cursor:"pointer",fontFamily:FONT}}>âœ…</button>
    </>}
    {(inv.status==="draft"||inv.status==="sent")&&<button onClick={(e)=>{e.stopPropagation();cancelInvoice(inv);}} style={{padding:"3px 5px",borderRadius:5,border:`1px solid ${C.brd}`,background:"transparent",color:C.td,fontSize:8,cursor:"pointer",fontFamily:FONT}} title="Annuler">âœ—</button>}
    </div>
    </div>;
    })}
    </div>;
    })}
    {invDraft.length>0&&<Card accent={C.acc} style={{padding:12,marginTop:8}}>
    <div style={{display:"flex",alignItems:"center",justifyContent:"space-between"}}>
    <div>
    <div style={{fontWeight:700,fontSize:11,color:C.acc}}>{invDraft.length} facture{invDraft.length>1?"s":""} en brouillon</div>
    <div style={{fontSize:9,color:C.td}}>Total : {fmt(invDraft.reduce((a,i)=>a+i.amount,0))}â‚¬ â€” PrÃªtes Ã  Ãªtre envoyÃ©es</div>
    </div>
    <Btn small onClick={async()=>{for(const inv of invDraft){await sendInvoice(inv);}}}>ðŸ“© Tout envoyer</Btn>
    </div>
    </Card>}
   </>}
  </>}
  {myInvoices.length===0&&myClients.length>0&&<Card style={{padding:16,marginTop:12,textAlign:"center"}}>
   <div style={{fontSize:24,marginBottom:4}}>ðŸ“„</div>
   <div style={{fontWeight:700,fontSize:12,marginBottom:4}}>Aucune facture gÃ©nÃ©rÃ©e</div>
   <div style={{color:C.td,fontSize:10,marginBottom:10}}>Ajoute un client avec engagement ou paiement en plusieurs fois pour gÃ©nÃ©rer automatiquement les factures</div>
  </Card>}
  <Modal open={!!editCl} onClose={()=>setEditCl(null)} title={editCl?.name?"Modifier client":"Nouveau client"} wide>
   {editCl&&(()=>{
    const b=editCl.billing||{type:"fixed"};const bt=BILL_TYPES[b.type];
    return <>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"0 10px"}}>
    <Inp label="Nom / Entreprise" value={editCl.name} onChange={v=>setEditCl({...editCl,name:v})} placeholder="Ex: Studio Fitness Paris"/>
    <Inp label="Contact" value={editCl.contact} onChange={v=>setEditCl({...editCl,contact:v})} placeholder="Nom du contact"/>
    </div>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"0 10px"}}>
    <Inp label="Email" value={editCl.email} onChange={v=>setEditCl({...editCl,email:v})} placeholder="email@client.com"/>
    <Inp label="TÃ©lÃ©phone" value={editCl.phone} onChange={v=>setEditCl({...editCl,phone:v})} placeholder="06..."/>
    </div>
    <div style={{padding:"10px 12px",background:C.card2,borderRadius:10,border:`1px solid ${C.brd}`,margin:"8px 0"}}>
    <div style={{color:C.td,fontSize:9,fontWeight:700,letterSpacing:.8,marginBottom:8}}>TYPE DE FACTURATION</div>
    <div style={{display:"flex",gap:4,marginBottom:10}}>
    {Object.entries(BILL_TYPES).map(([k,v])=>
    <button key={k} onClick={()=>setEditCl({...editCl,billing:{...editCl.billing,type:k}})} style={{flex:1,padding:"8px 6px",borderRadius:8,border:`1.5px solid ${b.type===k?v.c:C.brd}`,background:b.type===k?v.c+"15":C.card,color:b.type===k?v.c:C.td,fontWeight:b.type===k?700:500,fontSize:10,cursor:"pointer",fontFamily:FONT,transition:"all .15s",textAlign:"center"}}>
    <div style={{fontSize:14,marginBottom:2}}>{v.icon}</div>{v.l}
    </button>
    )}
    </div>
    {b.type==="fixed"&&<>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"0 10px"}}>
    <Inp label="Montant" value={b.amount} onChange={v=>setEditCl({...editCl,billing:{...b,amount:pf(v)}})} type="number" suffix="â‚¬"/>
    <Sel label="FrÃ©quence" value={b.freq||"monthly"} onChange={v=>setEditCl({...editCl,billing:{...b,freq:v}})} options={[{v:"monthly",l:"Mensuel"},{v:"annual",l:"Annuel"}]}/>
    </div>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"0 10px"}}>
    <Inp label="Engagement (mois)" value={b.commitment||0} onChange={v=>setEditCl({...editCl,billing:{...b,commitment:pf(v)}})} type="number" suffix="mois"/>
    <Inp label="Date de dÃ©but" value={b.startDate||""} onChange={v=>setEditCl({...editCl,billing:{...b,startDate:v}})} type="date"/>
    </div>
    {b.amount>0&&b.commitment>0&&<div style={{padding:"8px 10px",background:C.accD,borderRadius:6,fontSize:10,color:C.acc,fontWeight:600,marginTop:4}}>
    Valeur contrat : {fmt(b.amount*b.commitment)}â‚¬ sur {b.commitment} mois{commitmentRemaining(editCl)!==null?` Â· ${commitmentRemaining(editCl)} mois restants`:""}
    <div style={{fontSize:8,color:C.td,fontWeight:400,marginTop:2}}>ðŸ§¾ {b.commitment} factures brouillon seront crÃ©Ã©es automatiquement, une par mois{soc.ghlKey?" (envoi vers GHL)":""}</div>
    </div>}
    {b.amount>0&&!b.commitment&&<div style={{padding:"6px 8px",background:C.oD,borderRadius:6,fontSize:10,color:C.o,marginTop:4}}>Sans engagement â€” rÃ©siliable Ã  tout moment</div>}
    </>}
    {b.type==="percent"&&<>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"0 10px"}}>
    <Inp label="Pourcentage" value={b.percent||0} onChange={v=>setEditCl({...editCl,billing:{...b,percent:pf(v)}})} type="number" suffix="%"/>
    <Sel label="Base de calcul" value={b.basis||"ca"} onChange={v=>setEditCl({...editCl,billing:{...b,basis:v}})} options={[{v:"ca",l:"% du CA"},{v:"benefice",l:"% du bÃ©nÃ©fice"}]}/>
    </div>
    <Inp label="Date de dÃ©but" value={b.startDate||""} onChange={v=>setEditCl({...editCl,billing:{...b,startDate:v}})} type="date"/>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"0 10px"}}>
    <Inp label="CA mensuel du client" value={editCl.clientCA||""} onChange={v=>setEditCl({...editCl,clientCA:pf(v)})} type="number" suffix="â‚¬"/>
    {b.basis==="benefice"&&<Inp label="Charges client" value={editCl.clientCharges||""} onChange={v=>setEditCl({...editCl,clientCharges:pf(v)})} type="number" suffix="â‚¬"/>}
    </div>
    {(editCl.clientCA||0)>0&&(b.percent||0)>0&&<div style={{padding:"6px 8px",background:C.vD,borderRadius:6,fontSize:10,color:C.v,fontWeight:600,marginTop:4}}>
    Revenu estimÃ© : {fmt(clientMonthlyRevenue(editCl))}â‚¬/mois ({b.percent}% de {b.basis==="benefice"?fmt(Math.max(0,(editCl.clientCA||0)-(editCl.clientCharges||0))):fmt(editCl.clientCA)}â‚¬)
    </div>}
    </>}
    {b.type==="oneoff"&&<>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"0 10px"}}>
    <Inp label="Montant total" value={b.amount||0} onChange={v=>setEditCl({...editCl,billing:{...b,amount:pf(v)}})} type="number" suffix="â‚¬"/>
    <Inp label="Produit / Offre" value={b.product||""} onChange={v=>setEditCl({...editCl,billing:{...b,product:v}})} placeholder="Ex: Accompagnement Pub"/>
    </div>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:"0 10px"}}>
    <Inp label="Nb Ã©chÃ©ances" value={b.installments||1} onChange={v=>setEditCl({...editCl,billing:{...b,installments:Math.max(1,pf(v))}})} type="number" suffix="x"/>
    <Inp label="Date 1er paiement" value={b.paidDate||""} onChange={v=>setEditCl({...editCl,billing:{...b,paidDate:v}})} type="date"/>
    <Inp label="Date de livraison" value={b.deliveredDate||""} onChange={v=>setEditCl({...editCl,billing:{...b,deliveredDate:v}})} type="date"/>
    </div>
    {(b.installments||1)>1&&b.amount>0&&<div style={{padding:"8px 10px",background:C.bD,borderRadius:6,fontSize:10,color:C.b,fontWeight:600,marginTop:4}}>
    {b.installments} Ã©chÃ©ances de {fmt(Math.round(b.amount/(b.installments||1)))}â‚¬ â€” Total {fmt(b.amount)}â‚¬
    <div style={{fontSize:8,color:C.td,fontWeight:400,marginTop:2}}>Les factures seront crÃ©Ã©es automatiquement en brouillon, 1 par mois Ã  partir de la date du 1er paiement</div>
    </div>}
    </>}
    </div>
    <Sel label="Statut" value={editCl.status} onChange={v=>setEditCl({...editCl,status:v})} options={Object.entries(CLIENT_STATUS).map(([k,v])=>({v:k,l:`${v.icon} ${v.l}`}))}/>
    <Inp label="Notes" value={editCl.notes} onChange={v=>setEditCl({...editCl,notes:v})} placeholder="Contexte, dÃ©tails du dealâ€¦"/>
    <div style={{padding:"10px 12px",background:C.bg,borderRadius:10,border:`1px solid ${C.brd}`,margin:"8px 0"}}>
    <div style={{color:C.td,fontSize:9,fontWeight:700,letterSpacing:.8,marginBottom:6}}>CONNEXIONS EXTERNES</div>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"0 10px"}}>
    <Inp label="ID GoHighLevel" value={editCl.ghlId||""} onChange={v=>setEditCl({...editCl,ghlId:v})} placeholder="Contact/Opportunity ID" small/>
    <Inp label="ID Stripe" value={editCl.stripeId||""} onChange={v=>setEditCl({...editCl,stripeId:v})} placeholder="cus_..." small/>
    </div>
    </div>
    {/* Invoice section for existing clients */}
    {clients.some(c=>c.id===editCl.id)&&(()=>{
    const clInvs=clientInvoices(editCl.id);
    if(clInvs.length===0)return <div style={{padding:"10px 12px",background:C.bg,borderRadius:10,border:`1px solid ${C.brd}`,margin:"8px 0"}}>
    <div style={{display:"flex",alignItems:"center",justifyContent:"space-between"}}>
    <div style={{display:"flex",alignItems:"center",gap:4}}>
    <span style={{fontSize:10}}>ðŸ§¾</span>
    <span style={{color:C.td,fontSize:10,fontWeight:600}}>Aucune facture gÃ©nÃ©rÃ©e</span>
    </div>
    {((b.type==="fixed"&&b.commitment>0)||(b.type==="oneoff"&&b.amount>0))&&<button onClick={()=>regenInvoices(editCl)} style={{padding:"3px 8px",borderRadius:5,border:`1px solid ${C.acc}`,background:C.accD,color:C.acc,fontSize:9,fontWeight:700,cursor:"pointer",fontFamily:FONT}}>GÃ©nÃ©rer les factures</button>}
    </div>
    </div>;
    const paid=clInvs.filter(x=>x.status==="paid").length;
    const total=clInvs.reduce((a,x)=>a+x.amount,0);
    const paidAmt=clInvs.filter(x=>x.status==="paid").reduce((a,x)=>a+x.amount,0);
    return <div style={{padding:"10px 12px",background:C.bg,borderRadius:10,border:`1px solid ${C.brd}`,margin:"8px 0"}}>
    <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8}}>
    <div style={{display:"flex",alignItems:"center",gap:4}}>
    <span style={{fontSize:10}}>ðŸ§¾</span>
    <span style={{fontWeight:700,fontSize:10}}>Factures ({paid}/{clInvs.length})</span>
    <span style={{fontSize:9,color:C.g,fontWeight:600}}>{fmt(paidAmt)}â‚¬ / {fmt(total)}â‚¬</span>
    </div>
    <button onClick={()=>regenInvoices(editCl)} style={{padding:"2px 6px",borderRadius:4,border:`1px solid ${C.brd}`,background:"transparent",color:C.td,fontSize:8,cursor:"pointer",fontFamily:FONT}} title="RegÃ©nÃ©rer les factures">ðŸ”„</button>
    </div>
    <div style={{display:"flex",gap:1,height:4,borderRadius:2,overflow:"hidden",marginBottom:6}}>
    {clInvs.map(inv=>{const st=INV_STATUS[inv.status]||INV_STATUS.draft;
    return <div key={inv.id} style={{flex:1,background:st.c,borderRadius:1,transition:"background .3s"}} title={`${inv.description} â€” ${st.l} â€” ${fmt(inv.amount)}â‚¬`}/>;
    })}
    </div>
    <div style={{maxHeight:200,overflowY:"auto"}}>
    {clInvs.map(inv=>{const st=INV_STATUS[inv.status]||INV_STATUS.draft;
    return <div key={inv.id} style={{display:"flex",alignItems:"center",gap:4,padding:"3px 6px",background:st.bg,borderRadius:4,marginBottom:1,fontSize:9}}>
    <span style={{fontSize:8}}>{st.icon}</span>
    <span style={{fontSize:7,color:st.c,fontWeight:700,minWidth:48}}>{st.l}</span>
    <span style={{flex:1,color:C.t,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",fontSize:9}}>
    {inv.totalInstallments>1&&<strong style={{color:C.b}}>#{inv.installment} </strong>}
    {inv.description.length>30?inv.description.slice(0,30)+"â€¦":inv.description}
    </span>
    <span style={{fontWeight:700,color:C.t,whiteSpace:"nowrap"}}>{fmt(inv.amount)}â‚¬</span>
    <span style={{color:C.td,fontSize:7,whiteSpace:"nowrap"}}>{new Date(inv.dueDate).toLocaleDateString("fr-FR",{day:"numeric",month:"short"})}</span>
    {inv.status==="draft"&&<button onClick={(e)=>{e.stopPropagation();sendInvoice(inv);}} disabled={sending===inv.id} style={{padding:"1px 5px",borderRadius:3,border:`1px solid ${C.b}`,background:C.bD,color:C.b,fontSize:7,fontWeight:700,cursor:"pointer",fontFamily:FONT,opacity:sending===inv.id?.5:1}}>{sending===inv.id?"â€¦":"Envoyer"}</button>}
    {(inv.status==="sent"||inv.status==="overdue")&&<button onClick={(e)=>{e.stopPropagation();markPaid(inv);}} style={{padding:"1px 5px",borderRadius:3,border:`1px solid ${C.g}`,background:C.gD,color:C.g,fontSize:7,fontWeight:700,cursor:"pointer",fontFamily:FONT}}>PayÃ©e</button>}
    </div>;
    })}
    </div>
    </div>;
    })()}
    <div style={{display:"flex",gap:8,marginTop:12}}>
    <Btn onClick={()=>saveCl(editCl)}>Sauver</Btn>
    {clients.some(c=>c.id===editCl.id)&&<Btn v="secondary" onClick={()=>deleteCl(editCl.id)}>ðŸ—‘ Supprimer</Btn>}
    <Btn v="secondary" onClick={()=>setEditCl(null)}>Annuler</Btn>
    </div>
    </>;
   })()}
  </Modal>
 </div>;
}
/* PROACTIVE INSIGHTS ENGINE */
function genInsights(evo,hs,rw,myActions,soc,reps,allM){
 const ins=[];const last=evo.length>0?evo[evo.length-1]:null;const prev=evo.length>1?evo[evo.length-2]:null;
 if(!last)return ins;
 if(prev){
  const caD=last.ca-prev.ca;const caPct=prev.ca>0?Math.round(caD/prev.ca*100):0;
  if(caPct<-15)ins.push({type:"danger",icon:"ðŸ“‰",title:`CA en baisse de ${Math.abs(caPct)}%`,desc:`Votre CA est passÃ© de ${fmt(prev.ca)}â‚¬ Ã  ${fmt(last.ca)}â‚¬. ${last.charges>prev.charges?"Vos charges ont aussi augmentÃ©.":"Vos charges sont stables, c'est le revenu qui baisse."}`,tip:"Analysez quels clients ou canaux ont baissÃ©"});
  else if(caPct>20)ins.push({type:"success",icon:"ðŸš€",title:`Croissance de +${caPct}% ce mois`,desc:`CA de ${fmt(last.ca)}â‚¬ contre ${fmt(prev.ca)}â‚¬ le mois dernier. Belle progression !`,tip:"Identifiez ce qui a fonctionnÃ© pour reproduire"});
  const margeDiff=last.margePct-prev.margePct;
  if(margeDiff<-10)ins.push({type:"warning",icon:"ðŸ’¸",title:`Marge en chute de ${Math.abs(margeDiff)} points`,desc:`Marge Ã  ${last.margePct}% contre ${prev.margePct}%. ${last.salaire>prev.salaire?"Votre rÃ©munÃ©ration a augmentÃ©.":last.chargesOps>prev.chargesOps?"Charges opÃ©rationnelles en hausse.":"Vos charges globales pÃ¨sent plus lourd."}`,tip:"Passez en revue vos postes de dÃ©penses"});
  if(last.leads>0&&prev.leads>0){
   const closR=last.leadsClos>0?Math.round(last.leadsClos/last.leads*100):0;
   const prevClosR=prev.leadsClos>0?Math.round(prev.leadsClos/prev.leads*100):0;
   if(closR<prevClosR-10)ins.push({type:"warning",icon:"ðŸŽ¯",title:`Taux closing en baisse: ${closR}% vs ${prevClosR}%`,desc:"Vos leads convertissent moins bien",tip:"Revoyez votre process commercial ou la qualitÃ© des leads"});
  }
 }
 if(rw&&rw.months<3)ins.push({type:"danger",icon:"âš ",title:`Runway critique: ${rw.months} mois`,desc:`Votre trÃ©sorerie de ${fmt(last.treso)}â‚¬ ne couvre que ${rw.months} mois de charges.`,tip:"RÃ©duisez les dÃ©penses non-essentielles ou accÃ©lÃ©rez l'encaissement"});
 else if(rw&&rw.months>=9)ins.push({type:"success",icon:"ðŸ’ª",title:`Runway confortable: ${rw.months} mois`,desc:"Vous avez une marge de manÅ“uvre pour investir",tip:"Envisagez un investissement en croissance (ads, recrutement, outils)"});
 if(last.chargesOps>0&&last.ca>0&&last.chargesOps/last.ca>0.3)ins.push({type:"warning",icon:"âš™",title:"Charges opÃ© Ã©levÃ©es ("+pct(last.chargesOps,last.ca)+"%)",desc:`${fmt(last.chargesOps)}â‚¬ en logiciels/outils sur ${fmt(last.ca)}â‚¬ de CA`,tip:"Auditez vos abonnements, certains sont peut-Ãªtre sous-utilisÃ©s"});
 const lateAct=myActions.filter(a=>!a.done&&a.deadline&&a.deadline<curM());
 if(lateAct.length>=3)ins.push({type:"warning",icon:"ðŸ“‹",title:`${lateAct.length} actions en retard`,desc:"Des actions stratÃ©giques ne sont pas rÃ©alisÃ©es Ã  temps",tip:"Priorisez ou rÃ©Ã©valuez les actions non-pertinentes"});
 if(evo.length>=3){const last3=evo.slice(-3);const allUp=last3.every((d,i)=>i===0||d.ca>=last3[i-1].ca);if(allUp)ins.push({type:"success",icon:"ðŸ“ˆ",title:"3 mois de croissance consÃ©cutive",desc:`CA en hausse depuis ${last3[0].mois}`,tip:"Momentum positif â€” maintenez votre stratÃ©gie actuelle"});}
 return ins.slice(0,4);
}

/* ANONYMOUS BENCHMARK */
function calcBenchmark(soc,reps,socs,cM2){
 const actS=socs.filter(s=>s.stat==="active");if(actS.length<2)return null;
 const vals=actS.map(s=>{const r=gr(reps,s.id,cM2);if(!r)return null;const ca=pf(r.ca),ch=pf(r.charges),marg=ca>0?Math.round((ca-ch)/ca*100):0;const hs2=healthScore(s,reps);return{id:s.id,ca,marge:marg,score:hs2.score,treso:pf(r.tresoSoc)};}).filter(Boolean);
 if(vals.length<2)return null;
 const me=vals.find(v=>v.id===soc.id);if(!me)return null;
 const rank=(arr,val)=>{const sorted=[...arr].sort((a,b)=>a-b);const pos=sorted.indexOf(val);return pos>=0?Math.round((pos+1)/sorted.length*100):50;};
 const metrics=[
  {label:"CA",value:fmt(me.ca)+"â‚¬",pctile:rank(vals.map(v=>v.ca),me.ca),color:C.acc},
  {label:"Marge",value:me.marge+"%",pctile:rank(vals.map(v=>v.marge),me.marge),color:me.marge>0?C.g:C.r},
  {label:"Score santÃ©",value:me.score+"/100",pctile:rank(vals.map(v=>v.score),me.score),color:me.score>=70?C.g:me.score>=40?C.o:C.r},
  {label:"TrÃ©sorerie",value:fmt(me.treso)+"â‚¬",pctile:rank(vals.map(v=>v.treso),me.treso),color:C.b},
 ];
 const median=(arr)=>{const s=[...arr].sort((a,b)=>a-b);const m=Math.floor(s.length/2);return s.length%2?s[m]:(s[m-1]+s[m])/2;};
 return{metrics,total:actS.length,medianCA:median(vals.map(v=>v.ca)),medianScore:median(vals.map(v=>v.score))};
}

/* CONTEXTUAL PLAYBOOKS */
function getPlaybooks(evo,hs,rw,clients){
 const tips=[];const last=evo.length>0?evo[evo.length-1]:null;if(!last)return tips;
 const prev=evo.length>1?evo[evo.length-2]:null;
 if(hs.margin<10)tips.push({icon:"ðŸ’°",title:"Optimiser ma rentabilitÃ©",items:["Identifiez les 3 postes de charges les plus Ã©levÃ©s","NÃ©gociez vos tarifs fournisseurs (annuel vs mensuel)","Calculez le coÃ»t rÃ©el de chaque outil vs sa valeur","Augmentez vos prix si votre marge <20%"],color:C.g});
 if(hs.retention<10)tips.push({icon:"ðŸ”’",title:"AmÃ©liorer ma rÃ©tention client",items:["Contactez chaque client perdu pour comprendre pourquoi","Mettez en place un onboarding client structurÃ©","CrÃ©ez un check-in trimestriel avec vos top clients","Proposez des engagements annuels Ã  prix avantageux"],color:C.b});
 if(last.leads>0&&last.leadsClos>0&&last.leadsClos/last.leads<0.15)tips.push({icon:"ðŸŽ¯",title:"AmÃ©liorer mon taux de closing",items:["Qualifiez mieux vos leads avant le premier contact","Raccourcissez votre cycle de vente (max 2 relances)","PrÃ©parez des cas clients / tÃ©moignages","Testez l'offre d'essai ou la dÃ©mo gratuite"],color:C.o});
 if(rw&&rw.months<6)tips.push({icon:"âš¡",title:"SÃ©curiser ma trÃ©sorerie",items:["Facturez immÃ©diatement, pas Ã  30 jours","Proposez un escompte pour paiement anticipÃ©","Reportez les investissements non-urgents","Diversifiez vos sources de revenus"],color:C.r});
 if(hs.growth<10&&prev)tips.push({icon:"ðŸ“ˆ",title:"Relancer ma croissance",items:["Lancez une campagne de referral avec vos clients actuels","Testez un nouveau canal d'acquisition (pub, partenariats)","Proposez un upsell / cross-sell Ã  vos clients existants","CrÃ©ez du contenu qui attire vos prospects idÃ©aux"],color:C.v});
 return tips.slice(0,3);
}

/* PERSONAL GOALS */
const DEFAULT_GOALS=[
 {id:"ca",label:"CA mensuel",icon:"ðŸ’°",unit:"â‚¬",field:"ca"},
 {id:"clients",label:"Nouveaux clients",icon:"ðŸ‘¥",unit:"",field:"clients"},
 {id:"marge",label:"Marge minimum",icon:"ðŸ“Š",unit:"%",field:null},
 {id:"treso",label:"TrÃ©sorerie cible",icon:"ðŸ¦",unit:"â‚¬",field:"tresoSoc"},
];

function GoalEditor({goals,setGoals,evo}){
 const last=evo.length>0?evo[evo.length-1]:null;
 return <div style={{marginBottom:14}}>
  <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8}}>
   <div style={{color:C.td,fontSize:9,fontWeight:700,letterSpacing:.8}}>ðŸŽ¯ MES OBJECTIFS DU MOIS</div>
  </div>
  <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6}}>
  {DEFAULT_GOALS.map(g=>{
   const goal=goals[g.id]||0;const current=g.id==="marge"?(last?last.margePct:0):g.field&&last?last[g.field]||0:0;
   const progress=goal>0?Math.min(100,Math.round(current/goal*100)):0;
   const hit=goal>0&&current>=goal;
   return <div key={g.id} className="fu" style={{background:C.card,border:`1px solid ${hit?C.g:C.brd}`,borderRadius:10,padding:"10px 12px",transition:"all .2s"}}>
    <div style={{display:"flex",alignItems:"center",gap:5,marginBottom:6}}>
     <span style={{fontSize:12}}>{g.icon}</span>
     <span style={{fontSize:9,color:C.td,fontWeight:600,flex:1}}>{g.label}</span>
     {hit&&<span style={{fontSize:10,color:C.g}}>âœ“</span>}
    </div>
    <div style={{display:"flex",alignItems:"center",gap:6}}>
     <input value={goal||""} onChange={e=>{const v=parseInt(e.target.value)||0;setGoals(p=>({...p,[g.id]:v}));}} placeholder="Objectif" type="number" style={{width:60,background:C.card2,border:`1px solid ${C.brd}`,borderRadius:5,color:C.t,fontSize:11,padding:"3px 6px",fontFamily:FONT,outline:"none"}}/>
     <span style={{fontSize:8,color:C.td}}>{g.unit}</span>
     <div style={{flex:1,textAlign:"right"}}>
      <span style={{fontSize:12,fontWeight:800,color:hit?C.g:goal>0?C.t:C.td}}>{g.id==="marge"?current+"%":fmt(current)}{g.id!=="marge"&&g.unit?g.unit:""}</span>
     </div>
    </div>
    {goal>0&&<div style={{marginTop:6}}>
     <div style={{height:3,background:C.brd,borderRadius:2,overflow:"hidden"}}>
      <div style={{height:"100%",width:`${progress}%`,background:hit?C.g:progress>60?C.acc:C.o,borderRadius:2,transition:"width .4s"}}/>
     </div>
     <div style={{display:"flex",justifyContent:"space-between",marginTop:2}}><span style={{fontSize:7,color:C.td}}>{progress}%</span></div>
    </div>}
   </div>;
  })}
  </div>
 </div>;
}

/* CELEBRATION OVERLAY */
function CelebrationOverlay({milestone,onClose}){
 const[show,setShow]=useState(true);
 useEffect(()=>{const t=setTimeout(()=>{setShow(false);setTimeout(onClose,400);},5000);return()=>clearTimeout(t);},[]);
 const colors=["#c8a44e","#34d399","#60a5fa","#a78bfa","#fb923c","#f87171"];
 return <div style={{position:"fixed",inset:0,zIndex:10000,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(0,0,0,.7)",opacity:show?1:0,transition:"opacity .4s",pointerEvents:"auto"}} onClick={()=>{setShow(false);setTimeout(onClose,400);}}>
  {/* Confetti */}
  {Array.from({length:30}).map((_,i)=><div key={i} style={{position:"fixed",left:`${Math.random()*100}%`,top:-20,width:8+Math.random()*8,height:8+Math.random()*8,background:colors[i%colors.length],borderRadius:Math.random()>.5?"50%":"2px",animation:`confetti ${2+Math.random()*2}s ease-in ${Math.random()*.8}s both`,transform:`rotate(${Math.random()*360}deg)`}}/>)}
  {/* Card */}
  <div onClick={e=>e.stopPropagation()} style={{background:`linear-gradient(135deg,${C.card} 0%,#1a1a2c 100%)`,border:`2px solid ${C.acc}44`,borderRadius:20,padding:"32px 28px",maxWidth:340,textAlign:"center",animation:"celebIn .5s cubic-bezier(.16,1,.3,1) both",boxShadow:`0 0 60px rgba(200,164,78,.15)`}}>
   <div style={{fontSize:48,marginBottom:12,animation:"celebGlow 2s ease infinite"}}>{milestone.icon}</div>
   <div style={{color:C.acc,fontSize:10,fontWeight:700,letterSpacing:1.5,marginBottom:4}}>FÃ‰LICITATIONS ! ðŸŽ‰</div>
   <div style={{fontWeight:900,fontSize:20,color:C.t,marginBottom:6,fontFamily:FONT}}>{milestone.label}</div>
   <div style={{fontSize:12,color:C.td,lineHeight:1.5,marginBottom:16}}>Nouveau trophÃ©e dÃ©bloquÃ© par <strong style={{color:C.acc}}>Scale Corp</strong> â€” votre progression est remarquable !</div>
   <div style={{display:"flex",justifyContent:"center",gap:4,marginBottom:16}}>
    {["ðŸ¥‰","ðŸ¥ˆ","ðŸ¥‡","ðŸ’Ž","ðŸ‘‘"].map((t,i)=><span key={i} style={{fontSize:i<=(milestone.tier||0)?20:14,opacity:i<=(milestone.tier||0)?1:.2,transition:"all .3s",transitionDelay:`${i*.1}s`}}>{t}</span>)}
   </div>
   <button onClick={()=>{setShow(false);setTimeout(onClose,400);}} style={{background:`linear-gradient(135deg,${C.acc},#e8c85a)`,color:"#0a0a0f",border:"none",borderRadius:10,padding:"10px 24px",fontWeight:800,fontSize:12,cursor:"pointer",fontFamily:FONT}}>Continuer â†’</button>
  </div>
 </div>;
}

/* MEETING PREP */
function MeetingPrepView({soc,evo,myActions,myJournal,pulses,hs,rw,milestones,cM2,insights}){
 const last=evo.length>0?evo[evo.length-1]:null;const prev=evo.length>1?evo[evo.length-2]:null;
 const actionsDone=myActions.filter(a=>a.done);const actionsOpen=myActions.filter(a=>!a.done);
 const recentPulses=Object.entries(pulses).filter(([k])=>k.startsWith(soc.id+"_")).map(([k,v])=>({week:k.replace(soc.id+"_",""),...v})).sort((a,b)=>b.week.localeCompare(a.week)).slice(0,4);
 const newMilestones=milestones.filter(m=>m.unlocked).slice(-3);
 return <div>
  <div className="fu" style={{display:"flex",alignItems:"center",gap:10,marginBottom:16,padding:"14px 16px",background:`linear-gradient(135deg,${C.card} 0%,#1a1a2c 100%)`,borderRadius:14,border:`1px solid ${C.acc}22`}}>
   <span style={{fontSize:24}}>ðŸ“‹</span>
   <div><div style={{fontWeight:800,fontSize:14,color:C.t}}>PrÃ©pa point mensuel</div><div style={{fontSize:10,color:C.td}}>RÃ©sumÃ© auto-gÃ©nÃ©rÃ© pour votre RDV avec Scale Corp</div></div>
  </div>
  {/* Situation */}
  <Sect title="Situation actuelle">
   <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(100px,1fr))",gap:6,marginBottom:10}}>
    <KPI label="CA" value={last?`${fmt(last.ca)}â‚¬`:"â€”"} accent={C.acc} icon="ðŸ’°" small/>
    <KPI label="Marge" value={last?`${last.margePct}%`:"â€”"} accent={last&&last.marge>=0?C.g:C.r} icon="ðŸ“Š" small/>
    <KPI label="Score" value={`${hs.grade} (${hs.score})`} accent={hs.color} icon="â¤" small/>
    {rw&&<KPI label="Runway" value={`${rw.months}m`} accent={rw.months<3?C.r:rw.months<6?C.o:C.g} icon="â³" small/>}
   </div>
   {prev&&<div style={{padding:"8px 10px",background:C.card2,borderRadius:8,fontSize:10,color:C.td,lineHeight:1.5}}>
    Variation CA : <strong style={{color:last.ca>=prev.ca?C.g:C.r}}>{last.ca>=prev.ca?"+":"âˆ’"}{prev.ca>0?pct(Math.abs(last.ca-prev.ca),prev.ca):0}%</strong> Â· Marge : <strong style={{color:last.margePct>=prev.margePct?C.g:C.r}}>{last.margePct>=prev.margePct?"+":"âˆ’"}{Math.abs(last.margePct-prev.margePct)} pts</strong>
   </div>}
  </Sect>
  {/* Insights / alertes */}
  {insights.length>0&&<Sect title="Points d'attention">
   {insights.map((ins,i)=><div key={i} style={{display:"flex",gap:8,padding:"8px 0",borderBottom:i<insights.length-1?`1px solid ${C.brd}08`:"none"}}>
    <span style={{fontSize:14}}>{ins.icon}</span>
    <div><div style={{fontWeight:600,fontSize:11,color:ins.type==="danger"?C.r:ins.type==="warning"?C.o:C.g}}>{ins.title}</div><div style={{fontSize:9,color:C.td,marginTop:1}}>{ins.tip}</div></div>
   </div>)}
  </Sect>}
  {/* Actions */}
  <Sect title={`Actions (${actionsDone.length} faites / ${actionsOpen.length} en cours)`}>
   {actionsOpen.length>0&&<div style={{marginBottom:8}}>{actionsOpen.slice(0,5).map(a=><div key={a.id} style={{fontSize:10,color:C.t,padding:"3px 0",display:"flex",gap:5}}>
    <span style={{color:a.deadline<cM2?C.r:C.o}}>â—‹</span><span>{a.text}</span>{a.deadline<cM2&&<span style={{fontSize:8,color:C.r,fontWeight:600}}>retard</span>}
   </div>)}</div>}
   {actionsDone.length>0&&<div style={{borderTop:`1px solid ${C.brd}`,paddingTop:6}}>{actionsDone.slice(-3).map(a=><div key={a.id} style={{fontSize:10,color:C.td,padding:"2px 0"}}><span style={{color:C.g}}>âœ“</span> {a.text}</div>)}</div>}
   {actionsOpen.length===0&&actionsDone.length===0&&<div style={{fontSize:10,color:C.td}}>Aucune action en cours</div>}
  </Sect>
  {/* Pulses */}
  {recentPulses.length>0&&<Sect title="Mood rÃ©cent">
   <div style={{display:"flex",gap:6}}>
   {recentPulses.map((p,i)=><div key={i} style={{flex:1,textAlign:"center",padding:"6px 4px",background:C.card2,borderRadius:8}}>
    <div style={{fontSize:16}}>{"ðŸ˜«ðŸ˜•ðŸ˜ðŸ™‚ðŸ˜„"[clamp(p.mood-1,0,4)]}</div>
    <div style={{fontSize:8,color:C.td,marginTop:2}}>{p.mood}/5</div>
    {p.win&&<div style={{fontSize:7,color:C.g,marginTop:2,lineHeight:1.2}}>{p.win.slice(0,30)}</div>}
   </div>)}
   </div>
  </Sect>}
  {/* Milestones rÃ©cents */}
  {newMilestones.length>0&&<Sect title="Derniers trophÃ©es">
   <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
   {newMilestones.map(m=><div key={m.id} style={{display:"flex",alignItems:"center",gap:4,padding:"4px 8px",background:TIER_BG[m.tier],borderRadius:6,border:`1px solid ${TIER_COLORS[m.tier]}22`}}>
    <span style={{fontSize:14}}>{m.icon}</span><span style={{fontSize:9,fontWeight:600,color:C.t}}>{m.label}</span>
   </div>)}
   </div>
  </Sect>}
  {/* Questions Ã  prÃ©parer */}
  <Sect title="Questions Ã  poser">
   <div style={{padding:"10px 12px",background:C.card2,borderRadius:8,color:C.td,fontSize:10,lineHeight:1.7}}>
    <div>â€¢ Quels sont mes 3 leviers prioritaires pour le prochain mois ?</div>
    <div>â€¢ Y a-t-il des synergies avec d'autres sociÃ©tÃ©s du portfolio ?</div>
    {rw&&rw.months<6&&<div>â€¢ StratÃ©gie pour renforcer ma trÃ©sorerie ?</div>}
    {actionsOpen.length>3&&<div>â€¢ Peut-on reprioriser mes actions (j'en ai {actionsOpen.length} en parallÃ¨le) ?</div>}
    <div>â€¢ Quelles ressources Scale Corp sont sous-exploitÃ©es ?</div>
   </div>
  </Sect>
 </div>;
}

function CollapsibleSection({title,icon,children,defaultOpen=false}){
 const[open,setOpen]=useState(defaultOpen);
 return <div style={{marginBottom:8,border:`1px solid ${C.brd}`,borderRadius:10,overflow:"hidden",background:C.card2}}>
  <button onClick={()=>setOpen(!open)} style={{width:"100%",display:"flex",alignItems:"center",gap:8,padding:"8px 12px",border:"none",background:"transparent",cursor:"pointer",fontFamily:FONT,textAlign:"left"}}>
   <span style={{fontSize:12}}>{icon}</span>
   <span style={{flex:1,fontWeight:600,fontSize:11,color:C.t}}>{title}</span>
   <span style={{fontSize:9,color:C.td,transition:"transform .2s",transform:open?"rotate(90deg)":"rotate(0)"}}>â–¶</span>
  </button>
  <div style={{maxHeight:open?500:0,overflow:"hidden",transition:"max-height .25s ease",opacity:open?1:0}}>
   <div style={{padding:"0 12px 10px"}}>{children}</div>
  </div>
 </div>;
}

function SocSettingsPanel({soc,save,socs}){
 const[form,setForm]=useState({nom:soc.nom,porteur:soc.porteur,act:soc.act,color:soc.color,logo:soc.logo||"",email:soc.email||"",phone:soc.phone||"",desc:soc.desc||"",logoUrl:soc.logoUrl||"",brandColor:soc.brandColor||"",brandColorSecondary:soc.brandColorSecondary||""});
 const[saved,setSaved]=useState(false);
 const fileRef=useRef(null);
 const doSave=()=>{const updated=socs.map(s=>s.id===soc.id?{...s,...form}:s);save(updated,null,null);setSaved(true);setTimeout(()=>setSaved(false),2500);};
 const handleLogoUpload=(e)=>{const file=e.target.files?.[0];if(!file)return;if(!file.type.startsWith("image/"))return;if(file.size>2*1024*1024){alert("Image trop lourde (max 2 Mo)");return;}const reader=new FileReader();reader.onload=(ev)=>{setForm(f=>({...f,logoUrl:ev.target.result}));};reader.readAsDataURL(file);};
 const accent=form.brandColor||form.color;
 const accent2=form.brandColorSecondary||"";
 return <Sect title="âš™ï¸ ParamÃ¨tres" sub={soc.nom}>
  {saved&&<div style={{background:C.gD,border:`1px solid ${C.g}22`,borderRadius:8,padding:"8px 12px",marginBottom:12,color:C.g,fontSize:11,fontWeight:700}}>âœ… ParamÃ¨tres sauvegardÃ©s</div>}
  <Card style={{padding:16,marginBottom:12}}>
   <div style={{display:"flex",alignItems:"center",gap:14,marginBottom:16}}>
    <div style={{width:56,height:56,borderRadius:28,background:accent+"22",border:`2px solid ${accent}44`,display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden",flexShrink:0}}>
     {form.logoUrl?<img src={form.logoUrl} alt="" style={{width:"100%",height:"100%",objectFit:"cover"}}/>:form.logo?<img src={form.logo} alt="" style={{width:"100%",height:"100%",objectFit:"cover"}}/>:<span style={{fontSize:24,fontWeight:900,color:accent}}>{(form.nom||"?")[0]}</span>}
    </div>
    <div style={{flex:1}}>
     <div style={{fontWeight:800,fontSize:16,color:C.t}}>{form.nom||"Sans nom"}</div>
     <div style={{fontSize:11,color:C.td}}>{form.act} Â· {form.porteur}</div>
    </div>
   </div>
   <Inp label="Nom de la sociÃ©tÃ©" value={form.nom} onChange={v=>setForm({...form,nom:v})}/>
   <Inp label="ActivitÃ©" value={form.act} onChange={v=>setForm({...form,act:v})}/>
   <Inp label="Porteur (fondateur)" value={form.porteur} onChange={v=>setForm({...form,porteur:v})}/>
   <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"0 10px"}}>
    <Inp label="Email" value={form.email} onChange={v=>setForm({...form,email:v})} placeholder="contact@..."/>
    <Inp label="TÃ©lÃ©phone" value={form.phone} onChange={v=>setForm({...form,phone:v})} placeholder="+33..."/>
   </div>
   <Inp label="Description" value={form.desc} onChange={v=>setForm({...form,desc:v})} placeholder="DÃ©crivez l'activitÃ© de la sociÃ©tÃ©..."/>
  </Card>
  {/* Branding section */}
  <Card style={{padding:16,marginBottom:12}}>
   <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:14}}><span style={{fontSize:16}}>ðŸŽ¨</span><div><div style={{fontWeight:800,fontSize:13,color:C.t}}>Branding</div><div style={{fontSize:10,color:C.td}}>Personnalisez l'apparence de votre espace</div></div></div>
   {/* Logo upload */}
   <div style={{marginBottom:14}}>
    <label style={{display:"block",color:C.td,fontSize:10,fontWeight:600,marginBottom:6,letterSpacing:.3}}>Logo / Photo de profil</label>
    <div style={{display:"flex",alignItems:"center",gap:12}}>
     <div style={{width:64,height:64,borderRadius:32,background:accent+"15",border:`2px dashed ${accent}44`,display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden",flexShrink:0,cursor:"pointer",transition:"border-color .2s"}} onClick={()=>fileRef.current?.click()} onMouseEnter={e=>e.currentTarget.style.borderColor=accent} onMouseLeave={e=>e.currentTarget.style.borderColor=accent+"44"}>
      {form.logoUrl?<img src={form.logoUrl} alt="" style={{width:"100%",height:"100%",objectFit:"cover"}}/>:<span style={{fontSize:10,color:C.td,textAlign:"center",lineHeight:1.2}}>ðŸ“·<br/>Cliquer</span>}
     </div>
     <div style={{flex:1}}>
      <input ref={fileRef} type="file" accept="image/jpeg,image/png" onChange={handleLogoUpload} style={{display:"none"}}/>
      <Btn small v="secondary" onClick={()=>fileRef.current?.click()}>ðŸ“ Choisir une image</Btn>
      <div style={{fontSize:9,color:C.tm,marginTop:4}}>JPEG ou PNG, max 2 Mo</div>
      {form.logoUrl&&<Btn small v="ghost" onClick={()=>setForm({...form,logoUrl:""})} style={{marginTop:4,fontSize:9}}>âœ• Supprimer le logo</Btn>}
     </div>
    </div>
    <Inp label="Ou URL externe" value={form.logoUrl.startsWith("data:")?"":(form.logoUrl||"")} onChange={v=>setForm({...form,logoUrl:v})} placeholder="https://..." small note="Laisser vide pour utiliser le fichier uploadÃ©"/>
   </div>
   {/* Color pickers */}
   <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginBottom:14}}>
    <div>
     <label style={{display:"block",color:C.td,fontSize:10,fontWeight:600,marginBottom:4,letterSpacing:.3}}>Couleur principale</label>
     <div style={{display:"flex",alignItems:"center",gap:8}}>
      <input type="color" value={form.brandColor||form.color} onChange={e=>setForm({...form,brandColor:e.target.value})} style={{width:36,height:28,border:`1px solid ${C.brd}`,borderRadius:8,background:C.bg,cursor:"pointer",padding:1}}/>
      <span style={{fontSize:10,color:C.td,fontFamily:"monospace"}}>{form.brandColor||form.color}</span>
      {form.brandColor&&<Btn small v="ghost" onClick={()=>setForm({...form,brandColor:""})} style={{fontSize:8,padding:"2px 6px"}}>Reset</Btn>}
     </div>
    </div>
    <div>
     <label style={{display:"block",color:C.td,fontSize:10,fontWeight:600,marginBottom:4,letterSpacing:.3}}>Couleur secondaire <span style={{fontWeight:400,color:C.tm}}>(optionnel)</span></label>
     <div style={{display:"flex",alignItems:"center",gap:8}}>
      <input type="color" value={form.brandColorSecondary||"#60a5fa"} onChange={e=>setForm({...form,brandColorSecondary:e.target.value})} style={{width:36,height:28,border:`1px solid ${C.brd}`,borderRadius:8,background:C.bg,cursor:"pointer",padding:1}}/>
      <span style={{fontSize:10,color:C.td,fontFamily:"monospace"}}>{form.brandColorSecondary||"â€”"}</span>
      {form.brandColorSecondary&&<Btn small v="ghost" onClick={()=>setForm({...form,brandColorSecondary:""})} style={{fontSize:8,padding:"2px 6px"}}>Reset</Btn>}
     </div>
    </div>
   </div>
   {/* Preview */}
   <div style={{background:C.bg,border:`1px solid ${C.brd}`,borderRadius:10,padding:14}}>
    <div style={{color:C.td,fontSize:9,fontWeight:700,letterSpacing:.8,marginBottom:8}}>APERÃ‡U</div>
    <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:10}}>
     <div style={{width:36,height:36,borderRadius:18,background:accent+"22",border:`2px solid ${accent}44`,display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden",flexShrink:0}}>
      {form.logoUrl?<img src={form.logoUrl} alt="" style={{width:"100%",height:"100%",objectFit:"cover"}}/>:<span style={{fontSize:14,fontWeight:900,color:accent}}>{(form.nom||"?")[0]}</span>}
     </div>
     <div><div style={{fontWeight:800,fontSize:13,color:accent}}>{form.nom||"Ma sociÃ©tÃ©"}</div><div style={{fontSize:9,color:C.td}}>{form.porteur}</div></div>
    </div>
    <div style={{display:"flex",gap:8}}>
     <div style={{flex:1,background:C.card,border:`1px solid ${accent}33`,borderRadius:8,padding:"8px 10px"}}><div style={{fontSize:8,color:C.td}}>KPI</div><div style={{fontWeight:800,fontSize:14,color:accent}}>12 500â‚¬</div></div>
     <div style={{flex:1,background:C.card,border:`1px solid ${(accent2||C.b)}33`,borderRadius:8,padding:"8px 10px"}}><div style={{fontSize:8,color:C.td}}>KPI 2</div><div style={{fontWeight:800,fontSize:14,color:accent2||C.b}}>8 200â‚¬</div></div>
    </div>
   </div>
  </Card>
  <Btn onClick={doSave}>ðŸ’¾ Sauvegarder</Btn>
 </Sect>;
}
/* PORTEUR DASHBOARD */
function PorteurDashboard({soc,reps,allM,socBank,ghlData,setPTab}){
 const cm=curM();const report=gr(reps,soc.id,cm);
 const bankData=socBank?.[soc.id];const acc2=soc.brandColor||soc.color||C.acc;
 const ca=report?pf(report.ca):0;const charges=report?pf(report.charges):0;
 const marge=ca-charges;const margePct=ca>0?Math.round(marge/ca*100):0;
 const treso=bankData?.balance||0;
 const pm=prevM(cm);const prevReport=gr(reps,soc.id,pm);
 const prevCa=prevReport?pf(prevReport.ca):0;
 const caTrend=prevCa>0?Math.round((ca-prevCa)/prevCa*100):0;
 // Last 6 months chart data
 const chartData=useMemo(()=>{
  const months=[];let m=cm;for(let i=0;i<6;i++){months.unshift(m);m=prevM(m);}
  return months.map(mo=>{const r=gr(reps,soc.id,mo);return{month:ml(mo).split(" ")[0],ca:r?pf(r.ca):0,charges:r?pf(r.charges):0};});
 },[reps,soc.id,cm]);
 const maxVal=Math.max(1,...chartData.map(d=>Math.max(d.ca,d.charges)));
 // Recent transactions
 const excluded=EXCLUDED_ACCOUNTS[soc.id]||[];
 const recentTx=useMemo(()=>{
  if(!bankData?.transactions)return[];
  return bankData.transactions.filter(t=>{const leg=t.legs?.[0];if(!leg)return false;if(excluded.includes(leg.account_id))return false;return true;}).slice(0,5);
 },[bankData,excluded]);
 // GHL stats
 const ghlStats=ghlData?.[soc.id]?.stats;
 const ghlStages=ghlData?.[soc.id]?.pipelines?.[0]?.stages||[];
 const ghlOpps=ghlData?.[soc.id]?.opportunities||[];
 const kpis=[
  {label:"CA du mois",value:`${fmt(ca)}â‚¬`,trend:caTrend,accent:acc2},
  {label:"Charges",value:`${fmt(charges)}â‚¬`,accent:C.r},
  {label:"Marge",value:`${fmt(marge)}â‚¬`,sub:`${margePct}%`,accent:marge>=0?C.g:C.r},
  {label:"TrÃ©sorerie",value:`${fmt(treso)}â‚¬`,accent:soc.brandColorSecondary||C.b},
 ];
 return <div className="fu">
  {/* Hero KPIs */}
  <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(140px,1fr))",gap:12,marginBottom:20}}>
   {kpis.map((k,i)=><div key={i} className="fade-up" style={{background:C.card,border:`1px solid ${C.brd}`,borderRadius:14,padding:20,animationDelay:`${i*0.1}s`}}>
    <div style={{color:C.td,fontSize:10,fontWeight:700,letterSpacing:.8,textTransform:"uppercase",marginBottom:6}}>{k.label}</div>
    <div style={{fontSize:24,fontWeight:900,color:k.accent||C.t,lineHeight:1}}>{k.value}</div>
    {k.trend!==undefined&&k.trend!==0&&<div style={{marginTop:4,fontSize:11,fontWeight:700,color:k.trend>0?C.g:C.r}}>{k.trend>0?"â†‘":"â†“"} {Math.abs(k.trend)}% vs mois dernier</div>}
    {k.sub&&!k.trend&&<div style={{marginTop:4,fontSize:11,fontWeight:700,color:k.accent}}>{k.sub}</div>}
   </div>)}
  </div>
  {/* Revenue chart */}
  <div className="fade-up" style={{background:C.card,border:`1px solid ${C.brd}`,borderRadius:14,padding:20,marginBottom:20,animationDelay:"0.4s"}}>
   <div style={{color:C.td,fontSize:10,fontWeight:700,letterSpacing:.8,marginBottom:12}}>CA VS CHARGES â€” 6 DERNIERS MOIS</div>
   <svg viewBox="0 0 480 200" style={{width:"100%",height:"auto"}}>
    {chartData.map((d,i)=>{
     const bw=30,gap=50,x=40+i*gap+i*bw;
     const hCa=maxVal>0?(d.ca/maxVal)*160:0;
     const hCh=maxVal>0?(d.charges/maxVal)*160:0;
     return <g key={i}>
      <rect x={x} y={180-hCa} width={bw} height={hCa} fill={acc2} rx={4} style={{transformOrigin:`${x+bw/2}px 180px`,animation:`barGrow 0.6s ease ${0.1*i}s both`}}/>
      <rect x={x+bw+4} y={180-hCh} width={bw} height={hCh} fill={C.r+"88"} rx={4} style={{transformOrigin:`${x+bw+4+bw/2}px 180px`,animation:`barGrow 0.6s ease ${0.1*i+0.05}s both`}}/>
      <text x={x+bw+2} y={196} textAnchor="middle" fill={C.td} fontSize="9" fontFamily={FONT}>{d.month}</text>
      {d.ca>0&&<text x={x+bw/2} y={180-hCa-4} textAnchor="middle" fill={acc2} fontSize="8" fontWeight="700" fontFamily={FONT}>{fK(d.ca)}</text>}
     </g>;
    })}
    <line x1="30" y1="180" x2="470" y2="180" stroke={C.brd} strokeWidth="1"/>
   </svg>
   <div style={{display:"flex",gap:16,justifyContent:"center",marginTop:8}}>
    <div style={{display:"flex",alignItems:"center",gap:4,fontSize:10,color:C.td}}><span style={{width:10,height:10,borderRadius:3,background:acc2}}/> CA</div>
    <div style={{display:"flex",alignItems:"center",gap:4,fontSize:10,color:C.td}}><span style={{width:10,height:10,borderRadius:3,background:C.r+"88"}}/> Charges</div>
   </div>
  </div>
  {/* Quick Actions */}
  <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:12,marginBottom:20}}>
   {[{icon:"ðŸ‘¥",title:"Mes clients",sub:"Voir le portefeuille",tab:9},{icon:"ðŸ¦",title:"Transactions",sub:"Historique bancaire",tab:5},{icon:"âš™ï¸",title:"ParamÃ¨tres",sub:"Configurer ma sociÃ©tÃ©",tab:12}].map((a,i)=>
    <div key={i} className="fade-up hv" onClick={()=>setPTab(a.tab)} style={{background:C.card,border:`1px solid ${C.brd}`,borderRadius:14,padding:16,cursor:"pointer",textAlign:"center",animationDelay:`${0.5+i*0.1}s`}}>
     <div style={{fontSize:24,marginBottom:6}}>{a.icon}</div>
     <div style={{fontWeight:700,fontSize:12,color:C.t}}>{a.title}</div>
     <div style={{fontSize:10,color:C.td,marginTop:2}}>{a.sub}</div>
    </div>
   )}
  </div>
  {/* Recent transactions */}
  {recentTx.length>0&&<div className="fade-up" style={{background:C.card,border:`1px solid ${C.brd}`,borderRadius:14,padding:16,marginBottom:20,animationDelay:"0.8s"}}>
   <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
    <span style={{color:C.td,fontSize:10,fontWeight:700,letterSpacing:.8}}>DERNIÃˆRES TRANSACTIONS</span>
    <span onClick={()=>setPTab(5)} style={{color:C.acc,fontSize:10,fontWeight:600,cursor:"pointer"}}>Voir tout â†’</span>
   </div>
   {recentTx.map((tx,i)=>{const leg=tx.legs?.[0];if(!leg)return null;const isIn=leg.amount>0;const cat=categorizeTransaction(tx);
    const catColors={"revenus":C.g,"loyer":"#f59e0b","pub":"#ec4899","abonnements":C.b,"equipe":C.o,"transfert":"#6366f1","dividendes":"#7c3aed","autres":C.td};
    return <div key={tx.id||i} style={{display:"flex",alignItems:"center",gap:8,padding:"6px 0",borderBottom:i<recentTx.length-1?`1px solid ${C.brd}`:"none"}}>
     <span style={{width:22,height:22,borderRadius:6,background:isIn?C.gD:C.rD,display:"flex",alignItems:"center",justifyContent:"center",fontSize:9,color:isIn?C.g:C.r,flexShrink:0}}>{cat.icon||"â†‘"}</span>
     <div style={{flex:1,minWidth:0}}>
      <div style={{display:"flex",alignItems:"center",gap:4}}><span style={{fontWeight:600,fontSize:11,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{leg.description||tx.reference||"â€”"}</span><span style={{fontSize:8,padding:"1px 5px",borderRadius:8,background:(catColors[cat.id]||C.td)+"22",color:catColors[cat.id]||C.td,fontWeight:600,flexShrink:0}}>{cat.label}</span></div>
      <div style={{fontSize:9,color:C.td}}>{new Date(tx.created_at).toLocaleDateString("fr-FR")}</div>
     </div>
     <span style={{fontWeight:700,fontSize:11,color:isIn?C.g:C.r}}>{isIn?"+":""}{fmt(leg.amount)}â‚¬</span>
    </div>;
   })}
  </div>}
  {/* Pipeline snapshot */}
  {ghlStats&&<div className="fade-up" style={{background:C.card,border:`1px solid ${C.brd}`,borderRadius:14,padding:16,animationDelay:"0.9s"}}>
   <div style={{color:C.td,fontSize:10,fontWeight:700,letterSpacing:.8,marginBottom:10}}>PIPELINE</div>
   <div style={{display:"flex",gap:12,marginBottom:12}}>
    <div><div style={{fontSize:20,fontWeight:900,color:acc2}}>{fmt(ghlStats.pipelineValue)}â‚¬</div><div style={{fontSize:9,color:C.td}}>Valeur pipeline</div></div>
    <div><div style={{fontSize:20,fontWeight:900,color:C.b}}>{ghlStats.openDeals}</div><div style={{fontSize:9,color:C.td}}>Deals actifs</div></div>
    <div><div style={{fontSize:20,fontWeight:900,color:C.g}}>{ghlStats.wonDeals}</div><div style={{fontSize:9,color:C.td}}>GagnÃ©s</div></div>
   </div>
   {ghlStages.length>0&&<div style={{display:"flex",gap:4,flexWrap:"wrap"}}>
    {ghlStages.map((stage,i)=>{const count=ghlOpps.filter(o=>o.stage===stage).length;
     return <span key={i} style={{padding:"3px 10px",borderRadius:20,fontSize:10,fontWeight:600,background:GHL_STAGES_COLORS[i%GHL_STAGES_COLORS.length]+"22",color:GHL_STAGES_COLORS[i%GHL_STAGES_COLORS.length],border:`1px solid ${GHL_STAGES_COLORS[i%GHL_STAGES_COLORS.length]}33`}}>{stage}: {count}</span>;
    })}
   </div>}
  </div>}
 </div>;
}
function SocieteView({soc,reps,allM,save,onLogout,actions,journal,pulses,saveAJ,savePulse,socBankData,syncSocBank,okrs,saveOkrs,kb,saveKb,socs,subs,saveSubs,team,saveTeam,clients,saveClients,ghlData,invoices,saveInvoices,hold,onTour}){
 const cM2=curM();const[pTab,setPTab]=useState(0);const[mo,setMo]=useState(cM2);
 const[f,setF]=useState(()=>gr(reps,soc.id,cM2)||{...BF});const[done,setDone]=useState(false);const[showPub,setShowPub]=useState(false);const[jText,setJText]=useState("");
 useEffect(()=>{const ex=gr(reps,soc.id,mo)||{...BF};setF(ex);setShowPub(!!pf(ex.pub));setDone(false);},[mo,soc.id]);
 const ex=gr(reps,soc.id,mo),ca=pf(f.ca),ch=pf(f.charges),marge=ca-ch;
 const remontee=(soc.pT==="ca"?ca:Math.max(0,marge))*soc.pP/100;
 const oP=soc.obj>0&&ca>0?pct(ca,soc.obj):null;const past=Object.entries(reps).filter(([k])=>k.startsWith(soc.id+"_")).sort(([a2],[b2])=>b2.localeCompare(a2)).slice(0,6);
 const evo=allM.map(m=>{const r=gr(reps,soc.id,m);if(!r)return null;const rca=pf(r.ca),rch=pf(r.charges),sal=pf(r.salaire),ops=pf(r.chargesOps),form=pf(r.formation),pub=pf(r.pub),lds=pf(r.leads),ldC=pf(r.leadsContact),ldCl=pf(r.leadsClos);return{mois:ml(m),m,ca:rca,marge:rca-rch,margePct:rca>0?Math.round((rca-rch)/rca*100):0,mrr:pf(r.mrr),pipeline:pf(r.pipeline),treso:pf(r.tresoSoc),salaire:sal,chargesOps:ops,formation:form,pub,leads:lds,leadsContact:ldC,leadsClos:ldCl,charges:rch};}).filter(Boolean);
 const exCur=gr(reps,soc.id,cM2);const status=exCur?(exCur.ok?"validated":"pending"):"missing";
 const statusColor={missing:C.r,pending:C.o,validated:C.g}[status];const statusText={missing:"Ã€ soumettre",pending:"En attente",validated:"âœ“ ValidÃ©"}[status];
 const hs=healthScore(soc,reps);const myActions=actions.filter(a2=>a2.socId===soc.id);const myJournal=(journal[soc.id]||[]).sort((a2,b2)=>new Date(b2.date)-new Date(a2.date));
 const rw=runway(reps,soc.id,allM);
 const totalCA=evo.reduce((a2,d)=>a2+d.ca,0);const avgCA=evo.length>0?Math.round(totalCA/evo.length):0;
 const milestones=useMemo(()=>calcMilestones(soc,reps,actions,pulses,allM),[soc,reps,actions,pulses,allM]);
 const doSub=()=>{
  const newReps={...reps,[`${soc.id}_${mo}`]:{...f,at:new Date().toISOString(),ok:ex?.ok||false,comment:ex?.comment||""}};
  save(null,newReps,null);setDone(true);setTimeout(()=>setDone(false),2500);
  if(hold?.slack?.enabled&&hold.slack.notifyReport){
   slackSend(hold.slack,buildReportSlackMsg(soc,f,mo)).then(r=>{if(r.ok)console.log("Slack: report notified");});
  }
 };
 const toggleAction=(id)=>{saveAJ(actions.map(a2=>a2.id===id?{...a2,done:!a2.done}:a2),null);};
 const addJournal=()=>{if(!jText.trim())return;saveAJ(null,{...journal,[soc.id]:[...myJournal,{id:uid(),date:new Date().toISOString(),text:jText.trim()}]});setJText("");};
 const bankFin=revFinancials(socBankData,mo);
 const autoFill=()=>{if(!bankFin)return;setF(prev=>({...prev,ca:String(bankFin.ca),charges:String(bankFin.expense||bankFin.charges),tresoSoc:String(bankFin.tresoSoc)}));};
 /* NEW: Personal goals */
 const[goals,setGoals]=useState({});
 /* NEW: Celebration */
 const[celebMs,setCelebMs]=useState(null);
 const prevUnlocked=useRef(null);
 useEffect(()=>{
  const unlocked=milestones.filter(m=>m.unlocked);
  if(prevUnlocked.current!==null){
   const newOnes=unlocked.filter(m=>!prevUnlocked.current.find(p=>p.id===m.id));
   if(newOnes.length>0)setCelebMs(newOnes[newOnes.length-1]);
  }
  prevUnlocked.current=unlocked;
 },[milestones]);
 /* NEW: Computed insights, benchmark, playbooks */
 const insights=useMemo(()=>genInsights(evo,hs,rw,myActions,soc,reps,allM),[evo,hs,rw,myActions]);
 const benchmark=useMemo(()=>calcBenchmark(soc,reps,socs,cM2),[soc,reps,socs,cM2]);
 const playbooks=useMemo(()=>getPlaybooks(evo,hs,rw,clients),[evo,hs,rw,clients]);
 return <div style={{display:"flex",background:C.bg,minHeight:"100vh",fontFamily:FONT,color:C.t}}>
  <style>{CSS}</style>
  <Sidebar items={SB_PORTEUR} activeTab={pTab} setTab={setPTab} brandTitle={soc.nom} brandSub={`${soc.porteur}${soc.incub?" Â· "+sinceLbl(soc.incub):""}`} onLogout={onLogout} onTour={onTour||(() => {})} dataTourPrefix="porteur" brand={{logoUrl:soc.logoUrl||"",logoLetter:(soc.nom||"?")[0],accentColor:soc.brandColor||soc.color}} extra={<div style={{display:"flex",alignItems:"center",gap:4,flexWrap:"wrap"}}>
   {(()=>{const myC=clients.filter(c=>c.socId===soc.id&&c.status==="active");const mrr=myC.reduce((a,c)=>a+clientMonthlyRevenue(c),0);return myC.length>0?<span style={{fontSize:8,color:C.b,fontWeight:700,background:C.bD,padding:"2px 6px",borderRadius:8}}>ðŸ‘¥{myC.length} Â· {fK(mrr)}â‚¬/m</span>:null;})()}
   <MilestoneCount milestones={milestones}/>
   <GradeBadge grade={hs.grade} color={hs.color}/>
   {rw&&<span style={{fontSize:8,color:rw.months<3?C.r:rw.months<6?C.o:C.g,fontWeight:700,background:rw.months<3?C.rD:rw.months<6?C.oD:C.gD,padding:"2px 6px",borderRadius:8}}>{rw.months}m</span>}
  </div>}/>
  <div style={{flex:1,minWidth:0,height:"100vh",overflow:"auto"}}>
  {celebMs&&<CelebrationOverlay milestone={celebMs} onClose={()=>setCelebMs(null)}/>}
  <div style={{padding:16,maxWidth:680,margin:"0 auto"}}>
  {/* === PORTEUR DASHBOARD (pTab 0) === */}
  {pTab===0&&<PorteurDashboard soc={soc} reps={reps} allM={allM} socBank={socBankData?{[soc.id]:socBankData}:{}} ghlData={ghlData} setPTab={setPTab} soc2={soc} clients={clients}/>}
  {pTab===5&&<><SocBankWidget bankData={socBankData} onSync={()=>syncSocBank(soc.id)} soc={soc}/>
   <SubsTeamPanel socs={[soc]} subs={subs} saveSubs={saveSubs} team={team} saveTeam={saveTeam} socId={soc.id} reps={reps} socBankData={socBankData}/>
  </>}
  {pTab===9&&<ClientsPanel soc={soc} clients={clients} saveClients={saveClients} ghlData={ghlData} socBankData={socBankData} invoices={invoices} saveInvoices={saveInvoices}/>}
  {pTab===12&&<SocSettingsPanel soc={soc} save={save} socs={socs}/>}
  </div>
  </div>
 </div>;
}
/* ADMIN VALROW */
function ValRow({s,r,reps,save,hs,delay,onAction,hold}){
 const[open,setOpen]=useState(false);const[cmt,setCmt]=useState(r.comment||"");const[actText,setActText]=useState("");
 const ca=pf(r.ca),ch=pf(r.charges),mrr=pf(r.mrr),pipe=pf(r.pipeline),ts=pf(r.tresoSoc),marge=ca-ch,m=curM();
 const doVal=(wc)=>{
  const finalComment=wc?cmt:r.comment;
  save(null,{...reps,[`${s.id}_${m}`]:{...r,ok:true,comment:finalComment}},null);setOpen(false);
  if(hold?.slack?.enabled&&hold.slack.notifyValidation){
   slackSend(hold.slack,buildValidationSlackMsg(s,finalComment,m));
  }
 };
 const prevR=gr(reps,s.id,prevM(m)),prevCa=prevR?pf(prevR.ca):0;const trend=prevCa>0?pct(ca-prevCa,prevCa):null;
 return <div className={`fu d${delay}`}>
  <div style={{display:"flex",alignItems:"center",gap:8,padding:"10px 12px",background:C.card,borderRadius:open?"12px 12px 0 0":12,border:`1px solid ${C.brd}`,borderBottom:open?"none":`1px solid ${C.brd}`,marginBottom:open?0:5,cursor:"pointer"}} onClick={()=>setOpen(!open)}>
   <GradeBadge grade={hs.grade} color={hs.color}/><div style={{flex:1}}><div style={{fontWeight:700,fontSize:13}}>{s.nom} <span style={{color:C.td,fontWeight:400,fontSize:11}}>Â· {s.porteur}</span></div></div>
   <div style={{display:"flex",alignItems:"center",gap:8,flexShrink:0}}>{trend!=null&&<span style={{fontSize:10,fontWeight:600,color:trend>=0?C.g:C.r}}>{trend>=0?"â–²":"â–¼"}{Math.abs(trend)}%</span>}<span style={{fontWeight:800,fontSize:15}}>{fmt(ca)}â‚¬</span>
    {r.ok?<span style={{color:C.g,fontSize:13}}>âœ“</span>:<button className="ba" onClick={e=>{e.stopPropagation();doVal(false);}} style={{background:C.gD,color:C.g,border:`1px solid ${C.g}33`,borderRadius:6,padding:"4px 10px",fontSize:10,fontWeight:700,cursor:"pointer",fontFamily:FONT}}>Valider</button>}<span style={{color:C.td,fontSize:10,transform:open?"rotate(180deg)":"",transition:"transform .2s"}}>â–¼</span></div>
  </div>
  {open&&<div className="fu" style={{background:C.card,border:`1px solid ${C.brd}`,borderTop:"none",borderRadius:"0 0 12px 12px",padding:"8px 12px 12px",marginBottom:5}}>
   <div style={{display:"flex",flexWrap:"wrap",gap:8,marginBottom:8,fontSize:11,color:C.td}}>
    <span>CA: <strong style={{color:C.t}}>{fmt(ca)}â‚¬</strong></span><span>Marge: <strong style={{color:marge>=0?C.g:C.r}}>{fmt(marge)}â‚¬</strong></span>
    {s.obj>0&&<span>Obj: <strong style={{color:pct(ca,s.obj)>=100?C.g:C.r}}>{pct(ca,s.obj)}%</strong></span>}
    {s.rec&&mrr>0&&<span>MRR: <strong style={{color:C.b}}>{fmt(mrr)}â‚¬</strong></span>}{pipe>0&&<span>Pipe: <strong style={{color:C.acc}}>{fmt(pipe)}â‚¬</strong></span>}{ts>0&&<span>TrÃ©so: <strong>{fmt(ts)}â‚¬</strong></span>}
   </div>
   {r.notes&&<div style={{fontSize:11,color:C.td,fontStyle:"italic",marginBottom:8,padding:"6px 8px",background:C.bg,borderRadius:6}}>"{r.notes}"</div>}
   <div style={{display:"flex",gap:8,alignItems:"flex-end",marginBottom:8}}><div style={{flex:1}}><Inp label="Commentaire" value={cmt} onChange={setCmt} placeholder="Feedbackâ€¦" small/></div>
    {!r.ok&&<Btn small v="success" onClick={()=>doVal(true)}>âœ“ Valider</Btn>}
    {cmt!==r.comment&&<Btn small v="secondary" onClick={()=>{save(null,{...reps,[`${s.id}_${m}`]:{...r,comment:cmt}},null);}}>Envoyer</Btn>}
   </div>
   <div style={{display:"flex",gap:6,alignItems:"center",borderTop:`1px solid ${C.brd}`,paddingTop:8}}>
    <input value={actText} onChange={e=>setActText(e.target.value)} onKeyDown={e=>{if(e.key==="Enter"&&actText.trim()){onAction(s.id,actText.trim());setActText("");}}} placeholder="+ Actionâ€¦" style={{flex:1,background:C.bg,border:`1px solid ${C.brd}`,borderRadius:6,color:C.t,padding:"6px 8px",fontSize:11,fontFamily:FONT,outline:"none"}}/><Btn small v="secondary" onClick={()=>{if(actText.trim()){onAction(s.id,actText.trim());setActText("");}}}>+</Btn>
   </div>
  </div>}
 </div>;
}
/* SIMULATEUR */
function TabSimulateur({socs,reps,hold}){
 const cM2=curM();const actS=socs.filter(s=>["active","lancement"].includes(s.stat));
 const[simCA,setSimCA]=useState(()=>{const o={};actS.forEach(s=>{const r=gr(reps,s.id,cM2);o[s.id]=r?pf(r.ca):0;});return o;});
 const hcReal=calcH(socs,reps,hold,cM2),hcSim=simH(socs,simCA,hold),diff=hcSim.pf-hcReal.pf;
 return <><Sect title="Simulateur" sub="Ajustez et voyez l'impact en temps rÃ©el">{actS.map((s,i)=>{const cur=gr(reps,s.id,cM2);const curCA=cur?pf(cur.ca):0;const v=simCA[s.id]||0;
  return <div key={s.id} className={`fu d${Math.min(i+1,8)}`} style={{padding:"10px 14px",background:C.card,borderRadius:10,border:`1px solid ${C.brd}`,marginBottom:5}}>
   <div style={{display:"flex",justifyContent:"space-between",marginBottom:6}}><div style={{display:"flex",alignItems:"center",gap:6}}><span style={{width:6,height:6,borderRadius:3,background:s.color}}/><span style={{fontWeight:700,fontSize:12}}>{s.nom}</span></div><div style={{display:"flex",alignItems:"center",gap:6}}><span style={{color:C.td,fontSize:10}}>Actuel: {fmt(curCA)}â‚¬</span><span style={{fontWeight:800,fontSize:14,color:v>curCA?C.g:v<curCA?C.r:C.t,minWidth:70,textAlign:"right"}}>{fmt(v)}â‚¬</span></div></div>
   <input type="range" min={0} max={Math.max(curCA*3,30000)} step={100} value={v} onChange={e=>setSimCA({...simCA,[s.id]:parseInt(e.target.value)})} style={{width:"100%"}}/></div>;})}
 </Sect>
 <Sect title="Impact"><div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:10}}>
  <Card style={{padding:14,textAlign:"center"}}><div style={{color:C.td,fontSize:10,fontWeight:700}}>FLUX</div><div style={{fontWeight:800,fontSize:20,color:C.g}}>{fmt(hcSim.tIn)}â‚¬</div><div style={{color:C.td,fontSize:10}}>actuel: {fmt(hcReal.tIn)}â‚¬</div></Card>
  <Card style={{padding:14,textAlign:"center"}}><div style={{color:C.td,fontSize:10,fontWeight:700}}>DISPO</div><div style={{fontWeight:800,fontSize:20,color:C.acc}}>{fmt(hcSim.dispo)}â‚¬</div><div style={{color:C.td,fontSize:10}}>actuel: {fmt(hcReal.dispo)}â‚¬</div></Card>
  <Card style={{padding:14,textAlign:"center"}}><div style={{color:C.td,fontSize:10,fontWeight:700}}>/ FONDATEUR</div><div style={{fontWeight:800,fontSize:20,color:diff>=0?C.g:C.r}}>{fmt(hcSim.pf)}â‚¬</div><div style={{color:diff>=0?C.g:C.r,fontSize:11,fontWeight:600}}>{diff>=0?"+":""}{fmt(diff)}â‚¬</div></Card>
 </div></Sect></>;
}
/* ONBOARDING SYSTEM */
const OB_STEPS=[
 {id:"welcome",icon:"ðŸ‘‹",label:"Bienvenue",title:"Bienvenue dans l'incubateur Scale Corp",sub:"Avant d'accÃ©der Ã  la plateforme, configurons votre espace en quelques Ã©tapes."},
 {id:"company",icon:"ðŸ¢",label:"Entreprise",title:"Profil de votre entreprise",sub:"Ces informations seront visibles sur votre fiche dans le portfolio."},
 {id:"team",icon:"ðŸ‘¥",label:"Ã‰quipe",title:"Votre Ã©quipe fondatrice",sub:"PrÃ©sentez les personnes clÃ©s de votre projet."},
 {id:"metrics",icon:"ðŸ“Š",label:"MÃ©triques",title:"Vos mÃ©triques actuelles",sub:"Point de dÃ©part pour suivre votre progression."},
 {id:"goals",icon:"ðŸŽ¯",label:"Objectifs",title:"Objectifs d'incubation",sub:"DÃ©finissez ce que vous souhaitez accomplir."},
 {id:"legal",icon:"ðŸ“‹",label:"LÃ©gal",title:"Documents & engagements",sub:"Conditions du programme et validation."},
 {id:"prefs",icon:"âš™ï¸",label:"PrÃ©fÃ©rences",title:"Configuration du compte",sub:"Personnalisez votre expÃ©rience."},
 {id:"recap",icon:"âœ…",label:"RÃ©cap",title:"Tout est prÃªt !",sub:"VÃ©rifiez vos informations."},
];
const OB_SECTORS=["Media Buying","Copywriting","VidÃ©o / Contenu","Design / Branding","Formation","E-commerce","Consulting","SaaS","Coaching","Import / Export","Autre"];
const OB_GOALS=["Atteindre 10Kâ‚¬/mois de CA","Automatiser le delivery","Recruter les premiers talents","Structurer les processus","DÃ©velopper l'acquisition client","Diversifier les revenus","Construire une marque forte","Optimiser la rentabilitÃ©"];

function ObInp({label,value,onChange,type="text",placeholder,required,info,onKeyDown}){
 const[f,setF]=useState(false);
 return <div style={{marginBottom:14}}>
  {label&&<label style={{display:"flex",alignItems:"center",fontSize:12,fontWeight:600,color:C.td,marginBottom:5,fontFamily:FONT,letterSpacing:.3}}>
   {label}{required&&<span style={{color:C.r,marginLeft:3,fontSize:10}}>*</span>}
   {info&&<span title={info} style={{marginLeft:5,width:15,height:15,borderRadius:"50%",background:C.accD,color:C.acc,fontSize:9,display:"inline-flex",alignItems:"center",justifyContent:"center",cursor:"help",fontWeight:700}}>?</span>}
  </label>}
  <input type={type} value={value} onChange={e=>onChange(e.target.value)} placeholder={placeholder} onKeyDown={onKeyDown}
   onFocus={()=>setF(true)} onBlur={()=>setF(false)}
   style={{width:"100%",padding:"10px 13px",borderRadius:9,border:`1.5px solid ${f?C.acc+"66":C.brd}`,fontSize:13,fontFamily:FONT,background:C.bg,color:C.t,outline:"none",transition:"all .2s",boxSizing:"border-box",boxShadow:f?`0 0 0 3px ${C.accD}`:"none"}}/>
 </div>;
}
function ObTextArea({label,value,onChange,placeholder,rows=3,info}){
 const[f,setF]=useState(false);
 return <div style={{marginBottom:14}}>
  {label&&<label style={{display:"flex",alignItems:"center",fontSize:12,fontWeight:600,color:C.td,marginBottom:5,fontFamily:FONT,letterSpacing:.3}}>
   {label}{info&&<span title={info} style={{marginLeft:5,width:15,height:15,borderRadius:"50%",background:C.accD,color:C.acc,fontSize:9,display:"inline-flex",alignItems:"center",justifyContent:"center",cursor:"help",fontWeight:700}}>?</span>}
  </label>}
  <textarea value={value} onChange={e=>onChange(e.target.value)} placeholder={placeholder} rows={rows}
   onFocus={()=>setF(true)} onBlur={()=>setF(false)}
   style={{width:"100%",padding:"10px 13px",borderRadius:9,border:`1.5px solid ${f?C.acc+"66":C.brd}`,fontSize:13,fontFamily:FONT,background:C.bg,color:C.t,outline:"none",transition:"all .2s",boxSizing:"border-box",resize:"vertical",lineHeight:1.5,boxShadow:f?`0 0 0 3px ${C.accD}`:"none"}}/>
 </div>;
}
function ObSelect({label,value,onChange,options,placeholder,required}){
 return <div style={{marginBottom:14}}>
  {label&&<label style={{display:"flex",alignItems:"center",fontSize:12,fontWeight:600,color:C.td,marginBottom:5,fontFamily:FONT,letterSpacing:.3}}>
   {label}{required&&<span style={{color:C.r,marginLeft:3,fontSize:10}}>*</span>}
  </label>}
  <select value={value} onChange={e=>onChange(e.target.value)}
   style={{width:"100%",padding:"10px 13px",borderRadius:9,border:`1.5px solid ${C.brd}`,fontSize:13,fontFamily:FONT,background:C.bg,color:value?C.t:C.td,outline:"none",boxSizing:"border-box",appearance:"none",backgroundImage:`url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23c8a44e' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E")`,backgroundRepeat:"no-repeat",backgroundPosition:"right 12px center"}}>
   <option value="" disabled>{placeholder||"SÃ©lectionner..."}</option>
   {options.map(o=><option key={o} value={o}>{o}</option>)}
  </select>
 </div>;
}
function ObCheck({checked,onChange,label}){
 return <label style={{display:"flex",alignItems:"flex-start",gap:9,cursor:"pointer",fontSize:12.5,color:C.t,lineHeight:1.5,fontFamily:FONT,marginBottom:10}}>
  <div onClick={e=>{e.preventDefault();onChange(!checked);}}
   style={{width:18,height:18,minWidth:18,borderRadius:5,marginTop:1,border:checked?"none":`1.5px solid ${C.brd}`,background:checked?`linear-gradient(135deg,${C.acc},#e8c85a)`:"transparent",display:"flex",alignItems:"center",justifyContent:"center",transition:"all .2s",cursor:"pointer"}}>
   {checked&&<span style={{color:"#0a0a0f",fontSize:11,fontWeight:900}}>âœ“</span>}
  </div>
  <span>{label}</span>
 </label>;
}
function ObTag({selected,onToggle,options}){
 return <div style={{display:"flex",flexWrap:"wrap",gap:7}}>{options.map(o=>{const sel=selected.includes(o);return <button key={o} onClick={()=>onToggle(o)}
  style={{padding:"7px 14px",borderRadius:20,fontSize:11.5,fontWeight:sel?700:400,border:`1.5px solid ${sel?C.acc:C.brd}`,background:sel?C.accD:"transparent",color:sel?C.acc:C.td,cursor:"pointer",fontFamily:FONT,transition:"all .15s"}}>{o}</button>;})}</div>;
}

function OnboardingWizard({onComplete,onSkip,hold}){
 const[step,setStep]=useState(0);const[anim,setAnim]=useState(false);const ref=useRef(null);
 const[form,setForm]=useState({companyName:"",sector:"",website:"",foundedDate:"",description:"",city:"",country:"",founderName:"",founderRole:"",founderEmail:"",founderPhone:"",cofounderName:"",cofounderRole:"",currentMRR:"",teamSize:"",fundingStage:"",goals:[],customGoal:"",timeline:"12",acceptTerms:false,acceptReporting:false,acceptMentorship:false,notifEmail:true,notifSlack:false,notifWeekly:true,dashPublic:false});
 const up=(k,v)=>setForm(p=>({...p,[k]:v}));
 const go=t=>{if(anim)return;setAnim(true);setTimeout(()=>{setStep(t);setAnim(false);if(ref.current)ref.current.scrollTop=0;},180);};
 const canNext=()=>{switch(step){case 0:return true;case 1:return form.companyName&&form.sector&&form.description;case 2:return form.founderName&&form.founderRole&&form.founderEmail;case 3:return form.fundingStage;case 4:return form.goals.length>0;case 5:return form.acceptTerms&&form.acceptReporting;case 6:return true;case 7:return true;default:return true;}};
 const prog=step/(OB_STEPS.length-1)*100;
 const stp=OB_STEPS[step];

 const renderStep=()=>{
  switch(step){
   case 0:return <div>
    <div style={{padding:"24px 20px",borderRadius:14,marginBottom:20,background:`linear-gradient(135deg,${C.card2},${C.brd}22)`,border:`1px solid ${C.brd}`,position:"relative",overflow:"hidden"}}>
     <div style={{position:"absolute",top:-30,right:-30,width:110,height:110,borderRadius:"50%",background:C.accD,filter:"blur(30px)"}}/>
     <div style={{fontSize:36,marginBottom:12}}>ðŸš€</div>
     <h2 style={{fontFamily:FONT,fontSize:19,fontWeight:800,marginBottom:8,margin:0,color:C.t}}>PrÃªt Ã  rejoindre l'aventure ?</h2>
     <p style={{color:C.td,lineHeight:1.6,fontSize:13,margin:"8px 0 0"}}>En quelques minutes, vous allez configurer votre espace sur la plateforme Scale Corp. Ce processus est obligatoire pour accÃ©der Ã  l'ensemble des outils.</p>
    </div>
    <div style={{marginBottom:16}}>
     <div style={{fontSize:13,fontWeight:700,color:C.t,marginBottom:10}}>Ce qui vous attend :</div>
     {[["ðŸ¢","Profil entreprise","Informations essentielles de votre activitÃ©"],["ðŸ‘¥","Ã‰quipe fondatrice","Contacts clÃ©s pour la communication"],["ðŸ“Š","MÃ©triques de dÃ©part","KPIs actuels comme point de rÃ©fÃ©rence"],["ðŸŽ¯","Objectifs","Vos ambitions pour le programme"],["ðŸ“‹","Engagements","Conditions et validation"],["âš™ï¸","PrÃ©fÃ©rences","Notifications et visibilitÃ©"]].map(([ic,t,d],i)=>
      <div key={i} style={{display:"flex",gap:10,padding:"9px 12px",background:C.bg,borderRadius:9,border:`1px solid ${C.brd}`,marginBottom:5}}>
       <span style={{fontSize:18}}>{ic}</span><div><div style={{fontWeight:700,fontSize:12,color:C.t}}>{t}</div><div style={{fontSize:11,color:C.td}}>{d}</div></div></div>)}
    </div>
    <div style={{padding:"11px 14px",borderRadius:9,background:C.accD,border:`1px solid ${C.acc}33`,fontSize:12,color:C.acc,lineHeight:1.5}}>ðŸ’¡ <strong>Conseil :</strong> PrÃ©parez vos mÃ©triques clÃ©s (CA, Ã©quipe) et les infos de votre contact principal. ~5 minutes.</div>
   </div>;

   case 1:return <div>
    <div style={{padding:"11px 14px",borderRadius:9,background:C.accD,border:`1px solid ${C.acc}33`,marginBottom:18,fontSize:12,color:C.acc,lineHeight:1.5}}>
     <strong>ðŸ“Œ</strong> Ces infos constituent votre fiche d'identitÃ© dans le portfolio, visible par l'Ã©quipe Scale Corp.
    </div>
    <ObInp label="Nom de l'entreprise" required value={form.companyName} onChange={v=>up("companyName",v)} placeholder="Ex: MonBusiness SAS"/>
    <ObSelect label="Secteur d'activitÃ©" required value={form.sector} onChange={v=>up("sector",v)} options={OB_SECTORS} placeholder="SÃ©lectionnez..."/>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}}>
     <ObInp label="Site web" value={form.website} onChange={v=>up("website",v)} placeholder="https://..."/>
     <ObInp label="Date de crÃ©ation" type="date" value={form.foundedDate} onChange={v=>up("foundedDate",v)}/>
    </div>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}}>
     <ObInp label="Ville" value={form.city} onChange={v=>up("city",v)} placeholder="Ex: Saint-Denis"/>
     <ObInp label="Pays" value={form.country} onChange={v=>up("country",v)} placeholder="Ex: France"/>
    </div>
    <ObTextArea label="Description courte" value={form.description} onChange={v=>up("description",v)} placeholder="DÃ©crivez votre activitÃ© en 2-3 phrases..." info="Elevator pitch pour le portfolio"/>
    <div style={{fontSize:10,color:C.td,textAlign:"right",marginTop:-8}}>{form.description.length}/300</div>
   </div>;

   case 2:return <div>
    <div style={{padding:"11px 14px",borderRadius:9,background:C.accD,border:`1px solid ${C.acc}33`,marginBottom:18,fontSize:12,color:C.acc,lineHeight:1.5}}>
     <strong>ðŸ“Œ</strong> Le contact principal recevra toutes les communications de l'incubateur.
    </div>
    <div style={{fontSize:13,fontWeight:700,color:C.t,marginBottom:10}}>Contact principal *</div>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}}>
     <ObInp label="Nom complet" required value={form.founderName} onChange={v=>up("founderName",v)} placeholder="PrÃ©nom Nom"/>
     <ObInp label="RÃ´le" required value={form.founderRole} onChange={v=>up("founderRole",v)} placeholder="Ex: CEO"/>
    </div>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}}>
     <ObInp label="Email" required type="email" value={form.founderEmail} onChange={v=>up("founderEmail",v)} placeholder="email@entreprise.com"/>
     <ObInp label="TÃ©lÃ©phone" value={form.founderPhone} onChange={v=>up("founderPhone",v)} placeholder="+262 6..."/>
    </div>
    <div style={{fontSize:13,fontWeight:700,color:C.t,margin:"16px 0 8px"}}>AssociÃ©(e) <span style={{fontWeight:400,color:C.td,fontSize:11}}>(optionnel)</span></div>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}}>
     <ObInp label="Nom" value={form.cofounderName} onChange={v=>up("cofounderName",v)} placeholder="PrÃ©nom Nom"/>
     <ObInp label="RÃ´le" value={form.cofounderRole} onChange={v=>up("cofounderRole",v)} placeholder="Ex: COO"/>
    </div>
   </div>;

   case 3:return <div>
    <div style={{padding:"11px 14px",borderRadius:9,background:C.accD,border:`1px solid ${C.acc}33`,marginBottom:18,fontSize:12,color:C.acc,lineHeight:1.5}}>
     <strong>ðŸ“Œ</strong> "Photo de dÃ©part" dans l'incubateur â€” rÃ©fÃ©rence pour mesurer votre progression.
    </div>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}}>
     <ObInp label="CA mensuel actuel (â‚¬)" type="number" value={form.currentMRR} onChange={v=>up("currentMRR",v)} placeholder="Ex: 5000" info="Revenu mensuel actuel"/>
     <ObInp label="Taille de l'Ã©quipe" type="number" value={form.teamSize} onChange={v=>up("teamSize",v)} placeholder="Ex: 3"/>
    </div>
    <ObSelect label="Stade de dÃ©veloppement" required value={form.fundingStage} onChange={v=>up("fundingStage",v)} options={["IdÃ©e / Lancement","Premiers revenus","Croissance","StabilisÃ©","Bootstrapped"]} placeholder="SÃ©lectionner..."/>
    <div style={{padding:"11px 14px",borderRadius:9,background:C.gD,border:`1px solid ${C.g}33`,marginTop:12,fontSize:12,color:C.g,lineHeight:1.5}}>ðŸ”’ Vos donnÃ©es sont confidentielles â€” partagÃ©es uniquement avec l'Ã©quipe Scale Corp.</div>
   </div>;

   case 4:return <div>
    <div style={{padding:"11px 14px",borderRadius:9,background:C.accD,border:`1px solid ${C.acc}33`,marginBottom:18,fontSize:12,color:C.acc,lineHeight:1.5}}>
     <strong>ðŸ“Œ</strong> Vos objectifs orientent le programme : mentoring, ressources et critÃ¨res de succÃ¨s.
    </div>
    <div style={{fontSize:12,fontWeight:600,color:C.td,marginBottom:8}}>Objectifs prioritaires * <span style={{fontWeight:400}}>(1 Ã  4)</span></div>
    <ObTag selected={form.goals} onToggle={g=>up("goals",form.goals.includes(g)?form.goals.filter(x=>x!==g):[...form.goals,g])} options={OB_GOALS}/>
    {form.goals.length>4&&<div style={{fontSize:11,color:C.o,marginTop:8}}>âš  Maximum 4 recommandÃ©</div>}
    <div style={{marginTop:16}}><ObTextArea label="Objectif personnalisÃ©" value={form.customGoal} onChange={v=>up("customGoal",v)} placeholder="Un objectif spÃ©cifique Ã  votre situation..." rows={2}/></div>
    <div style={{fontSize:12,fontWeight:600,color:C.td,marginBottom:8}}>Horizon temporel</div>
    <div style={{display:"flex",gap:8}}>{["6","12","18","24"].map(m=><button key={m} onClick={()=>up("timeline",m)}
     style={{flex:1,padding:"10px 8px",borderRadius:9,border:`1.5px solid ${form.timeline===m?C.acc:C.brd}`,background:form.timeline===m?C.accD:"transparent",color:form.timeline===m?C.acc:C.td,fontWeight:form.timeline===m?700:400,fontSize:13,cursor:"pointer",fontFamily:FONT,transition:"all .15s"}}>{m} mois</button>)}</div>
   </div>;

   case 5:return <div>
    <div style={{padding:"11px 14px",borderRadius:9,background:C.accD,border:`1px solid ${C.acc}33`,marginBottom:18,fontSize:12,color:C.acc,lineHeight:1.5}}>
     <strong>ðŸ“Œ</strong> Lisez et acceptez les conditions pour participer au programme.
    </div>
    <div style={{padding:"14px 16px",borderRadius:11,background:C.bg,border:`1px solid ${C.brd}`,marginBottom:12}}>
     <div style={{fontWeight:700,fontSize:13,color:C.t,marginBottom:8}}>ðŸ“œ Conditions gÃ©nÃ©rales</div>
     <div style={{maxHeight:120,overflowY:"auto",fontSize:11.5,color:C.td,lineHeight:1.6,padding:"10px 12px",background:C.card,borderRadius:8,border:`1px solid ${C.brd}`,marginBottom:10}}>
      <p style={{margin:"0 0 6px"}}><strong>1. DurÃ©e</strong> â€” L'incubation dure de 6 Ã  24 mois selon le profil.</p>
      <p style={{margin:"0 0 6px"}}><strong>2. Engagements</strong> â€” Participation aux sessions mensuelles, mise Ã  jour des mÃ©triques.</p>
      <p style={{margin:"0 0 6px"}}><strong>3. ConfidentialitÃ©</strong> â€” Vos donnÃ©es restent confidentielles.</p>
      <p style={{margin:"0 0 6px"}}><strong>4. PropriÃ©tÃ© intellectuelle</strong> â€” Votre IP reste votre propriÃ©tÃ©.</p>
      <p style={{margin:0}}><strong>5. RÃ©siliation</strong> â€” PrÃ©avis de 30 jours de chaque cÃ´tÃ©.</p>
     </div>
     <ObCheck checked={form.acceptTerms} onChange={v=>up("acceptTerms",v)} label={<span>J'accepte les <strong>conditions gÃ©nÃ©rales</strong> du programme <span style={{color:C.r}}>*</span></span>}/>
    </div>
    <div style={{padding:"14px 16px",borderRadius:11,background:C.bg,border:`1px solid ${C.brd}`,marginBottom:12}}>
     <div style={{fontWeight:700,fontSize:13,color:C.t,marginBottom:6}}>ðŸ“Š Engagement de reporting</div>
     <p style={{fontSize:11.5,color:C.td,lineHeight:1.6,margin:"0 0 10px"}}>Mise Ã  jour mensuelle de vos mÃ©triques sur la plateforme.</p>
     <ObCheck checked={form.acceptReporting} onChange={v=>up("acceptReporting",v)} label={<span>Je m'engage au reporting <strong>mensuel</strong> <span style={{color:C.r}}>*</span></span>}/>
    </div>
    <div style={{padding:"14px 16px",borderRadius:11,background:C.bg,border:`1px solid ${C.brd}`}}>
     <div style={{fontWeight:700,fontSize:13,color:C.t,marginBottom:6}}>ðŸ¤ Mentorship</div>
     <p style={{fontSize:11.5,color:C.td,lineHeight:1.6,margin:"0 0 10px"}}>Optionnel : point mensuel de 30 min avec un mentor expert.</p>
     <ObCheck checked={form.acceptMentorship} onChange={v=>up("acceptMentorship",v)} label="Je souhaite participer au mentorship (recommandÃ©)"/>
    </div>
   </div>;

   case 6:return <div>
    <div style={{padding:"11px 14px",borderRadius:9,background:C.accD,border:`1px solid ${C.acc}33`,marginBottom:18,fontSize:12,color:C.acc,lineHeight:1.5}}>
     <strong>ðŸ“Œ</strong> ParamÃ¨tres modifiables Ã  tout moment depuis les rÃ©glages.
    </div>
    <div style={{fontSize:13,fontWeight:700,color:C.t,marginBottom:10}}>ðŸ”” Notifications</div>
    <ObCheck checked={form.notifEmail} onChange={v=>up("notifEmail",v)} label="Notifications par email (milestones, rappels, invitations)"/>
    <ObCheck checked={form.notifSlack} onChange={v=>up("notifSlack",v)} label="IntÃ©gration Slack (notifications temps rÃ©el)"/>
    <ObCheck checked={form.notifWeekly} onChange={v=>up("notifWeekly",v)} label="Digest hebdomadaire (rÃ©sumÃ© + actualitÃ©s)"/>
    <div style={{fontSize:13,fontWeight:700,color:C.t,margin:"18px 0 10px"}}>ðŸ‘ï¸ VisibilitÃ©</div>
    <div style={{padding:"14px 16px",borderRadius:11,background:C.bg,border:`1px solid ${C.brd}`}}>
     <ObCheck checked={form.dashPublic} onChange={v=>up("dashPublic",v)} label="Rendre mon profil visible aux autres entreprises du portfolio"/>
     <div style={{padding:"8px 12px",borderRadius:8,background:C.accD,border:`1px solid ${C.acc}22`,fontSize:11,color:C.acc,lineHeight:1.5,marginTop:6}}>ðŸ’¡ Si activÃ© : nom, secteur et description visibles. MÃ©triques financiÃ¨res toujours privÃ©es.</div>
    </div>
   </div>;

   case 7:return <div>
    <div style={{padding:"11px 14px",borderRadius:9,background:C.gD,border:`1px solid ${C.g}33`,marginBottom:18,fontSize:12,color:C.g,lineHeight:1.5}}>
     <strong>âœ… DerniÃ¨re Ã©tape !</strong> VÃ©rifiez ci-dessous. Modifiable Ã  tout moment aprÃ¨s validation.
    </div>
    {[
     ["ðŸ¢","Entreprise",form.companyName?<><div><strong>{form.companyName}</strong> Â· {form.sector||"â€”"}</div>{form.city&&<div style={{fontSize:11,color:C.td}}>ðŸ“ {form.city}{form.country?`, ${form.country}`:""}</div>}{form.description&&<div style={{fontSize:11,color:C.td,fontStyle:"italic",marginTop:2}}>"{form.description.slice(0,80)}{form.description.length>80?"...":""}"</div>}</>:null],
     ["ðŸ‘¥","Contact",form.founderName?<><div><strong>{form.founderName}</strong> â€” {form.founderRole}</div><div style={{fontSize:11,color:C.td}}>ðŸ“§ {form.founderEmail}</div>{form.cofounderName&&<div style={{fontSize:11,color:C.td}}>AssociÃ© : {form.cofounderName}</div>}</>:null],
     ["ðŸ“Š","MÃ©triques",<><div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:2,fontSize:11}}><span>CA : <strong>{form.currentMRR?`${Number(form.currentMRR).toLocaleString()}â‚¬`:"â€”"}</strong></span><span>Ã‰quipe : <strong>{form.teamSize||"â€”"}</strong></span><span>Stade : <strong>{form.fundingStage||"â€”"}</strong></span></div></>],
     ["ðŸŽ¯","Objectifs",<><div style={{display:"flex",flexWrap:"wrap",gap:4}}>{form.goals.map(g=><span key={g} style={{padding:"3px 9px",borderRadius:10,background:C.accD,color:C.acc,fontSize:10,fontWeight:600}}>{g}</span>)}</div><div style={{fontSize:11,color:C.td,marginTop:3}}>â± Horizon : {form.timeline} mois</div></>],
     ["ðŸ“‹","Engagements",<div style={{fontSize:11}}><div>CGU : {form.acceptTerms?"âœ…":"âŒ"} Â· Reporting : {form.acceptReporting?"âœ…":"âŒ"} Â· Mentorship : {form.acceptMentorship?"âœ…":"â¬œ"}</div></div>],
     ["âš™ï¸","PrÃ©fÃ©rences",<div style={{fontSize:11}}><div>Email : {form.notifEmail?"âœ…":"â¬œ"} Â· Slack : {form.notifSlack?"âœ…":"â¬œ"} Â· Digest : {form.notifWeekly?"âœ…":"â¬œ"}</div><div>Profil : {form.dashPublic?"ðŸ‘ï¸ Public":"ðŸ”’ PrivÃ©"}</div></div>],
    ].map(([ic,title,content],i)=><div key={i} style={{padding:"10px 14px",background:C.bg,borderRadius:9,border:`1px solid ${C.brd}`,marginBottom:6}}>
     <div style={{display:"flex",alignItems:"center",gap:7,marginBottom:content?5:0}}><span style={{fontSize:16}}>{ic}</span><span style={{fontWeight:700,fontSize:12,color:C.t}}>{title}</span></div>
     {content&&<div style={{paddingLeft:30,color:C.t,fontSize:12}}>{content}</div>}
    </div>)}
   </div>;
   default:return null;
  }
 };

 return <div style={{minHeight:"100vh",display:"flex",background:C.bg,fontFamily:FONT,color:C.t}}>
  <style>{CSS}{`@keyframes obSlide{from{opacity:0;transform:translateX(16px)}to{opacity:1;transform:translateX(0)}}@keyframes obPulse{0%,100%{box-shadow:0 0 0 0 rgba(200,164,78,.4)}70%{box-shadow:0 0 0 8px rgba(200,164,78,0)}}`}</style>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  {/* Sidebar stepper */}
  <div style={{width:220,minHeight:"100vh",background:C.card,borderRight:`1px solid ${C.brd}`,padding:"28px 16px",display:"flex",flexDirection:"column"}}>
   <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:28}}>
    <div style={{width:32,height:32,background:hold?.brand?.logoUrl?"transparent":`linear-gradient(135deg,${hold?.brand?.accentColor||C.acc},#e8c85a)`,borderRadius:7,display:"flex",alignItems:"center",justifyContent:"center",fontWeight:900,fontSize:14,color:"#0a0a0f",overflow:"hidden"}}>{hold?.brand?.logoUrl?<img src={hold.brand.logoUrl} alt="" style={{width:"100%",height:"100%",objectFit:"cover"}}/>:(hold?.brand?.logoLetter||"S")}</div>
    <div><div style={{fontWeight:800,fontSize:13,letterSpacing:.5}}>{hold?.brand?.name||"SCALE CORP"}</div><div style={{color:C.td,fontSize:9}}>Onboarding</div></div>
   </div>
   <div style={{flex:1}}>
    {OB_STEPS.map((s,i)=>{const done=i<step,curr=i===step;return <button key={s.id} onClick={()=>{if(i<step)go(i);}}
     style={{display:"flex",alignItems:"center",gap:9,width:"100%",padding:"9px 10px",marginBottom:2,borderRadius:8,border:"none",background:curr?C.accD:"transparent",cursor:i<=step?"pointer":"default",fontFamily:FONT,transition:"all .15s",opacity:i>step?.4:1}}>
     <div style={{width:26,height:26,borderRadius:7,display:"flex",alignItems:"center",justifyContent:"center",fontSize:done?11:13,fontWeight:700,background:done?C.g+"22":curr?C.accD:"transparent",color:done?C.g:curr?C.acc:C.td,border:done?`1.5px solid ${C.g}44`:curr?`1.5px solid ${C.acc}44`:`1.5px solid ${C.brd}`}}>{done?"âœ“":s.icon}</div>
     <span style={{fontSize:11,fontWeight:curr?700:400,color:curr?C.acc:done?C.t:C.td}}>{s.label}</span>
    </button>;})}
   </div>
   <div style={{padding:"10px 12px",background:C.bg,borderRadius:8,border:`1px solid ${C.brd}`}}>
    <div style={{display:"flex",justifyContent:"space-between",fontSize:10,color:C.td,marginBottom:4}}><span>Progression</span><span>{Math.round(prog)}%</span></div>
    <div style={{height:4,background:C.brd,borderRadius:4,overflow:"hidden"}}><div style={{height:"100%",width:`${prog}%`,background:`linear-gradient(90deg,${C.acc},#e8c85a)`,borderRadius:4,transition:"width .3s ease"}}/></div>
   </div>
   {onSkip&&<button onClick={onSkip} style={{marginTop:8,width:"100%",padding:"8px",borderRadius:7,border:`1px solid ${C.brd}`,background:"transparent",color:C.td,fontSize:10,cursor:"pointer",fontFamily:FONT,transition:"all .15s"}}>â† Retour Ã  la connexion</button>}
  </div>
  {/* Content */}
  <div style={{flex:1,display:"flex",flexDirection:"column",minHeight:"100vh"}}>
   <div style={{padding:"20px 28px",borderBottom:`1px solid ${C.brd}`,background:C.card}}>
    <div style={{fontSize:9,fontWeight:700,color:C.acc,letterSpacing:1,marginBottom:3}}>Ã‰TAPE {step+1}/{OB_STEPS.length}</div>
    <h1 style={{margin:0,fontSize:20,fontWeight:800,color:C.t}}>{stp.title}</h1>
    <p style={{margin:"4px 0 0",color:C.td,fontSize:12}}>{stp.sub}</p>
   </div>
   <div ref={ref} style={{flex:1,overflowY:"auto",padding:"24px 28px"}}>
    <div style={{maxWidth:540,animation:anim?"none":"obSlide .3s cubic-bezier(.16,1,.3,1)"}}>{renderStep()}</div>
   </div>
   <div style={{padding:"14px 28px",borderTop:`1px solid ${C.brd}`,background:C.card,display:"flex",justifyContent:"space-between",alignItems:"center"}}>
    <button onClick={()=>{if(step>0)go(step-1);}} disabled={step===0}
     style={{padding:"9px 20px",borderRadius:9,border:`1px solid ${C.brd}`,background:"transparent",color:step>0?C.t:C.tm,fontSize:12,fontWeight:600,cursor:step>0?"pointer":"default",fontFamily:FONT}}>â† Retour</button>
    {step<OB_STEPS.length-1?
     <button onClick={()=>{if(canNext())go(step+1);}} disabled={!canNext()}
      style={{padding:"9px 24px",borderRadius:9,border:"none",background:canNext()?`linear-gradient(135deg,${C.acc},#e8c85a)`:"#1a1a2c",color:canNext()?"#0a0a0f":C.tm,fontSize:12,fontWeight:700,cursor:canNext()?"pointer":"default",fontFamily:FONT,boxShadow:canNext()?`0 4px 16px ${C.accD}`:"none",animation:canNext()?"obPulse 2s infinite":"none"}}>Continuer â†’</button>
    :<button onClick={()=>{if(form.acceptTerms&&form.acceptReporting&&form.companyName&&form.founderName)onComplete(form);}}
      disabled={!(form.acceptTerms&&form.acceptReporting&&form.companyName&&form.founderName)}
      style={{padding:"9px 24px",borderRadius:9,border:"none",background:(form.acceptTerms&&form.acceptReporting&&form.companyName&&form.founderName)?`linear-gradient(135deg,${C.g},#16a34a)`:"#1a1a2c",color:(form.acceptTerms&&form.acceptReporting&&form.companyName&&form.founderName)?"#fff":C.tm,fontSize:12,fontWeight:700,cursor:(form.acceptTerms&&form.acceptReporting&&form.companyName&&form.founderName)?"pointer":"default",fontFamily:FONT,display:"flex",alignItems:"center",gap:6,boxShadow:(form.acceptTerms&&form.acceptReporting&&form.companyName&&form.founderName)?`0 4px 16px ${C.gD}`:"none"}}>ðŸš€ AccÃ©der Ã  la plateforme</button>
    }
   </div>
  </div>
 </div>;
}

/* TUTORIAL SYSTEM â€” SPOTLIGHT TOUR */
const TOUR_ADMIN=[
 {target:"admin-nav",tab:0,title:"Navigation",icon:"ðŸ§­",desc:"La sidebar Ã  gauche organise la plateforme en 6 sections clÃ©s : Dashboard, Portfolio, Finance, Commercial, AI Copilot et Ressources. Cliquez sur une section pour dÃ©plier ses sous-modules. Tout est accessible en un clic.",pos:"right",highlight:C.acc},
 {target:"admin-kpis",tab:0,title:"KPIs en temps rÃ©el",icon:"ðŸ’°",desc:"Vue instantanÃ©e de la santÃ© financiÃ¨re du groupe. CA total, marge nette, rÃ©munÃ©ration des fondateurs, disponible et trÃ©sorerie. Ces chiffres se recalculent automatiquement Ã  chaque rapport soumis par une sociÃ©tÃ©.",pos:"bottom",highlight:C.acc},
 {target:"admin-alerts",tab:0,title:"Alertes intelligentes",icon:"ðŸ””",desc:"Le systÃ¨me dÃ©tecte automatiquement les risques : rapports en retard, trÃ©sorerie basse, chute de CA, actions non terminÃ©es. Chaque alerte est priorisÃ©e par criticitÃ© (danger, warning, info).",pos:"bottom",highlight:C.o},
 {target:"admin-feed",tab:0,title:"Fil d'activitÃ©",icon:"âš¡",desc:"Chronologie des derniÃ¨res actions du portfolio : rapports soumis, pulse check-ins, milestones dÃ©bloquÃ©s. Gardez un Å“il sur l'activitÃ© sans vÃ©rifier chaque sociÃ©tÃ©.",pos:"right",highlight:C.b},
 {target:"admin-leaderboard",tab:0,title:"Classement & grades",icon:"ðŸ†",desc:"Les sociÃ©tÃ©s sont classÃ©es par score composite (CA, croissance, rentabilitÃ©, engagement). Le grade A Ã  F donne un aperÃ§u instantanÃ©. Cliquez pour accÃ©der au dÃ©tail.",pos:"left",highlight:C.acc},
 {target:"admin-okr-actions",tab:0,title:"OKRs & Actions",icon:"ðŸŽ¯",desc:"Ã€ gauche : progression des objectifs trimestriels (OKR) avec barres d'avancement auto-synchro. Ã€ droite : actions prioritaires ouvertes avec dÃ©tection des retards.",pos:"top",highlight:C.g},
 {target:"admin-portfolio",tab:0,title:"Cartes Portfolio",icon:"ðŸ“‹",desc:"Chaque carte = une sociÃ©tÃ© active. CA, trÃ©sorerie, grade santÃ©, milestones dÃ©bloquÃ©s, runway estimÃ©. Les donnÃ©es viennent des rapports mensuels et des connexions bancaires.",pos:"top",highlight:C.v},
 {target:"admin-milestones",tab:0,title:"Milestones",icon:"ðŸ…",desc:"Progression de chaque sociÃ©tÃ© vers ses trophÃ©es : clubs CA (1K, 5K, 10Kâ€¦), streaks de croissance, anciennetÃ©, rentabilitÃ©. Le systÃ¨me dÃ©bloque automatiquement les achievements.",pos:"top",highlight:C.acc},
 {target:"admin-tab-1",tab:1,title:"SociÃ©tÃ©s",icon:"ðŸ“‹",desc:"Dans la section Portfolio : ajoutez, modifiez et suivez chaque sociÃ©tÃ© incubÃ©e. PIN d'accÃ¨s, couleur, porteur, objectifs, intÃ©grations API. C'est le cÅ“ur de configuration de l'incubateur.",pos:"right",highlight:C.b},
 {target:"admin-tab-2",tab:2,title:"Analytique",icon:"ðŸ“Š",desc:"Section Portfolio > Analytique : comparez les performances entre sociÃ©tÃ©s avec des graphiques interactifs. RÃ©partition du CA, Ã©volution mensuelle, matrice de risque.",pos:"right",highlight:C.v},
 {target:"admin-tab-5",tab:5,title:"AI Copilot",icon:"ðŸ¤–",desc:"Votre assistant IA dÃ©diÃ©. Posez n'importe quelle question sur votre portfolio : analyses, comparaisons, recommandations. Il a accÃ¨s Ã  toutes vos donnÃ©es en temps rÃ©el.",pos:"right",highlight:"#a78bfa"},
 {target:"admin-tab-6",tab:6,title:"Pipeline",icon:"â—Ž",desc:"Section Commercial > Pipeline : gÃ©rez les nouveaux projets de l'idÃ©e Ã  la signature. 4 Ã©tapes : IdÃ©e, Ã‰valuation, Due Diligence, SignÃ©.",pos:"right",highlight:C.b},
 {target:"admin-tab-10",tab:10,title:"Synergies",icon:"ðŸ¤",desc:"Section Commercial > Synergies : cartographiez les referrals et collaborations entre sociÃ©tÃ©s. Suivez le CA gÃ©nÃ©rÃ© par les synergies internes.",pos:"right",highlight:C.v},
 {target:"admin-tab-13",tab:13,title:"Charges & Ã‰quipe",icon:"ðŸ”„",desc:"Section Finance > Charges : centralisez abonnements et membres d'Ã©quipe de chaque sociÃ©tÃ©. CoÃ»t mensuel total, rÃ©partition par catÃ©gorie.",pos:"right",highlight:C.r},
];

const TOUR_PORTEUR=[
 {target:"porteur-nav",tab:10,title:"Votre espace",icon:"ðŸ§­",desc:"La sidebar organise vos modules : Accueil (vue d'ensemble), Rapport, Performance, Suivi, Banque, Clients et Ressources.",pos:"right",highlight:C.acc},
 {target:"porteur-tab-10",tab:10,title:"Accueil",icon:"â—‰",desc:"Votre tableau de bord personnel : nudges d'actions Ã  faire, KPIs du mois, Ã©volution du CA, trophÃ©es et activitÃ© rÃ©cente. Tout en un coup d'Å“il.",pos:"right",highlight:C.acc},
 {target:"porteur-tab-0",tab:0,title:"Rapport mensuel",icon:"ðŸ“Š",desc:"Renseignez CA, charges, clients et trÃ©sorerie chaque mois. Les champs avancÃ©s (dÃ©tail charges, funnel, pub) sont dans des sections dÃ©pliables.",pos:"right",highlight:C.o},
 {target:"porteur-tab-1",tab:1,title:"Statistiques",icon:"ðŸ“ˆ",desc:"Performance > Stats : KPIs, score de santÃ© A-F, graphes CA/marge. Les dÃ©tails (finances, prÃ©visions, funnel) se dÃ©plient Ã  la demande.",pos:"right",highlight:C.g},
 {target:"porteur-tab-2",tab:2,title:"ActivitÃ©",icon:"âœ…",desc:"Suivi > ActivitÃ© : vos actions Ã  faire, journal stratÃ©gique et historique fusionnÃ©s en un seul fil chronologique.",pos:"right",highlight:C.b},
 {target:"porteur-tab-4",tab:4,title:"Pulse hebdomadaire",icon:"ðŸ’“",desc:"Suivi > Pulse : mood, victoire, blocage et confiance chaque semaine. Signal rapide pour Scale Corp.",pos:"right",highlight:C.o},
 {target:"porteur-tab-6",tab:6,title:"Milestones",icon:"ðŸ†",desc:"Performance > Milestones : achievements automatiques, 5 tiers de Bronze Ã  Diamant.",pos:"right",highlight:C.acc},
 {target:"porteur-tab-9",tab:9,title:"Gestion Clients",icon:"ðŸ‘¥",desc:"Portefeuille clients : statuts, historique, facturation. GÃ©rez le cycle de vie client.",pos:"right",highlight:C.o},
];

function TutorialOverlay({steps,onFinish,onSkip,setActiveTab}){
 const[idx,setIdx]=useState(0);
 const[rect,setRect]=useState(null);
 const[tipPos,setTipPos]=useState({x:0,y:0,side:"bottom"});
 const[ready,setReady]=useState(false);
 const[transitioning,setTransitioning]=useState(false);
 const prevTab=useRef(null);
 const s=steps[idx];const isLast=idx===steps.length-1;

 const measure=useCallback(()=>{
  const el=document.querySelector(`[data-tour="${s.target}"]`);
  if(!el){setRect(null);setReady(true);return;}
  el.scrollIntoView({behavior:"smooth",block:"nearest"});
  setTimeout(()=>{
   const r=el.getBoundingClientRect();
   const pad=6;
   const spotlight={x:r.left-pad,y:r.top-pad,w:r.width+pad*2,h:r.height+pad*2};
   setRect(spotlight);
   /* Tooltip positioning */
   const tipW=380,tipH=200;const vw=window.innerWidth,vh=window.innerHeight;
   let tx,ty,side=s.pos||"bottom";
   if(side==="bottom"){tx=spotlight.x+spotlight.w/2-tipW/2;ty=spotlight.y+spotlight.h+14;}
   else if(side==="top"){tx=spotlight.x+spotlight.w/2-tipW/2;ty=spotlight.y-tipH-14;}
   else if(side==="right"){tx=spotlight.x+spotlight.w+14;ty=spotlight.y+spotlight.h/2-tipH/2;}
   else if(side==="left"){tx=spotlight.x-tipW-14;ty=spotlight.y+spotlight.h/2-tipH/2;}
   /* Clamp to viewport */
   if(tx<12)tx=12;if(tx+tipW>vw-12)tx=vw-tipW-12;
   if(ty<12)ty=12;if(ty+tipH>vh-12){ty=spotlight.y-tipH-14;side="top";}
   if(ty<12){ty=spotlight.y+spotlight.h+14;side="bottom";}
   setTipPos({x:tx,y:ty,side});
   setReady(true);
  },100);
 },[s]);

 const goToStep=(newIdx)=>{
  setReady(false);setTransitioning(true);
  const newStep=steps[newIdx];
  if(prevTab.current!==newStep.tab){setActiveTab(newStep.tab);prevTab.current=newStep.tab;}
  setIdx(newIdx);
  setTimeout(()=>{setTransitioning(false);},80);
 };

 useEffect(()=>{
  prevTab.current=s.tab;setActiveTab(s.tab);
  const t=setTimeout(measure,250);
  const onR=()=>measure();window.addEventListener("resize",onR);
  return()=>{clearTimeout(t);window.removeEventListener("resize",onR);};
 },[idx,measure,s.tab]);

 useEffect(()=>{
  const onK=e=>{if(e.key==="Escape")onSkip();if(e.key==="ArrowRight"&&!isLast)goToStep(idx+1);if(e.key==="ArrowLeft"&&idx>0)goToStep(idx-1);};
  window.addEventListener("keydown",onK);return()=>window.removeEventListener("keydown",onK);
 },[idx,isLast]);

 const spotStyle=rect?{position:"fixed",left:rect.x,top:rect.y,width:rect.w,height:rect.h,borderRadius:10,boxShadow:`0 0 0 9999px rgba(0,0,0,.62)`,border:`2px solid ${s.highlight}88`,zIndex:10000,transition:"all .45s cubic-bezier(.4,0,.2,1)",pointerEvents:"none"}:{position:"fixed",left:"50%",top:"50%",width:0,height:0,borderRadius:"50%",boxShadow:"0 0 0 9999px rgba(0,0,0,.62)",zIndex:10000,pointerEvents:"none"};

 const arrowSide=tipPos.side;

 return <div style={{position:"fixed",inset:0,zIndex:9999,fontFamily:FONT,pointerEvents:"none"}}>
  <style>{`@keyframes tourPulse{0%,100%{box-shadow:0 0 0 9999px rgba(0,0,0,.62),0 0 0 0 ${s.highlight}44}50%{box-shadow:0 0 0 9999px rgba(0,0,0,.62),0 0 16px 4px ${s.highlight}33}}@keyframes tourTipIn{from{opacity:0;transform:translateY(8px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}`}</style>
  {/* Spotlight cutout */}
  <div style={{...spotStyle,animation:ready?"tourPulse 2.5s ease infinite":"none"}}/>
  {/* Clickable backdrop */}
  <div style={{position:"fixed",inset:0,zIndex:10001,pointerEvents:"auto",cursor:"pointer"}} onClick={e=>{
   if(rect){const{clientX:cx,clientY:cy}=e;const inSpot=cx>=rect.x&&cx<=rect.x+rect.w&&cy>=rect.y&&cy<=rect.y+rect.h;if(inSpot)return;}
   /* Click outside spotlight = skip */
  }}/>
  {/* Tooltip card */}
  {ready&&<div style={{position:"fixed",left:tipPos.x,top:tipPos.y,width:380,maxWidth:"92vw",zIndex:10002,pointerEvents:"auto",animation:"tourTipIn .35s cubic-bezier(.16,1,.3,1) both",opacity:transitioning?0:1,transition:"opacity .15s"}}>
   <div style={{background:C.card,border:`1px solid ${C.brd}`,borderRadius:14,overflow:"hidden",boxShadow:`0 20px 50px rgba(0,0,0,.45), 0 0 0 1px ${s.highlight}18`}}>
    {/* Arrow */}
    {rect&&arrowSide==="bottom"&&<div style={{position:"absolute",top:-7,left:"50%",marginLeft:-7,width:14,height:14,background:C.card,border:`1px solid ${C.brd}`,borderRight:"none",borderBottom:"none",transform:"rotate(45deg)",zIndex:1}}/>}
    {rect&&arrowSide==="top"&&<div style={{position:"absolute",bottom:-7,left:"50%",marginLeft:-7,width:14,height:14,background:C.card,border:`1px solid ${C.brd}`,borderLeft:"none",borderTop:"none",transform:"rotate(45deg)",zIndex:1}}/>}
    {/* Accent bar */}
    <div style={{height:3,background:`linear-gradient(90deg,${s.highlight},${s.highlight}44)`}}/>
    {/* Header */}
    <div style={{padding:"14px 18px 10px",display:"flex",alignItems:"center",gap:10}}>
     <div style={{width:36,height:36,borderRadius:9,background:`${s.highlight}15`,border:`1.5px solid ${s.highlight}33`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:18,flexShrink:0}}>{s.icon}</div>
     <div style={{flex:1,minWidth:0}}>
      <div style={{fontSize:8,fontWeight:700,color:s.highlight,letterSpacing:1,marginBottom:1}}>{idx+1} / {steps.length}</div>
      <div style={{fontSize:15,fontWeight:800,color:C.t,lineHeight:1.2}}>{s.title}</div>
     </div>
    </div>
    {/* Body */}
    <div style={{padding:"2px 18px 14px"}}><p style={{margin:0,fontSize:12.5,color:C.td,lineHeight:1.65}}>{s.desc}</p></div>
    {/* Footer */}
    <div style={{padding:"10px 18px",borderTop:`1px solid ${C.brd}`,display:"flex",alignItems:"center",justifyContent:"space-between",background:C.bg+"44"}}>
     {/* Mini progress bar */}
     <div style={{flex:1,maxWidth:120,height:4,background:C.brd,borderRadius:2,overflow:"hidden",marginRight:12}}><div style={{height:"100%",width:`${(idx+1)/steps.length*100}%`,background:`linear-gradient(90deg,${s.highlight},${s.highlight}88)`,borderRadius:2,transition:"width .4s ease"}}/></div>
     <div style={{display:"flex",gap:6,alignItems:"center"}}>
      <button onClick={onSkip} style={{padding:"5px 10px",borderRadius:6,border:"none",background:"transparent",color:C.td,fontSize:10,cursor:"pointer",fontFamily:FONT}}>Passer</button>
      {idx>0&&<button onClick={()=>goToStep(idx-1)} style={{padding:"5px 12px",borderRadius:6,border:`1px solid ${C.brd}`,background:"transparent",color:C.t,fontSize:10,fontWeight:600,cursor:"pointer",fontFamily:FONT}}>â†</button>}
      <button onClick={()=>{if(isLast)onFinish();else goToStep(idx+1);}}
       style={{padding:"6px 16px",borderRadius:6,border:"none",background:isLast?`linear-gradient(135deg,${C.g},#16a34a)`:`linear-gradient(135deg,${s.highlight},${s.highlight}cc)`,color:isLast?"#fff":"#0a0a0f",fontSize:10,fontWeight:700,cursor:"pointer",fontFamily:FONT,boxShadow:`0 2px 8px ${s.highlight}33`}}>{isLast?"âœ¨ C'est parti !":"Suivant â†’"}</button>
     </div>
    </div>
   </div>
  </div>}
  {/* Keyboard hint */}
  {ready&&<div style={{position:"fixed",bottom:14,left:"50%",transform:"translateX(-50%)",zIndex:10002,pointerEvents:"none",display:"flex",gap:8,alignItems:"center"}}>
   {[["â†","PrÃ©cÃ©dent"],["â†’","Suivant"],["Esc","Quitter"]].map(([k,l])=><div key={k} style={{display:"flex",alignItems:"center",gap:4}}><span style={{padding:"2px 6px",borderRadius:4,background:C.card,border:`1px solid ${C.brd}`,fontSize:9,fontWeight:700,color:C.td,fontFamily:"monospace"}}>{k}</span><span style={{fontSize:8,color:C.tm}}>{l}</span></div>)}
  </div>}
 </div>;
}

/* SIDEBAR NAVIGATION */
const SB_ADMIN=[
 {id:"dash",icon:"â—‰",label:"Dashboard",tab:0,accent:C.acc},
 {id:"portfolio",icon:"â–£",label:"Portfolio",accent:C.b,children:[
  {icon:"ðŸ“‹",label:"SociÃ©tÃ©s",tab:1},
  {icon:"ðŸ“Š",label:"Analytique",tab:2},
  {icon:"âš¡",label:"Challenges",tab:12},
 ]},
 {id:"finance",icon:"ðŸ’°",label:"Finance",accent:C.g,children:[
  {icon:"ðŸ›",label:"Holding",tab:4},
  {icon:"ðŸ¦",label:"Banque",tab:8},
  {icon:"ðŸ“",label:"Simulateur",tab:3},
  {icon:"ðŸ”„",label:"Charges & Ã‰quipe",tab:13},
 ]},
 {id:"commercial",icon:"ðŸŽ¯",label:"Commercial",accent:C.o,children:[
  {icon:"â—Ž",label:"Pipeline",tab:6},
  {icon:"ðŸ“‡",label:"CRM",tab:7},
  {icon:"ðŸ¤",label:"Synergies",tab:10},
 ]},
 {id:"copilot",icon:"âœ¦",label:"AI Copilot",tab:5,accent:"#a78bfa"},
 {id:"kb",icon:"ðŸ“š",label:"Ressources",tab:11,accent:C.v},
];

const SB_PORTEUR=[
 {id:"dashboard",icon:"ðŸ“Š",label:"Dashboard",tab:0,accent:C.acc},
 {id:"bank",icon:"ðŸ¦",label:"Banque",tab:5,accent:C.g},
 {id:"clients",icon:"ðŸ‘¥",label:"Clients",tab:9,accent:C.o},
 {id:"settings",icon:"âš™ï¸",label:"ParamÃ¨tres",tab:12,accent:C.td},
];

function Sidebar({items,activeTab,setTab,brandTitle,brandSub,onLogout,onTour,extra,dataTourPrefix,brand}){
 const[exp,setExp]=useState(()=>{
  const init={};items.forEach(g=>{if(g.children&&g.children.some(c=>c.tab===activeTab))init[g.id]=true;});return init;
 });
 useEffect(()=>{items.forEach(g=>{if(g.children&&g.children.some(c=>c.tab===activeTab))setExp(p=>({...p,[g.id]:true}));});},[activeTab]);
 const isAct=t=>t===activeTab;
 const grpAct=g=>g.children?g.children.some(c=>c.tab===activeTab):false;

 return <aside data-tour={`${dataTourPrefix}-nav`} style={{width:210,minWidth:210,height:"100vh",position:"sticky",top:0,background:`linear-gradient(180deg,${C.card} 0%,${C.bg} 100%)`,borderRight:`1px solid ${C.brd}`,display:"flex",flexDirection:"column",fontFamily:FONT,overflow:"hidden",zIndex:50}}>
  <div style={{padding:"16px 14px 14px",borderBottom:`1px solid ${C.brd}`,display:"flex",alignItems:"center",gap:9}}>
   <div style={{width:30,height:30,background:brand?.logoUrl?"transparent":`linear-gradient(135deg,${brand?.accentColor||C.acc},#e8c85a)`,borderRadius:8,display:"flex",alignItems:"center",justifyContent:"center",fontWeight:900,fontSize:13,color:"#0a0a0f",boxShadow:`0 2px 8px ${(brand?.accentColor||C.acc)}44`,flexShrink:0,overflow:"hidden"}}>{brand?.logoUrl?<img src={brand.logoUrl} alt="" style={{width:"100%",height:"100%",objectFit:"cover"}}/>:(brand?.logoLetter||brandTitle?.[0]||"S")}</div>
   <div style={{minWidth:0}}><div style={{fontWeight:800,fontSize:12,letterSpacing:.5,color:C.t,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{brandTitle}</div><div style={{fontSize:8,color:C.td}}>{brandSub}</div></div>
  </div>
  <nav style={{flex:1,overflow:"auto",padding:"8px 6px 8px 6px"}}>
   {items.map(g=>{
    const hasK=!!g.children;const open=exp[g.id];const gA=hasK?grpAct(g):isAct(g.tab);
    return <div key={g.id} style={{marginBottom:1}}>
     <button data-tour={!hasK?`${dataTourPrefix}-tab-${g.tab}`:undefined} onClick={()=>{if(hasK){setExp(p=>({...p,[g.id]:!p[g.id]}));if(!open&&g.children[0])setTab(g.children[0].tab);}else setTab(g.tab);}}
      style={{width:"100%",display:"flex",alignItems:"center",gap:8,padding:"8px 10px",borderRadius:8,border:"none",background:gA?(g.accent||C.acc)+"12":"transparent",color:gA?C.t:C.td,fontSize:11,fontWeight:gA?700:500,cursor:"pointer",fontFamily:FONT,transition:"all .15s",borderLeft:gA?`2.5px solid ${g.accent||C.acc}`:"2.5px solid transparent",textAlign:"left"}}
      onMouseEnter={e=>{if(!gA)e.currentTarget.style.background=C.card2;}} onMouseLeave={e=>{if(!gA)e.currentTarget.style.background="transparent";}}>
      <span style={{fontSize:14,width:20,textAlign:"center",flexShrink:0}}>{g.icon}</span>
      <span style={{flex:1}}>{g.label}</span>
      {hasK&&<span style={{fontSize:7,color:C.td,transition:"transform .2s",transform:open?"rotate(90deg)":"rotate(0)"}}>â–¶</span>}
     </button>
     {hasK&&<div style={{marginLeft:16,borderLeft:`1px solid ${open?g.accent+"33":C.brd}`,paddingLeft:0,overflow:"hidden",maxHeight:open?200:0,transition:"max-height .25s ease, opacity .2s",opacity:open?1:0}}>
      {g.children.map(c=>{
       const cA=isAct(c.tab);
       return <button key={c.tab} data-tour={`${dataTourPrefix}-tab-${c.tab}`} onClick={()=>setTab(c.tab)}
        style={{width:"100%",display:"flex",alignItems:"center",gap:6,padding:"5px 8px 5px 10px",borderRadius:0,borderRight:"none",borderTop:"none",borderBottom:"none",borderLeft:cA?`2px solid ${g.accent||C.acc}`:"2px solid transparent",background:cA?(g.accent||C.acc)+"15":"transparent",color:cA?C.t:C.tm,fontSize:10,fontWeight:cA?600:400,cursor:"pointer",fontFamily:FONT,transition:"all .12s",textAlign:"left"}}
        onMouseEnter={e=>{if(!cA)e.currentTarget.style.background=C.card2;}} onMouseLeave={e=>{if(!cA)e.currentTarget.style.background="transparent";}}>
        <span style={{fontSize:11,width:16,textAlign:"center"}}>{c.icon}</span>
        <span style={{flex:1}}>{c.label}</span>
        {cA&&<span style={{width:5,height:5,borderRadius:3,background:g.accent||C.acc,flexShrink:0}}/>}
       </button>;
      })}
     </div>}
    </div>;
   })}
  </nav>
  {extra&&<div style={{padding:"6px 10px",borderTop:`1px solid ${C.brd}`}}>{extra}</div>}
  <div style={{padding:"6px 6px 10px",borderTop:extra?"none":`1px solid ${C.brd}`,display:"flex",flexDirection:"column",gap:1}}>
   <button onClick={onTour} style={{width:"100%",display:"flex",alignItems:"center",gap:8,padding:"6px 10px",borderRadius:7,border:"none",background:"transparent",color:C.td,fontSize:10,cursor:"pointer",fontFamily:FONT,textAlign:"left",transition:"background .12s"}} onMouseEnter={e=>e.currentTarget.style.background=C.card2} onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
    <span style={{fontSize:12}}>ðŸŽ“</span><span>Tutoriel</span>
   </button>
   <button onClick={onLogout} style={{width:"100%",display:"flex",alignItems:"center",gap:8,padding:"6px 10px",borderRadius:7,border:"none",background:"transparent",color:C.td,fontSize:10,cursor:"pointer",fontFamily:FONT,textAlign:"left",transition:"background .12s"}} onMouseEnter={e=>{e.currentTarget.style.background=C.rD;e.currentTarget.style.color=C.r;}} onMouseLeave={e=>{e.currentTarget.style.background="transparent";e.currentTarget.style.color=C.td;}}>
    <span style={{fontSize:12}}>â†©</span><span>DÃ©connexion</span>
   </button>
  </div>
 </aside>;
}

/* MAIN APP */
export default function App(){
 const[loaded,setLoaded]=useState(false);const[role,setRole]=useState(null);
 const[socs,setSocs]=useState([]);const[reps,setReps]=useState({});const[hold,setHold]=useState(DH);
 const[actions,setActions]=useState([]);const[journal,setJournal]=useState({});
 const[pulses,setPulses]=useState({});const[deals,setDeals]=useState([]);const[ghlData,setGhlData]=useState({});const[revData,setRevData]=useState(null);const[socBank,setSocBank]=useState({});
 const[okrs,setOkrs]=useState([]);const[synergies,setSynergies]=useState([]);const[kb,setKb]=useState([]);const[challenges,setChallenges]=useState([]);
 const[subs,setSubs]=useState([]);const[team,setTeam]=useState([]);const[clients,setClients]=useState([]);const[invoices,setInvoices]=useState([]);
 const[pin,setPin]=useState("");const[lErr,setLErr]=useState("");const[shake,setShake]=useState(false);
 const[tab,setTab]=useState(0);const[eSoc,setESoc]=useState(null);const[eHold,setEHold]=useState(false);
 const[saving,setSaving]=useState(false);const[meeting,setMeeting]=useState(false);
 const[newActSoc,setNewActSoc]=useState("");const[newActText,setNewActText]=useState("");
 const[onboarded,setOnboarded]=useState(null);const[showTour,setShowTour]=useState(false);const[obData,setObData]=useState(null);const[showOnboarding,setShowOnboarding]=useState(false);
 useEffect(()=>{(async()=>{try{const[s,r,h,a,j,p,d,g,rv,sb,ok,sy,kk,ch,su,tm,cl,iv]=await Promise.all([sGet("scAs"),sGet("scAr"),sGet("scAh"),sGet("scAa"),sGet("scAj"),sGet("scAp"),sGet("scAd"),sGet("scAg"),sGet("scAv"),sGet("scAb"),sGet("scAo"),sGet("scAy"),sGet("scAk"),sGet("scAc"),sGet("scAu"),sGet("scAt"),sGet("scAcl"),sGet("scAiv")]);setSocs(s||DS);setReps(r||mkPrefill());setHold(h||DH);setActions(a||DEMO_ACTIONS);setJournal(j||DEMO_JOURNAL);setPulses(p||DEMO_PULSES);setDeals(d||DEMO_DEALS);setGhlData(g||{});setRevData(rv||null);setSocBank(sb||{});setOkrs(ok||DEMO_OKRS);setSynergies(sy||DEMO_SYNERGIES);setKb(kk||DEMO_KB);setChallenges(ch||[]);setSubs(su||DEMO_SUBS);setTeam(tm||DEMO_TEAM);setClients(cl||DEMO_CLIENTS);setInvoices(iv||mkDemoInvoices(cl||DEMO_CLIENTS,s||DS));}catch{setSocs(DS);setReps(mkPrefill());setHold(DH);setActions(DEMO_ACTIONS);setJournal(DEMO_JOURNAL);setPulses(DEMO_PULSES);setDeals(DEMO_DEALS);setOkrs(DEMO_OKRS);setSynergies(DEMO_SYNERGIES);setKb(DEMO_KB);setSubs(DEMO_SUBS);setTeam(DEMO_TEAM);setClients(DEMO_CLIENTS);setInvoices(mkDemoInvoices(DEMO_CLIENTS,DS));}
   try{const obStatus=await sGet("scOnboarded");const obD=await sGet("scObData");setOnboarded(!!obStatus);setObData(obD||null);}catch{setOnboarded(false);}
   setLoaded(true);})();},[]);
 const save=useCallback(async(ns,nr,nh)=>{setSaving(true);try{if(ns!=null){setSocs(ns);await sSet("scAs",ns);}if(nr!=null){setReps(nr);await sSet("scAr",nr);}if(nh!=null){setHold(nh);await sSet("scAh",nh);}}catch{}setSaving(false);},[]);
 const saveAJ=useCallback(async(na,nj)=>{try{if(na!=null){setActions(na);await sSet("scAa",na);}if(nj!=null){setJournal(nj);await sSet("scAj",nj);}}catch{}},[]);
 const savePulse=useCallback(async(k,v)=>{const np={...pulses,[k]:v};setPulses(np);await sSet("scAp",np);},[pulses]);
 const saveDeals=useCallback(async(nd)=>{setDeals(nd);await sSet("scAd",nd);},[]);
 const saveOkrs=useCallback(async(no)=>{setOkrs(no);await sSet("scAo",no);},[]);
 const saveSynergies=useCallback(async(ns)=>{setSynergies(ns);await sSet("scAy",ns);},[]);
 const saveKb=useCallback(async(nk)=>{setKb(nk);await sSet("scAk",nk);},[]);
 const saveChallenges=useCallback(async(nc)=>{setChallenges(nc);await sSet("scAc",nc);},[]);
 const saveSubs=useCallback(async(ns)=>{setSubs(ns);await sSet("scAu",ns);},[]);
 const saveTeam=useCallback(async(nt)=>{setTeam(nt);await sSet("scAt",nt);},[]);
 const saveClients=useCallback(async(nc)=>{setClients(nc);await sSet("scAcl",nc);},[]);
 const saveInvoices=useCallback(async(ni)=>{setInvoices(ni);await sSet("scAiv",ni);},[]);
 const syncGHL=useCallback(async()=>{
  const hasKeys=socs.some(s=>s.ghlLocationId||s.ghlKey);
  let newData={};
  if(hasKeys){
   for(const s of socs.filter(x=>x.ghlLocationId||x.ghlKey)){
    const d=await syncGHLForSoc(s);
    if(d)newData[s.id]=d;
   }
  }
  const demo=mkGHLDemo(socs);
  socs.filter(s=>s.stat==="active"&&s.id!=="eco").forEach(s=>{
   if(!newData[s.id])newData[s.id]=demo[s.id];
  });
  setGhlData(newData);await sSet("scAg",newData);
  // Merge GHL contacts into clients state
  const ghlSocIds=Object.keys(newData).filter(sid=>newData[sid].ghlClients?.length>0);
  if(ghlSocIds.length>0){
   setClients(prev=>{
    // Remove old ghl_ clients for these socs, keep manual ones
    const kept=prev.filter(c=>!(ghlSocIds.includes(c.socId)&&c.id.startsWith("ghl_")));
    const newCl=ghlSocIds.flatMap(sid=>newData[sid].ghlClients);
    const merged=[...kept,...newCl];
    sSet("scAcl",merged);return merged;
   });
  }
 },[socs]);
 // Auto-sync GHL every 30s + on mount
 useEffect(()=>{
  if(!loaded)return;
  const doSync=()=>{syncGHL().catch(e=>console.warn("Auto-sync GHL failed:",e));};
  doSync();
  const id=setInterval(doSync,30000);
  return()=>clearInterval(id);
 },[loaded,syncGHL]);
 const syncRev=useCallback(async()=>{
  let data=null;
  data=await syncRevolut("eco");
  if(!data)data=mkRevolutDemo();
  setRevData(data);await sSet("scAv",data);
 },[]);
 const syncSocBank=useCallback(async(socId)=>{
  const s=socs.find(x=>x.id===socId);if(!s)return;
  let data=null;
  if(s.revolutCompany){data=await syncSocRevolut(s);}
  if(!data)data=mkSocRevDemo(s);
  const nb={...socBank,[socId]:data};setSocBank(nb);await sSet("scAb",nb);
 },[socs,socBank]);
 const syncAllSocBanks=useCallback(async()=>{
  const nb={};
  for(const s of socs.filter(x=>["active","lancement"].includes(x.stat)&&x.id!=="eco")){
   let data=null;
   if(s.revolutCompany){data=await syncSocRevolut(s);}
   if(!data)data=mkSocRevDemo(s);
   nb[s.id]=data;
  }
  setSocBank(nb);await sSet("scAb",nb);
 },[socs]);
 useEffect(()=>{
  if(!loaded)return;
  const doSync=async()=>{try{await syncRev();await syncAllSocBanks();}catch(e){console.warn("Auto-sync Revolut failed:",e);}};
  doSync();
  const id=setInterval(doSync,60000);
  return()=>clearInterval(id);
 },[loaded,syncRev,syncAllSocBanks]);
 // Auto-generate reports for current month when socBank/ghlData change
 useEffect(()=>{
  if(!loaded||!socs.length)return;
  const cM=curM();
  let updated=false;const nr={...reps};
  socs.filter(s=>["active","lancement"].includes(s.stat)&&s.id!=="eco"&&(s.ghlLocationId||s.revolutCompany)).forEach(s=>{
   const key=`${s.id}_${cM}`;const existing=nr[key];
   if(existing?.ok===true)return;// never overwrite validated
   const hasBankData=socBank?.[s.id]?.monthly?.[cM];
   const hasGhlData=ghlData?.[s.id];
   if(!hasBankData&&!hasGhlData)return;
   const auto=autoGenerateReport(s.id,cM,socBank,ghlData,subs);
   if(existing){// preserve manual edits on non-empty fields, but update auto fields
    nr[key]={...auto,...Object.fromEntries(Object.entries(existing).filter(([k,v])=>v!==""&&v!==0&&v!=="0"&&k!=="notes"&&k!=="_auto"&&k!=="at")),_auto:true,at:new Date().toISOString()};
   }else{nr[key]=auto;}
   updated=true;
  });
  if(updated){setReps(nr);sSet("scAr",nr);}
 },[loaded,socs,socBank,ghlData,subs]);
 const allM=useMemo(()=>{const ks=[...new Set(Object.keys(reps).map(k=>k.split("_").slice(1).join("_")))].sort();const c=curM();if(!ks.includes(c))ks.push(c);return ks.slice(-12);},[reps]);
 const alerts=useMemo(()=>socs.length?getAlerts(socs,reps,hold):[]  ,[socs,reps,hold]);
 const feed=useMemo(()=>buildFeed(socs,reps,actions,pulses),[socs,reps,actions,pulses]);
 const leaderboard=useMemo(()=>calcLeaderboard(socs,reps,actions,pulses,allM),[socs,reps,actions,pulses,allM]);
 const cM2=curM(),actS=socs.filter(s=>s.stat==="active");
 const smartAlerts=useMemo(()=>calcSmartAlerts(socs,reps,actions,pulses,allM,socBank),[socs,reps,actions,pulses,allM,socBank]);
 const login=useCallback(()=>{if(pin==="0000"||pin==="admin"){setRole("admin");setLErr("");if(!onboarded)setShowTour(true);return;}const s=socs.find(x=>x.pin===pin);if(s){setRole(s.id);setLErr("");if(!onboarded)setShowTour(true);return;}setLErr("Code incorrect");setShake(true);setTimeout(()=>setShake(false),500);},[pin,socs,onboarded]);
 const addAction=(socId,text,dl)=>{saveAJ([...actions,{id:uid(),socId,text,deadline:dl||nextM(cM2),done:false,by:"admin",at:new Date().toISOString()}],null);};
 const toggleAction=(id)=>{saveAJ(actions.map(a=>a.id===id?{...a,done:!a.done}:a),null);};
 const deleteAction=(id)=>{saveAJ(actions.filter(a=>a.id!==id),null);};
 if(!loaded)return <div style={{background:C.bg,minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",fontFamily:FONT}}><style>{CSS}</style><div style={{width:36,height:36,border:`3px solid ${C.brd}`,borderTopColor:C.acc,borderRadius:"50%",animation:"sp 1s linear infinite"}}/></div>;
 /* ONBOARDING (optional, non-blocking) */
 if(showOnboarding)return <OnboardingWizard hold={hold} onSkip={()=>setShowOnboarding(false)} onComplete={async(formData)=>{try{await sSet("scOnboarded",true);await sSet("scObData",formData);}catch{}setObData(formData);setOnboarded(true);setShowOnboarding(false);setShowTour(true);}}/>;
 if(!role)return <div style={{background:C.bg,minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",fontFamily:FONT,padding:16}}>
  <style>{CSS}</style>
  {/* TUTORIAL OVERLAY ON LOGIN */}
  {showTour&&<div style={{position:"fixed",inset:0,zIndex:9998,background:"rgba(0,0,0,.6)",backdropFilter:"blur(3px)",display:"flex",alignItems:"center",justifyContent:"center",fontFamily:FONT}}>
   <div className="si" style={{background:C.card,border:`1px solid ${C.brd}`,borderRadius:18,padding:0,width:500,maxWidth:"92vw",boxShadow:"0 24px 60px rgba(0,0,0,.5)",overflow:"hidden"}}>
    <div style={{padding:"24px 28px",background:`linear-gradient(135deg,${C.accD},transparent)`,borderBottom:`1px solid ${C.brd}`,textAlign:"center"}}>
     <div style={{width:64,height:64,borderRadius:16,background:`linear-gradient(135deg,${C.acc},#e8c85a)`,display:"inline-flex",alignItems:"center",justifyContent:"center",fontSize:30,marginBottom:12,boxShadow:`0 8px 32px ${C.accD}`}}>ðŸŽ“</div>
     <h2 style={{margin:0,fontSize:22,fontWeight:800,color:C.t}}>Bienvenue {obData?.founderName||""} !</h2>
     <p style={{color:C.td,fontSize:13,margin:"8px 0 0",lineHeight:1.5}}>Votre espace est configurÃ©. Connectez-vous puis dÃ©couvrez la plateforme avec un tutoriel guidÃ© de chaque onglet.</p>
    </div>
    <div style={{padding:"20px 28px"}}>
     <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>{[{icon:"ðŸ“Š",label:"Dashboard",desc:"Pilotage global"},{icon:"ðŸ†",label:"Milestones",desc:"TrophÃ©es & progrÃ¨s"},{icon:"ðŸ¤–",label:"AI Copilot",desc:"Insights IA"},{icon:"ðŸ“ˆ",label:"Analytique",desc:"Tendances & comparaisons"}].map(it=>
      <div key={it.label} style={{padding:"12px 14px",borderRadius:10,background:C.bg,border:`1px solid ${C.brd}`,display:"flex",alignItems:"center",gap:8}}>
       <span style={{fontSize:18}}>{it.icon}</span><div><div style={{fontWeight:700,fontSize:11,color:C.t}}>{it.label}</div><div style={{fontSize:10,color:C.td}}>{it.desc}</div></div></div>)}</div>
    </div>
    <div style={{padding:"14px 28px",borderTop:`1px solid ${C.brd}`,textAlign:"center"}}>
     <button onClick={()=>setShowTour(false)} style={{padding:"10px 28px",borderRadius:9,border:"none",background:`linear-gradient(135deg,${C.acc},#e8c85a)`,color:"#0a0a0f",fontSize:13,fontWeight:700,cursor:"pointer",fontFamily:FONT,boxShadow:`0 4px 16px ${C.accD}`}}>Se connecter â†’</button>
    </div>
   </div>
  </div>}
  <div className="si" style={{background:C.card,border:`1px solid ${C.brd}`,borderRadius:16,padding:28,width:340,maxWidth:"100%",boxShadow:"0 24px 60px rgba(0,0,0,.5)"}}>
   <div style={{textAlign:"center",marginBottom:24}}>
    <div className="fl" style={{width:44,height:44,background:hold.brand?.logoUrl?"transparent":`linear-gradient(135deg,${hold.brand?.accentColor||C.acc},#e8c85a)`,borderRadius:10,display:"inline-flex",alignItems:"center",justifyContent:"center",fontWeight:900,fontSize:18,color:"#0a0a0f",marginBottom:10,boxShadow:`0 4px 16px ${(hold.brand?.accentColor||C.acc)}44`,overflow:"hidden"}}>{hold.brand?.logoUrl?<img src={hold.brand.logoUrl} alt="" style={{width:"100%",height:"100%",objectFit:"cover"}}/>:(hold.brand?.logoLetter||"S")}</div>
    <h1 style={{margin:0,fontSize:18,fontWeight:900,letterSpacing:.5}}>{hold.brand?.name||"SCALE CORP"}</h1>
    <p style={{color:C.td,fontSize:11,margin:"4px 0 0"}}>{hold.brand?.sub||"Plateforme de pilotage"}</p>
   </div>
   <div style={{animation:shake?"sh .4s ease":"none"}}><Inp label="Code d'accÃ¨s" value={pin} onChange={v=>{setPin(v);setLErr("");}} type="password" placeholder="Entrez votre PIN" onKeyDown={e=>{if(e.key==="Enter")login();}}/></div>
   {lErr&&<div style={{color:C.r,fontSize:11,marginBottom:8,textAlign:"center"}}>âš  {lErr}</div>}
   <Btn onClick={login} full>Connexion</Btn>
   <div className="fu d2" style={{marginTop:18,padding:"10px 12px",background:C.bg,borderRadius:9,border:`1px solid ${C.brd}`}}>
    <div style={{color:C.td,fontSize:9,fontWeight:700,letterSpacing:.8,marginBottom:4}}>ACCÃˆS RAPIDE</div>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"2px 14px",fontSize:10}}>
    <div><span style={{color:C.acc,fontWeight:700}}>0000</span> <span style={{color:C.td}}>Admin</span></div>
    {socs.filter(s=>s.pin!=="admin").slice(0,5).map(s=><div key={s.id}><span style={{color:s.color,fontWeight:600}}>{s.pin}</span> <span style={{color:C.td}}>{s.nom}</span></div>)}
    </div>
   </div>
   {obData&&<div style={{marginTop:10,padding:"8px 12px",background:C.gD,borderRadius:8,border:`1px solid ${C.g}33`,fontSize:10,color:C.g,textAlign:"center"}}>âœ… Onboarding complÃ©tÃ©{obData.companyName?` â€” ${obData.companyName}`:""}</div>}
   {onboarded===false&&<button onClick={()=>setShowOnboarding(true)} style={{marginTop:10,width:"100%",padding:"9px",borderRadius:8,border:`1.5px solid ${C.acc}44`,background:C.accD,color:C.acc,fontSize:11,fontWeight:700,cursor:"pointer",fontFamily:FONT,transition:"all .15s"}}>ðŸ‘‹ ComplÃ©ter l'onboarding</button>}
   {onboarded&&<button onClick={()=>setShowOnboarding(true)} style={{marginTop:8,width:"100%",padding:"6px",borderRadius:6,border:`1px solid ${C.brd}`,background:"transparent",color:C.td,fontSize:9,cursor:"pointer",fontFamily:FONT,opacity:.5}}>â†» Relancer l'onboarding</button>}
  </div>
 </div>;
 if(role!=="admin"){const soc=socs.find(s=>s.id===role);if(!soc)return null;
  const porteurSetTab=(t)=>{const btn=document.querySelector(`[data-tour="porteur-tab-${t}"]`);if(btn)btn.click();};
  return <>{showTour&&<TutorialOverlay steps={TOUR_PORTEUR} onFinish={()=>setShowTour(false)} onSkip={()=>setShowTour(false)} setActiveTab={porteurSetTab}/>}<SocieteView key={soc.id} soc={soc} reps={reps} allM={allM} save={save} onLogout={()=>{setRole(null);setShowTour(false);}} onTour={()=>setShowTour(true)} actions={actions} journal={journal} pulses={pulses} saveAJ={saveAJ} savePulse={savePulse} socBankData={socBank[soc.id]||null} syncSocBank={syncSocBank} okrs={okrs} saveOkrs={saveOkrs} kb={kb} saveKb={saveKb} socs={socs} subs={subs} saveSubs={saveSubs} team={team} saveTeam={saveTeam} clients={clients} saveClients={saveClients} ghlData={ghlData} invoices={invoices} saveInvoices={saveInvoices} hold={hold}/></>;}
 if(meeting)return <MeetingMode socs={socs} reps={reps} hold={hold} actions={actions} pulses={pulses} allM={allM} onExit={()=>setMeeting(false)}/>;
 const hc=calcH(socs,reps,hold,cM2);const pending=socs.filter(s=>{const r=gr(reps,s.id,cM2);return r&&!r.ok;});
 const missing=actS.filter(s=>!gr(reps,s.id,cM2));const lateActions=actions.filter(a=>!a.done&&a.deadline<cM2);
 return <div style={{display:"flex",background:C.bg,minHeight:"100vh",fontFamily:FONT,color:C.t}}>
  <style>{CSS}</style>
  {showTour&&role==="admin"&&<TutorialOverlay steps={TOUR_ADMIN} onFinish={()=>setShowTour(false)} onSkip={()=>setShowTour(false)} setActiveTab={setTab}/>}
  <Sidebar items={SB_ADMIN} activeTab={tab} setTab={setTab} brandTitle={hold.brand?.name||"SCALE CORP"} brandSub={`${actS.length} sociÃ©tÃ©s Â· Admin`} onLogout={()=>setRole(null)} onTour={()=>setShowTour(true)} dataTourPrefix="admin" brand={hold.brand} extra={<div style={{display:"flex",flexDirection:"column",gap:2}}>
   {hold.slack?.enabled&&<div style={{display:"flex",alignItems:"center",gap:4,padding:"3px 4px"}}><span style={{width:5,height:5,borderRadius:3,background:C.g}}/>
    <span style={{fontSize:8,color:C.td}}>{SLACK_MODES[hold.slack?.mode]?.icon} Slack connectÃ©</span>
    {missing.length>0&&<button onClick={async()=>{const results=[];for(const s of missing){const r=await slackSend(hold.slack,buildReminderSlackMsg(s,"report",deadline(cM2)));results.push({nom:s.nom,ok:r.ok});}const ok=results.filter(r=>r.ok).length;alert(`ðŸ“¤ ${ok}/${results.length} rappels envoyÃ©s`);}} style={{marginLeft:"auto",fontSize:8,color:C.o,background:C.oD,border:"none",borderRadius:4,padding:"2px 5px",cursor:"pointer",fontFamily:FONT,fontWeight:600}}>ðŸ”” {missing.length}</button>}
   </div>}
   <button onClick={()=>setMeeting(true)} style={{width:"100%",display:"flex",alignItems:"center",gap:6,padding:"6px 8px",borderRadius:6,border:`1px solid ${"#a78bfa"}22`,background:"#a78bfa"+"0a",color:"#a78bfa",fontSize:10,fontWeight:600,cursor:"pointer",fontFamily:FONT,textAlign:"left"}}>
    <span>ðŸ“‹</span><span>Mode RÃ©union</span>
   </button>
  </div>}/>
  <div style={{flex:1,minWidth:0,height:"100vh",overflow:"auto"}}>
  {saving&&<div style={{position:"fixed",top:12,right:12,zIndex:100,width:14,height:14,border:`2px solid ${C.brd}`,borderTopColor:C.acc,borderRadius:"50%",animation:"sp .8s linear infinite"}}/>}
  <div style={{padding:"16px 22px 50px",maxWidth:1000,margin:"0 auto"}}>
  {tab===0&&<>
   {smartAlerts.length>0&&<div data-tour="admin-alerts" style={{marginBottom:12}}>
    <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:6}}>
    <span style={{color:C.td,fontSize:9,fontWeight:700,letterSpacing:.8}}>ðŸ”” ALERTES INTELLIGENTES</span>
    <span style={{fontSize:8,color:smartAlerts.filter(a=>a.type==="danger").length>0?C.r:C.o}}>{smartAlerts.length} alerte{smartAlerts.length>1?"s":""}</span>
    </div>
    <SmartAlertsPanel alerts={smartAlerts.slice(0,5)}/>
   </div>}
   <div data-tour="admin-kpis" style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(110px,1fr))",gap:8}}>
    <KPI label="CA Groupe" value={`${fmt(actS.reduce((a,s)=>a+pf(gr(reps,s.id,cM2)?.ca),0))}â‚¬`} accent={C.acc} icon="ðŸ’°" delay={1}/>
    <KPI label="Marge nette" value={`${fmt(actS.reduce((a,s)=>a+pf(gr(reps,s.id,cM2)?.ca)-pf(gr(reps,s.id,cM2)?.charges),0))}â‚¬`} accent={C.g} icon="ðŸ“Š" delay={2}/>
    <KPI label="On se verse" value={`${fmt(hold.remun)}â‚¬`} accent={C.o} icon="ðŸ‘¤" delay={3} sub={`${fmt(hold.remun/2)}â‚¬ chacun`}/>
    <KPI label="Reste dispo" value={`${fmt(hc.dispo)}â‚¬`} accent={hc.dispo>0?C.g:C.r} icon="âœ¨" delay={4}/>
    <KPI label="TrÃ©sorerie" value={`${fmt(hold.treso)}â‚¬`} accent={(hold.treso||0)<5e3?C.r:C.g} icon="ðŸ¦" delay={5}/>
   </div>
   <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginTop:14}}>
    <div>
    {feed.length>0&&<div data-tour="admin-feed"><Card style={{padding:12,marginBottom:10}}>
    <div style={{color:C.td,fontSize:9,fontWeight:700,letterSpacing:.8,marginBottom:6}}>ACTIVITÃ‰ RÃ‰CENTE</div>
    {feed.slice(0,5).map((f2,i)=><div key={i} style={{display:"flex",alignItems:"center",gap:5,marginBottom:4,fontSize:10}}>
    <span style={{width:4,height:4,borderRadius:2,background:f2.color,flexShrink:0}}/>
    <span style={{color:C.t,flex:1,lineHeight:1.3}}>{f2.m}</span>
    <span style={{color:C.tm,fontSize:8,whiteSpace:"nowrap"}}>{ago(f2.date)}</span>
    </div>)}
    </Card></div>}
    <Sect title="âš¡ Pulse" sub={curW()}><PulseOverview socs={socs} pulses={pulses}/></Sect>
    </div>
    <div data-tour="admin-leaderboard">
    <BankingPanel revData={revData} onSync={syncRev} compact/>
    <Card style={{padding:12,marginTop:10}}>
    <div style={{color:C.td,fontSize:9,fontWeight:700,letterSpacing:.8,marginBottom:6}}>ðŸ† CLASSEMENT</div>
    {leaderboard.slice(0,5).map((lb,i)=>{const ms=calcMilestones(lb.soc,reps,actions,pulses,allM);const msN=ms.filter(m=>m.unlocked).length;return <div key={lb.soc.id} className={`fu d${Math.min(i+1,5)}`} style={{display:"flex",alignItems:"center",gap:6,padding:"5px 0",borderBottom:i<Math.min(leaderboard.length,5)-1?`1px solid ${C.brd}08`:"none"}}>
    <span style={{fontWeight:800,fontSize:12,color:i===0?C.acc:i===1?"#C0C0C0":i===2?"#CD7F32":C.td,width:16}}>{i+1}</span>
    <span style={{width:4,height:4,borderRadius:2,background:lb.soc.color}}/>
    <span style={{flex:1,fontWeight:600,fontSize:11}}>{lb.soc.nom}</span>
    {msN>0&&<span style={{fontSize:7,color:C.acc,background:C.accD,padding:"1px 4px",borderRadius:6,fontWeight:700}}>ðŸ†{msN}</span>}
    <GradeBadge grade={lb.hs.grade} color={lb.hs.color}/>
    <span style={{fontWeight:800,fontSize:12,color:C.acc,minWidth:28,textAlign:"right"}}>{lb.score}</span>
    </div>;})}
    </Card>
    </div>
   </div>
   <div data-tour="admin-okr-actions" style={{display:"grid",gridTemplateColumns:"1fr",gap:12,marginTop:14}}>
    <Card style={{padding:12}}>
    <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8}}>
    <div style={{color:C.td,fontSize:9,fontWeight:700,letterSpacing:.8}}>âš¡ ACTIONS PRIORITAIRES</div>
    <span style={{fontSize:9,color:C.td}}>{actions.filter(a=>!a.done).length} ouvertes</span>
    </div>
    {(()=>{
    const open=actions.filter(a=>!a.done).sort((a,b)=>a.deadline>b.deadline?1:-1);
    if(open.length===0)return <div style={{color:C.td,fontSize:11,padding:10,textAlign:"center"}}>Tout est fait ðŸŽ‰</div>;
    return open.slice(0,5).map((a,i)=>{
    const s=socs.find(x=>x.id===a.socId);const isLate=a.deadline<cM2;
    return <div key={a.id} className={`fu d${Math.min(i+1,5)}`} style={{display:"flex",alignItems:"center",gap:5,padding:"4px 0",borderBottom:i<Math.min(open.length,5)-1?`1px solid ${C.brd}08`:"none"}}>
    <span style={{width:4,height:4,borderRadius:2,background:s?.color||C.td,flexShrink:0}}/>
    <span style={{flex:1,fontSize:10,lineHeight:1.3,color:isLate?C.r:C.t}}>{a.text}</span>
    {isLate&&<span style={{fontSize:7,color:C.r,background:C.rD,padding:"1px 4px",borderRadius:4,fontWeight:700}}>RETARD</span>}
    <span style={{fontSize:8,color:C.td,whiteSpace:"nowrap"}}>{ml(a.deadline)}</span>
    </div>;
    });
    })()}
    </Card>
   </div>
   <Sect title="Portfolio" sub={`${actS.filter(s=>s.id!=="eco").length} sociÃ©tÃ©s actives`}>
    <div data-tour="admin-portfolio" style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(220px,1fr))",gap:8}}>
    {actS.filter(s=>s.id!=="eco").map((s,i)=>{
    const r=gr(reps,s.id,cM2);const hs2=healthScore(s,reps);const rw2=runway(reps,s.id,allM);const sb=socBank[s.id];
    const ca2=r?pf(r.ca):0;const ms=calcMilestones(s,reps,actions,pulses,allM);const msUnlocked=ms.filter(m=>m.unlocked);
    return <Card key={s.id} accent={s.color} style={{padding:12}} delay={Math.min(i+1,8)}>
    <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:8}}>
    <div style={{width:24,height:24,borderRadius:6,background:s.color+"22",border:`1.5px solid ${s.color}44`,display:"flex",alignItems:"center",justifyContent:"center",fontWeight:800,fontSize:10,color:s.color}}>{s.nom[0]}</div>
    <div style={{flex:1,minWidth:0}}>
    <div style={{fontWeight:700,fontSize:11,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{s.nom}</div>
    <div style={{color:C.td,fontSize:9}}>{s.porteur}</div>
    </div>
    <GradeBadge grade={hs2.grade} color={hs2.color}/>
    </div>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:4,marginBottom:6}}>
    <div style={{background:C.bg,borderRadius:6,padding:"5px 7px"}}><div style={{color:C.td,fontSize:8,fontWeight:600}}>CA</div><div style={{fontWeight:800,fontSize:12,color:C.t}}>{ca2>0?`${fmt(ca2)}â‚¬`:"â€”"}</div></div>
    <div style={{background:C.bg,borderRadius:6,padding:"5px 7px"}}><div style={{color:C.td,fontSize:8,fontWeight:600}}>{sb?"SOLDE":"TRÃ‰SO"}</div><div style={{fontWeight:800,fontSize:12,color:C.g}}>{sb?`${fmt(sb.balance)}â‚¬`:r?`${fmt(pf(r.tresoSoc))}â‚¬`:"â€”"}</div></div>
    </div>
    {msUnlocked.length>0&&<div style={{display:"flex",alignItems:"center",gap:4,marginBottom:5,padding:"3px 6px",background:C.accD,borderRadius:6}}>
    <MilestonesCompact milestones={ms} max={4}/>
    <span style={{fontSize:7,color:C.acc,fontWeight:700,marginLeft:"auto"}}>{msUnlocked.length}/{ms.length}</span>
    </div>}
    <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",gap:4}}>
    <div style={{display:"flex",gap:3}}>
    {s.incub&&<span style={{fontSize:8,color:C.v,background:C.vD,padding:"1px 6px",borderRadius:8,fontWeight:600}}>ðŸ“… {sinceLbl(s.incub)}</span>}
    <SubsTeamBadge subs={subs} team={team} socId={s.id} reps={reps}/>
    </div>
    <div style={{display:"flex",gap:3}}>
    {rw2&&<span style={{fontSize:8,fontWeight:700,color:rw2.months<3?C.r:rw2.months<6?C.o:C.g,background:rw2.months<3?C.rD:rw2.months<6?C.oD:C.gD,padding:"1px 5px",borderRadius:8}}>{rw2.months===99?"âˆž":rw2.months+"m"}</span>}
    <Badge s={s.stat}/>
    </div>
    </div>
    </Card>;
    })}
    </div>
   </Sect>
   <div data-tour="admin-milestones"><Sect title="ðŸ† Milestones" sub="Progression de chaque sociÃ©tÃ©">
    <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(200px,1fr))",gap:6}}>
    {actS.filter(s=>s.id!=="eco").map((s,i)=>{
    const ms=calcMilestones(s,reps,actions,pulses,allM);const un=ms.filter(m=>m.unlocked);const pctMs=Math.round(un.length/ms.length*100);
    const topTier=un.sort((a2,b2)=>b2.tier-a2.tier).slice(0,5);
    const next=ms.filter(m=>!m.unlocked).sort((a2,b2)=>a2.tier-b2.tier)[0];
    return <div key={s.id} className={`fu d${Math.min(i+1,8)}`} style={{background:C.card,border:`1px solid ${C.brd}`,borderRadius:10,padding:"10px 12px"}}>
    <div style={{display:"flex",alignItems:"center",gap:5,marginBottom:6}}>
    <span style={{width:4,height:4,borderRadius:2,background:s.color,flexShrink:0}}/>
    <span style={{flex:1,fontWeight:700,fontSize:11}}>{s.nom}</span>
    <span style={{fontWeight:800,fontSize:12,color:C.acc}}>{un.length}<span style={{color:C.td,fontWeight:400,fontSize:9}}>/{ms.length}</span></span>
    </div>
    <PBar value={un.length} max={ms.length} color={pctMs>=70?C.g:pctMs>=40?C.acc:C.b} h={3}/>
    <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginTop:5}}>
    <div style={{display:"flex",gap:2}}>
    {topTier.map(m=><span key={m.id} title={m.label} style={{fontSize:10}}>{m.icon}</span>)}
    </div>
    {next&&<span style={{fontSize:7,color:C.td}} title={next.desc}>ðŸ”œ {next.label}</span>}
    </div>
    </div>;
    })}
    </div>
   </Sect></div>
   <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,marginTop:14}}>
    <Card style={{padding:12,cursor:"pointer"}} onClick={()=>setTab(10)}>
    <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:6}}>
    <span style={{fontSize:11,fontWeight:700}}>ðŸ¤ Synergies</span>
    <span style={{fontSize:8,color:C.acc}}>Voir â†’</span>
    </div>
    <div style={{display:"flex",gap:10,alignItems:"baseline"}}>
    <div><div style={{fontWeight:800,fontSize:18,color:C.g}}>{fmt(synergies.filter(s=>s.status==="won").reduce((a,s)=>a+pf(s.value),0))}â‚¬</div><div style={{fontSize:8,color:C.td}}>gÃ©nÃ©rÃ©s</div></div>
    <div><div style={{fontWeight:800,fontSize:14,color:C.b}}>{synergies.filter(s=>s.status==="active").length}</div><div style={{fontSize:8,color:C.td}}>en cours</div></div>
    <div><div style={{fontWeight:800,fontSize:14,color:C.td}}>{synergies.length}</div><div style={{fontSize:8,color:C.td}}>total</div></div>
    </div>
    </Card>
   </div>
   {pending.length>0&&<Sect title={`Rapports â€” ${ml(cM2)}`} sub={`${pending.length} en attente`}>{socs.map((s,i)=>{const r=gr(reps,s.id,cM2);if(!r)return null;return <ValRow key={s.id} s={s} r={r} reps={reps} save={save} hs={healthScore(s,reps)} delay={Math.min(i+1,8)} onAction={(sid,txt)=>addAction(sid,txt)} hold={hold}/>;})}</Sect>}
   {lateActions.length>0&&<Sect title={`âš  Actions en retard (${lateActions.length})`}>{lateActions.map(a=><ActionItem key={a.id} a={a} socs={socs} onToggle={toggleAction} onDelete={deleteAction}/>)}</Sect>}
   <Sect title="TrÃ©sorerie & Runway" right={<Btn small v="secondary" onClick={syncAllSocBanks}>â†» Sync</Btn>}>{actS.filter(s=>s.id!=="eco").map((s,i)=>{const rw=runway(reps,s.id,allM);const sb=socBank[s.id];const bf=revFinancials(sb,cM2);
    return <div key={s.id} className={`fu d${Math.min(i+1,8)}`} style={{display:"flex",alignItems:"center",gap:6,padding:"7px 10px",background:C.card,borderRadius:8,border:`1px solid ${C.brd}`,marginBottom:2}}>
    <span style={{width:4,height:4,borderRadius:2,background:s.color}}/><span style={{flex:1,fontSize:11,fontWeight:600}}>{s.nom}</span>
    {sb&&<><span style={{fontSize:9,color:C.g,fontWeight:700}}>ðŸ¦ {fmt(sb.balance)}â‚¬</span>{bf&&<span style={{fontSize:8,color:C.td}}>â†“{fmt(bf.ca)}â‚¬ â†‘{fmt(bf.charges)}â‚¬</span>}</>}
    {!sb&&rw&&<span style={{fontSize:10,color:C.td}}>TrÃ©so: {fmt(rw.treso)}â‚¬</span>}
    {rw&&<span style={{fontWeight:700,fontSize:9,color:rw.months<3?C.r:rw.months<6?C.o:C.g,padding:"1px 6px",background:rw.months<3?C.rD:rw.months<6?C.oD:C.gD,borderRadius:8}}>{rw.months===99?"âˆž":rw.months+"m"}</span>}
    </div>;})}
   </Sect>
   <Sect title="Projection T+3">{actS.map((s,i)=>{const proj=project(reps,s.id,allM);if(!proj)return null;const n=[nextM(cM2),nextM(nextM(cM2)),nextM(nextM(nextM(cM2)))];return <div key={s.id} className={`fu d${Math.min(i+1,8)}`} style={{display:"flex",alignItems:"center",gap:6,padding:"6px 10px",background:C.card,borderRadius:8,border:`1px solid ${C.brd}`,marginBottom:2}}><span style={{width:4,height:4,borderRadius:2,background:s.color}}/><span style={{flex:1,fontSize:11,fontWeight:600}}>{s.nom}</span>{proj.map((v,j)=><span key={j} style={{fontSize:9,color:C.td}}>{ml(n[j]).split(" ")[0]}: <strong style={{color:C.t}}>{fmt(v)}â‚¬</strong></span>)}</div>;})}
   </Sect>
   <RiskMatrix socs={socs} reps={reps} allM={allM}/>
   {(challenges||[]).filter(c=>c.month===cM2).length>0&&<Card style={{padding:12,marginTop:12,cursor:"pointer"}} onClick={()=>setTab(12)}>
    <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:6}}>
    <span style={{fontSize:11,fontWeight:700}}>âš¡ Challenges ce mois</span>
    <span style={{fontSize:8,color:C.acc}}>Voir â†’</span>
    </div>
    <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
    {(challenges||[]).filter(c=>c.month===cM2).map(ch=>{const tmpl=CHALLENGE_TEMPLATES.find(t=>t.id===ch.templateId);return tmpl?<span key={ch.id} style={{padding:"3px 8px",background:C.accD,borderRadius:6,fontSize:10,fontWeight:600}}>{tmpl.icon} {tmpl.title.replace(/^. /,"")}</span>:null;})}
    </div>
   </Card>}
  </>}
  {tab===1&&<>
   <div style={{display:"flex",justifyContent:"space-between",marginTop:6,marginBottom:12}}><span style={{color:C.td,fontSize:12}}>{socs.length} sociÃ©tÃ©s</span><Btn small onClick={()=>setESoc({id:`s${Date.now()}`,nom:"",porteur:"",act:"",pT:"benefices",pP:20,stat:"lancement",color:"#22d3ee",pin:String(2000+socs.length),rec:false,obj:0,objQ:0,ghlKey:"",revToken:"",revEnv:"sandbox",incub:new Date().toISOString().slice(0,10),slackId:""})}>+ Ajouter</Btn></div>
   {socs.map((s,i)=>{const hs2=healthScore(s,reps);const ms=calcMilestones(s,reps,actions,pulses,allM);return <Card key={s.id} accent={s.color} style={{marginBottom:4,padding:"10px 14px"}} delay={Math.min(i+1,8)} onClick={()=>setESoc({...s})}><div style={{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"}}><GradeBadge grade={hs2.grade} color={hs2.color}/><div style={{flex:"1 1 130px"}}><div style={{fontWeight:700,fontSize:12}}>{s.nom} <span style={{color:C.td,fontWeight:400,fontSize:10}}>Â· {s.porteur}</span></div><div style={{color:C.td,fontSize:10}}>{s.act}</div></div><div style={{display:"flex",gap:4,alignItems:"center",flexWrap:"wrap"}}><MilestoneCount milestones={ms}/><IncubBadge incub={s.incub}/><Badge s={s.stat}/></div></div></Card>;})}
   <Sect title="Actions"><div style={{display:"flex",gap:6,marginBottom:10,flexWrap:"wrap"}}><select value={newActSoc} onChange={e=>setNewActSoc(e.target.value)} style={{background:C.bg,border:`1px solid ${C.brd}`,borderRadius:6,color:C.t,padding:"6px 8px",fontSize:11,fontFamily:FONT,outline:"none"}}><option value="">SociÃ©tÃ©â€¦</option>{socs.map(s=><option key={s.id} value={s.id}>{s.nom}</option>)}</select><input value={newActText} onChange={e=>setNewActText(e.target.value)} placeholder="Nouvelle actionâ€¦" style={{flex:1,minWidth:120,background:C.bg,border:`1px solid ${C.brd}`,borderRadius:6,color:C.t,padding:"6px 8px",fontSize:11,fontFamily:FONT,outline:"none"}}/><Btn small onClick={()=>{if(newActSoc&&newActText.trim()){addAction(newActSoc,newActText.trim());setNewActText("");}}} disabled={!newActSoc||!newActText.trim()}>+ CrÃ©er</Btn></div>{actions.filter(a=>!a.done).map(a=><ActionItem key={a.id} a={a} socs={socs} onToggle={toggleAction} onDelete={deleteAction}/>)}</Sect>
   <Sect title="Journal">{Object.entries(journal).filter(([,v])=>v.length>0).map(([sid,entries])=>{const s=socs.find(x=>x.id===sid);if(!s)return null;return <div key={sid} style={{marginBottom:8}}><div style={{display:"flex",alignItems:"center",gap:5,marginBottom:4}}><span style={{width:5,height:5,borderRadius:3,background:s.color}}/><span style={{fontWeight:700,fontSize:12}}>{s.nom}</span></div>{entries.sort((a2,b2)=>new Date(b2.date)-new Date(a2.date)).map(j=><div key={j.id} style={{padding:"4px 0 4px 14px",borderLeft:`2px solid ${s.color}33`,marginBottom:2}}><div style={{fontSize:11,color:C.t}}>{j.text}</div><div style={{fontSize:9,color:C.td}}>{new Date(j.date).toLocaleDateString("fr-FR")}</div></div>)}</div>;})}</Sect>
   <Modal open={!!eSoc} onClose={()=>setESoc(null)} title={eSoc?.nom||"Nouvelle sociÃ©tÃ©"} wide>{eSoc&&<>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"0 10px"}}>
    <Inp label="Nom" value={eSoc.nom} onChange={v=>setESoc({...eSoc,nom:v})}/>
    <Inp label="Porteur" value={eSoc.porteur} onChange={v=>setESoc({...eSoc,porteur:v})}/>
    <Inp label="ActivitÃ©" value={eSoc.act} onChange={v=>setESoc({...eSoc,act:v})}/>
    <Inp label="Date d'incubation" type="date" value={eSoc.incub||""} onChange={v=>setESoc({...eSoc,incub:v})} note={eSoc.incub?`â†’ ${sinceLbl(eSoc.incub)} d'association`:""}/>
    <Inp label="PIN" value={eSoc.pin} onChange={v=>setESoc({...eSoc,pin:v})}/>
    <Inp label="Couleur" type="color" value={eSoc.color} onChange={v=>setESoc({...eSoc,color:v})}/>
    <Sel label="Part sur" value={eSoc.pT} onChange={v=>setESoc({...eSoc,pT:v})} options={[{v:"benefices",l:"% bÃ©nÃ©fices"},{v:"ca",l:"% CA"}]}/>
    <Inp label="%" value={eSoc.pP} onChange={v=>setESoc({...eSoc,pP:pf(v)})} type="number" suffix="%"/>
    <Sel label="Statut" value={eSoc.stat} onChange={v=>setESoc({...eSoc,stat:v})} options={[{v:"active",l:"Active"},{v:"lancement",l:"Lancement"},{v:"signature",l:"Signature"},{v:"inactive",l:"Inactive"}]}/>
    <Sel label="RÃ©current" value={eSoc.rec?"1":"0"} onChange={v=>setESoc({...eSoc,rec:v==="1"})} options={[{v:"0",l:"Non"},{v:"1",l:"Oui"}]}/>
    <Inp label="Obj. mensuel" value={eSoc.obj} onChange={v=>setESoc({...eSoc,obj:pf(v)})} type="number" suffix="â‚¬"/>
    <Inp label="Obj. trim." value={eSoc.objQ} onChange={v=>setESoc({...eSoc,objQ:pf(v)})} type="number" suffix="â‚¬"/>
    </div>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginTop:8}}>
    <div style={{padding:"10px 12px",background:C.bg,borderRadius:8,border:`1px solid ${C.brd}`}}><div style={{display:"flex",alignItems:"center",gap:5,marginBottom:6}}><span style={{fontSize:12}}>ðŸ“¡</span><span style={{fontWeight:700,fontSize:10,color:C.td}}>GHL</span></div><Inp label="ClÃ© API" value={eSoc.ghlKey||""} onChange={v=>setESoc({...eSoc,ghlKey:v})} placeholder="eyJhbGciOi..." small/></div>
    <div style={{padding:"10px 12px",background:C.bg,borderRadius:8,border:`1px solid ${C.brd}`}}><div style={{display:"flex",alignItems:"center",gap:5,marginBottom:6}}><span style={{fontSize:12}}>ðŸ¦</span><span style={{fontWeight:700,fontSize:10,color:C.td}}>REVOLUT</span></div><Inp label="Token" value={eSoc.revToken||""} onChange={v=>setESoc({...eSoc,revToken:v})} placeholder="oa_sand_..." small/><Sel label="Env." value={eSoc.revEnv||"sandbox"} onChange={v=>setESoc({...eSoc,revEnv:v})} options={[{v:"sandbox",l:"Sandbox"},{v:"production",l:"Production"}]}/></div>
    </div>
    <div style={{padding:"10px 12px",background:C.bg,borderRadius:8,border:`1px solid ${C.brd}`,marginTop:8}}>
    <div style={{display:"flex",alignItems:"center",gap:5,marginBottom:6}}><span style={{fontSize:12}}>ðŸ’¬</span><span style={{fontWeight:700,fontSize:10,color:C.td}}>SLACK</span></div>
    <Inp label="Slack User ID du porteur" value={eSoc.slackId||""} onChange={v=>setESoc({...eSoc,slackId:v})} placeholder="U06ABC123" note="Profil Slack du porteur â†’ â‹® â†’ Copier l'ID membre" small/>
    {eSoc.slackId&&<div style={{fontSize:8,color:C.g,marginTop:2}}>âœ“ Le porteur sera taguÃ© dans les notifications Slack</div>}
    </div>
    <div style={{display:"flex",gap:8,marginTop:12}}><Btn onClick={()=>{const idx=socs.findIndex(x=>x.id===eSoc.id);save(idx>=0?socs.map(x=>x.id===eSoc.id?eSoc:x):[...socs,eSoc]);setESoc(null);}}>Sauver</Btn><Btn v="secondary" onClick={()=>setESoc(null)}>Annuler</Btn>{socs.find(x=>x.id===eSoc.id)&&<Btn v="danger" onClick={()=>{save(socs.filter(x=>x.id!==eSoc.id));setESoc(null);}} style={{marginLeft:"auto"}}>Supprimer</Btn>}</div>
   </>}</Modal>
  </>}
  {tab===2&&<AnalytiqueTab socs={socs} reps={reps} allM={allM}/>}
  {tab===3&&<TabSimulateur socs={socs} reps={reps} hold={hold}/>}
  {tab===4&&(()=>{
   const holdSubs=subs.filter(s=>s.socId==="holding");const holdTeam=team.filter(t=>t.socId==="holding");
   const holdSubsM=holdSubs.reduce((a,s)=>a+subMonthly(s),0);
   const holdTeamM=holdTeam.reduce((a,t)=>a+teamMonthly(t,0),0);
   const allSubsM=subs.reduce((a,s)=>a+subMonthly(s),0);
   const allTeamM=team.reduce((a,t)=>{const ca=t.socId!=="holding"?pf(gr(reps,t.socId,cM2)?.ca):0;return a+teamMonthly(t,ca);},0);
   return <>
   <div style={{display:"flex",justifyContent:"flex-end",marginTop:6,gap:6}}><Btn small v="secondary" onClick={()=>setTab(13)}>ðŸ”„ GÃ©rer charges</Btn><Btn small onClick={()=>setEHold(true)}>âš™ ParamÃ¨tres</Btn></div>
   <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(110px,1fr))",gap:8,marginTop:8}}>
    <KPI label="Flux entrant" value={`${fmt(hc.tIn)}â‚¬`} accent={C.g} icon="ðŸ’°" delay={1} sub={`RemontÃ©es: ${fmt(hc.rem)}â‚¬`}/>
    <KPI label="On se verse" value={`${fmt(hold.remun)}â‚¬`} accent={C.acc} icon="ðŸ‘¤" delay={2} sub={`${fmt(hold.remun/2)}â‚¬ chacun`}/>
    <KPI label="Charges holding" value={`${fmt(hc.tCh)}â‚¬`} accent={C.r} icon="ðŸ“¤" delay={3}/>
    <KPI label="Abos + Ã‰quipe" value={`${fmt(holdSubsM+holdTeamM)}â‚¬`} accent={C.o} icon="ðŸ”„" delay={4} sub={`${holdSubs.length} abos Â· ${holdTeam.length} membres`}/>
    <KPI label="Reste dispo" value={`${fmt(hc.dispo)}â‚¬`} accent={hc.dispo>0?C.g:C.r} icon="âœ¨" delay={5}/>
   </div>
   <Sect title="Cascade des flux">
    <Card style={{padding:14}}>
    {(()=>{
    const steps=[
    {l:"RemontÃ©es sociÃ©tÃ©s",v:hc.rem,c:C.g,icon:"ðŸ¢"},
    {l:"CRM / sociÃ©tÃ©",v:hc.crm,c:C.g,icon:"ðŸ“‹"},
    {l:"CA Ã‰cosystÃ¨me (net)",v:Math.max(0,hc.eNet),c:C.g,icon:"ðŸŒ"},
    {l:"= Flux entrant",v:hc.tIn,c:C.acc,icon:"ðŸ’°",total:true},
    {l:"âˆ’ Charges holding",v:-hc.tCh,c:C.r,icon:"ðŸ“¤"},
    {l:"âˆ’ RÃ©munÃ©ration",v:-hold.remun,c:C.r,icon:"ðŸ‘¤"},
    ...(holdSubsM>0?[{l:`âˆ’ Abonnements holding (${holdSubs.length})`,v:-holdSubsM,c:C.b,icon:"ðŸ’»"}]:[]),
    ...(holdTeamM>0?[{l:`âˆ’ Ã‰quipe holding (${holdTeam.length})`,v:-holdTeamM,c:C.o,icon:"ðŸ‘¥"}]:[]),
    {l:"âˆ’ RÃ©serve",v:-hc.res,c:C.b,icon:"ðŸ›¡ï¸"},
    {l:"= Disponible",v:hc.dispo,c:hc.dispo>0?C.g:C.r,icon:"âœ¨",total:true},
    ];
    const maxV=Math.max(...steps.map(s=>Math.abs(s.v)),1);
    return steps.map((s,i)=><div key={i} className={`fu d${Math.min(i+1,8)}`} style={{display:"flex",alignItems:"center",gap:8,padding:"5px 0",borderBottom:s.total?`1px solid ${C.brd}`:"none",marginTop:s.total?4:0,paddingTop:s.total?4:5}}>
    <span style={{fontSize:12,width:16,textAlign:"center"}}>{s.icon}</span>
    <span style={{flex:1,fontSize:s.total?11:10,fontWeight:s.total?700:500,color:s.total?C.t:C.td}}>{s.l}</span>
    <div style={{width:120,display:"flex",alignItems:"center",gap:4}}>
    <div style={{flex:1,height:6,background:C.bg,borderRadius:3,overflow:"hidden"}}>
    <div style={{height:"100%",width:`${Math.abs(s.v)/maxV*100}%`,background:s.c,borderRadius:3,transition:"width .4s"}}/>
    </div>
    <span style={{fontWeight:700,fontSize:11,color:s.c,minWidth:55,textAlign:"right"}}>{s.v>=0?"+":""}{fmt(s.v)}â‚¬</span>
    </div>
    </div>);
    })()}
    </Card>
   </Sect>
   <Sect title="Ce que chaque sociÃ©tÃ© rapporte" sub="RemontÃ©es au holding ce mois">
    {socs.filter(s=>s.id!=="eco").map((s,i)=>{
    const r=gr(reps,s.id,cM2);const ca2=r?pf(r.ca):0,ch2=r?pf(r.charges):0;
    const base=s.pT==="ca"?ca2:Math.max(0,ca2-ch2);const remontee=base*s.pP/100;
    const margeNet=ca2-ch2;const margePct2=ca2>0?Math.round(margeNet/ca2*100):0;
    const salaire=r?pf(r.salaire):0;
    const divHold=r?pf(r.dividendesHolding):0;const resteVerser=remontee-divHold;
    return <Card key={s.id} accent={s.color} style={{marginBottom:4,padding:"10px 14px"}} delay={Math.min(i+1,8)}>
    <div style={{display:"flex",alignItems:"center",gap:8}}>
    <div style={{width:28,height:28,borderRadius:7,background:s.color+"22",border:`1.5px solid ${s.color}44`,display:"flex",alignItems:"center",justifyContent:"center",fontWeight:800,fontSize:11,color:s.color}}>{s.nom[0]}</div>
    <div style={{flex:1}}>
    <div style={{display:"flex",alignItems:"center",gap:6}}>
    <span style={{fontWeight:700,fontSize:12}}>{s.nom}</span>
    <span style={{fontSize:9,color:C.td}}>({s.pP}% {s.pT==="ca"?"du CA":"des bÃ©nÃ©fices"})</span>
    </div>
    <div style={{display:"flex",gap:8,marginTop:3,flexWrap:"wrap"}}>
    <span style={{fontSize:9,color:C.td}}>CA: <strong style={{color:C.t}}>{fmt(ca2)}â‚¬</strong></span>
    <span style={{fontSize:9,color:C.td}}>Marge: <strong style={{color:margeNet>=0?C.g:C.r}}>{fmt(margeNet)}â‚¬ ({margePct2}%)</strong></span>
    {salaire>0&&<span style={{fontSize:9,color:C.td}}>RÃ©m fondateur: <strong style={{color:C.o}}>{fmt(salaire)}â‚¬</strong></span>}
    {divHold>0&&<span style={{fontSize:9,color:"#7c3aed"}}>ðŸ›ï¸ VirÃ©: <strong>{fmt(divHold)}â‚¬</strong></span>}
    </div>
    </div>
    <div style={{textAlign:"right"}}>
    <div style={{fontWeight:900,fontSize:16,color:C.acc}}>{fmt(remontee)}â‚¬</div>
    <div style={{fontSize:8,color:C.td}}>thÃ©orique</div>
    {divHold>0&&<div style={{fontSize:9,fontWeight:700,color:resteVerser>0?C.o:C.g,marginTop:2}}>{resteVerser>0?`âš  Reste ${fmt(resteVerser)}â‚¬`:`âœ… +${fmt(Math.abs(resteVerser))}â‚¬`}</div>}
    </div>
    </div>
    </Card>;
    })}
    <Card style={{marginTop:6,padding:"10px 14px",background:C.accD,border:`1px solid ${C.acc}22`}}>
    <div style={{display:"flex",alignItems:"center",justifyContent:"space-between"}}>
    <span style={{fontWeight:700,fontSize:12,color:C.acc}}>Total remontÃ©es</span>
    <span style={{fontWeight:900,fontSize:16,color:C.acc}}>{fmt(hc.rem)}â‚¬</span>
    </div>
    </Card>
   </Sect>
   <Sect title="Ã‰volution des revenus"><div className="fu d4" style={{height:200,background:C.card,borderRadius:12,border:`1px solid ${C.brd}`,padding:"14px 6px 6px 0"}}><ResponsiveContainer><BarChart data={allM.map(m=>{const h2=calcH(socs,reps,hold,m);return{mois:ml(m),Entrant:h2.tIn,RÃ©munÃ©ration:hold.remun,Dispo:h2.dispo};}).filter(d=>d.Entrant>0)}><CartesianGrid strokeDasharray="3 3" stroke={C.brd}/><XAxis dataKey="mois" tick={{fill:C.td,fontSize:9}} axisLine={false} tickLine={false}/><YAxis tick={{fill:C.td,fontSize:9}} axisLine={false} tickLine={false} tickFormatter={v=>`${fK(v)}â‚¬`}/><Tooltip content={<CTip/>}/><Legend wrapperStyle={{fontSize:10}}/><Bar dataKey="Entrant" fill={C.g} radius={[3,3,0,0]}/><Bar dataKey="RÃ©munÃ©ration" fill={C.acc} radius={[3,3,0,0]}/><Bar dataKey="Dispo" fill={C.b} radius={[3,3,0,0]}/></BarChart></ResponsiveContainer></div></Sect>
   <Modal open={eHold} onClose={()=>setEHold(false)} title="ParamÃ¨tres holding" wide><div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"0 12px"}}><Inp label="Logiciels" type="number" value={hold.logiciels} onChange={v=>setHold({...hold,logiciels:pf(v)})} suffix="â‚¬"/><Inp label="Ã‰quipe" type="number" value={hold.equipe} onChange={v=>setHold({...hold,equipe:pf(v)})} suffix="â‚¬"/><Inp label="Service" type="number" value={hold.service} onChange={v=>setHold({...hold,service:pf(v)})} suffix="â‚¬"/><Inp label="Cabinet" type="number" value={hold.cabinet} onChange={v=>setHold({...hold,cabinet:pf(v)})} suffix="â‚¬"/><Inp label="RÃ©munÃ©ration" type="number" value={hold.remun} onChange={v=>setHold({...hold,remun:pf(v)})} suffix="â‚¬"/><Inp label="RÃ©serve" type="number" value={hold.reservePct} onChange={v=>setHold({...hold,reservePct:pf(v)})} suffix="%"/><Inp label="CRM/soc" type="number" value={hold.crm} onChange={v=>setHold({...hold,crm:pf(v)})} suffix="â‚¬"/><Inp label="TrÃ©sorerie" type="number" value={hold.treso} onChange={v=>setHold({...hold,treso:pf(v)})} suffix="â‚¬"/></div><div style={{marginTop:12,padding:"12px 14px",background:C.bg,borderRadius:10,border:`1px solid ${C.brd}`}}><div style={{display:"flex",alignItems:"center",gap:6,marginBottom:8}}><span style={{fontSize:16}}>ðŸ¦</span><span style={{fontWeight:700,fontSize:12,color:C.td}}>REVOLUT BUSINESS</span></div><Inp label="API Token" value={hold.revolutToken||""} onChange={v=>setHold({...hold,revolutToken:v})} placeholder="oa_sand_..." note="Settings â†’ API â†’ Generate token (avec les scopes accounts:read + transactions:read)"/><Sel label="Environnement" value={hold.revolutEnv||"sandbox"} onChange={v=>setHold({...hold,revolutEnv:v})} options={[{v:"sandbox",l:"Sandbox (test)"},{v:"production",l:"Production (live)"}]}/></div>
   <div style={{marginTop:12,padding:"12px 14px",background:C.bg,borderRadius:10,border:`1px solid ${hold.slack?.enabled?C.g+"44":C.brd}`}}>
    <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8}}>
    <div style={{display:"flex",alignItems:"center",gap:6}}><span style={{fontSize:16}}>ðŸ’¬</span><span style={{fontWeight:700,fontSize:12,color:C.td}}>SLACK</span></div>
    <Toggle on={hold.slack?.enabled||false} onToggle={()=>setHold({...hold,slack:{...(hold.slack||DH.slack),enabled:!(hold.slack?.enabled)}})} label=""/>
    </div>
    {hold.slack?.enabled&&<>
    <div style={{display:"flex",gap:4,marginBottom:10}}>
    {Object.entries(SLACK_MODES).map(([k,v])=>{const active2=hold.slack?.mode===k;return <button key={k} onClick={()=>setHold({...hold,slack:{...hold.slack,mode:k}})} style={{flex:1,padding:"8px 6px",borderRadius:8,border:`1.5px solid ${active2?C.acc:C.brd}`,background:active2?C.accD:C.card,color:active2?C.acc:C.td,fontWeight:active2?700:500,fontSize:10,cursor:"pointer",fontFamily:FONT,transition:"all .15s",textAlign:"center"}}><div style={{fontSize:14,marginBottom:2}}>{v.icon}</div>{v.l}<div style={{fontSize:7,color:C.td,marginTop:2}}>{v.desc.slice(0,30)}</div></button>;})}
    </div>
    {hold.slack?.mode==="webhook"&&<Inp label="Webhook URL" value={hold.slack?.webhookUrl||""} onChange={v=>setHold({...hold,slack:{...hold.slack,webhookUrl:v}})} placeholder="https://hooks.slack.com/services/..." small/>}
    {hold.slack?.mode==="bot"&&<><Inp label="Bot OAuth Token" value={hold.slack?.botToken||""} onChange={v=>setHold({...hold,slack:{...hold.slack,botToken:v}})} placeholder="xoxb-..." note="Slack â†’ Apps â†’ Your App â†’ OAuth â†’ Bot User OAuth Token"/><Inp label="Channel ID" value={hold.slack?.channel||""} onChange={v=>setHold({...hold,slack:{...hold.slack,channel:v}})} placeholder="C06..." note="Clic droit sur le channel â†’ Copier l'ID du channel"/></>}
    {hold.slack?.mode==="bob"&&<Inp label="Bob Webhook URL" value={hold.slack?.bobWebhook||""} onChange={v=>setHold({...hold,slack:{...hold.slack,bobWebhook:v}})} placeholder="https://your-bob-webhook.com/..." small/>}
    <div style={{padding:"8px 10px",background:C.card2,borderRadius:8,marginTop:8}}>
    <div style={{fontSize:9,color:C.td,fontWeight:700,marginBottom:6}}>NOTIFICATIONS</div>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:4}}>
    <Toggle on={hold.slack?.notifyReport!==false} onToggle={()=>setHold({...hold,slack:{...hold.slack,notifyReport:!hold.slack?.notifyReport}})} label="ðŸ“Š Rapports soumis"/>
    <Toggle on={hold.slack?.notifyPulse!==false} onToggle={()=>setHold({...hold,slack:{...hold.slack,notifyPulse:!hold.slack?.notifyPulse}})} label="âš¡ Pulses envoyÃ©s"/>
    <Toggle on={hold.slack?.notifyValidation!==false} onToggle={()=>setHold({...hold,slack:{...hold.slack,notifyValidation:!hold.slack?.notifyValidation}})} label="âœ… Rapports validÃ©s"/>
    <Toggle on={hold.slack?.notifyReminders!==false} onToggle={()=>setHold({...hold,slack:{...hold.slack,notifyReminders:!hold.slack?.notifyReminders}})} label="ðŸ”” Rappels auto"/>
    </div>
    </div>
    <div style={{marginTop:8}}><Btn small v="secondary" onClick={async()=>{const r=await slackSend(hold.slack,{text:`ðŸ§ª Test ${hold.brand?.name||"Scale Corp"} â€” Slack est bien connectÃ© ! ðŸŽ‰`,blocks:[{type:"section",text:{type:"mrkdwn",text:`ðŸ§ª *Test ${hold.brand?.name||"Scale Corp"}*\n\nSlack est bien connectÃ© ! Les notifications de rapports et pulses arriveront ici.\n\n_Mode: ${SLACK_MODES[hold.slack?.mode]?.l}_`}}]});alert(r.ok?"âœ… Message envoyÃ© avec succÃ¨s !":"âŒ Erreur: "+(r.error||"Ã©chec"));}}>ðŸ§ª Envoyer un test</Btn></div>
    </>}
   </div>
   <div style={{marginTop:12,padding:"12px 14px",background:C.bg,borderRadius:10,border:`1px solid ${C.brd}`}}>
    <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:8}}><span style={{fontSize:16}}>ðŸŽ¨</span><span style={{fontWeight:700,fontSize:12,color:C.td}}>BRANDING</span></div>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"0 12px"}}>
    <Inp label="Nom de la plateforme" value={hold.brand?.name||"SCALE CORP"} onChange={v=>setHold({...hold,brand:{...(hold.brand||DH.brand),name:v}})}/>
    <Inp label="Sous-titre" value={hold.brand?.sub||"Plateforme de pilotage"} onChange={v=>setHold({...hold,brand:{...(hold.brand||DH.brand),sub:v}})}/>
    <Inp label="Logo URL (optionnel)" value={hold.brand?.logoUrl||""} onChange={v=>setHold({...hold,brand:{...(hold.brand||DH.brand),logoUrl:v}})} placeholder="https://..."/>
    <Inp label="Lettre logo (fallback)" value={hold.brand?.logoLetter||"S"} onChange={v=>setHold({...hold,brand:{...(hold.brand||DH.brand),logoLetter:v.slice(0,2)}})}/>
    </div>
    <div style={{display:"flex",alignItems:"center",gap:10,marginTop:4}}>
     <label style={{fontSize:10,color:C.td,fontWeight:600}}>Couleur accent</label>
     <input type="color" value={hold.brand?.accentColor||"#c8a44e"} onChange={e=>setHold({...hold,brand:{...(hold.brand||DH.brand),accentColor:e.target.value}})} style={{width:32,height:24,border:`1px solid ${C.brd}`,borderRadius:6,background:C.bg,cursor:"pointer"}}/>
     <span style={{fontSize:10,color:C.td}}>{hold.brand?.accentColor||"#c8a44e"}</span>
    </div>
    {hold.brand?.logoUrl&&<div style={{marginTop:8,display:"flex",alignItems:"center",gap:8}}><span style={{fontSize:9,color:C.td}}>AperÃ§u:</span><div style={{width:36,height:36,borderRadius:8,overflow:"hidden",border:`1px solid ${C.brd}`}}><img src={hold.brand.logoUrl} alt="" style={{width:"100%",height:"100%",objectFit:"cover"}}/></div></div>}
   </div>
   <div style={{display:"flex",gap:8,marginTop:12}}><Btn onClick={()=>{save(null,null,hold);setEHold(false);}}>Sauver</Btn><Btn v="secondary" onClick={()=>setEHold(false)}>Annuler</Btn></div></Modal>
   <Sect title="ðŸ”„ Charges rÃ©currentes holding" right={<Btn small v="ghost" onClick={()=>setTab(13)}>Tout gÃ©rer â†’</Btn>}>
    {holdSubs.length>0&&<div style={{marginBottom:8}}>
    <div style={{color:C.td,fontSize:9,fontWeight:700,letterSpacing:.8,marginBottom:4}}>ABONNEMENTS Â· {fmt(holdSubsM)}â‚¬/m</div>
    <div style={{display:"flex",flexWrap:"wrap",gap:4}}>
    {holdSubs.map(s=><span key={s.id} style={{fontSize:9,background:C.card,border:`1px solid ${C.brd}`,padding:"3px 8px",borderRadius:6}}>{s.name} <strong style={{color:C.b}}>{fmt(subMonthly(s))}â‚¬</strong><span style={{color:C.td}}>/{s.freq==="annual"?"an":"m"}</span></span>)}
    </div>
    </div>}
    {holdTeam.length>0&&<div>
    <div style={{color:C.td,fontSize:9,fontWeight:700,letterSpacing:.8,marginBottom:4}}>Ã‰QUIPE Â· {fmt(holdTeamM)}â‚¬/m</div>
    {holdTeam.map(t=><div key={t.id} style={{display:"flex",alignItems:"center",gap:6,padding:"4px 8px",background:C.card,borderRadius:6,border:`1px solid ${C.brd}`,marginBottom:2}}>
    <span style={{width:20,height:20,borderRadius:5,background:C.oD,display:"flex",alignItems:"center",justifyContent:"center",fontWeight:700,fontSize:9,color:C.o}}>{t.name[0]}</span>
    <span style={{flex:1,fontSize:10,fontWeight:600}}>{t.name}</span>
    <span style={{fontSize:9,color:C.td}}>{t.role}</span>
    <span style={{fontWeight:700,fontSize:10,color:t.payType==="fixed"?C.b:C.o}}>{t.payType==="fixed"?`${fmt(t.amount)}â‚¬/m`:`${t.amount}%`}</span>
    </div>)}
    </div>}
    {holdSubs.length===0&&holdTeam.length===0&&<div style={{color:C.td,fontSize:11,padding:8,textAlign:"center"}}>Aucune charge rÃ©currente</div>}
    {allSubsM+allTeamM>holdSubsM+holdTeamM&&<div style={{marginTop:10,padding:"8px 10px",background:C.rD,borderRadius:8,border:`1px solid ${C.r}15`}}>
    <div style={{color:C.td,fontSize:9,fontWeight:700,marginBottom:4}}>TOUTES SOCIÃ‰TÃ‰S CONFONDUES</div>
    <div style={{display:"flex",gap:12}}>
    <span style={{fontSize:10,color:C.r}}>Abos: <strong>{fmt(allSubsM)}â‚¬/m</strong></span>
    <span style={{fontSize:10,color:C.o}}>Ã‰quipe: <strong>{fmt(allTeamM)}â‚¬/m</strong></span>
    <span style={{fontSize:10,color:C.r,fontWeight:700}}>Total: {fmt(allSubsM+allTeamM)}â‚¬/m</span>
    </div>
    </div>}
   </Sect>
  </>;})()}
  {tab===5&&<AICoPilot socs={socs} reps={reps} hold={hold} actions={actions} pulses={pulses} allM={allM} revData={revData} socBank={socBank} okrs={okrs} synergies={synergies} clients={clients}/>}
  {tab===6&&<DealFlow deals={deals} saveDeals={saveDeals}/>}
  {tab===7&&<TabCRM socs={socs} ghlData={ghlData} onSync={syncGHL}/>}
  {tab===8&&<BankingPanel revData={revData} onSync={syncRev}/>}
  {tab===10&&<SynergiesPanel socs={socs} synergies={synergies} saveSynergies={saveSynergies}/>}
  {tab===11&&<KnowledgeBase socs={socs} kb={kb} saveKb={saveKb}/>}
  {tab===12&&<ChallengesPanel socs={socs} reps={reps} allM={allM} pulses={pulses} challenges={challenges} saveChallenges={saveChallenges}/>}
  {tab===13&&<SubsTeamPanel socs={socs} subs={subs} saveSubs={saveSubs} team={team} saveTeam={saveTeam} socId="all" reps={reps} revData={revData}/>}
  </div>
  </div>
 </div>;
}
/* ANALYTIQUE TAB */
function AnalytiqueTab({socs,reps,allM}){
 const cM2=curM();const actS=socs.filter(s=>s.stat==="active");
 const[cmpIds,setCmpIds]=useState(actS.slice(0,3).map(s=>s.id));const cmpSocs=socs.filter(s=>cmpIds.includes(s.id));
 return <><Sect title="Comparaison" right={<div style={{display:"flex",gap:4,flexWrap:"wrap"}}>{actS.map(s=><button key={s.id} onClick={()=>setCmpIds(prev=>prev.includes(s.id)?prev.filter(x=>x!==s.id):[...prev,s.id])} style={{padding:"4px 10px",borderRadius:6,fontSize:10,fontWeight:600,border:`1px solid ${cmpIds.includes(s.id)?s.color:C.brd}`,background:cmpIds.includes(s.id)?s.color+"22":"transparent",color:cmpIds.includes(s.id)?s.color:C.td,cursor:"pointer",fontFamily:FONT}}>{s.nom}</button>)}</div>}>
  {cmpSocs.length>=2&&<><div className="fu d1" style={{height:200,background:C.card,borderRadius:12,border:`1px solid ${C.brd}`,padding:"14px 6px 6px 0"}}><ResponsiveContainer><BarChart data={allM.slice(-6).map(m=>{const row={mois:ml(m)};cmpSocs.forEach(s=>{row[s.nom]=pf(gr(reps,s.id,m)?.ca);});return row;})}><CartesianGrid strokeDasharray="3 3" stroke={C.brd}/><XAxis dataKey="mois" tick={{fill:C.td,fontSize:9}} axisLine={false} tickLine={false}/><YAxis tick={{fill:C.td,fontSize:9}} axisLine={false} tickLine={false} tickFormatter={v=>`${fK(v)}â‚¬`}/><Tooltip content={<CTip/>}/><Legend wrapperStyle={{fontSize:10}}/>{cmpSocs.map(s=><Bar key={s.id} dataKey={s.nom} fill={s.color} radius={[3,3,0,0]}/>)}</BarChart></ResponsiveContainer></div>
   <div style={{display:"grid",gridTemplateColumns:`repeat(${cmpSocs.length},1fr)`,gap:8,marginTop:12}}>{cmpSocs.map(s=>{const r=gr(reps,s.id,cM2);const ca2=r?pf(r.ca):0,ch2=r?pf(r.charges):0;const hs2=healthScore(s,reps);return <Card key={s.id} accent={s.color} style={{padding:12}}><div style={{display:"flex",alignItems:"center",gap:5,marginBottom:8}}><GradeBadge grade={hs2.grade} color={hs2.color}/><span style={{fontWeight:700,fontSize:12}}>{s.nom}</span></div>{[["CA",fmt(ca2)+"â‚¬"],["Marge",pct(ca2-ch2,ca2)+"%"],["Score",hs2.score+"/100"]].map(([l,v2],i2)=><div key={i2} style={{display:"flex",justifyContent:"space-between",padding:"2px 0",fontSize:11}}><span style={{color:C.td}}>{l}</span><span style={{fontWeight:700}}>{v2}</span></div>)}</Card>;})}</div></>}
 </Sect>
 <Sect title="CA Total"><div className="fu d2" style={{height:200,background:C.card,borderRadius:12,border:`1px solid ${C.brd}`,padding:"14px 6px 6px 0"}}><ResponsiveContainer><AreaChart data={allM.map(m=>{let t=0;socs.forEach(s=>{t+=pf(gr(reps,s.id,m)?.ca);});return{mois:ml(m),total:t};})}><defs><linearGradient id="ga" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor={C.acc} stopOpacity={.25}/><stop offset="100%" stopColor={C.acc} stopOpacity={0}/></linearGradient></defs><CartesianGrid strokeDasharray="3 3" stroke={C.brd}/><XAxis dataKey="mois" tick={{fill:C.td,fontSize:9}} axisLine={false} tickLine={false}/><YAxis tick={{fill:C.td,fontSize:9}} axisLine={false} tickLine={false} tickFormatter={v=>`${fK(v)}â‚¬`}/><Tooltip content={<CTip/>}/><Area type="monotone" dataKey="total" stroke={C.acc} strokeWidth={2} fill="url(#ga)" name="CA Total"/></AreaChart></ResponsiveContainer></div></Sect>
 <Sect title="RÃ©partition"><div className="fu d3" style={{height:200,background:C.card,borderRadius:12,border:`1px solid ${C.brd}`,padding:10,display:"flex",alignItems:"center"}}><div style={{width:"45%"}}><ResponsiveContainer><PieChart><Pie data={socs.filter(s=>pf(gr(reps,s.id,cM2)?.ca)>0).map(s=>({name:s.nom,value:pf(gr(reps,s.id,cM2).ca),color:s.color}))} dataKey="value" cx="50%" cy="50%" innerRadius={35} outerRadius={58} paddingAngle={3} strokeWidth={0}>{socs.filter(s=>pf(gr(reps,s.id,cM2)?.ca)>0).map((s,i)=><Cell key={i} fill={s.color}/>)}</Pie><Tooltip content={<CTip/>}/></PieChart></ResponsiveContainer></div><div style={{flex:1,paddingLeft:8}}>{socs.filter(s=>pf(gr(reps,s.id,cM2)?.ca)>0).sort((a2,b2)=>pf(gr(reps,b2.id,cM2).ca)-pf(gr(reps,a2.id,cM2).ca)).map(s=>{const ca3=pf(gr(reps,s.id,cM2).ca);const tot=socs.reduce((a2,s2)=>a2+pf(gr(reps,s2.id,cM2)?.ca),0);return <div key={s.id} style={{display:"flex",alignItems:"center",gap:5,marginBottom:4}}><span style={{width:5,height:5,borderRadius:3,background:s.color}}/><span style={{color:C.td,fontSize:10,flex:1}}>{s.nom}</span><span style={{fontWeight:700,fontSize:10}}>{fmt(ca3)}â‚¬</span><span style={{color:C.td,fontSize:9,width:28,textAlign:"right"}}>{pct(ca3,tot)}%</span></div>;})}</div></div></Sect>
 <RiskMatrix socs={socs} reps={reps} allM={allM}/>
 <CohortAnalysis socs={socs} reps={reps} allM={allM}/>
 </>;
}
